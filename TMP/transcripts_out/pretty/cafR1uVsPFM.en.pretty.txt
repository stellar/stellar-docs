We're going to talk about a. a protocol upgrade that we're pushing.For next week that is around .Fixing a bug that was discovered last.Week.So last month we pushed out.Whisk which is protocol 23 protocol .Was upgraded by a vote from tier one.Validators. and on Thursday last.Week, a week ago, we discovered a bug.In the protocol. we've we worked.The following two days on containing the.Bug. which affected state.Archival. so basically some small.Number of ledger entries that were.Archived were archived with the wrong .Version.So the not most recent version. and when they were restored the.Restoration allowed for the non-most.Recent version to be restored. the.Total number that was actually .Affected is less than 500 ledger.Entries.478 to be exact. out of.These only 84 were restored. so.These are ledger entries that were.Actually restored to the Navos recent.Value. last week, Thursday, Friday,.We worked with tier one validators to.Contain this issue, which means that.We've. set out an emergency SLP to avoid.Archiving more u more ledger entries.We also manually bumped all entries .On the network that were about to expire.So that they don't. we then issued a released a new.Version of Stellar core that was patched.In order to ensure that the affected.Ledger entries cannot be touched so that. any state inconsistencies remain.Quarantined. that happened last week on Friday and.From that moment on we've been working.For the past week since Friday night.On on communicating with .Validators and with affected protocols.To understand what the extent of of.Their issue was. we've also .Suggested a few protocol. upgrade options in order to .Rectify this. and the protocol option. that is overwhelmingly the most.Popular is the less intrusive one which.Is to obviously fix the bug to fix.The archive.So all the ledger entries.That were archived and not restored will.Be will be fixed in the archive and.So when they're restored they will be.Restored to the correct value. but.With regards to the ledger entries that.Are live and have been restored.Incorrectly we will not be addressing.Them on the protocol level but we.Have ensured with all affected .Issuers and protocols that we've been.Communicating with.we're talking about.Around 20 protocols. that they do.Have ways to rectify this on their.End. so for some issuers, it just.Means that they need to adjust the.Supply to make sure that it's it.Reflects what's on chain. a lot of.The issues a lot of the state .Changes have actually been benign and.Not had any meaningful impact., and.Some protocols have had ways to , kind.Of like upgrade out of these issues., and so I am going to stop talking.For a bit right now and , happy to ,.Take any questions.Justin, did you guys.Hear all this?
Hear all this?
Hear all this?
 , yes.It sounded great.And right now. , yes.I'm just going to paste the blog post.That we just released that explains.This a little bit in the chat over.Here.So if you want to sort of read a.Version of what Tor said, it's there..We also you'll see that there's a link.To a CAP there. the CAP is is the.Suggested change that Tor was talking.About and I think I think Nico is.Here and will join us on stage in a.Minute to talk through the cap.First there is a question from Jome.This was completely random.So some.Entries were correctly archived and.Restored. it's not random in the sense that.This was not arbitrary.It was.Deterministic in the sense that all.Protocols all validators actually.Behaved exactly the same.So the.Network did not fork based on this.Behavior. it was consistent. but. it required a very kind of like.Specific arbitrary chain of events that.Relate to how whisk handles live.State prioritization between the.Bucket list which includes all the live.States and the evicted state.Not random but definitely also not. trivial to identify.Okay, it looks like it looks like there.Are .I mean I see someone saying I am late.How bad is this?
As Tor pointed out and.You can read that blog post that's.Posted above, this bug was discovered by. Elliot friend who's here on this.Call. who's who is a senior developer.Advocate at the Stellar Development.Foundation and he discovered it while he.Was you know doing some work to get.Ready for a hackathon that's coming up.And you know short it did not take long.At all and you can see the timeline.There for there to be for the the.Issue to be very quickly quarantined and.The fix will be rolled out pretty.Soon.So, while it's a bug that, you.Know, is very it's a serious bug.The.Impact is something that we've like.Evaluated, talk to everyone who's been.Impacted about and, you know, it's it's.Definitely contained at this point.,.So I'll let you read the post and decide.How bad it is., but my answer is I.Think that the response has kept it.Pretty contained and has cut it off very. quickly.The other so at this point we have.I'm going to post here this is cap.Yeah and as as Dimma points out above.I mean you can read what he he wrote in.Response to your question too.So, I know there's a lot of of of.Discussion going on, but at this point,.I also think it's important to take this.Opportunity to look at the proposed.Solution, which is what I just pasted.There.It's a core advancement proposal.76.And we have some people from the core.Team to walk through this., Nico, do.You want to do it or or is it better if.Dimma does it?
 I can I can Yeah.take a first stab at. I can I can Yeah.It.Guess hear me?
Okay,. perfect. All right.So yeah, so like at a high.Level what the CAP is describing is .First what is actually in scope for.The to to kind of mitigate this.Problem.So like Toma was explaining.Earlier there there's actually two.Types of entries that that u that.Were corrupted. they both started in the same way.Where they basically entries got moved.From the live ledger state into the.Archive and during that process .Entries got corrupted.And then after that some of those got.Restored and at that point they were.Restored for all sorts of purpose.Could be for just reading them.Like a you know a lot of entries on.On in Sorban are just accessed for.For reads like a WAM for example is.An example of that. others were also.Accessed for modification. and yeah but what what the CAP is. is putting in scope is the only.The first category of of entry.So.Basically the ones that were moved into.The archived and kind of stayed there. and .The the solution as part of this is. is is to basically go and.Take the value that was supposed to.Be in the archive and then override.The the archive with that expected.So the fix itself sounds fairly.Fairly simple.U because it is the u the.Bit the the bit of a challenging part.Here is how can you all of you guys.Can trust us that this is the right list.And there's actually quite a bit of.Work that went into this in in the.The cap.So the there's a full list of. of basically of in a CSV file .That you will find where you will see.For each of those entries that end up in.The archive we have the ledger number.Where when the the entry got moved.Into the archive corrupted like I said.So in that case we actually have in this.CSV the the value of the of the entry as.It was at the moment it was about to get.Moved.And then we also have in the same.Row like the value that of the.Corrupted u entry and and then what.Happens when we when we are going to. u follow the this CAP right is the .Core is going to to scan those entries.One by one and see the ones that match.The corrupted state in the archive and.Then if the if it's if it's there it.Should be because we.Also froze restoration at this point. then the the value will get .Replaced by what it should have been.That's kind of like like the the.First part I guess of of this fix..There's another one that's this one is. actually related to this second.Set of entries that actually got . that's for the total lumen.Supply. they were about I think it's.Like three lumen around that like of .Accounting discrepancy.So in the.Proposal what we are saying is that well.Some lumen got got burned in during.This event. we're going to just kind of for.Accounting purpose move that burn as.A into the fee pool.So that's kind of.What the mitigation is for for that.So in terms of like the.The like I said like the so this is.The CSV CSV file what the what core is.Going to do as part of like. in terms of like actual steps right.To to restore the entries in the archive.To the right value. in terms of like verification.There like a few things that can be.Done.There's first there's the list.Itself. this one was computed .By instrumenting core and replay.All those events that are around.Eviction.The version of core that will go out.With the protocol change will will have.This instrumentation.And better than that actually it will.Also have a a way to basically use.That CSV file and check that the.Modification those those changes are.The only changes that happened in the.In that time period.So it's kind of a.Double you know double double use in.A way where the CSV file you can use it.First to see what is the full list of of.Impacted entries to also see which ones.Will be restored and you can also use.That as a way to understand that what.Will happen with protocol 24 and also.Which one which of those entries.Will will not be impacted by this .Protocol.upgrade in which case they.Will stay corrupted as they are today.On the So those are like the entries.That are in yeah that got restored so.Those are like live entries.So maybe I should stop here for a bit.See if there are like specific questions.I just want to add one thing because I.Got some questions on this earlier today. the the patched version of core that.Is currently in production by tier one.Validators bans every transaction.That tries to touch any of the state.That's been corrupted.That's those 87.Ledger entries. so if for some reason. anyone on this call or anyone you're.Talking to is unable to get a.Transaction in and and is getting a.Timeout because of just getting.Timeout then this might be because .You're trying to touch that state.And part of protocol 24 is removing.That ban.So, that ban is supposed to be.Removed as soon as the protocol is in.Effect. which is right now .Scheduled for Wednesday next week .5:00 p.m.EDC. And again, that's a small number small.Number of ledger entries, right?
Number of ledger entries, right?
Number of ledger entries, right?
 Yeah.Just for just for context, . Yeah.You know, ledger Stellar is a database. you can you know think of these.Ledger entries as row rows in the.Database. and Stellar has around 47.Million rows in this database. out.Of which 80 87 have these .Issues. There's a question will protocol 24.Contain new ZK features?
No. the the.Features that were planned for the ZK.Features that were planned for protocol.24 will now be pushed to the next.Protocol 24 is.Just a stability upgrade.Mootz has a question to clarify this cap.Focuses on managing the existing.Corrupted entries.Was there a.Cap/update that could be shared that.Addresses the root cause of generating.Corrupted entries?
Yes. definitely this protocol 24.Yes.Will fix the debug. yeah, actually I.I thought we included the fix itself in.The the cap.So if we didn't, I'm.Sorry about that.But yeah, it should be.Yeah,.Like we could add it to the CAP for.Posterity.Like we typically don't.Include bug fixes in the cup because.It's like two lines fix and you do.Not do anything new from the protocol.Standpoint.Like you already have a CAP defined for.This feature.The issue is not the.Protocol but the issue is that.Implementation was incorrect.But the.Cap itself is CAP 62 I believe. so.You know we got added to the CAP like.That we also fixing the bug but it's not.That historic historically done for the.Bug fixes.Of course, I asked as several people are.Typing.Just to confirm, will this require a.Network pause?
No.I see there are some questions about the.24 that will now be for protocol 25.If.You scroll up and you grab that CAP, you.Can actually look at the different.Proposals for things that relate to ZK.Features.And I think you can dig into.Those.But for now, I think we should.Kind of keep this focused on the on the.Current situation,.The current upgrade.Because I think it's also important.I mean, Nico, you sort of talked through.A lot of this, but can you just tell us.What happens next?
So in terms of you mean like.So in terms of you mean like.Implementation so and and all this.Like the team already has been .Very busy actually implementing this.U this protocol change. given the yeah the urgency of getting.This voted as you know as soon as.Possible so that we can you know like .Like Toma was saying part of this is. also allows the the network to to to. unblock those those entries as.Well.So yeah it's a it's there are many.Reasons that why we want this to to.Happen as quickly as possible. the .So yeah in terms of next step what's.Going to happen is that so we are .Going to have builds of Stellar core and.The the rest of the like platform type.Of software that depends directly on.Stellar core released by. that's like Horizon RPC galaxy.Yeah.And then those will be.Released by Monday. and then what.We expect to do is Tuesday will be.The test net upgrade to this new.And then we'll get the the vote to .With with the validators to be scheduled.On Wednesday and hopefully given that.We did a lot of work already with with.Those validators the vote will actually.Be approved and meaning that we'll.Be back in in business in general.At that time. and so just in general to prepare if.People run infrastructure that basically.Has Stellar core embedded in it so.Either Stellar core for a validator or.Those things that are on the platform.Side that Nico mentioned RPC horizon.Galaxy.You'll need to upgrade right before the. test net if you want to your.Infrastructure to work on test net and.Before the mainet floats.That means you.Have to like pick up the fixes, the the.New releases on Monday.But unlike other.Protocol protocol upgrades, this doesn't.Require everyone to install new SDKs.Correct. That's correct.It's only .There's no impact to the XDR in.Particular.And because of that, that.Means that applications. in general don't actually need to .To do anything.It's basically like.About picking up the It's already about.Picking up the right version of core at.This point.The reason we have to upgrade systems.Like RPC and Horizon is because .There's actually a check in the those.Systems that that check that the.Protocol version.That core is that the network is.Running on.So in this case it will you.Know after the vote it will switch to.24. so like the systems are actually.Built with a safety in place that they.Will only ingest data from a protocol.That they understand. and so.Basically this is this constant and.That's the only that's the only.Change really in those downstream.Systems. I'd like to answer Adam's question. so Adam asked if a reserve asset .Is added to the pool they are tokens.Created inside the contract it won't.Require a deposit of the actual assets.To reconcile. so we did have a few.Of these ledger entries ended up being.Ledger entries that relate to to.Liquidity pools. and the remediation.U is a bit different between different.Pools and different assets. so for.Some assets that changed .Imbalance if they have a centralized.Issuer it was fairly simple to.Basically add the backing asset .And and offchain so that they can.Reconcile the issue. in some .Other situations it was it was .Almost trivial to to burn if if there.Was a eronous credit for some.Pools some liquidity pools are sorry are.Implemented in different ways.Example the Aquarius pool is.Implemented in a way in which .Actually adding an asset doesn't .Change the price or anything because.Aquarius has like internal tracking of.The of the reserves and so manually.Adding a reserve doesn't actually .Impact price and and and that added.Balance is is unusable. it's not it's.Not like that for for source swap and so.It's really different assets and.Different protocols like found.Different ways to fix it. but again.We've talked to pretty much every.Affected protocol and issuer and.Ensured that all of them have ways to.Fix the situation in the context of.These 77 ledger entries.Sorry, I.Said the wrong number before.It's 77,.Not 87. and I can't stress enough how .Helpful every protocol and asset.Issuer have been., I think we started.Reaching out Friday night and Saturday.Morning and we've and everyone has been.Extremely. understanding and and collaborative.And and it's awesome to see the.Ecosystem come together like this.I see there's still some people typing.In the chat.If the questions wind down is I think a.Lot of it's just sort of comments.I'd say if you have a question, get it.In now.It's telling me OrbitLens has a.Question, but Orbit asked, "Do we need.To update the RPCs as well?" and .George from the platform team said yes. Yes.Is there a technical reason this must be.A protocol version upgrade instead of a.Patch release?
Well, yes., like it's a it's a it's.Well, yes.An update to the ledger and because of.That it has to happen basically on all.Machines at once.It was going to be.Like a patch release., yeah, we would.Only be able to kind of the the change.Would happen basically on like whatever.Machine is running right on that with.That patch version.Is this recorded for playback, Carsten?
Is this recorded for playback, Carsten?
Yes, correct.Yeah, I would say in general if you know.You have further questions or it's a.Good idea to read that blog.It just.Came out I think an hour ago, maybe even.Less.And also to read the the CAP.And in general, I think if you're.Interested in in these kinds of issues,.Make sure that you pay attention here or.Sign up for the Stellar Dev mailing.List.Make sure that you pay attention.To the caps., we do try to be as.Transparent about any of these changes.As possible.And obviously we you know.Through all of this we we not only.Couldn't make a decision without all the.Feedback from the ecosystem about what.To implement but implementation is just.One step in governance and the actual.Adoption of a protocol change on the.Network requires validators to vote it.In.So in all of this we we always are.Trying to talk to people including you.Know this call but also online and .Various other platforms and we're trying.To like put the work out there in a.Place where you can examine it and.Understand it and we certainly encourage.You to do that.In fact, with the CAP,. there's a whole process for core.Advancement proposals and as part of.It, we put them into final comment.Period.And because of the urgency here,.We just fast forwarded this to final.Comment period. and so it's it's.Going to stay in final comment period,.Which means that you can write about it.On on the Stellar Dev mailing list until.The time that the validator vote.Happens, which should be on Wednesday.So, this CAP is officially in final.You know, we definitely.Urge you to take a look if you have.Anything to say to add it.Orbit is pointing out the short.Timeline.Yeah, it is a short timeline.I agree., yeah, like .The reason we.We are still kind we think this is best.For the ecosystem is that we are.Actually giving at this point like .Yeah like a you know almost a week .Notice that this is coming.People should be able to to prepare.Ahead of you know and allocate those. two days for upgrading their.Infrastructure.I think given the the severity of. of having those those entries .Blocked I think this is the probably.The right trade-off.Nico,. can you what will the experience be like.For somebody that needs to upgrade their.RPC?
RPC?
RPC?
Will it be difficult?
Will it be difficult?
Will it be difficult?
 So like Yeah.No to upgrade this is . So like Yeah.Basically just like doing a a regular.Kind of a software package update.U.There's really no other steps to.Take. and for people that don't I.Think you mentioned that earlier the.This that core instance will will.Will get stuck until u until the package.Gets updated.It's not going to do like some strange.Things.It's just going to to.Or anything to add?
Or anything to add?
I think there were question I saw a.I think there were question I saw a.Question that I don't think we we can.Really answer to that directly like .On potential impact of like for specific.Protocols.I think yeah th those.Those need to be answered by .Those protocols themselves.Like the assessment, you know, that we.Got from from basically everyone at this.Point is that people are going to be.Able to mitigate for the most part.The the impact of this corruption.Well, I'll give it a few more minutes.For some of these comments or questions.To come in.Know where the bug came from slash how.It got in?
 I mean like bugs or bugs.Yeah, it's. I mean like bugs or bugs.Kind of a they're always sad. what I.Can say is that yeah we had multiple.Rounds of code review.We had.Well,.Feel a little bit more typing.It seems to be witicisms more than.Questions.Thank you for being so responsive to fix.The issue.That's that's really nice.Again, I also want to say echo what.Tor said before.This has been like a.Really cool moment where.A lot of engineers at SDF, but also a.Lot of people in the ecosystem have.Really stood up and provided.Information, given opinions, given.Feedback, reviewed data, done their own.Analysis.And so this is like, you know,.For what it's worth, it really does show.That there is just an ability to be.Super responsive in general across the.Ecosystem.Yeah, if you're not following over there.There in the CAP, there's actually a.List CSV file that has all the different.Columns that got restored.So, you can.Actually look at all the restored.Or you can do some stuff with the RPC.Look at that.We're learning here and.Sharpening our honing our chops.Yeah, that's correct.Right now, all you.Will get is a timeout from if you try to.Interact with one of those entries.I see somebody said and may maybe this.Was a joke.I can't tell.It says or.Not, I guess there's no way to tell.So,.This isn't going to cause Stellar to.Fork.No, this Well, I that's a tricky.Construction because there's a negative.In there., this will not cause.Stellar to fork.That's my statement.I'm trying to even think through how how.It possibly would.I I don't I can't.Even picture how it might.Yeah, again the the the important I mean.The place where we are right now like.The issue was identified.The functionality was turned off.Impacted ledger entries were temporarily.Fix will basically.Allow them to be uncaranted.and and.Allow the any of the ledger entries that.Are currently archived when they get.Restored they'll be restored correctly I.Believe is is where we're at but again.All of that is is an implementation.Based on feedback from the ecosystem it.Actually requires validator validator.Ascent through a programmatic vote on.The network to go live and take effect.It looks like Adam was experiencing a.Timeout message.To save you from yourself.Okay, cool.I feel like we're winding.Down.And again, , some takeaways, read the.Blog, read the CAP caps and final.Comment period, join the Stellar dev.Mailing list if you want to leave a.Comment.Look at that thread that.Persists about the issue.If you have.Questions or an experience that you want.To share,.We will try to keep you updated as new.Things happen. again we have sort of.It seems like there is social consensus.On a path forward for a fix which is.What is captured in that cap. as.The Stellar core team implements a.Solution and it becomes available we.Will let you know and shortly thereafter.We will try to upgrade the network.To.Orbit's point it's a very short time.Frame for that to happen.So, we're.Starting to talk to people now to let.Them know, but once this all the.Software is released, the actual upgrade.Process from a from an operational point.Of view should be pretty.Straightforward., so yeah, I really.Appreciate you all for joining this and.Maybe under different circumstances we.Can just hang and chat again sometime.This was nice.Thank you all.
