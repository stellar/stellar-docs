Hello everyone and welcome to the.Stellar open protocol discussion so.In these meetings.We discuss core advancement proposals.Aka caps.These are technical specs that suggest.Changes to the Stellar protocol.Necessary to allow the protocol to.Continue to evolve to meet the needs of.The ecosystem.And we live stream these meetings so.That anyone who's interested in watching.They can follow along although I do want.To know it is a technical discussion so.If you are watching.You may want to take a look at the caps.Themselves and they're linked to in the.Show description. also we do keep an eye on the.Discussion box and your comments there.They do help us inform our decisions.Going forward.Today's discussion will focus on two.Caps and our goal is really.As as it is generally in these meetings.To try to resolve some outstanding.Questions about them.So we may not address questions that you.Ask directly but if some relevant.Ones come in I may actually try to.Incorporate them into the conversation.So as I said we are focusing on caps and.This meeting is just part of the cap.Life cycle so generally caps are.Discussed on the Stellar depth mailing.List.There's a link to that mailing list in.The event description for anyone who's.Interested in joining the discussion. then caps are drafted and iterated on.Based on feedback and suggestions.And they end up here in this protocol.Meeting and based on what happens in.This meeting.They may be put up for a vote by the cap.Committee who decides whether or not to.Accept a rejected cap.Which point they move into final comment.Period so there's everyone has a.Last chance to raise questions on the.Stellar debt mailing list and if it.Makes it through final comment period a.Cap is implemented into a major Stellar.Core release.Then there's still one final step which.Is that every major release every.Protocol upgrade.Is voted on by the validators and has to.Be accepted before it's applied to the.Network.And so all of that is to say this is a.Long process where there's a lot of.Public participation.And ultimately the network decides to.Accept major protocol changes so.Enough preamble today we are discussing.Cap 21 and CAP 40. both of these lay the groundwork for.Building payment channels on Stellar so.Payment channels.They allow multiple parties to securely.Transact off chain and periodically.Settle on chain.And among other things that could make.It easier to build high volume use cases.On Stellar so.If today's discussion seems dense at any.Point keep that in mind.These caps make technical changes geared.Towards payment channels and payment.Channels.Are important for scaling network.Throughput.So without further ado we will look at.The actual caps we're going to start by.Talking about CAP 21. this proposal generalizes the time.Balance field in transaction.To support other conditions including.Conditions that relax sequence number.Checking.And provide relative time locks and.Since we last discussed this there were.Some small technical changes. there was also the addition of extra.Signers and I think we should start.There.The new precondition extra signers has.Been added lee can you just explain.What that.Why why that edition happened and sort.Of talk us through any questions that.You have about it. yes so extra signers was.Initially added to.Support stateless htlc's so the.Ability to. just to say that this transaction.Needs to be signed by.Or a hash needs to be included with this.Transaction to make it valid.Without having to store that hash as a.Signer on the account so right now you.Can use the hashtag signer.To to say that you need this you need.A hash.Included with transactions to be able to.Transact with an account. and instead of needing to store that.On the account it can now just be stored.Within the transaction. and then second it's it's also being.Used.For cat 40 which we'll talk about later.Would help for me to like overview the.Other changes to CAP 21.Just because you know I think it was.Already people were kind of generally.Okay with it the last time we discussed.It and so a lot of these changes are.Kind of.In response to leads like specific.Implementation and experience like.Things that just came up because of.Implementing it.I think that would be super helpful yeah.Great when you're working so yeah.So one of the changes .Is that the previous version didn't.Really talk about the.Results and there's new failure modes.Now because you've got these multiple.Preconditions and so you might have sort.Of multiple preconditions failing.And in particular you know you could.Have preconditions failing.Because it's too early or preconditions.Failing because it's too late or both.And so what we basically said is if a.Transaction can.Never be valid again then even if.There's other things that are too early.We'll still call it too late.And we'll give the result code tx2 early.Only in the case that.There is the possibility that the.Transaction can be valid again if if.Resubmitted at some later time.So basically if you have said a thing.That's too early and a thing that's too.Late that gets combined to a too late.Error.And so that fits it into like the.Existing error codes and I think.You know preserves the sort of the.Intuition if you're too late you can.Never resubmit and if you're too early. there might be a chance of of.Resubmitting at some later point. so other things that we changed. there's some some some.Clarifications oh yeah the.The .The we kind of rearranged the stuff.That's dangling off. the account of the account entry .In the ledger because it turns out that.Kind of the sponsorship.Information is only there .If you're actually sponsoring things.And so otherwise it's it's currently.Null or it's.A v1 extension instead of v2 so we.Changed that into a pointer and we just.Kept the v2 data structure as a thing.That dangles off. the v3 now optionally if you're.Actually using it. and then the final change is that we.Didn't talk about. we previously I hadn't mentioned.What to do. to an account that didn't have an.Account.Entry extension v3 and so the answer was.Just.Now we just say pretend all the fields.Are zero right so that means like it's.As if like the.The last time it was mod the last ledger.Was modified in time and stuff.Are zero and that's okay because even.Though that means anything.Can anything that's like a relative..Delay will execute any time.You would use these things it would be.On some new account in some new protocol.And so therefore .There would be some other transaction on.The account knew that zero wouldn't.Matter.So again it's just to be precise I don't.Think it really.Matters but it's important to like say.That it's something just to make sure. you know everything is deterministic.And fully specified.So I think that's pretty much all we.Needed to change right.Forget anything lee.No I think that that was everything that.We listed.And I think specifically to do with you.Know the extension like I'm really.Interested to hear.What nico siddharth john what you folks.Think. of this and how this might impact.Core.Well the first thing i'll say is you.Were the one who kind of just prototyped.Out this implementation so what was.Your experience doing it.So I haven't tried the new change so.The diff the difficulty that i.Definitely. hit with the initial proposal. was that there are assumptions made.In core. that the sponsors.The v2 extension is only present when.The account's involved in sponsorship .And.That shows up a lot in the tests more.Than the actual application code.So I guess if call makes that assumption.In tests are there any other products or.Anything else that makes that assumption.That might be interpreting xdr .Comes to mind.I think I think please continue I think.The new proposal.Which which says that you know the v2 is.Still only there when the sponsorship.I think that works from my perspective.From my from my perspective here like i.Don't think it really matters that much.I don't think it's really worth fighting.About much honestly.In the grand scheme of things like i.Could see some merits to this now that.We have all these dangling things. maybe it would be nice to every once.In a while you know smash them all down.Into one.Single dangling thing then dangle.Some more stuff off of it for a while.And then smush them all down again at a.Later date.Again I can see merit to that. I think in terms of like how core.Treats these things. core basically like the process that.We've used for upgrading these.Extensions.Is basically like .There's like two parts to it like one.Thing is like once it comes to existence.Will never unwind that.So like if you sponsor an account and.Then remove the sponsorship you'll still.Have the v2 extension. so the tests most of them have these.Assumptions about.When will these things appear and that's.What you were running into.Not about whether they will be there or.Not period .The other thing is that we are kind.We already kind of made this executive.Decision when .When we added the sponsorship stuff that.Like .Imagine that you didn't have any native.Liabilities so you shouldn't have had a.V1 extension.But then you participated in the.Sponsorship now you have a v2 extension.And we just said like okay well in that.Case we'll just inject the v1 extension.And set it to zero and it's no different.From the case where you would add.Liabilities and then subsequently remove.Them so.From my perspective like core is.Designed in such a way that like either.Solution is completely reasonable. I think like in terms of the total.Net implementation changes it would.Probably be less.If we dangled it but the size of the.Extension would be less if we didn't.So like so just to be clear.You're okay with the current state so.The current state is like a right hybrid.Right where v3.Includes v1 but dangles off v2 so that's.That that's there's basically this thing.Called sponsor info.That is a pointer to an account.Extension v2 but that's inside. the account entry extension v3.Yeah that would be fine I mean again.Like it doesn't.It doesn't really matter but like if.You're if you're gonna do that.Then the marginal additional cost.Of dangling the v3 extension off the v2.Extension is even smaller.Because the four extra bytes are.Appearing in either case. so you're saying that there's no.Situation where.It's important that the v2 be null.Correct.Okay so well anyway I guess I don't.Really.I don't care what I really want is for.Cap 21 to make it in so like what's the.What's the best structure to like make.This happen or.Is the current one I mean I think it's. like .I'm I'm the one that always brings this.Back up you know as soon as you.So you know the current proposal in a.Way is kind of this weird hybrid thing.Like that is.Neither of the nested one neither the.You know the fully.Like represented one so I say like.Either we consider one or the other but.Not this kind of.Half broken one because you get.Basically like.The reason why you want nesting in the.First place that's kind of the whole.Rationale that we have in the. in the repo actually and why we are.Doing nesting is because it makes it.Easier for people.To they don't have to change their.Code.Right like if you depend on on let's say.Sponsorship.You keep referring to sponsorship the.Same way you don't have to.Add the non you know conditions like.Oh if it's a v3.I need to go look for sponsorship over.There instead of over here right.And so there's never it's never going to.Be useful to take something that has.Sponsorship info.And then delete the sponsorship info.Because or to kind of create new.Accounts that just.Don't have any sponsorship info because.They've never sponsored anything.That's the question it sounded like lee.Kind of wanted this in order to make a.Lot of the tests.Easier to port oh well does it act.There's not going to be easier hold on.Wait.Let me clarify something there the v3.Extension will always.Exist for a newly created account right.That's right.But the sponsorship info might not.Whereas like and it so it sounded like.Currently there's a cal like in a lot of.Tests there's like accounts that don't.Have sponsorship info and they think.They never get upgraded to v2 and.I don't know that this is somehow i.Don't know lee do you want to .This is primarily I did this primarily.In response to your feedback lee so i.Don't know if.You want to jump in and yeah so that so.That there's two so I think so far we've.Only really talked about the impact on.Core and.It sounded like from what john was was.Saying like there's not really a big.Impact on core. and I think the concern that I had.Around the impact on tests is maybe.Misplaced.But the second impact is the impact on.The ecosystem which I think is what niko.Was highlighting to.And that is you know everyone who passes.This xtr will need to look for.Fields in the v1 and the v2 in two.Places they'll need to look for it.Either in the v1 or v2 or.In v3 if we move it and I think.That's.That's maybe something that eric well.Like the horizon team.Would you know that's something that.They would be having to deal with.Basically anyone who passes the xtr has.To know to look for it in all these.Different places.Which can also be a little bit of a foot.Gun for people who are upgrading.Because they may not realize that this.Field has been duplicated into a new.Place.Yeah although we can mechanically fix it.With .Like any place that gets translated to.Json for example we can just.Mechanically always move the.Sponsorship info out .Yeah I don't think we should be making.Any decisions based on the effects. of downstream applications .Consuming ledger entries realistically.We're talking about.One maybe two consumers so.You know we can we can talk to them okay.So I think that.I mean to my mind the two things that.Make the most sense are to either keep.The.Cap 21 draft exactly as is or to flatten.Out.The sponsorship info the way it was in.The previous.Revision of the draft so it's just all.One big.Like v3 structure wait.Well you're saying that so I'm looking.At the current master.Is that what you call the latest draft.Because this one is the hybrid one that.Has like this half.Flattened version exactly and so I'm.Saying either we just keep that.Or we should fully flatten it just.Like instead of having.So no but that's actually the one that.Doesn't make sense the one that's half.Flattened either you're doing a nesting.Fully nested.Right where you extend d3 inside v2 okay.Or you're doing the full flattening okay.And then let's do that how about the.Full flattening how about I just.Instead of making that up instead of.Making is having.Having sponsor info be a pointer to like.An account entry.Or account extension v2 how about i.Just take the fields of account entry v2.And make put them in line.Inside the county account entry v3 or.Just put the whole.V2 structure in there.Yeah I know I don't really care.Honestly flatten it or.Or fully nest it but yeah the hybrid.Thing I think is kind of like the worst.Of all the worlds.I propose that I will so I propose to.Just basically.Revert to what it was before if lee.Is okay with that.What was it before yesterday it was.Nested before no no it was it was.Flattened before it was just.The fields at the fields of v1 and v2.Structures were just inside the v3.Structure.Yeah the things that I do think that.Flatten every time we flatten structures.It involves.Changes in a bunch of places that we may.Or may not understand.And i'd rather not do it if we can avoid.It.So are you advocating for the nested.Version foodie nested is kind of the.As a default is safe.Because we don't definitely require the.Fewest changes to core because we.Already have.Well not just score but like yeah it's.Not just core it's also right like the.You know.Anything out there that is actually.Using sponsor like looking up.Sponsorship let's say.So what about what about having them .Not as pointers but just.Putting the v1 and v2 structures into v3.So then.Any xtr library can just kind of extract.Those things by type.No but it's the same problem you have to.You have to switch.Like you have to change your code that.Still.Compiles and still looks like it's.Working but.It will just fail miserably when you.Actually run into that.Like existing code it's always the same.Problem right kind of like the.The problem we you know we created.With the .What was it the next accounts.Right like. but I would argue that like mux.Accounts is precisely because it's way.Worse mexican was way worse because.Of course people use accounts a lot more.Right but here we make it even more.French so that's kind of why.You know if if you're looking at like.The edge case of the edge case and you.Hope that people are going to.Do the right thing I think it's.Actually less likely.Because I mean the problem is that the.Nested is just like much much harder to.Program.To right it's like you're literally like.Fighting with like the right-hand margin.Of your. of your text editor all the time.Where it's like you have to put like.Line breaks in the middle of like you.Know.Expressions that contain dots and arrows.To access fields so it's just like.You know we're getting the point that.We're now we're gonna access fields that.Are like you know.Four or five or six.Deep in structures it's just kind of.Like.Painful for the programmers so what so.Yes there might be like a little bit.More .Stuff to do in transitional though i.Would argue that actually if like we.Do our xcr stuff right it's actually not.That hard because you can automate a lot.Of this stuff. and so i'd rather just have a little.Bit of pain up front and just have.Something that's like much nicer to.Program to.In the long run so when I when I wrote.The prototype. I actually used the nested version .I didn't use the flattened version.Because.It was easier to do an essence I i.Mean you you put the account entry v3.You didn't use the security put the.Account entry v3 inside the country v2.Yeah I'm pretty sure that's what I did.And it was it wasn't that bad.How wide what's your what's the width of.Your text editor.I mean I use softwrap.The thing is that david like the the if.You want to have a helper function.To avoid typing all this stuff you can.Right like it's it.That helpful function is optional in the.Nested world it's mandatory.In the non-nested world.And we already have all right okay.Whatever I'm overruled like no but.That's gonna vote.You guys are all wrong but i'll do it.This way i'll rewrite the CAP to do this.You know generations generations of.Like poor Stellar programmers are gonna.Have to be typing structures six nested.Deep because like.Whatever you guys are worried about a.Non-existent problem but fine.It's more important to get CAP 21.Accepted so .Fine it sounds like a reasonable.Concession.There we are going with the nested.Version in order to get cap21 done.I like it I think this raises.Interesting points though for the.Preconditions.Type that we're introducing because the.Precondition type.Is setting itself up to be like a. a flattened version or at least.That's that was my understanding.Of the proposal it would definitely work.Better I mean like in the.Like five five years from now there will.Be no benefit you know there will be.Only disadvantages to doing.What we're doing now but like yes in the.Short run it will be slightly smoother.To do.To do it with like a fully nested thing.It's just like just how when they were.Choosing you know.Not to fix the precedence of the bitwise.And and or operators when they went from.Bcpl to c and introduced like the.Logical double and double r.And they're like well you know yeah this.Is broken but there's like hundreds of.C programmers in the world like we don't.Want to you know break backwards.Compatibility and you know.Then we got to the point that even java.Adopted those broken.Let's get back.Like I don't know I understand what.You're saying but at the same time.There is this like there is this need to.Sort of.Get something out there that people can.Adopt and start using in order to well i.Think there's.There's really there's use cases that.Cap21 allows there's two there's two.Problems here I think .One is I think people are like massively.Mistaken about.You know how hard it is to adapt to.Something where you have like multiple.Versions of the structure right.And we already have an existence proof.That we did it with something which much.Harder which was the accounts in order.To get the most accounts right so if we.Survive that we can definitely survive.This.The second thing is I think people don't.Appreciate how much should be automated.Because currently in our sdk.We're doing too much sort of manual.Stuff right.And if you use sort of like more. meta programming friendly .Xdr libraries like say you know.Goxster the the one that I wrote or the.Xdrpp that we're using. for Stellar you can actually automate.A lot of this stuff.And so what would be great is that since.There's like the places where people.Actually care about this.Probably if they do it all is when.They're manipulating the json and it's.Not it would be easy to write just like.A few simple rules to like.Make the json look the same or to.Understand the json both ways.But you know what I'm just beating a.Dead horse we'll i'll just .You know maybe a thing to do is like.Introduce a a CAP that's like a meta cap.But like this is how we should do.Upgrades and.Show some evidence for why in the future.It's better to actually version.Structures.And put the versions at the top instead.Of putting these ext things at the.Bottom but.Whatever.So general preconditions I think that's.What was it lee.It was yeah asking about that yeah sorry.I think in general.A it's a misleading name.Yeah I'm I'm not really too fussed on.The on the name but I I'm just.Not the no it's not the name but the you.Know right now it's hardcoded not.General.That's what I mean by it's a lie.So I thought it it was habit you.Wanted to become like pre-conditioned v1.Or something like what do you want.No I would like make it an array of .You know static array or something.But we've already we've already let's.Not relitigate that I know we do we.Already we already discussed this.And and only introduced because.So actually they have a more of a.Question related to the to the cap.Because what have been the time I spent.Actually in the past .Few days was looking at the step.That is the payment channel protocol. trying to see okay like how is.That set related really to the cap.And it doesn't look like the set is.Using.All of the functionalities that are in.The CAP so that's kind of what you know.Where I'm coming from it's like I feel.Like it's .Trying to guess on use cases that maybe.Don't exist and at the same time I would.Prefer to grab something that's that.Can be extended.Easily as opposed to right now because.We can.Just we can just version it right.Now if you mention it you break.Everybody even even if we're doing the.Fully nested there's no reason why we.Can't version.The v3 thing that's dangling off the v2.Right.Like if you want to add a new condition.You would break all the.All consumers no because you would just.Have a data structure that includes.Yeah now you need to add access also.Every single.Condition.No you just need a function that always.Converts to the latest version.But that can be done in a in an.Automated way.Could we just add a v2 can we just add.An extension on the end of the general.Precondition so that we can v2 it.Dangling.I mean we're going to have to if this.Thing is. like we're totally bike shedding this.Thing like and.Did someone else wanna make a pass at.This and then like i'll.Clean up the mess so that like because.Otherwise I'm gonna do something that.Like you guys aren't going to like.I I think it's worth just responding to.Nico what you said about.You know the prototype channel protocol.Doesn't use all of the fields.The only field it doesn't use right now.Is ledger bounds it uses everything else.And I think that was a comment or.Something that david and i.Talked about very briefly was it doesn't.Make sense to keep ledger bounds. because of that.Why what is the argument for keeping.Electric bounds the argument for keeping.The ledger bounds.Is that the the the current payment.Are kind of probably safe enough.But they're not safe if there's like.You know something happens and there's.Like you know an hour of downtime on the.Network or something which you know.Does actually happen periodically so.Somebody who's paranoid.And wants to make create a payment.Channel that is actually robust.To downtime of the network would also.Need.The ledger bounds to be safe.If right because it never goes down all.Your timers expire.But if you have this ledger bound thing. then. you have since the network wasn't.Creating you ledgers while it was down.You still have some opportunity to .Get in there and prevent someone from.Incorrectly closing the channel.Personally I'm like not really that.Concerned about changing the.Like however we struck for the.Preconditions like.We could make it an array of you know .Of whatever of unions and that would be.Fine or we could.Make it a it doesn't really matter.Honestly to me. I think like.At the end of the day like people are.Caring much more about writing these.Than reading them like the only thing.That really should be reading these at.The end of the day.Is you know like if you for some.Reason want to inspect something to make.Sure that you're.Signing the thing that you mean to be.Signing.Which I think is like a very very very.Small subset of the code because a lot.Of times you're assigning the.Transactions that you're creating.Yourself in which case you kind of know.What you're doing.And core and since like this stuff is.Super isolated down to just like one.Code path and core.And if you read the wrong branch and.You're you know signing code and then.You.You're just not going to sign that.Transaction because you didn't know what.It meant.Or your code didn't understand it so.Like I don't feel like the risk of.Blowing yourself up with edge cases here.Is particularly high.So like let's not fight about it that.Much.Like we have unions on unions on all.Sorts of stuff everywhere and.We just kind of you know transactions.For like for example I could send you a.V0 transaction if your code only knows.How to handle v1 transactions you're.Going to blow up.So like we already serious problems.Is.John is your comment about whether or.Not we need ledger bounds.No no no no it's about like the whole.Like nico saying like these aren't.Really general.It's about that part I personally i.My point is kind of like the ludger band.Seemed reasonable to me.The structure is reasonable to me we.Could do a different structure and it.Would also be reasonable to me.I don't see a lot of reason to hash it.Out for 20 minutes .So I is just it could you could could we.Just change the name from general.Preconditions to something else.Yeah I mean like if you named it like.Preconditions v1 or something.That would map up with the names that we.Normally use.But like that sounds good doesn't really.Matter to me.Because if you didn't change it I would.Just stick like if you called in general.I would just like if I needed to change.It later I would just call it general.Preconditions of v2 and call today.So you know.Can we can we add an extension as well.So that we just.Follow the same dangling pattern I i.Just don't see a lot of reason to is.My point here like if you can't handle.The types of transactions you're trying.To sign you won't sign them.And like great if you didn't sign.Something then you didn't agree to.Something you didn't understand.So that's not that I mean the point.It's already in union we've we've.Already got like no preconditions and.Time bounds right so.There's like if it turns out that we.Need a different kind of preconditions.We can just add. a you know a preconditions v2 nobody.Can handle the v.Like the the what is it's the extension.To.Like number two like case number two.Right now anyway without modifying their.So like it's more about thinking about.What happens when you.Change when you make a v2 of that thing.Yeah that's what you're saying though.Like if let's say that I make let's say.That like I add a new feature which is.I don't know like time times ledger.Bound some.Super crazy stupid condition that nobody.No how about number of ledgers that.Aren't completely flawless number one.That's actually plausible number of.Ledgers that aren't completely full.But like if you want to sign this you're.Only going to sign transaction like if.You want to sign stuff and you want to.Understand what you're signing.So you're checking for some condition.You're not going to sign stuff that you.Don't understand.So like your code might barf but like.You won't have signed something that you.Didn't understand so it's it's fine.Like I don't understand what the bad.Case if you don't understand something.Is you're just not going to agree to.Something that.Like I don't know I don't.I don't think there's a bad case there i.Think the case that I'm concerned with.Is the same case with.That we were talking to about with the.Account extensions and that is that. every SDK every application that.Pauses the xdr.Now needs to look for time or now.Let's take.A ledger bounce so say ledger amount.Stays in the v1 then we add.V2 ledger bounds is now going to be in.Two places so it needs to look for it in.Both places.So there's the parsing case and then.There's also the creation case for the.Transaction so sdks need to make a.Decision about. you know what's the general best.Practice for creating a transaction that.Has ledger bounds do they use the new v2.That has ledger bounds or do they use.The new v1 or do they.Only use the v2 when they're using one.Of the new fields. and for the most part in a lot of.Cases that probably won't matter but in.The cases where.Somebody builds a transaction and then.They want to build that exact.Same transaction and they want to expect.The SDK to build it the same way.That does matter because if an sk sdk.Developer decides they're just always.Going to use the latest version.Structure then the transaction is going.To change every time they build that.Same transaction.So we're actually in some ways we're.Actually introducing it backwards.Incompatibility.Because we're saying like you.Conceptually build the same transaction.But you know sdks may make it so that.You're actually building a different.Transaction.I see what you're getting at here and.That's a concern I don't totally.Think that that concern is necessarily.Exactly.Relevant here in the sense that like i.Don't know what.Promises sdks are making but like if an.Sdk is promising to have that property.That we're not going to.Retroactively change your stuff and.That's really a property of the sdk.Because like if you're creating like a.Semantic transaction I feel like the sdk.Just has a promise to do what it's.What you asked it to do but if you want.To have a stronger constraint like an.Exact transaction you probably need a.Different. vocabulary in the SDK for that but.Putting that all aside like the thing.That I'm the thing that makes me scared.About like doing the nesting in this.Context is like.You really really really don't want.To sign something that you don't.Understand like imagine that you're.A guy and you're like I'm looking for.This ledger bound structure right which.I know to be in the in the case 2.Extension. also known as general preconditions.But like imagine we're dangling a v3 off.Of it.You have to actually like you can't just.Call a function to look up the v2 one.And look out.Look up the ledger numbers because you.Actually have to check to make sure that.The v3 stuff.Isn't there because if it is there.In nested you're going to sign something.That you didn't mean to sign.This is this is what I wrote in the code.Example in the agenda this is why it.Kind of explodes and becomes.Pretty awful so.As versions increment you're going to.Get more and more of these to go.Down down the rabbit hole of checking so.I really think like the much safer thing.Is to just.Fail to like fail to sign things you.And then update your code to understand.Them instead of having to handle all.These cases of like oh like what if the.What I need something that's in the v4.But the v3 doesn't.Like but the v3 exists but I don't care.About anything there maybe the v5.Like that gets really confusing and your.Code can change out from under you.Just as the extensions grow basically.And and I think that there's another.Thing.Too which is that if we were really.Trying to build this like little.Language.Of like you know have an array of little. precondition operations that can be.Sort of like arbitrary or you know it.Can be constantly extended.Honestly we then we should try to unify.That with like the claimable balances.Right because.We have like two different little.Languages for.Like preconditions right or if we do.Have two different ones then it just.Seems like.Really needlessly complex for people to.Learn how to use this so what we have is.Simple.It is not it doesn't have to be the last.Word because we can.Change it by again using these unions. and it you know it covers like.All the things that we need to do.Payment channels plus the thing that we.Need if we want to do like super safe.Payment channels which like there's.You know some people like might want to.Be able like people could potentially.Object that you know well on ethereum i.Can make it safer by counting ledgers or.Something. that like this is like a good set and.That we shouldn't let the perfect be the.Enemy of the good we just do this and if.It turns out that it's like so.Successful that we want like.12 different other slight variations on.The preconditions then then we can do a.An array of a programmable thing or.Maybe we can update the claimable.Balances and have like a general.Language for describing preconditions.I'm pretty in sync with david on this.One personally.I think the argument is basically just a.Lot different than the .Than the ledger entry stuff where we.Already have something established that.We're already doing so.So what would that mean the next step is.For CAP 21 like what is the revision.And who who's sort of taking it on.I think the only thing we said we might.Change is to change.General precondition to precondition v1.And that was it.That's it and we would keep ledger.Bounds wait I thought we were also we.Had to move to the.Extensions these like multiple.I think what john counted I thought what.John and you were advocating for was no.I thought we were just talking about the.Preconditions not the not the.Legendary extension there's two.Questions right.One is should our preconditions be how.To do future accessibility for the .For the preconditions that are embedded.In the transaction and the other is.What to do about the ledger entry.Part or the count entry extension part.So john I believe you and I were talking.About just what goes in an actual.Transaction the preconditions.Right yeah that's the thing that I think.Is really dangerous to have these.Accessor functions for that just like.Look that don't necessarily look all the.Way down to the bottom.Right and so and so of course while.I'm happy to leave.Cap 21 and this is it sounded like .We wanted like it sounded like the.Everybody else wanted me to make like.These.To dangle accounting extension v3 off of.Account extension.V2 yes yeah sorry I left that out.At least so I guess I can just do that.Fine.I'll change my stomach but i'll do it.And so that after that change we'll sort.Of reevaluate CAP 21.Are there any other questions that we.Want to talk about about CAP 21 right.Now or should we move on to cat 40.I did have one other question about this.There was like something that struck me.As kind of strange.Yeah so there there actually I had.There like three lines I pulled out and.Like all of them were basically about.The exact same thing and I kept thinking.That this was really weird.There's a sentence in the proposal that.Reads.All transactions are validated sequence.Numbers increased.And fees deducted before any operations.Are executed.One consequence is that bump sequence.Operations though they update an account.Seek time and seek ledger.Do not affect the validity of other.Transactions in the same block.But that's that's actually not how.Things work at all right now.So this is like either a very profound.Change to the way that things work that.We'd have to recognize is a really big.Change.Even though I don't think people are.Using bump seek a lot.Or it's a misunderstanding of the.Current situation sorry the.Audio is breaking up.Sorry what's what's the line number.Or what can what can I search for.You broke up when you're saying which .Yeah let me just tell you what to search.For if you search for.Probably if you search for one.Consequence is.That'll probably work let me see if that.Works okay yeah.Yeah I often find myself searching for.One consequences.Right but that actually is what happens.Currently right bump sequence.Happens when you're executing operations.It doesn't happen when you're validating.Operations.Correct but like like let's imagine.That you have one source account.You submit transactions t1 and t2 at.Sequence numbers. you know n plus one and n plus two.You get the point. and the behavior like both of them.Are no ops they contain like .Zero sorry I don't know if david can.Hear me at all right now.No I can't but..I can't hear david.Oh hopefully I'm on summer when.Like I can't.I couldn't do this meeting but I want to.Move forward so. you have.Okay where's the chat let's let's.Take this one off .Let's take this one to the mailing list.I think.Yeah and I want to point something out.That that doesn't actually impact.The behavior of the bump sequence the.Payment channels are not actually.Dependent on that.So I think that that what that breaks is.That it breaks .That right now you can have transactions.That.Fail later because of that sequence.Number.Exactly like as you can imagine.You have to go on the mainland list at.This point you're bound from this call.There's no chat david not a new chat.That I see at least.So yeah there's not a ch there's not a.Chat in this.Interface one does not simply chat.During the protocol committee meeting.Yeah it sounds like he can hear it so.Yeah the concern is that you have.Two transactions first transaction and.Sequence number you know nn plus one and.Then the first one does a bump sec.To n plus ten this invalidates the.Second one that will fail with a bad.Sequence number.But that will only happen at applied.You know like like when you actually.Apply transactions.And the proposed change would actually.Break that.If you are changing because it would.Allow both transactions to execute.Exactly if the second one has like some.Funny.You know side effects in the proposal.Now those side effects can actually.Happen.And there are like some pretty pretty.Important consequences to another.Sentence in the proposal.Which is that earlier in the proposal.There's a.Two sentences that read a transaction.Whose preconditions are not satisfied is.Invalid.And must not execute even to fail.Meaning it cannot change the source.Account sequence number or charge a fee.But basically the example we just gave.You could imagine a like a like a .A seek gap thing min c.Mint c gap and seek age whatever you.Guys know what I'm talking about. and that would be broken by the.Current bump seek semantics.Because it would actually write it.During the apply time and then the later.One would be invalid at apply time and.Therefore.Fail so yeah.There's probably some like edge cases.Here that we have to iron out either we.Have to.Say that these work in a different way.From other stuff or.Yeah I'm not super sure you'll not allow.I think I thought what we talked about.Before was maybe not allowing more than.One.So like that source account can only be.In one transaction.But that's not necessarily easy well i.Know it's.It's not but that's the only way you can.Make this work I think but you know.Maybe there's a better I'm that's i.Think the only way but.That might be other one another one not.That people can figure out.But it sounds like this is something.That will bear further thought.Like it will require further thought to.Sort of figure out what's.The best solution here and so I think.This is something that.Someone maybe john if you should raise.On the mailing list.Yeah i'll send me an email about it or.Call me by any chance I don't.Actually no david you you have solar.Flares or something.Like I'm on a amount of you might.Find out but like this is like super.Important or can we have.This meeting next week or something i.Knew this was like a bad.Week for this this is like the week that.I wasn't gonna have a wired interest.David didn't predict that it's true.Did yes I apologize for.Trying to force it forward but I mean we.Can certainly this is super important.This is super important stuff that we're.Talking about now so.There's no way zoom usually allows you.To like call and.How and and get in by phone but when i.Click the thing it doesn't give me a.Phone number.The crazy thing is I can hear everything.You're saying now so maybe just.Tell us what you want to say .Okay what I was gonna say is if you have.Transaction n. and you have transaction n plus one.And n is a bump sequence .To like say n plus two both can.Currently execute.Yes they will both execute but no.Currently.Yeah guarantee the second one fails.How does it feel so you've actually.Executed the bump sequence when you're.Validating transactions.Sequence suppose transaction n like .Changes the signer or something right.You're still .Charging a fee for transaction two right.But it fails exactly.Yeah it fails so what I'm like.What kind of ends up happening is like.Any check that we run during validity.Also gets run during during.Transaction application.So basically you get all your validity.Checks get done twice once.Once kind of speculatively and once once.For real for real.And if it fails the validity check that.It does again during application it.Fails.At application it's on the ledger it's.Charged a fee and the sequence number is.Consumed.Yeah okay so what about this what about.Saying like these preconditions always.Get checked twice. if it passes the first time you get.Charged the fee if you get.If it passes a second time .You then can execute that that's fine.That would basically map up what.We're saying but the question is like.Does that break your stuff. no I mean it's a little more.Expensive but it's like .Well the age thing that's what john.Was talking about right yeah I don't.Know if you were able to hear me at that.Point but like.This would this potentially messes up.The the the seek age or seek gap I can't.Remember.So maybe we check the age things only.Once in the other fields twice.And we like rearrange the data structure.If it needs to be such that it's very.Obvious which section is the stuff that.Gets.Checked once and which section gets.Checked twice.In all honesty like there could be some.Sanity to.To basically saying like hey like these.Preconcept precondition things we only.Need to check them once.But you're saying that this would.Currently allow things to succeed.Where currently they fail.Well right now the preconditions aren't.Anything that can be.That can change state like time.Is time it's all checked against the.Close time so it .Shouldn't matter but .Yeah they can't yeah they can't yeah the.Thing is that right now we don't have a.Concept.Of checks. that are done at apply time.Before like like while we do like the.Fee processing for example like we don't.Have that kind of concept.Which is I think what we're talking.About like a phase that is like.Let's do all those checks that are like.On the you know the.Only done once per block.Before anything else happens.That would actually be really easy to.Implement like a bed that would be easy.But that doesn't exist today right.Agreed yeah and I think .I wonder if it would do something funny.Also in terms of like.Results.Oh yeah there'd probably be some.Annoying cases to handle there.But like because we don't have a place.Right now to.Express that there would be a failure in.That phase for. like for horizon I'm thinking.Like the mirror doesn't let you fail.Early like that hold on wait do we.Not like early like it doesn't .There's like it.It applies at apply time you get the.Results but you don't.You wouldn't know that it's a failure.That happened because of a.An early check there's something kind of.Interesting going on here though like.I guess the real point would be like.These precondition checks.Are something that should be done at.Validation time but not at apply time.Because if they succeeded at validation.Time.I guess you're right yeah yeah that.Could also be the.That could be the the change right the.New like the updated thing is that we.Have certain checks that are only.Done at validation time yeah.I bet that could be useful for other.Reasons so I mean the problem.The annoying thing is that okay well one.Thing I mean it wouldn't be.I mean like arguably the behavior that.I'm describing here.Is not like terrible it's just.Unfortunately like a slightly more.Permissive.Than what we currently do it might not.Be inherently.Fatal so so david one of the things.That's actually annoying to do.Those checks at validation time only is. we're supposed to have a.I don't we're supposed to have a as.More or less as an invariant that.Those checks don't depend.On let's just state I mean like they.Only depend on sequence number I guess.Right but you're still literally you're.You're loading the account entry right.Yeah that's the only thing but like if.We wanted to.Have like maybe other dependencies there.Like in terms of checks.I guess you could everything depends on.Either the ledger header or.The ledger entry there's nothing you.Don't need to fetch any.You know right cross lines or any other.Kind of state so.I think that we should still be okay in.Terms of no.Extra database accesses.I don't I don't think that's a big issue.I think this is something we can handle.In a.In a sane way I think it's just.Something I think I just think about let.Me just like.Address it like I can make a pass of.This and I can propose something.That is that is .Both compatible with what we're doing.Today and has kind of the least overhead.Like avoids double checking.If it's sane to do so I have to think it.Through a little bit more but I could.Have.You know something by next week or.Next week I could do something but.I mean that feels like the logical next.Step to capturing one to me yeah.Okay so I have to address this and i.Have to address the. the nested ext structures.And I think yeah like with this new.Condition like one of the.Like I guess that that paragraph or.Whatever section in the cap.Will be where you can talk about.If we have like specific rules around.Multiple transactions. that maybe you want to.Like where you want to allow you know.Certain combinations like what I'm.Thinking here is that if you have two.Transactions.With this min age requirement.Because otherwise you're going to break.The payment channel like the you know.The assumption that. you have a grace period every time.You process a transaction.For the payment channel protocol that's.A good point also.Well okay I will I will I think.That's good that's a good change I think.We're going to highlight this.This specific environment that we're.Going to go after here that's the same.Environment that we need for.The transaction queue policy exactly.Okay so I think I need is there anything.Else because I want to make sure we.Discuss CAP 40.No I think we should move on to count.40.I mean there's only four minutes.Left so.Let's let's jump to CAP 40 because i.Feel like there's a clear path with cap.21.Cat 40..What is the let me see that so cap.40 just trying to find myself. so for anyone who's watching this.Proposal allows participants in a.Payment channel to.Safely exchange signatures for a set of.Up to three transactions in a single.Step. it looks like there are some open.Questions.Several but we don't have time that much.Time so what is the most important.Question that you need answered here.Lee so I think I think.I guess the question i've been most.Interested in is nico raised.You know is this the right structure are.There other things like local trees.That we could be using and then maybe i.Can add a little more detail on.I mean I have that on the mailing list.Right like that the the question there.Is really.So I looked at so the so the the.Proposal I think makes sense with the.Current proposal of payment channels.Because you only have like a very small.Set of participants if you are looking.At.What you would need if you have more.Participants or.Maybe it's like those multi-hop things.Or whatever.Would that make this like.Insufficient.And then you need at that point like .Some way of expressing a bigger set.Like a miracle tree maybe I don't know.Something else.I mean I think that what we have now is.So general like.Yes you can't do merkel trees but you.Can like interoperate with like ethereum.Or like other blockchains like it's.So not only does it like save entire.Round trips.And like eliminate a whole bunch of foot.Guns on these payment channel.Protocols but it also like in such a.Straightforward way adds support for.Essentially.We can basically do htlc's with other.Blockchains without even the hash part.Right like you can literally like just.Kind of tie transactions together across.Blockchains.So from my point of view this is just.Like completely obvious in retrospect.Except you know obviously it's brilliant.Because like nobody.Thought of it until now but like this.Like it's just it's so.Straightforwardly like exactly what you.Want in so many situations where it's.Like I want this texture only if this.Executes fine if you execute this then.Sign the other thing.Right and it's like we're done right so.It's so simple and.So useful.I also had like a very similar reaction.To this when we suggested I was like oh.That's very clever.No no like no I mean I agree like I i.Think it makes total sense for the.For what we're trying to do right now is.It's more.The question for me is is that going to.Be durable.For in terms of design for the payment.Channel because I know for for example.In lightning oh I think it didn't go.That far because.No no no but like for in in the context.Of payment channels.They didn't do that with lightning in.Lightning for example.Because they need a lot more .To unlock a lot more transactions with. one transaction no I think honestly i.Think they just didn't think of it.Right because you could just say if you.Have a three hop like lightning payment.You could just like have to sign.You know all three hops in order to cash.It in.Yeah but so you need three yeah you need.This transaction needs to have.Three additional payloads right.Sure so that's why this doesn't scale.That's the part where it doesn't scale.So that's.That's my question let me ask you a.Question nico.Like sometimes there exists a world.Where it makes sense to have something.That's like.Simple and easy to use but not.Necessarily scalable and something.Harder to use but highly scalable I feel.Like the merkle tree falls into that.Category of like it's obviously much.More scalable but it's also.Not as easy friend user friendly and not.As easy to fit into.Like the current Stellar model so like.Well maybe.A miracle tree of a miracle tree of one.Element is.The same thing right that's kind of what.Maybe i.I don't know that's a.It's more like a if the design relies.Heavily.On such a construct I'm more questioning.The design of the payment channel.But honestly you could do the merkle.Tree it's just the merkle tree would.Have to be on the ethereum side.Right but like .But you know obviously we don't have.Like logic to interpret merkle trees but.The point is like because you're.Signing arbitrary data right you could.Do something such that like.A single payment on Stellar like a usdc.Payment on Stellar could like unlock.Like 20 you know usdc payments on.Ethereum right and do some kind of.Complicated multi-way exchange that way.David if we like.Let's so your point is well taken that.If the merkle tree part was on the.Ethereum side perhaps this would work.So is the argument you're making that.The construct that lee proposes.Is sufficient for the merkle tree case.Assuming that Stellar could also handle.The merkle trees.Or is the payload not big enough or you.Know whatever.I mean you know to be honest the the.Things that.The cases that I think come to mind.Involve .Multiple signers rather than.Signatures on multiple transactions.Right because you could always on.Stellar you know we have a different way.Of unlocking transactions which is like.Twiddle sequence numbers and use like.Or the and use preconditions so .So from my point of view the real the.Real bottleneck here is that just like i.Don't want to add like.A gazillion signatures just because.Verification is expensive right so if we.If we somehow change the transaction.Fees to like.Also include the number of signature.Verifications or something. like I could see like there's a very.Obvious way to extend this to have like.More than two. more than one or two signatures. well actually so actually that's.Related to . yeah that question on number of.Signature verifications actually that's.Sorry I missed that as part of the.Capturing in one conversation.Because you know you guys added this the.Extra sign at the same time then kat von.D kat von d and I didn't.I was not sure on which CAP was tracking.You know what. one thing we could do because in the.Context of.Cap 40 it's just another sign I mean the.X-ray signature it doesn't matter.Actually because it's .It's it's it's being processed like any.Other signature.Right but we don't charge for signatures.Do we thought we just charged for.Operation.But for so yeah so so now going back.Though on to CAP 21 but how it's being.Used in a new way.Right that is you can have like those.Is it two or three.Additional .Signature checks I would argue that.Those should be.Counted towards the 20 signatures limit.That we have.On a transaction okay that's fine.Right because that way we don't have to.Change the model in terms of .Like fees or anything because right now.It's.I mean if we are going with the.Did you see what I mean like I think it.Gets too complicated done.Right and that's a quick CAP 21 change.Because CAP 40 just introduces the.Concept of this new type of yeah.Of cyano I also want to say we're over.Time so I think we're going to have to.Cut this. but I do I mean I feel like with cap.21 there's a clear path forward and it's.That david is going to make those.Two revisions with CAP 40 is there an.Easy next step that we can take here.Just to keep this moving keep pushing.Is there a discussion that we need to.Have either synchronously later.Or async on the Stellar dev list about.This question.I think we should move to accept CAP 40.Today.Yeah I feel I feel like the the argument.About you know would it be better if.It's a merkle tree this is a little bit.Like one or both. you know this is very simple and it.Does it's you know.Only really useful in specific.Constrained.Cases like the payload has to be below a.Certain size that there's a.There's a lot of constraints and so if.The constraints.Are a match this is a great use and.Then if the constraints aren't and we.Have use cases that.Need that are outside those constraints.Then maybe we need some other type of.Signer like a mogul tree signer.And then you know with that sign like.Comes a whole lot of costs and things we.Have to figure out.Bigger problems to solve.I mean like the only reason I would say.Should not be accepted yet is because we.Don't.Like it doesn't make sense to have kept.Fully.In the abstract it's actually in the.Context of CAP 21.Actually it does make sense in the.Abstract the same way we have hashtag.Signers it's just like a better baby.Like who is going to use that.Anybody who wants to like anybody who.Wants to like tie multiple but who is.This anybody.My point is that caps what we have in.The you know.In the in the description of a CAP is.That you have to have the use case.Before we actually go and.Spend the work on implementing those.Things.So you're advocating for holding off on.Accepting count 40 until yeah I mean.It looks fine right like from what we're.Saying it's fine it's more of a.Like we're not going to spend time.Implementing it if you know if we.Don't have the full story.But so we could just make a soft sort of.Promise okay we're planning to accept.Yeah this one is like right after we.Accept CAP 21 we're looking good.Yeah so ideally our next protocol.Meeting whatever that is we can accept.Both CAP 21.Exactly yeah i'd rather do that than.Than try to do this.Piecemeal thing because the point of all.This is like to.To get something that makes sense for.Yeah sure but I do think cap40 is just.It's it's so simple and it has so many.Additional uses it's just like a.Fantastic.Thing in and of itself but actually one.Thing I would love to see.In the CAP 40 proposal would be a use.Case for CAP 40 that doesn't depend on.Cap.21 that would be cool I would like that.Lee can you add like an ethereum like.Swap.Sure okay so that's all that cap40 will.That's like basically the requirement.For CAP 40 is lee's going to add a use.Case that doesn't reply.Require CAP 21 rely on caption one the.Goal for next time is to.Review the changes that david makes to.Cap 21 ideally to get.Cap 21 shortly followed by CAP 40.Accepted cool cool.I think anything else we'll just look to.The Stellar dead mailing list.And everyone here thank you so much for.Joining thanks for your time thanks for.Thinking this through anyone out there.Who's watching thank you so much. you know it's always it's always.Great to have you here and feel free to.Join that.Dev mailing list if you want to see.These discussions and participate in.Them yourselves.There's a link to it in the show.Description all right sorry we ran over.Everybody but thanks again for your time.
