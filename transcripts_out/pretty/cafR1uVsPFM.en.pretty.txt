We're going to talk about um a.Uh a protocol upgrade that we're pushing.For uh next week uh that is around uh.Fixing a bug that was discovered last.Week.So um last month we pushed out.Whisk which is protocol 23 protocol um.Was upgraded by a vote from uh tier one.Validators.Um and um on Thursday last.Week, a week ago, we um discovered a bug.In the protocol.Uh we've uh we worked.The following two days on containing the.Bug.uh which affected um state.Archival.Uh so basically some small.Number of ledger entries uh that were.Archived were archived with the wrong uh.Version.So the not most recent version.Um and when they were restored uh the.Restoration allowed for the non-most.Recent uh version to be restored.Uh the.Total uh number that was actually uh.Affected is um less than 500 ledger.Entries.478 to be exact.Um out of.These uh only 84 were restored.Uh so.These are ledger entries um that were.Actually uh restored to the Navos recent.Value.Um last week, Thursday, Friday,.We worked with uh tier one validators to.Contain this issue, which means that.We've.Um set out an emergency SLP to um avoid.Archiving more u uh more ledger entries.We also manually bumped all entries um.On the network that were about to expire.So that they don't.Um we then um issued a uh released a new.Version of stellar core that was patched.In order to ensure that um the affected.Ledger entries cannot be touched so that.Um any state inconsistencies remain.Quarantined.Um that happened last week on Friday and.From that moment on we've been working.For the past week uh since Friday night.On um on uh communicating with uh.Validators and with affected protocols.To understand what the extent of uh of.Their issue was.Uh we've also um.Suggested a few uh protocol.Um uh upgrade options in order to uh.Rectify this.Um and the protocol option.Uh that is um overwhelmingly the most.Popular is the less intrusive one which.Is to uh obviously fix the bug to um fix.The archive.So all the ledger entries.That were archived and not restored will.Be um will be fixed in the archive and.So when they're restored they will be.Restored to the correct uh value.Um but.With regards to the ledger entries that.Are live and have been restored.Incorrectly um we will not be addressing.Them on the protocol level um but we.Have ensured with all uh affected uh.Issuers and protocols that we've been.Communicating with.we're talking about.Around 20 protocols.Um that they do.Have ways uh to rectify this on their.End.Uh so for uh some issuers, it just.Means that uh they need to adjust the.Supply to make sure that it's uh uh it.Reflects what's on chain.Um a lot of.The issues uh a lot of the state uh.Changes have actually been uh benign and.Not had any meaningful impact.Um, and.Some protocols have had ways to um, kind.Of like upgrade out of these issues.Um, and so I am going to stop talking.For a bit right now and uh, happy to uh,.Take any questions.Justin, did you guys.Hear all this?
Hear all this?
Hear all this?
&gt;&gt; Uh, yes.It sounded great.And right now.&gt;&gt; Uh, yes.I'm just going to paste the blog post.That we just um released that explains.This a little bit in the um chat over.Here.So if you want to sort of read a.Version of what Tor said, it's there.Um.We also you'll see that there's a link.To a CAP there.Um the CAP is is the.Suggested change that Tor was talking.About and I think um I think Nico is.Here and will join us on stage in a.Minute to talk through the cap.First there is a question from Jome.This was completely random.So some.Entries were correctly archived and.Restored.&gt;&gt; Um it's not random in the sense that.This was not uh arbitrary.It was.Deterministic in the sense that all.Protocols uh all validators actually.Behaved uh exactly the same.So the.Network uh did not fork uh based on this.Behavior.Um it was consistent.Uh but.Uh it required a very kind of like.Specific arbitrary chain of events that.Relate to how um whisk handles uh live.State prioritization between um the.Bucket list which includes all the live.States and uh the evicted state.Not random uh but definitely uh also not.Uh uh trivial to identify.Okay, it looks like it looks like there.Are um.I mean I see someone saying I am late.How bad is this?
As Tor pointed out and.You can read that blog post that's.Posted above, this bug was discovered by.Um Elliot friend who's here on this.Call.uh who's who is a senior developer.Advocate at the Stellar Development.Foundation and he discovered it while he.Was you know doing some work to get.Ready for a hackathon that's coming up.And you know short it did not take long.At all and you can see the timeline.There for there to be um for the the.Issue to be very quickly quarantined and.The uh fix will be rolled out pretty.Soon.So, while it's a bug that, you.Know, is very it's a serious bug.The.Impact is something that we've like.Evaluated, talk to everyone who's been.Impacted about and, you know, it's it's.Definitely contained at this point.Um,.So I'll let you read the post and decide.How bad it is.Um, but my answer is I.Think that the response has kept it.Pretty contained and has cut it off very.Um quickly.The other so at this point um we have.I'm going to post here this is cap.Yeah and as as Dimma points out above.I mean you can read what he he wrote in.Response to your question too.So, I know there's a lot of of uh of.Discussion going on, but at this point,.I also think it's important to take this.Opportunity to look at the proposed.Solution, which is what I just pasted.There.It's a core advancement proposal.76.And we have some people from the core.Team to walk through this.Um, Nico, do.You want to do it or or is it better if.Dimma does it?
&gt;&gt; I can I can Yeah.take a first stab at.&gt;&gt; I can I can Yeah.It.Guess hear me?
Okay,.&gt;&gt; perfect.&gt;&gt; All right.So yeah, so like at a high.Level what the CAP is describing is um.First what is actually in scope uh for.The uh to to kind of mitigate this.Problem.So like Toma was explaining.Earlier there there's actually uh two.Types of entries that um that u that.Were corrupted.Um they both started in the same way.Where they basically entries got moved.From the live ledger state into the.Archive and during that process uh.Entries got corrupted.And then after that some of those got.Restored and uh at that point they were.Restored for all sorts of purpose.Could be uh for just uh reading them.Like a uh you know a lot of entries on.On in Sorban are just accessed uh for.For reads uh like a WAM for example is.An example of that.Uh others were also.Accessed for modification.Um and uh yeah but what what the CAP is.Uh is uh putting in scope is the only.The first category of of entry.So.Basically the ones that were moved into.The archived and kind of stayed there.Um and um.The uh the solution as part of this is.Uh is uh is to basically go and.Take the value uh that was supposed to.Be in the archive uh and then override.The uh the archive with that expected.So the fix itself sounds fairly.Fairly simple.U because it is the u the.Bit the the bit of a challenging part.Here is um how can you all of you guys.Can trust us that this is the right list.And uh there's actually quite a bit of.Work that went into this um in in the.The cap.So the there's a full list of.Um of basically of uh in a CSV file uh.That you will find uh where you will see.For each of those entries that end up in.The archive we have the uh ledger number.Where uh when the um the entry got moved.Into the archive corrupted like I said.So in that case we actually have in this.CSV the the value of the of the entry as.It was at the moment it was about to get.Moved.And then we also have in the same.Row uh like the value that uh of the.Corrupted u entry and uh and then what.Happens when we uh when we are going to.Um u follow the this CAP right is the um.Core is going to to scan those entries.One by one and see the ones that match.The corrupted state in the archive and.Then if the if it's if it's there it.Should be uh because we.Also froze uh restoration at this point.Um then the uh the value will get um.Replaced by what it should have been.That's kind of like like the uh the.First part I guess of uh of this fix.Uh.There's another one that's this one is.Um actually related to this um second.Set of entries that actually got um.Uh that's for the total lumen.Supply.Uh they were about I think it's.Like three lumen around that like of uh.Accounting discrepancy.So in the.Proposal what we are saying is that well.Some lumen got um got burned in during.This event.Um we're going to just kind of for.Accounting purpose uh move that burn as.A into the fee pool.So that's kind of.What the mitigation is uh for for that.So in terms of like the.The uh like I said like the so this is.The CSV CSV file what the what core is.Going to do as part of like.Um in terms of like actual steps right.To to restore the entries in the archive.To the right value.Um in terms of like verification.There like a few things uh that can be.Done.There's first um there's the list.Itself.Uh this one was uh computed uh.By instrumenting core and replay.All those events that are around.Eviction.The version of core that will go out.With the protocol change will will have.This instrumentation.And um better than that actually it will.Also have a um a way to basically use.That CSV file and check that um the.Modification those um those changes are.The only changes uh that happened in the.In that time period.So it's kind of a.Double uh you know double double use in.A way where the CSV file you can use it.First to see what is the full list of of.Impacted entries to also see which ones.Will be restored and uh you can also use.That as a way to understand that what.Will happen with protocol 24 and also.Which one which of those entries.Will will not be impacted by this um.Protocol.upgrade in which case they.Will stay uh corrupted as they are today.On the So those are like the entries.That are in uh yeah that got restored so.Those are like live entries.So maybe I should stop here for a bit.See if there are like specific questions.I just want to add one thing because I.Got some questions on this earlier today.Um the the patched version of core that.Is currently in production by tier one.Validators um bans every transaction.That tries to touch um any of the state.That's been corrupted.That's those 87.Ledger entries.Uh so if for some reason.Uh anyone on this call or anyone you're.Talking to is uh unable to uh get a.Transaction in uh and and is getting a.Timeout because of um uh just getting.Timeout then uh this might be because uh.You're trying to touch uh that state.And part of uh protocol 24 is removing.That ban.So, that ban is supposed to be.Removed as soon as the protocol um is in.Effect.Uh which is right now uh.Scheduled for Wednesday uh next week uh.5:00 p.m.EDC.&gt;&gt; And again, that's a small number small.Number of ledger entries, right?
Number of ledger entries, right?
Number of ledger entries, right?
&gt;&gt; Yeah.Just for um just for context, uh.&gt;&gt; Yeah.You know, ledger Stellar is a database.Um you can uh you know think of these.Ledger entries as row rows uh in the.Database.Uh and Stellar has around 47.Million uh rows in this database.Um out.Of which um 80 um 87 um have these uh.Issues.&gt;&gt; There's a question will protocol 24.Contain new ZK features?
No.um the the.Features that were planned for the ZK.Features that were planned for protocol.24 will now be pushed to the next.Protocol 24 um is.Just a stability upgrade.Mootz has a question to clarify this cap.Focuses on managing the existing.Corrupted entries.Was there a.Cap/update that could be shared that.Addresses the root cause of generating.Corrupted entries?
Yes.Uh definitely this uh protocol 24.Yes.Will fix the debug.Uh yeah, actually I.I thought we included the fix itself in.The uh the cap.So if we didn't, I'm.Sorry about that.But yeah, it should be.Yeah,.Like we could add it to the CAP for.Posterity.Like we typically don't.Include bug fixes in the cup because.It's like two lines fix and uh you do.Not do anything new from the protocol.Standpoint.Like you already have a CAP defined for.This feature.The issue is not the.Protocol but the issue is that.Implementation was incorrect.But the.Cap itself is CAP 62 I believe.Um so.You know we got added to the CAP like.That we also fixing the bug but it's not.That historic historically done for the.Bug fixes.Of course, I asked as several people are.Typing.Just to confirm, will this require a.Network pause?
No.I see there are some questions about the.24 that will now be for protocol 25.If.You scroll up and you grab that CAP, you.Can actually look at the different.Proposals for things that relate to ZK.Features.And I think you can dig into.Those.But for now, I think we should.Kind of keep this focused on the on the.Current situation,.The current upgrade.Because I think it's also important.I mean, Nico, you sort of talked through.A lot of this, but can you just tell us.What happens next?
So in terms of um you mean like.So in terms of um you mean like.Implementation so and and all this.Like uh the team already has been um.Very busy uh actually implementing this.U this protocol change.Um given the yeah the urgency of getting.This uh voted as uh you know as soon as.Possible so that we can you know like uh.Like Toma was saying part of this is.Um also allows the the network to to to.Uh unblock those uh those entries as.Well.So yeah it's a it's there are many.Reasons that why we want this to to.Happen as quickly as possible.Um the uh.So yeah in terms of next step what's.Going to happen is that so we are uh.Going to have builds of stellar core and.The the rest of the like platform type.Of software that depends directly on.Stellar core released by.&gt;&gt; that's like Horizon RPC galaxy.Yeah.And then those will be.Released by Monday.Uh and then um what.We expect to do is uh Tuesday will be.The test net upgrade to this new.And then we'll get the um the vote to um.With with the validators to be scheduled.On Wednesday and uh hopefully given that.We did a lot of work already with with.Those validators the vote will actually.Be um approved and meaning that uh we'll.Be back in in business uh in general.At that time.&gt;&gt; and so just in general to prepare if.People run infrastructure that basically.Has stellar core embedded in it so.Either stellar core for a validator or.Those things that are on the platform.Side that Nico mentioned RPC horizon.Galaxy.You'll need to upgrade right before the.Um test net if you want to your.Infrastructure to work on test net and.Before the mainet floats.That means you.Have to like pick up the fixes, the the.New releases on Monday.But unlike other.Protocol protocol upgrades, this doesn't.Require everyone to install new SDKs.Correct.&gt;&gt; That's correct.It's only uh.There's no impact to the uh XDR in.Particular.And because of that, that.Means that applications.Uh in general don't actually need to um.To do anything.It's basically like.About picking up the It's already about.Picking up the right version of core at.This point.The reason we have to upgrade um systems.Like RPC uh and Horizon is because uh.There's actually a check in the those.Systems that uh that check that the.Protocol version.That core is um that the network is.Running on.So in this case it will you.Know after the vote it will switch to.24.Um so like the systems are actually.Built with a safety in place that they.Will only ingest data from a protocol.That they understand.Um and so.Basically this is this constant and.That's the only uh that's the only.Change really in those downstream.Systems.&gt;&gt; I'd like to answer uh Adam's question.Uh so Adam asked if a reserve asset uh.Is added to the pool um they are tokens.Created inside the contract it won't.Require a deposit of the actual assets.To reconcile.Um so we did have um a few.Of these ledger entries ended up being.Ledger entries that relate to um to.Liquidity pools.Um and the remediation.U is a bit different between different.Pools and different assets.Uh so for.Some assets uh that uh changed um.Imbalance uh if they have a centralized.Issuer it was fairly uh simple to.Basically add uh the backing asset uh.And and offchain so that they can.Reconcile uh the issue.Um in some uh.Other situations it was it was um uh.Almost trivial to to burn uh if if there.Was a eronous uh credit um for uh some.Pools some liquidity pools are sorry are.Implemented in different ways.Example um the Aquarius pool is.Implemented in a way in which uh.Actually adding an asset uh doesn't uh.Change uh the price or anything because.Aquarius has like internal tracking of.The of the reserves and so manually.Adding a reserve doesn't actually uh.Impact price and and and that added.Balance is is unusable.uh it's not it's.Not like that for for source swap and so.It's really different assets and.Different protocols um like found.Different ways to fix it.Uh but again.We've talked to pretty much every.Affected um protocol and issuer um and.Ensured that all of them uh have ways to.Fix the situation in the context of.These um 77 ledger entries.Sorry, I.Said the wrong number before.It's 77,.Not 87.Uh and I can't stress enough how uh.Helpful every uh protocol and asset.Issuer have been.Uh, I think we started.Reaching out Friday night and Saturday.Morning and we've and everyone has been.Extremely.Um understanding and and collaborative.And and it's awesome to see the.Ecosystem come together like this.I see there's still some people typing.In the chat.If the questions wind down is I think a.Lot of it's just uh sort of comments.I'd say if you have a question, get it.In now.It's telling me orbit lens has a.Question, but Orbit asked, "Do we need.To update the RPCs as well?" Uh and uh.George from the platform team said yes.&gt;&gt; Yes.Is there a technical reason this must be.A protocol version upgrade instead of a.Patch release?
Well, yes.Uh, like it's a it's a it's.Well, yes.An update to the ledger and because of.That it has to happen basically on all.Machines at once.It was going to be.Like a patch release.Um, yeah, we would.Only be able to kind of the the change.Would happen basically on like whatever.Machine is running right on that with.That patch version.Is this recorded for playback, Carsten?
Is this recorded for playback, Carsten?
Yes, correct.Yeah, I would say in general if you know.You have further questions or it's a.Good idea to read that blog.It just.Came out I think an hour ago, maybe even.Less.And also to read the the CAP.And in general, I think if you're.Interested in in these kinds of issues,.Make sure that you pay attention here or.Sign up for the Stellar Dev mailing.List.Make sure that you pay attention.To the caps.Um, we do try to be as.Transparent about any of these changes.As possible.And obviously we you know.Through all of this we we not only.Couldn't make a decision without all the.Feedback from the ecosystem about what.To implement but implementation is just.One step in governance and the actual.Adoption of a protocol change on the.Network requires validators to vote it.In.So in all of this we we always are.Trying to talk to people including you.Know this call but also online and uh.Various other platforms and we're trying.To like put the work out there in a.Place where you can examine it and.Understand it and we certainly encourage.You to do that.In fact, with the CAP,.Um there's a whole process for core.Advancement proposals and uh as part of.It, we put them into final comment.Period.And because of the urgency here,.We just fast forwarded this to um final.Comment period.Uh and so it's it's.Going to stay in final comment period,.Which means that you can write about it.On on the Stellar Dev mailing list until.The time that the validator vote.Happens, which should be on Wednesday.So, this CAP is officially in final.You know, we definitely.Urge you to take a look if you have.Anything to say to add it.Orbit is pointing out the short.Timeline.Yeah, it is a short timeline.I agree.Um, yeah, like uh.The uh reason we.We are still kind we think this is best.For the ecosystem is that we are.Actually giving at this point like um.Yeah like a you know almost a week uh.Notice that this is coming.People should be able to to prepare.Ahead of uh you know and allocate those.Uh two days for upgrading their.Infrastructure.I think given the the severity of.Uh of having those uh those entries uh.Blocked uh I think this is the probably.The right trade-off.Nico,.&gt;&gt; can you what will the experience be like.For somebody that needs to upgrade their.RPC?
RPC?
RPC?
Will it be difficult?
Will it be difficult?
Will it be difficult?
&gt;&gt; So like Yeah.No to upgrade this is uh.&gt;&gt; So like Yeah.Basically uh just like doing a a regular.Kind of a software package update.U.There's uh really no other steps to.Take.Uh and for people that don't I.Think you mentioned that earlier the.This um that core instance will uh will.Will get stuck until u until the package.Gets updated.It's not going to do like some strange.Things.It's just going to to.Or anything to add?
Or anything to add?
I think there were question I saw a.I think there were question I saw a.Question that I don't think we we can.Really answer to that directly like uh.On potential impact of like for specific.Protocols.I think um yeah th those.Those um need to be um answered by uh.Those protocols themselves.Like the assessment, you know, that we.Got from from basically everyone at this.Point is that uh people are going to be.Able to mitigate uh for the most part.The the impact of this corruption.Well, I'll give it a few more minutes.For some of these comments or questions.To come in.Know where the bug came from slash how.It got in?
&gt;&gt; I mean like um bugs or bugs.Yeah, it's.&gt;&gt; I mean like um bugs or bugs.Kind of a they're always sad.Uh what I.Can say is that yeah we had multiple.Rounds of code review.We had.Well,.Feel a little bit more typing.It seems to be witicisms more than.Questions.Thank you for being so responsive to fix.The issue.That's uh that's really nice.Again, I also want to say echo what.Tor said before.This has been like a.Really cool moment where.A lot of engineers at SDF, but also a.Lot of people in the ecosystem have.Really stood up and provided.Information, given opinions, given.Feedback, reviewed data, done their own.Analysis.And so this is like, you know,.For what it's worth, it really does show.That there is just an ability to be.Super responsive in general across the.Ecosystem.Yeah, if you're not following over there.There in the CAP, there's actually a.List CSV file that has all the different.Columns that got restored.So, you can.Actually look at all the restored.Or you can do some stuff with the RPC.Look at that.We're learning here and.Sharpening our honing our chops.Yeah, that's correct.Right now, all you.Will get is a timeout from if you try to.Interact with one of those entries.I see somebody said and may maybe this.Was a joke.I can't tell.It says or.Not, I guess there's no way to tell.So,.This isn't going to cause Stellar to.Fork.No, this Well, I that's a tricky.Construction because there's a negative.In there.Um, this will not cause.Stellar to fork.That's my statement.I'm trying to even think through how how.It possibly would.I I don't I can't.Even picture how it might.Yeah, again the the the important I mean.The place where we are right now like.The issue was identified.The functionality was turned off.Impacted ledger entries were temporarily.Fix will basically.Allow them to be uncaranted.and and.Allow the any of the ledger entries that.Are currently archived when they get.Restored they'll be restored correctly I.Believe is is where we're at but again.All of that is is an implementation.Based on feedback from the ecosystem it.Actually requires validator validator.Ascent through a programmatic vote on.The network to go live and take effect.It looks like Adam was experiencing a.Timeout message.To save you from yourself.Okay, cool.I feel like we're winding.Down.And again, uh, some takeaways, read the.Blog, read the CAP caps and final.Comment period, join the stellar dev.Mailing list if you want to leave a.Comment.Look at that thread that.Persists about the issue.If you have.Questions or an experience that you want.To share,.We will try to keep you updated as new.Things happen.Um again we have sort of.It seems like there is social consensus.On a path forward for a fix which is.What is um captured in that cap.Uh as.The stellar core team implements a.Solution and it becomes available we.Will let you know and shortly thereafter.We will try to upgrade the network.To.Orbit's point it's a very short time.Frame for that to happen.So, we're.Starting to talk to people now to let.Them know, but once this all the.Software is released, the actual upgrade.Process from a from an operational point.Of view should be pretty.Straightforward.Um, so yeah, I I really.Appreciate you all for joining this and.Maybe under different circumstances we.Can just hang and chat again sometime.This was nice.Thank you all.
