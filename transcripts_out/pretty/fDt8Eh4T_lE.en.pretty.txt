All right hi everyone my name is Marta.And I'm a software engineer on the.Stellar core team and today I'm here to.Talk to you about the Stellar consensus.Protocol.We're briefly going to go over the.Agenda so first we're gonna have some.Motivation for this talk why are we even.Doing this and what are the things that.We're going to cover we're then going to.Have a quick recap on chorim's and what.They are and what they mean in the.Context of the Style Network we will.Talk a little bit about statements which.Are the building blocks of the Stellar.Consensus protocol and then we will see.How statements are used in the process.Called federated voting we will have a.Demo for federated voting to see kind of.How it all plays out and then finally.The two steps of the Stellar consensus.Protocol which are nomination protocol.And the ballot protocol will be the last.Thing that we will cover all right well.Let's start with motivation why are we.Even doing this.So distributes concerns protocol are.Difficult to understand there are a lot.Of steps a lot of things to keep in mind.And if you're new to the protocol and.Just trying to get an understanding of.It it could be quite overwhelming to.Read through all those materials and try.To understand it understand everything.At once we also realized that there is.Quite a bit of advanced material out.There and there's a lack of simplified.Version so this talk will not have any.Complex theorems no math just the high.Level ideas to help you get the right.Understanding of the static consensus.Protocol and we were inspired by physics.In physics you don't go directly into.Complex formulas you first get a high.Level understanding of what's going on.You try to imagine something before you.Actually go and work out the formulas.And dive into more complexity with that.We're going to briefly go over quorums.So you might already be familiar with.Quorums but we're going to go over a few.Important definitions here.So chorim said is a set of notes that.You trust so for example if you look at.The diagram on the right we have a we.Have four nodes a B C and D and you can.Look at the arrows and the arrows.Represent the quorum sets so for example.For a a has B and C in its quorum set.Another example is for B B has three.Nodes in its quorum said it's a C and D.We also have the notion of threshold and.Threshold is a minimum number of nodes.In one's quorum set that must agree for.Example if we go back to our node B.Remember that it has notes AEC in D and.It's quorum set suppose that the.Threshold for B is 2 which means that.Any combination of 2 nodes would be.Sufficient for B to proceed and in this.Case like I was saying it can be any.Combination so it could be a CCD or ad.So those subsets a CCD and ad are called.Corns license.You.And finally the most important.Definition is the definition of quorum.Quorum is.And non-empty set of notes that contains.A slice for each member.So in our example on the right let's try.It and see if we can if we can get a.Quorum starting with a note a so.Remember that a has B and C in its.Quorum slices so we add a B and C to a.Quorum but ABC is not a quorum on its.Own because B and C also have D in their.Quorum slices so we have to add D to the.Quorum and then altogether ABC and D is.A quorum another very crucial definition.On the Stellar network is notion of.Nodes blocking sets any set of nodes in.The quorum set without which the nodes.Cannot reach consensus is a blocking set.And intuitively if you think about the.Name the blocking set blocks consensus.If you do not see agreement of you're.Blocking set then you may not proceed in.In the consensus round so you're blocked.Just with a small example here if we.Have a quorum set of four nodes and then.Suppose we have a threshold three so we.Required three out of four to agree any.Two nodes will be blocking and it sort.Of makes sense because we require three.Out of four nodes to agree so if we have.Two nodes that are not an agreement then.They're blocking us and we cannot.Proceed and reach consensus.Another important thing here to note is.That the concept of blocking blocking.Set is a per node.It's a node because every node gets to.Select their quorum set and so the.Blocking said for each node would be.Different depending of what their quorum.Set is so going back to our example.Let's look at the node C so C has a B.And D in its chorim's quorum set and.Let's say that C went with the most.Aggressive threshold three out of three.Everybody must agree so any node really.In C's quorum set can be blocking for.Example a is a blocking set because C.Threshold three out of three so as soon.As a does not agree cease blocked.Similarly be on its own is a blocking.Set and D on its own as a block instead.And also any combination of those three.Nodes are also blocking sets but here.We're just looking at the smallest.Blocking sets.All right moving on to statements what.Is a statement so statement is the.Smallest building block of the Stellar.Consensus protocol it's basically.Something that the network wants to.Agree on for example when a node says I.Proposed this transaction sets for.Leisure 5,000 that's a statement or.Similarly if the note says I am ready to.Apply this transaction set for l√©ger.5000 that's that's also a valid.Statement so the second one here is a.Little bit stronger because at this.Point the node is actually ready to.Apply the transaction said but.Nevertheless both are valid statements.And both both statements are valid for.The network to agree on which naturally.Leads me to my next point how does the.Network know if a statement is actually.Agreed on it thoughts on it and it votes.On on statements we had this procedure.That is called federal voting so before.We dive into the rules of the Federated.Voting it's important to see how a node.Perceives a statement when it when it.Receives one so I know let me decide.What it wants to do about a statement.Depending off on what its quorum said.Said about that particular statement so.For example and node may say four things.About a statement it may say I don't.Know anything about statement a and I.Have no opinion whatsoever they can also.Say I received a and it's valid and I.Vote for a but it's still not quite safe.To act on it yet so voting is basically.Like a weak form of agreement where a.Node says that yes I vote for a because.I validated it but we still don't know.Network-wide what's the state of a a.Node may also say I accept a if it has.Seen enough support in its form slice.For this particular statement a.But at that point the note still doesn't.Know if it's safe to act on it yet and.Then finally another might say I confirm.A and it is safe to act on it even if.Every note in a quorum slides has not.Yet confirmed a they will not be able to.Confirm anything else but a so this.Means that there is final agreement on.Statement a in the quorum slice and at.This point a note might say I confirm a.So these are the various steps that a.Node may take regarding a particular.Statement a but let's actually go over.The rules and see how this transition.Happens how does it know the boat for.Something how does it move to accept and.Confirm so here are the rules of.Federated voting and node may vote for a.If a is valid and consistent with.Previous votes a node may accept a if.Either every node in its quorum slice.Voted for or accepted a or.A nodes blocking set accepted a and.Let's let's look at this second bullet a.Little bit closer why do we have this.Rule that a node may accept a if you.Blocking set accepted a so remember the.Definition of the blocking said without.The agreement of the blocking said it is.Impossible to reach consensus so a node.Has two choices it can either be stuck.Because a blocking said accepted.Something else or it might it might just.Go ahead and proceed and accept what.Blocking said accepted and so this is.Why we have this rule here that a node.May accept a if it sees the blocking set.Accepted a but you might wonder what.Happened if I voted against a before in.Case and node may just forget its.Previous food and accept a note this.Does not mean that a node would vote for.A it could accept a but doesn't.Necessarily vote for it could have voted.For something else but because it sees.The agreement of its blocking said it.Also accepts a and then finally a node.May confirm a if every node in its.Quorum slice accepted a.All right a little demo here to see how.Those federal voting rules actually work.In an example so at the top right corner.There are some they're the same rules of.The Federative voting that we just.Covered in the previous slide but I just.Put them here like a little cheat sheet.For us to kind of always be able to.Refer to it so here we have a network of.Seven notes and similarly to our.Previous example the arrows show the.Quorum sets selected by each node and I.Want to focus here on this dependency of.Node five so note 5 has six seven and.One in its quorum set and it's important.Here because remember the definition of.The blocking set for this particular.Example let's assume that the threshold.Is the most aggressive right so we it's.All all basically all nodes in the.Quorum slice must agree for a node to.Proceed so one is a would be a blocking.Set four five and six on its own would.Be a blocking set four five and seven.Would be a blocking set four five all.Right let's move on to voting so let's.Say that two different nodes on a.Network decided to vote for different.Things different statements so three.Voted for X and then six voted for Y and.Then those notes send out messages.Saying then hey I voted for X or hey I.Voted for Y and let's see what other.Nodes do when they receive those.Messages so nodes 1 2 & 4 receive vote.For X from 3 and you know they have 3 in.Their quorum set so they validate X no.Problem with that so they go ahead and.Vote for X on the left side notes 5 and.7 receive messages from 6 that they've.That six votes for why they validate Y.No problem and they also go ahead and.Vote for y.Now let's refer to our second rule of.Federal voting just accept if quorum.Sliced voted or accepted so let's see.What we have on the right side on the.Right side every node voted for X so as.Soon as those messages get through nodes.May proceed and accept statement X and.So we can we can see that 1 2 & 3.Accepted X and you know maybe some.Messages are delayed and 4 hasn't.Accepted X yet but this is just a matter.Of time where the messages reach 4 so.Something really important is happen.Here if we look again at our node 5.Remember that 1 is a blocking said for 5.And 1 just accepted X and 5 voted for y.Let's look at our rule number three.Which is except if blocking set accepted.So at this point five sees that it's.Blocking set accepted X so it just goes.Ahead and accept X as well and we can.Also see that for node for the messages.Finally went through and four accepted X.As well.What about our notes six and seven so.Notes six and seven they also see that.I've accepted X and 5 is a blocking set.For 6 and 5 is also blocking set for 7.So referring to our rule number 3 again.Here accepted blocking set accepted 6 &.7 can accept X as well so at this point.Everybody accepted X so all the quorum.Slices except the X in which case we can.Proceed to our rule number four which is.Confirm if a quorum slice accepted so.Everyone scorn slices on the right.Except the next everyone's corn slices.On the Left accepted X so everybody can.Go ahead and confirm X and at this point.It is safe to act on it.Great so now that we covered statements.And federal voting let's actually see.How those are applied to the Stellar.Consensus protocol.So Stellar consensus protocol is a.Two-phase protocol that uses federated.Voting to vote on statements and the.Voting is on statements and statements.Contain values so for the Stellar.Network the values are transaction sets.The first step of the Stellar consensus.Protocol is the nomination protocol.Which selects values to consider for a.Particular ledger so it selects multiple.Transaction sets to consider for the.Ledger the second step is the ballot.Protocol and what it does is it actually.Attempts to commit those values which.Were selected during nomination protocol.And it does so in two steps at first it.Prepares values and then it commits.Values all right time for another.Diagram here so we can think of the.Stellar consensus protocol as the funnel.So the very beginning a node doesn't.Know anything about the state of the.Network it does not know what its quorum.Slices agreed on its uncommitted it may.Really vote for anything it then goes.Into first step which is the nomination.Protocol where it selects a few valid.Values that it wants to consider so it.Goes through the nominate phase and it.Selected candidate set it then goes in.To prepare once it's selected a few.Nominations it goes into the preparer.State where it attempts to commit those.Values alternatively if it gets stuck it.Can also accept what the blocking said.Accept it and proceed with that value.After that no after the preparer is done.Notes go into commit phase where nodes.Attempt to prepare the values attempt to.Commit prepared values excuse me or they.Can again accept what the blocking set.Accepted and then finally at the very.End once the commit phase is done this.Is where we know that the network has.Agreed on a single value and so.Everybody applies the single value and.The.Census is reached so if you were to walk.Away from this talk just remembering one.Thing this is the diagram that I want.You to remember just high-level this is.How Stellar consents protocol works it.Basically tries to narrows down all the.Possible values and at the end you end.Up with a single value which everybody.Agrees on and then you probably have.Guessed that this yellow step is what.Nomination protocol does and then the.Orange step is what about protocol does.For the prepare and commit alright let's.Get into a little more detail about what.Nomination protocol actually does so.Nomination protocol is essentially.Federative voting on statements such as.Nominated transaction set C and though.It may vote for any transaction set any.Transaction said during nomination phase.As long as it's valid.Once the node goes through federated.Voting on the particular nomination.Statement and let's say that that.Nomination got confirmed a node may add.That value into the sub that we called.The candidate set so the candidate set.Is basically just all of the confirmed.Nominations there's an important.Variance here and note stops voting for.New values as soon as it confirms its.First nomination so a node may still.Accept and confirm values that it sees.Its blocking said accepting or.Confirming but it may not vote for new.Values and we will discuss a little bit.More why this is actually really.Important in the next slide but for now.Just remember there is an important.Variant here that we do not vote for any.New values as soon as you confirm.Something and then finally when we have.Those candidates those confirmed.Nominations we may select a single value.Which we call the composite value and at.That point we can start the ballot.Protocol on that value.So in the Stellar network nodes select.The biggest transaction set as the.Composite value so if you have several.Transaction sets in your candidate set.You just go by whichever transaction set.Has most transactions all right let's go.Over the belt protocol so about protocol.Similarly to nomination it's a procedure.Of federated voting on statements and.There are two types of statements.Prepared transaction set X and commit.Transaction set X.So prepare verifies that everybody is.Willing to commit this value that.Everybody is okay with committing it.While commit ensures that everyone.Actually commits the value and at which.Point it is safe to act on the value the.Important thing here is that nomination.Keeps running in the background even.When the belt protocol is running so you.Might have started the belt protocol on.A particular composite value but.Nomination never really stops so it may.Update the composite value in the in the.Background and we will see why this is.Important in in the next slide all right.So why exactly do we start the ballot.Protocol as soon as we have a confirmed.Nomination why don't we wait for.Nomination to finish.So we know that it eventually all nodes.Will converge to the same candidate set.Through nomination and why do we know.This we discussed the important.Invariant a few slides ago that.Nomination protocol stops issuing any.New votes as soon as it confirms its.First nomination remember that it can.Still accept or confirm whatever it's.Blocking said accepted or confirmed but.It may not vote for anything new because.Of that property we can guarantee that.Eventually all the nodes on the network.Through nomination but there's a problem.We don't know when we don't know when.That's gonna happen and so this is why.We are starting about protocol.Optimistically as soon as we have our.First confirmed nomination but you might.Be wondering what can it hurt safety is.It actually safe to do it this way is it.Possible that the network will end up.With some different values actually no.This is pretty safe and there are two.Scenarios here so best-case scenario is.Let's say we started with in.Optimistically prepared value and let's.Say that the network actually agrees.With that and everybody ends up.Committing that optimistically prepared.Value so it's kind of the happy path.Well what happens if the things don't go.So well.Worst case a node might try to prepare a.Value but it gets stuck because it.Doesn't see agreement of the other nodes.On the network and so it would timeout.After it turns out it can either retry.With the new composite value remember.That nomination is running in the.Background and updating composite value.So we might end up with with a new.Compass value actually so it could retry.With that new value or if it sees that.It's blocking said made more progress.And it accepted some time or confirmed.Something it can just switch over and.Vote for excuse me accept or confirm.Whatever the blocking side accepted or.Confirmed all right.So this was sort of a very brief.Discussion of the Stellar consensus.Protocol I also encourage you to check.Out the blog post that we have there is.Another demo in the blog post which.Actually shows how the federated voting.Works with both nomination and the.Ballot protocol and it's very detailed.So I definitely encourage you to take a.Look but for now we're going to go over.The summary so remember that statement.Is a building block of consensus and SCP.Uses federated voting to agree on.Different statements nomination is.Essentially Federative voting on.Statements to select a small set of.Values to consider for a particular.Ledger and the ballot protocol is 32.Voting which tries to prepare and commit.Those values which were selected in.Nomination and most importantly SCP acts.Like a funnel by narrowing down possible.Values for notes to commit and with that.I want to see if there any questions all.Right.Do I have a choice to choose a threshold.Value for quorum slices yeah that is a.Very good question so you do you do but.The selection of threshold really.Depends on how many failures you're.Willing to tolerate so generally we.Suggest that for if you for example to.Add different organizations into your.Quorum set you want at the threshold of.At least 67% so then you can tolerate.Failures but if you have nodes within.Your own organization for example then.You can select a lower threshold like if.You are running three nodes and they're.All within the same organization you can.Have just a simple majority 51 percent.Threshold but yes short answer you you.Get a choice when you configure your.Stellar core node you may configure your.Quorum sets however you want and select.Whichever thresholds you want but we.Generally recommend using the automatic.Automatic quorum generation mechanism.That we have built into Stellar core.Because it accounts for that 67% and it.Looks at nodes within the same.Organization and choose them and it.Chooses a simple majority there so we.Definitely recommend going that route.Because this way you're making sure that.Your configuration is actually safe and.It cannot fork.Great.Any other questions alright well thank.You guys so much thank you for watching.
