Hello everyone. welcome to the open protocol meeting. which is being live streamed and.For all of you watching at home I just.Want to give a quick overview.The goal of these meetings is to talk.About and plan for changes to upcoming.Versions of the Stellar protocol so.We go over core advancement proposals.Aka caps.Which are open source specs and they.Describe new features designed to evolve.The protocol and meet ecosystem needs.And the CAP life cycle begins with the.Draft and today that's what we're.Discussing.A draft specifically a draft of CAP 21.Which is titled generalized transaction.Preconditions.This CAP has actually been kicking.Around for quite a while it was first.Created in may of 2019 but with the .Recent addition of claimable balances.Which were introduced in protocol 15.There were some new possibilities that.Opened up and this week david naziris.Has been adapting the original proposal.With those claimable balances.Possibilities.In mind so fair warning this is a.Technical discussion so if you want to.Follow along.I suggest reading the CAP and the recent.Developer.Mailing list thread about it both of.Which are linked to in the event.Description. so I think you know just a sort of.Quick overview of CAP 21 it generalizes.The time balance field in transaction.To support other conditions including.Conditions that relax sequence number.Checking.And that provide relative time locks it.Does that by extending account entry to.Keep track.Of the time and ledger number which an.Account sequence number was last changed.It also replaces the time bounce field.Of transaction with a union.That allows more general transaction.So the goal is to advance network.Scalability by facilitating off-chain.Payment channels. and that's sort of like what we're.Talking about today is this.Are there questions that we can answer.Will this CAP help. create those payment channels it's.Also to advance security and simplicity.And interoperability with other networks.By enabling relative time locks.And finally it should make it easier for.Developers to create highly usable.Products.By enabling time-delayed queue recovery.So today it's the first discussion of.This newly revised.Cap so part of what we're trying to do.Here is really just get like a sanity.Check.Before we start prototyping anything .Does anything have anyone have anything.They want to want to add here at the top.Yeah as well as insanity check I think.There's also so this one question is is.The overall approach saying and the.Other question is. nico's raised some points . many of which are you know things one.Could go either way on and so.It'd be nice to just kind of see what.The consensus is.For for where we should go.Great I mean and since this is sort of.Something that you've been working on do.You want to.Start out with any any questions that.You might have or sort of pick a point.Where you think the discussions will.Start we can go from there yeah i.Mean I think.Thanks for I think your summary was.Was pretty good here I mean I guess the.The things we could discuss are .One you know does this seem useful for.Like a bunch of different scenarios.Because if you have one mechanism that.Supports like a bunch of different.Things then that's good so i've got.Four examples of things that you can do.With this. you know if people accept those.That's great if people have questions.It's also great if people have other.Things like could it do this like I was.Very grateful lee kind of suggested this.That you have a one-way payment channel.And maybe this isn't perfect but this is.But the fact that I was able to cook.Something up.Pretty quickly using this mechanism to.Do something that.Hadn't been one of the things we'd.Anticipated was .You know an encouraging sign I would say. yeah and then the other thing is like.Sort of nitpicky like technical.Questions that we should get consensus.On.So where should we start application.Like uses or .Or just dive right into the nitpicky.Questions.David can you give a high level overview.Why these things are relevant for.Payment channels ah okay good so.The the the kind of overall.Architecture.Of a lot of payment channels and a lot.Of other .Protocols frankly higher level.Protocols on blockchains.Involves kind of a two-phase thing.Where you want someone to be able to.Kind of recover unilaterally.From a failure if the other party goes.Away or starts becoming non-cooperative. but you don't want people to do.Something. invalid so there's kind of one phase.Where you disclose that you're going to.Do something.And then there's a certain amount of.Time in which someone else can object.If you're doing something that's not.Quite right like you're trying to for.Example.Close a payment channel with an old .Closing state and there's a.More recent closing state but then if.Nobody objects.Then after that time delay you're you're.Able to to close the channel so this.Pattern of kind of disclose and then.Finalize something is extremely.Important in a number of contexts. and so .With without CAP 21 it is possible.But but both extremely tricky to do.With Stellar.And you have to sort of pay a time.Penalty and that things where like for.Example when someone fails you might in.A payment channel you might lose access.To your funds for twice as long.Because you cannot the only way to do it.Is with kind of these. pairs of transactions that have.Non-overlapping absolute times. in them essentially so we've we've.Done stuff like this like.Starlight a long time ago was was was.A proposal it uses it just gets.Super complicated and so the idea here.Is like let's just make it a let's just.Provide as a primitive the thing you.Actually want.Which is kind of the ability to do.Something after some relative. delay and since we already have this.Notion of accounts and sequence numbers.It seems like and since sequence.Numbers are extremely useful for sort of.Invalidating a bunch of stale.Transactions you can just kind of give.Them successive sequence numbers.It seems like the simplest way to.Address this is to just .Have a a transaction precondition says.You can do this transaction but only.When the account has been idled for a.Certain amount of time.Therefore if the attack count gets.Changed when someone discloses that they.Want to do something.You have to wait that amount of time.Before they can actually do the thing.And in that time. somebody else can object by you know.Raising the sequence number further and.Invalidating whatever you were going to.Do to close the transaction.So so that's kind of what what what led.To this .The proposal so it might be worth.Mentioning that. the bitcoin protocol has relative.Time locks.They added it specifically for enabling.The lightning. network just as a reference. but it seems that david like you were.Talking about relative time locks but.Your.Proposal is actually much bigger than.That and also includes some some .Sequence number changes and maybe you.Can talk a bit about that and why that's.Relevant. yeah so .So the .The sigma summer changes are because we.Have .Basically it's our sequence.Sequence numbers are extremely brittle.And hard to use.Right in in protocols because basically.You have to have you have to know the.Exact sequence number in order for.For a transaction to run so so for.One consequence of this is that .In a you know if we don't have CAP 21.And you're implementing payment channels.The kind of disclosure disclosure.Transaction that sets you up to to close.A payment channel.Needs to be signed on multiple source.Accounts you need multiple versions of.It because .You know if you submit yours.But you submit the wrong one then i.Still need to submit one. and so and so it needs to be on a.Different source account because you've.Already burned the sequence number of.Yours.Another example is you want to set it.Like a pre-signed. transaction that will that you.Can kind of submit at any time to do.Something like clean up some.Mess or something and again the.Account.That's only valid if the count is like.In a particular sequence number and so.Without I think overly complicating.Things I added a feature where.You can optionally for an account say by.The way this transaction is valid.For a range of sequence numbers so.Whenever you execute a transaction you.Always leave the account state. the the the invariant is the.Transaction is only valid.When the sequence number of the.Transaction is.Greater than the sequence number of the.Account and after you've executed.A transaction the sequence number of the.Account is always the sequence number.The transaction you just.Executed until now it's always been the.Case that.It also that the sequence number the.Account has to be exactly one.Less than the sequence number of the.Transaction in order for the transaction.To be valid.With this new optional feature you can.Add a different.A minimum sequence number so you can say.Actually I want this transaction to be.Valid.For any sequence number below the.Sequence number of the transaction or.For you know the last hundred sequence.Numbers. and so this makes transactions that.You've kind of signed ahead of time a.Lot less brittle.The particular you know particular.Example of where.Where I use this well actually it seems.To come up in in.Actually all of the the proposed.Applications so in payment channels.It's useful because I can submit a.Disclosure transaction and if it's the.Wrong one you can submit a disclosure.Transaction and they can both just be on.The escrow account.We didn't need to have our special other.Accounts just for the sequence number.Because.You know an earlier disclosure.Transaction doesn't invalidate a later.One because the disclosure transactions.Are signed.To accept a range of sequence numbers. you know another place where this.Might come up is.Where you have you want to be submitting.Large.Numbers of transactions on one account.You have like a farm of 100 servers that.Are all like you know each. each round they're kind of submitting.A transaction .On on the same source account and using.The new feature you can accept gaps in.The in the sequence number space so if.Like one. server happens to be down or not.Produce a.Assigned transaction time that's okay.You can just skip over its transaction. another example that I had was .Was recovering like if you want a.Friend to be able to help you recover.Your account in case you lose your keys. you know you want to pre-sign a.Transaction that you give to them.That they can just submit and will.Will add their signing key to your.Account but of course.You don't want them to be able to do.That immediately you want to have some.Chance to object in case somebody.Like steals their key and so again you.Want.One transaction you can just submit that.Will bump this disclose that this is.Going to happen and bump the sequence.Number all the way up to the point where.Your friend can take over the account.And then a second transaction with a.Relative time lock that allows your.Friend after a few days or whatever to.Take over.That account and help you regain access.To your funds.One thing that I wanted to can you guys.Hear me.Yes excellent one thing that I wanted to..To kind of ask about was how you.Anticipate this interrupt.Excuse me interacting with claimable.Balance ids.Which are sequence number dependent is.The anticipation that.When you do one of these range.Bounded.Transactions on the sequence number that.The sequence number is bumped to the.Last sequence number prior.To submission like prior to the.Operations being applied so that.No matter where you were applied in the.Range the.Any claimable balance generated would.Always be generated using an id that is.Equal to the actual sequence number.Of the transaction so there should be no.Change the the the definition.Of the operation id .Still applies unchanged in the sense.That every transaction still has a.Sequence number.The only thing we're changing and always.Leaves the account with that sequence.Number when it's finished executing.The difference is simply that the.Transaction may be valid.Even if a transaction with the prior.Sequence numbers have not executed yet.So just to make sure I'm 100 on the same.Page as you if the sequence number.Bounds were minimum one maximum three.Whether I played the transaction at.Sequence number one two or three.The claimable balance would always be.Created as if it was ab sequence number.Three. I think what you're saying is.Technically correct but.That's not maybe not the clearest way to.View it so I just view it as there's no.Maximum sequence number there's just a.Which is just the sequence number of.Your transaction.And then there's a minimum sequence.Number that says when your transaction.Starts being valid.And the minimum sequence number by.Default if you don't specify it is just.One less than the sequence number of the.Transaction meaning like every.Transaction.Can be submitted at exactly one sequence.Number but you can. you can reduce that minimum sequence.Number.Down to all the way down to zero if you.Want the reason I'm kind of asking about.It and asking about it specifically in.This way is that the the language you.Keep using is that.When the transaction finishes executing.You will be at blah blah blah sequence.Yeah but I actually think that the.Phrase you want to use is when the.Operation start executing you will be at.Blah blah sequence number.Because otherwise it's quite ambiguous.About which sequence number you're at.When you're actually doing these.Operations and also it's quite ambiguous.What it means to a bump sequence.Okay so let me actually address so.There's several points so.I so the way I was viewing it is that.The. the the operation id.In a claimable balance is depends on the.Actual sequence number of the.Transaction not the sequence number of.The account. and the reason is that I was assuming.That you kind of.Execute transactions in two phases one.In one phase you kind of.Claim all the fees and and bump all the.Sequence and address those sequence.Numbers and you know validate the.Sequence numbers.And then in a second phase you do all.The operations including things like.Bump sequence. but it is currently the case that for.You could you could submit two.Transactions.In the same block right and .Depending on the order in which they.Actually one of them could like bump.Sequence to invalidate the other right.If they have different transaction level.Source accounts and so.That behavior is sort of unchanged. in that like all the validation and.Checking whatever is still.All happening before bump sequence.But regardless of bump sequence when.You're generating a so forget CAP 21.When you're generating an operation id.It's still based on the sequence number.Of the transaction not the sequence.Number of the account in the sense that.If you have a bump transaction.That's not going to affect the operation.Ids right I'm actually.I'm actually trying to confirm that.Right now I was under the impression.That it was based off of the actual.Sequence number of the.Account at the time that it executes so.That would make it difficult to predict.The the operation ids which i.Think.Might be a a problem with claimable.Balances if it's the case so that might.Be something.Independent of CAP 21 that we might want.To revisit.Regardless right maybe it's not it's.It's not because you don't know the.Order in which transactions on different.Source accounts are going to execute in.The same block so.You could have a situation where you you.Have a you have a transaction it you.Know.It it creates some claimable balances . and then because some other.Transaction happened to call bump.Sequence.That the claimable balances have a.Different op id that would be.Oh but no no no we no no like the.Sequence numbers are strictly.Like they are enforced at the time we.Apply the transaction.Yeah david is right though actually it.Comes from the transaction sequence.Not from the account sequence number and.So given that that's the case.Cap 21 doesn't change that that then it.Doesn't every every transaction.Still has a unique sequence number it's.Just we're now we're now can.Skip some sequence numbers we're a.Little bit more flexible at when a.Transaction runs.I have kind of a basic question which is.What was the original rationale for.Sequence numbers replay prevention.Because we don't have.Utxos we need to.We just need to make sure that like a.Valid transaction cannot be submitted.Multiple times to you know double the.Payments.The reason the reason I'm asking is.Because I could foresee that if this is.A.Feature for convenience.Maybe many people would use this feature.So they don't have to think about.And although that's like a choice that.They've made maybe this actually makes.Their implementation less secure.Well no they still need to think about.It it's still it still prevents replay.But.One thing that this allows for example.Is that let's say that you have a fairly.Low.Volume you know account where you're.Not doing a lot of payments you could.Decide.That rather than query for. the the latest sequence number the.You could just kind of use the the like.The unix time.Epoch as like the low 32 bits of your.Sequence number right and and now.If you set your minimum sequence to zero.That that would just.Work obviously you would it would not.Work.You would like get some transactions .Rejected if you happen to.On two different machines use the.Generate transactions at exactly the.Same time and use the same sequence.Number but if that's unlikely to happen.Then.Maybe that's a that's a better trade-off.In some situations and we would allow.That.And just following up on just to make.Sure it's super clear to you eric like.This wouldn't let you ignore sequence.Numbers imagine that you wanted to be.Like hey you know I'm gonna set the.Minimum.Number to one and the maximum number to.N64 max that's not going to cause any.Problems but again there's no match I'm.Not going to work.There's no maximum number exactly please.Don't use the term maximum number. it's going to take you straight to in.64 max you can do this one time and now.You're a count stock.I suppose we could we should actually.Do the .Maybe we should add the limitation the.Same way bump sequence doesn't let you.Bump to n64 max right because we have.Some idea that we want to be able to.Delete the account and then.Recreate it and and not have old.Transactions be valid.It does let you bump into 64 max.Actually it just stuck.At that point and then you're just stuck.You need to use another okay because we.Can't delete the account okay so great.So fine we can just allow to have the.Same thing then.Yeah so so is one way to think about.This that it's a bit like a.Normal transaction with a bump sequence.Built into it yeah but but with a slight.Advantage that the bump sequence.Happens later in the.Processing of a block and this.Happens.Earlier during the initial phase of like.Collecting fees and validating. transactions but yeah it acts a lot.Like an implicit.Like basically you're you're implicitly.Your sequence number is implicitly a.Bump sequence now.So where there are also you know i.Believe on the Stellar dev mailing list.There were some specific technical.Issues. that niko raised and I want to make.Sure that we do.If they're important that we do have.Time to get to them does it seem like.Time to move on to those are there still.More sort of high level or general.Let's get specific okay so so the.First one is that. I mean this is something I feel.Strongly about but it's not the hill.That I want .Cap 21 to die on so .Maybe we end up just deferring this.To some some leader CAP but.The way we do extensions for unions by.Kind of. kind of dangling more and more nested.Structures off the nested unions off the.End of a structure.Is kind of messy and gross and it seems.Like the reason we're doing this.Is just because we're like we don't.Have.Enough like engineering resources to.Kind of fix each individual.Sdk in a way that like frankly wouldn't.Be that hard if we had someone who is.Like living and breathing that.That SDK so. so I you know I think it's it's much.Better to do.Your have your extensions to unions.Be kind of like.Having like an outer union so you can.Just kind of keep improving the data.Structure.And you know keep most of the fields the.Same as opposed to having like many many.Nested unions which is both.You know encodes in a more it takes.More bytes to encode and is like.More of a pain to program to because you.Have all these nested unions.So I'm suggesting that the account entry.Extension that we replace.The thing that's currently a v2 dangling.Off of v1.With with just a .A v3 that that has everything in it.And this isn't even like transaction.State right this is like ledger state so.Like.But by the time you talk talking about.Software that's actually parsing these.Like ledger entries like we're already.In like.Pretty advanced software and not like.Random end users who were like. doing xdr parsing on the .On the actual blockchain state as.Opposed to transactions.I mean I think the by the way this.Was the last.Thing on the list I think in terms of.Priorities I don't know why we're.Spending.Time yeah so again right now I mean we.Can't.Okay why don't we defer this to the end.Then .So the next next question. is that and this is kind of a more.General.Point but it's like coming up here too.We have we're using a combination.Of signed and unsigned integers.For durations and time points and it.Would be super nice if we could kind of.Unify that across everything .And so my proposal so I don't.I don't have a strong opinion on.Which because 62 to the 64 or 2 to 63.Are both very large numbers of seconds. john has suggested that it's useful.To.You know do queries in sql and that sql.Doesn't have.Good support for unsigned 64-bit.Entities not just sql it's also. no other languages sure so. so what we could do is change time.Point to be.Assigned 64-bit integer have duration be.Assigned 64-bit integer. and we would just say that any time.Bounds that.Is negative is just treated as.Like you know n64 max basically for.Backwards compatibility and I doubt any.Why would anyone.Nobody is going to care about if they've.Already signed a transaction whether the.Time bounds is like 2 to the 63 or 2 to.The 64 seconds from the epic right.I mean I think a priori I think that.Sounds fine to me i'd have to.Just look carefully through everything.And make sure that it .Doesn't break anything terribly I mean.But a priori.I agree like nobody cares if something's.Gonna happen in 2200 or I don't know.Two to the 64 must put you into like the.30 000 or something I don't know.Something like that.No I mean it's got to be much more than.That because 32 bits already gets us to.20 30 something right so 16.yeah no.Yeah you're totally right you know.He death of the universe kind of thing.I think we got bigger problems to worry.About at that point in time.Like yeah even changing crypto yeah.Yeah exactly I think my problem said 25.Deep by that point.Okay so for that one is that is that.Where we're landing it sounds a priori.Okay but like we should go to sign.64-bit.And we just have to be a little careful.About legacy you know do it in a way.That doesn't.Mess up legacy transactions..Okay so another question so.Someone so again you know I just like.Doing things. nice and simple and figure we already.Have unions like we've already got.Two kinds of precondition now no.Precondition . time bounds and then these like.General preconditions so if we want to.Add more stuff we could just add a new.Precondition you know.But an alternative would be to kind of.Turn this into a little language. like like the claimable balance.Preconditions and you know having like.An array of different.Things you know. again the proposal could work either.Way. I like this way because it's simpler.But if.There's overwhelming desire to go the.Other way.We can do that as well.I guess one concern you can go first.Nico I was just waiting to see if.Anybody wanted to go first.Yeah I know I was like thinking that if.We just do this pattern right without.The array I think it would just end up.Growing if we add more as we add more.Condition even actually with the current.Version. like you always use like the worst.Almost like max.Max maximum size bikewise. that doesn't seem like a you know.A good property I think in terms of.Complexities.You know we can make it that it's.Actually fairly simple like I would say.Like you know.The array has to be strictly ordered by.You know value for example right like.You cannot put like.That's where you have like a normalized. form right you can't.You have to put for example time bomb.Before.Sequence number right things like. and if you did that could you expand.The the possibilities.Yeah that's it yeah I mean this thing is.Like 20 bytes right if it's not.If it's not doing anything so let's.See there's one there's one.Two three four yeah five things so like.20 bytes. I don't know 24 because the direct.Duration is like 64 bits.But I mean I mean especially for.Things like.Yeah I don't know I mean I can make it.Work the other way it'll be.It'll be like you know more complicated.To implement everywhere.There'll be like more weird edge.Conditions .You know I think that in the end.Maybe you'll shave you know.Eight or 12 bytes off the size of some. preconditions and others will be.Larger and you know maybe like four.Bytes bigger or the same. to me I don't know like.To me it's like the you know it's called.Generalized but it's not generalized.Type of thing you know it's kind of.You know we want it to be generalized.Like a place where we can add more and.More conditions and then.What if I called it something less.Arrogant than general preconditions.Like you know relatives or.Relative general preconditions v1 or.Something I guess you yeah you ask for.It because.It's like when people call the function.You're smart something you know it's not.Smart right. but no no no I'm I'm just saying like.I don't necessarily think it's it's a.Name problem.I think it's more of a yeah the pattern.Like what what is the pattern that we.Want to have here and i.I can see that fairly.You know maybe not in the in the far.Future.We'll have like yeah like some new.Conditions that pop up and.Do I want to again like. you know have like it's it goes back.I guess to this other point about half.The weekend.Yeah fractures right how much pain do.You want to have.In the yeah and I guess here I just i.Don't.I don't agree that the pain needs to be. very very high I just think there's a.There's a there's like a kind of a bug.In our ecosystem that we make these. union upgrades more painful than.Than they should be part.For me kind of what I'm looking at here.Is if we think.That this is a pretty reasonable.Representation of all the things we'll.Need in the near future like near future.Being like.Let's call it the next year I mean we.Lived with just sequence.With just time bounds and single.Sequence numbers for like.I don't know much longer than that five.Years I guess .So if we think we're gonna make it that.Kind of length I don't feel any need to.Go.Super crazy making this complex and.Extensible.But I remember seeing I don't know maybe.It was in the actual proposal maybe it.Was in the notes for this meeting i.Don't remember which.Discussion about whether we should be.Like implicitly elevating.And which is the way that it's currently.Written you need to meet.All the preconditions versus or. if we do something like if we care.About or.Then probably it warrants something more.Complicated but I think that or.Also might might.Might put you into people not being able.To understand what they mean.Yeah I mean you're certain like foot.Guns and stuff like I mean like.You know first of all I actually haven't.Yet come up with a.An example where or you need.Or that's not to say they don't exist .And I would appreciate people speaking.Up if they have any such examples. you can also do or by just signing.Multiple transactions.Yeah that's not impossible.So I would really like to I mean.Especially because I think like to the.Extent we want.To go crazy we can do that with.Claimable balances.Right like we already have a little or.Or we should like try to unify the.Languages right like which is somehow.Make.Like have a notion of precondition that.Can apply to both clinical balances and.Regular accounts and stuff and once we.Start doing this I'm just seeing this.Thing like spiral.Out of control and I think it's like.We're not like.Saying we can never do this like we can.Have like a you know.A new we can add a new thing to the.Union like when when we decide this is.This is done but like look like you know.I just let's just.Try to be good and not perfect for this.Like what we have here is just simple.It's easy to understand.I think it's not going to be too bad to.Implement.And I think it will be already enabled.Like a huge number of use cases.You know I mean as oleg was pointing out.This morning like in order to make.Lightning really work on.On bitcoin they had to go through like.Four different soft forks or something. so like maybe it's not perfect and.Maybe we'll want to make other changes.We have that ability because we have we.Have unions so.I think this claimable balance point is.Worth talking about for two minutes.Though I mean do we think we're going to.Be.Wanting to add this kind of thing to.I'm asking because I'm feeling the pain.Of clinical balances in horizon right.Now and how.We wish we'd made the ids more general.Because we built everything around.Accounts but it turns out clingable.Balances have similar.Properties to occur I mean the the thing.That the the predicates on. climate balances have is that they.Don't they they're less monotonic.Than this stuff so kind of intentionally.Like things like duration and.And like sorry min seek age and and.Min secret ledger gap and stuff .They they have a monotonic property that.They'll you know like once they're valid.They'll.They'll stay valid right there's still a.Maximum time bounds because we're not.Going to get and.Get rid of that in the ledger bounds but. and I think that that. that monotonicity makes it a lot.Easier to reason about like when you're.Sort of forwarding.Multiple transactions on the same. source account you know whether they.Can all be in the same block.You know we don't want to have.Situations where someone can kind of.Waste a bunch of bandwidth by causing.Validators to forward around invalid.Transactions and things like that and so.The monotonicity. helps with that as well you know once.You start adding in not in all these.Other.Operators that you no longer have that.And it just gets more complicated to.Reason about these things. nico and john any pitfalls that you.See in in.Implementing this whether it's a an sdf.Team or someone in the ecosystem trying.To prototype this and still a core.For which part the the condition like.I guess the only.Thing I thought so so in terms of like.The captain itself. like at apply time I don't think.There are like real.Problems from what I see like they are i.Mean it's a fairly simple change.Actually. I'm still kind of.Trying to kind of really .Wrap my head around like the.Like the .The coupling I guess in in some of those.Things like the.Like does that only work basically in.For example like they are like the.Limitations on the flooding that.David added last night that I read.This morning.In particular the the ones that are.Related to.Relative timelocks themselves I think.This.Really only works if you basically do.Like the same type of setup or you have.Like two.Transactions where one kind of allows.You to.To gate the disclosure and then the.Actual right you always have to do this.Right it's kind of and in a way it kind.Of bothers me a little bit that.You know we have those constructs and.They don't work independently I mean.Like all one actually requires the other.One.And I don't know it kind of sorry but.That's the point right you want that you.Want to do you want to have to.Performing the action should require the.Disclosure right you know I understand.But it's. in terms of the construct like you.Have this construct that cannot be used.Outside of of the.The combination right like normally we.Try to make things that.Like for example the sequence number.Thing that can be used in.Any other source of context right the.Other one.The relative condition.Has to be used with sequence numbers .Like I mean like actually.Like other transactions actually it has.To be paired with some other scheme.Otherwise it's a food gun right like .People will not realize maybe that the.You know it's actually a fairly subtle.Thing right that.You it you know if some evil.Person is is constantly kind of.Pushing transactions in front of you.Then your relative.Time kind of keeps moving but it's.Always you know. not where you want it to be right.And you're in in the it's not it's like.You have to use it I mean there are.Other patterns where you could use it.Right you can imagine.You know if my account is idle for a.Year I want.You know my family members to be able to. access the the funds or something.Right so you could just.You could do it as a kind of a a trigger.For for idleness. so it doesn't have to it doesn't have.To be for that but it seems like the.The most most of the cases do involve.This this pattern. of disclose and then act. but I mean I think it's kind of.A very useful pattern right so it is.No the pattern is useful what I'm saying.Is more like .Like I guess you gave an example that.Where I mean this is useful in a context.So we.You don't pre-sign many transactions and.Maybe that's okay.Right I don't know I mean maybe so.I thought I understood your point but.Now I'm actually confused so I thought.That your pro your problem was like well.It's kind of inefficient because it like.Prevents you from pipelining.Back-to-back. transactions or something but.It's it was not an efficiency .Question it was more of a. like a potential attack right like.You pre-signed a bunch of transactions.And then you expect.The that last one to just work but you.Don't realize that maybe.There are ways to touch the account.Basically.Because you have all like an example of.A payment channel right like you can.Imagine that.You can actually if there was no if.If the sequence number was not working.In a way that it would . remove.All transactions you would end up in.Situations.In a situation where .The timestamp would keep moving from all.Transactions right so you end up.Invalidating.Basically your latest one and that's not.The one you.You want to invalidate right we're not.Invalidating you're just. delaying it like you sort of you're.Worried about something like a live lock.Situation.Where yeah someone has low signing.Threshold on the account and so they.Keep.You know exactly like this kind of stuff.Right yeah I don't know.From my perspective on this it's kind of.Like if you're doing pre-signed.Transactions like.You better know what you're doing or.You're probably going to screw yourself.Up no matter what the pitfall is.But you can imagine a day where say.Someone provides a service that does.Pre-signed transactions.Right where where some of that.Difficulty would be.Concealed but I still think that you.Know like CAP 21 is only going to make.That less error-prone.Right because of the fact that you.Sequence something less brittle so.I mean you know there are.Things you can do that are would be.Weird with this.But but they would be weird anyway. I mean like you could have a.Situation where like someone has low.Signing threshold in the account and.They keep.You know bumping a sequence number and.So my my idol thing. you so my idol condition never kicks.In and I can't execute this but they.Could also.Use bump sequence to bump the sequence.Number to.You know max 64 and lock the account.Too right so it's kind of like.You're already giving someone the power.To shoot you in the head and then.Don't you know I guess be happy if they.Only shoot you in the foot instead of.The head or something but.So can we just kind of accept that yes.There there are ways to I mean.Yeah it was more of a yeah like.Like I said like a a concern that.We are adding more complicated things.That you have to know to use.Exactly right otherwise you know I mean.I guess maybe that's what.John is saying like you know those are. to be used only if you.Really understand what you're doing and.You know in a way like I think.Like when I when I see the .The actual payment channel protocol is.Actually super easy to understand like.You can.You know like it takes five minutes to.Actually get it right like and you know.It's correct. unlike you know like previous.Attempts so you know.To me this is like the big win.Tomer had asked about you know.Implementation challenges and i.I agree with nikola that the apply time.Part of it should be like.Super easy I mean a couple new if.Conditions a couple of.Fields to update but like there's not.Really any logic here so it's.I think it's actually probably the.Forwarding logic so there's two.Places where that's what I was going to.Say dude.And the forwarding logic is like a.Little bit more complicated but I think. you know after I kind of thought it.Through and wrote that new section last.Night which. yeah by the way thank you nico for.Pointing that out should have been in.First version of this I think it's.Not too bad.I think like the main challenge will.Just be you know.The the forwarding logic is already.Complicated like there's lots and lots.Of.Conditions on conditions on conditions.And the main new challenge here is just.The additional.Bookkeeping burden of things that used.To not be possible for example like you.Receive a.Trans transaction that's like signum.Three to seven or minsek three seek.Number seven as david would prefer me.Prefer I specify it and then the next.Thing you receive is.Min seek four sequinum six and now you.Can actually add that to the queue and.So it's all about like do our data.Structures allow us to do these things.Efficiently.Yes no I'm not sure probably not.Actually right now. so we'll probably have to redesign.That stuff to make those things fast. but like it's probably within the.Realm of.Doable just the type of thing that.We'll have to do a kind of detailed.Study of like what do we actually have.To do before we touch anything.Lots of positive feedback here.Yeah this is exciting.Okay so in terms of my to-do things.That I should revise here. it sounds like well I guess we.Never really resolve the union thing. if if I don't it sounds like if i.Don't want to.I don't want to predicate this in an.Argument about like unions and ledger.State I should just dangle.The extension v3 off of v2 .Which is my favorite but whatever i'll.Just do that if I have to. sounds like there is consensus that.We should have a duration.And time that we should have duration.And time point types that these should.Be signed throughout. and so I can change that in this cap.And then it sounds like there's also .Kind of reasonable consensus that it's.Okay.To stick with just one big structure.With all the preconditions as opposed to.Trying to build a little language like.For claimable balances.And does it make sense for instance john.You know you were saying that.You would need to to do a detailed study.To figure out if the data structure.Would allow us to do these things.Efficiently does it make sense to also.Start doing that or is that something.That should happen.Post these revisions. yeah I mean our general goal is to.Try to do more stuff in parallel than we.Used to so we can go faster. we have a lot of stuff to do so i.Don't know when that's going to get onto.Our schedule.David my guess is david will beat us.But in theory we we can start that.Whenever at this point I would say. maybe nikola descents but I there's.Nothing blocking us from doing that and.We've we've been doing a lot of work on.That code recently so it's very fresh in.Our mind so it actually could be a.A pretty good time to do it.Are not mandatory to to write kind of.Like a.You know like a quick dirty perhaps.Dirty prototype. and obviously if we accept.Cap 21 in the future and and you know.Merge changes.You know we'll need to optimize but we.Can think about it let's do that first.Cool.This this CAP is premised on the idea.That it actually solves payment channels.Though right.So we add another solution to payment.Channels we'd have to revisit whether.This is something we want to do.Or or if I mean we do have other.Solutions they just have undesirable.Properties right so this was the.Best solution for payment channels it.Would go ahead but if it wasn't then i.Guess we'd re-evaluate whether it was.Still worth doing is that right.Yeah I mean or or we would do that we.Would tweak this because.Probably it seems unlikely that a good.Solution for payment channels.Would not involve some kind of relative.Time lock it just could be that there's.Some other feature we need to add or. or there's some small tweak that we.Need here. so yeah definitely feedback.Challenges like.You know again it was great like lee.Came up with this idea of you know.The one-way payment channels with.Different trade-offs and so yeah so.Maybe i'll keep thinking about that.Too see if see if we can push on that to.Do like top-ups and stuff.In there yeah I think.What I imagine actually is that there.Might be more work to do.As people think in more detail about.The closing like what really happens.When you close the payment.Payment channel like I know in the.Past a lot of the complexity.In the in the starlight.Implementation was that.Balances well we didn't have claimable.Balances. and .And then you have like yeah all the.Things that can fail and then you know.There's no way to retry.And then you're kind of stuck .And yeah like thinking about .Yeah like how to ensure that things.Are safe even if you go beyond the one.Transaction right like.Because in this case you have this one.Transaction I mean I think it.Probably works if nothing fails if.Everything is claimed our claimable.Balances but that's kind of you know.We'll know as we .Actually go a little further yeah I mean.The major major pain point was that.Like paying out to the responder.Could actually fail and so therefore you.Had to make sure that.Like you know it was a separate.Transaction from like restoring the.And now the claimable balances can't.Fail .It's like it's fantastic right it's just.You can do everything and just like one.Transaction that like fixes the thing.Yeah what I'm saying is more like the.Limit right there's a limit of 100.Operations.In a in one transaction so are there.Cases where you have to go beyond that.And if so is it just a matter of like.Right now you do two times I maybe it's.Like three times I is that all there is.To it I don't know saying like.Yeah a payment channel with like 100.Assets in it or something. that that would be interesting i.Think we actually could do well.Yeah or like it depends if you do like.Multi-parties you know more than two.Parties like.You know all this stuff right yeah so.Yeah and I actually think all that will.Work but I could .If you'd like I could add a section on a.Like a a.Multi-party multi-asset channel that.Needs to span.More than one trans closing transaction.Yeah I mean there's really no reason you.Can't just have.Multiple closing transactions with just.Kind of successive sequence numbers.As long as they never fail right that's.Kind of the.Thing no no they can fail actually.Because because it still consumes a.Sequence number they can't be invalid.But they can fail right so if it turns.Out you'd rather pay out with an.With an actual payment instead of a.Create clinical balance.You can still do that it's just now.You have to consider the fact that that.Transaction could fail therefore you.Can't pay out to multiple users in the.Same transaction you just have to have.Multiple closing transactions yeah and.Then you have like the whole like.What do you do with the leftover at the.End and yeah you know the leftover at.The end is you just.The initiator gets control of the.Account yeah but like that's you know.I guess that's one decision you have to.On that front which is because we don't.Have a way to. like the only thing we can do is.Leave it leave full control at the end.Of the leftover to like a given party. you know which I think you want.Anyway because someone had to like put.Up the.Base reserve and stuff for that account.So why not let them just get control.It's also it has this other advantage.That it lets the initiator. unilaterally top up right that you.Don't have to like do some complicated.Protocol to top up like.The initiator can just kind of throw.More funds in there and then it can.Either spend those or.It'll get them back automatically when.It when it closes the channel.Leigh are you raising your hand.Yeah I have a question back on so i.Think I think we're getting in the.Details of like.The specific payment channel.Implementation but I just had a.Thought on.Something that you were raising nico.About .You know the foot gun of just that min.Sequence age. and I'm wondering if like one of the.Early.Proposals I think david that you shared. attempted to use claimant balances.As like the relative timeline so as.Opposed to having the relative time lock.In the account.It existed out in this external thing.Somewhere else in the ledger.And I think that has some like.Undesirable.Properties that you know we wouldn't.Want to do that with claimable balances. is is it worthless exploring that.Idea of having relative time locks being. like a very simple small thing on the.Ledger.They get created outside of the account.And we can define things like when.They expire.And therefore transactions yeah.So actually the this I you know i.Think we could still make.Payment channels work if we got rid of.The min sequence number.But actually it would have more foot.Guns right I actually think the min.Sequence number .Is there to reduce foot guns and to make.A lot of things.Simpler by making sequence numbers less.Brittle.I'm also interested in lee's question.Though it's something i've been.Wondering this whole conversation.Like are there things that we can do.Beyond changing the account state that.Might be more powerful.Than just changing the underlying.Account state like you know recording.Some other state or. you know transmuting claimable.Balances on a transaction.Exactly I was actually referring to the.Sequence age so I was actually meaning.Like move that out of the account.Into like some you know you create a.Lock and that lock is.Automatically locked for like a specific.Age or something like that.Okay so I mean I can tell you a couple.Things you could do but.They're all going to be more.Complicated so one thing you could do is.You could somehow guarantee that.A claim claimable balance will never.Valid and fail right so then you could.Use a claimable balances as a kind of.Synchronization primitive and be.Guaranteed that you're not accidentally.Going to burn.A sequence number another thing that you.Could do.Is you could add a replay cache to each.Account so you can have a new kind of.That instead of instead of.Altering the sequence number it like.Adds itself to the replay cache for.Which you have to pay.You know a base reserve and then.The transactions would get you know.Garbage collected from the replay cache.Based on their .Their max time or maybe based on like.Bumping the sequence number.This starts getting complicated because.You don't want a single transaction to.Be able to kind of delete a million.Things from the database just because.Then that would be like an expensive.Transaction so you'd have to kind of.Limit the per account number of entries.In the replay cache or somehow ensure.That they can't all be deleted at once.Or.Have some other operation that deletes.Like only up to 100.Things from your replay cache that.Are stale. so that that again would that that.Would simplify things because.Again you could kind of submit.Transactions it would be more a little.Bit more general and useful than this.Because now you wouldn't even have to.Worry about.The relative sequence of these.Transactions you could have two.Transactions on the same source account.That could be submitted in either order.And they would both be allowed to to.Execute. so I'm happy to.To cook up a proposal along this lines.Of a replay cache.And I think it would be have some nice.Usability properties.I think it would be much harder to.Implement and I think it would end up.Having some annoying warts owing to the.Fact that. we want to bound the amount of work.That any single transaction.Can cause validators to do so there's.Either gonna be like.Limits the replay cash or limits to how.Quickly it gets garbage collected. leigh do you have more to say I say.You're still unmuted. i'll leave okay on the replay topic i.I have tons of ideas about this david if.You want to talk about it that I want to.Talk about in this context.I actually drafted like a short proposal.Somewhere. about this that you could do this in.A in a very like no storage kind of way.On the ledger .And still have no undesirable replay.Things. we could talk about it offline if you.Want to okay.Would it would it is it was your.Proposal good enough that we should.Consider.Instead of min sequence number or talk.About that.No it's kind of orthogonal to min.Sequence number it's .It avoids other kinds of problems but it.Doesn't fix those problems so.But it does allow you to submit.Transactions without changing the.It does okay yeah let's talk about.Flying about that cool.And I think we're pretty much out of.Time I mean I don't know if if there's.Anything anyone wants to say just at the.End here but it sounds like there's some.Pretty clear.Next steps any final.Parting words parting shots clever jokes.Awesome everyone well thank you for.Coming into everyone who's watching.Thank you for watching this was.A nice deep technical dive into CAP 21.And.More to come on there if you want to .Know what's going on you can always.Join the Stellar death mailing list and.You can also look at the github repo and.Look at the actual. drafts for these kinds of proposals.And I appreciate.Everyone here for joining in the.Conversation thanks so much.You.
