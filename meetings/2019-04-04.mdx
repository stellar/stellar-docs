---
title: "Mergeable Trustlines and Usability Requirements"
description: "This overview highlights Horizon API and network fees and resource limits."
authors: johnny-goodnow
tags: [legacy, CAP-15, SEP-16]
---

## [Public Discussion](https://groups.google.com/g/stellar-dev/c/QSR2wf207ow/m/stluewnDCQAJ)

### Announcements

- Pushing fee work out to next week given David and Orbit's absence (Tomer is also out).

### Agenda

- Discussing next steps for trustlines work.
- David personally doesn't feel good about pushing forward Sponsored Trustlines, despite multiple people who think it's mostly there (Tom, Orbit).
- There was initial discussion of going back to [SEP-0016 (atp3 account transfer)](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0016.md).
- Goal today is to discuss alternative solutions (as opposed to criticism of existing solutions), given the requirements that are extensively listed [here](https://docs.google.com/document/d/1_3KcBTbF7Diu_wu-ArvajYhEcPoDp9SgK5-dNruOK3c/edit).
  - Deposits have to finish without additional user clicks, even when the recipient’s account is uncreated or lacks a trustline, and nor should the user need to fund extra XLM.
  - The send workflow should credit the intended account ID even if no trustline exists, so clients don’t need to coordinate new trustlines for every payment.
  - The document’s overall goal is usability: keep issuer/wallet flows simple so developers actually ship the solution instead of avoiding a hard protocol change.

### Jon proposal

- Trying to solve the add balance problem, and the merge problem related to trustlines.
- We add a concept called a mergeable trustline.
- Can send them to anyone; only the account owner can merge it into a "classic" trustline.
- "CAP-XXXX (Pending Trustlines)" that doesn't break merge.
- Carries its own reserve, uses union-find to merge accounts. Would give O(log n) performance for merging accounts (not the most efficient version of union-find, but still performant).

### Summary of mergeable trustline details

- Mergeable trustlines are associated with accounts via a variant of a union-find data structure (see https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-046j-design-and-analysis-of-algorithms-spring-2012/lecture-notes/MIT6_046JS12_lec16.pdf) that does not include the path-compression optimization.
- Mergeable trustlines are immutable, except that the balance can be transferred in its entirety to the "real" trustline for the corresponding asset on the same account (noted in the meeting that this might be relaxable).
- Each mergeable trustline carries an amount of native asset equal to the base reserve at the time it was created, and this is the entire reserve requirement of the mergeable trustline.
- An account can have an arbitrary number of mergeable trustlines associated with it, even multiple mergeable trustlines for the same asset.
- Sending a mergeable trustline never fails if the receiving account exists.
- Merging accounts never fails due to the presence of mergeable trustlines.
- Open questions included what happens if the sender owns the trustline, or if the sender merges their account, creating issues around locking accounts and outstanding trustlines.
- Revocability should not be done on-ledger; it should be handled via pre-authorized transactions or other multi-phase protocols. If it is on-ledger, it should be irrevocable.

### Nico's caveats

- Similar complexities arise as with SEP-0016: clients must track incoming mergeable trustlines, decide whether they matter, query them from Horizon, and take actions.
- This puts significant burden on clients to download and reason about many mergeable trustlines.
- Union-find might help reduce what needs to be downloaded, potentially in tandem with SEP-0016.
- David, Nico, and Jon's proposals all rely on some form of "incoming trustline" at the core layer, which does not appear substantially simpler than ecosystem-level approaches.

### SEP-0016 thoughts

- Defining the last step is difficult given current protocol constraints and would require "shrink to fit" and other small core changes.
- SEP-0016 should likely remain a living document that evolves alongside core capabilities.

### Follow-up actions

- David to put together a list of constraints and concerns blocking [CAP-0015](https://github.com/stellar/stellar-protocol/blob/master/core/cap-0015.md) from moving forward with Nico.
