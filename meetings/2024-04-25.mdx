---
title: "CAP-57 Updates and History Archive–Based Restoration"
description: "This overview summarizes updates to CAP-57, focusing on history archive–based state restoration, RPC proof generation, and changes to the state archival architecture."
authors: [garand-tyson, kalepail, naman-kumar]
tags: [developer, CAP-57]
---

import DriveVideo from "@site/src/components/DriveVideo";

<DriveVideo ID="1WdZeRnjwl0FCxwtQhy2DNqMtNIiZIgtD" />

This session covered significant updates to the state archival and restoration design described in CAP-57, reflecting feedback gathered from the ecosystem. Garand outlined how the proposal has evolved to simplify architecture while improving verifiability and operational flexibility.

The discussion centered on removing the need for a separate storage system for expired state and instead leveraging Stellar’s History Archive to store archived entries and restoration data. Participants examined how RPC, captive-core, and validators would interact with archived state, as well as open questions around performance and proof construction.

### Key Topics

1. Garand discussed changes to the State Archival proposal based on feedback received at Meridian 2023. The proposed changes are:

- Previously, a downstream system called the ESS (Expired State Store) would store expired entries. In the new proposal, There is no ESS. All Archived entries, as well as all information required to generate restoration proofs for those entries, is stored directly in the History Archive.
- RPC nodes can generate proofs for archived state during preflight
- Captive-core can be directly queried for archived state, meaning that RPC/Horizon instances can potentially service queries for archival state

2. [The draft proposal](https://docs.google.com/document/d/1FAs3Yfo-o-gVqccrP29NSG8ysRvdEoyvuL7ywV4ijXI) lays out the state archival architecture: evicted persistent entries get archived into the Hot/Cold archives, recorded via the Archive State Tree, and exposed through RPC/RestoreOp proofs instead of a separate ESS.

- Validators drop expired persistent entries into the Hot Archive, snapshot it into immutable AST subtrees, and publish Merkle roots (plus binary fuse filters) so RPC can produce restoration proofs without replaying history.
- RPC/captive-core access to archived state during preflight enables proofs to be attached by clients, while restore flows ensure each archived version can only be restored once and cannot be recreated with different data.
- The design keeps live state lean, lets History Archives store only snapshots + proofs, and encourages downstream systems (RPC/Horizon) to fetch archived snapshots on demand or shard them across nodes.

3. Ongoing GitHub discussion about safely evicting and later restoring persistent contract state in CAP-0057 by archiving it in Stellar’s History Archive and generating cryptographic proofs during preflight, without introducing a new storage system.
4. Snapshot size is TBD; it's a function of bucket list size as well as memory and historic demands placed on the RPC.
5. Bloom filters are the likely solution for proof of non-exitance though they come with trade-offs. They enable fast and cheap lookup but are probabilistic not deterministic.
6. Further comments are welcome.

### Resources

- [CAP-57: Archived Contract State](https://github.com/stellar/stellar-protocol/blob/master/core/cap-0057.md)
- [Discussion: Persistent Entry Eviction](https://github.com/stellar/stellar-protocol/discussions/1480)
