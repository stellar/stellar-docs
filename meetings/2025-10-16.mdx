---
title: "State Archival Bug Review"
description: "Discussion of a state-archival bug introduced with Protocol 23 (Whisk), its impact on archived ledger entries, and the proposed protocol-level remediation focused on correcting archived state and safely unblocking affected Soroban contracts."
authors:
  - carsten-jacobsen
  - dmytro-kozhevin
  - justin-rice
  - nicolas-barry
  - tomer-weller
tags: [developer, CAP-62]
---

import YouTube from "@site/src/components/YouTube";

<YouTube ID="cafR1uVsPFM" />

This meeting is devoted to a recently discovered state-archival issue introduced with Protocol 23 (Whisk). Core developers explain what went wrong in the archival and restoration logic, how the issue was detected and contained, and why the network remained consistent despite the bug.

The discussion focuses on the scope of impact, the reasoning behind the proposed remediation strategy, and what builders and infrastructure operators should expect during the upcoming protocol upgrade. Community questions cover challenges of pruning old ledger state, solutions/tradeoffs, and handling reconciliation in [CAP-76](https://github.com/stellar/stellar-protocol/blob/master/core/cap-0076.md).

### Key Topics

- Overview of the state-archival bug
  - Introduced with Whisk (Protocol 23)
  - Affected a small number of archived ledger entries restored with non-latest values
  - Deterministic behavior across validators (no fork)
  - Total affected entries under 500; only a subset were restored and quarantined
- Containment actions
  - Emergency measures to halt further archival of affected entries
  - Manual extension of expiring entries to prevent additional corruption
  - Patched Stellar Core released to quarantine corrupted ledger entries
  - Transactions touching quarantined entries temporarily blocked
- Remediation approach
  - Focus on fixing archived (not-yet-restored) corrupted entries at the protocol level
  - Archived entries will be corrected so future restores return the proper value
  - Live entries that were already restored incorrectly are handled by affected protocols directly
  - Lumen supply discrepancy addressed by accounting adjustments (moving burn to fee pool)
- Transparency and verification
  - CSV published listing all impacted archived entries
  - Includes expected values, corrupted values, and ledger numbers
  - Core will verify and update only entries matching known corrupted states
- Operational guidance
  - Protocol 24 is a stability-only upgrade (no new features)
  - Validators, RPC, Horizon, and related infrastructure must upgrade
  - No SDK or XDR changes required for application developers
  - Testnet upgrade precedes mainnet vote
- Ecosystem coordination
  - Direct outreach to affected issuers and protocols
  - Protocol-specific mitigation strategies (e.g., supply adjustments, internal accounting fixes)
  - Emphasis on fast response, validator consensus, and Final Comment Period feedback

### Resources

- [CAP-0062: Soroban Live State Prioritization](https://github.com/stellar/stellar-protocol/blob/master/core/cap-0062.md)
- [Blog Post Announcement](https://stellar.org/blog/developers/addressing-state-archival-inconsistencies-protocol-upgrade-vote-next-week)
- [Community Discussion](https://x.com/i/spaces/1rmxPvRdmyjGN)

<details>
  <summary>Video Transcript</summary>

[00:00] We're going to talk about a protocol upgrade, that we're pushing for next week, that is around fixing a bug, that was discovered last week. So last month we pushed out whisk, which is Protocol 23 protocol was upgraded by a vote from tier one validators. And on Thursday last week, a week ago, we discovered a bug in the protocol. We've we worked the following two days on containing the bug. Which affected state archival. So basically some small number of ledger entries, that were archived with the wrong version. So the not most recent version and. When they were restored the

[01:00] restoration allowed for the non-most recent version to be restored. The total number, that was actually affected is less than 500 ledger entries. 478 to be exact. Out of these only 84 were restored. So these are ledger entries, that were actually restored to the Navos recent value. Last week, Thursday, Friday, we worked with tier one validators to contain this issue, which means, that we've set out an emergency SLP to avoid archiving more u more ledger entries. We also manually bumped all entries on the network, that were about to expire so, that they don't. We. Then issued a released a new version of Stellar Core, that was patched in order to ensure, that the affected

[02:00] ledger entries cannot be touched so, that any state inconsistencies remain quarantined. Quarantined. That happened last week on Friday and from, that moment on we've been working for the past week since Friday night on communicating with validators and with affected protocols to understand what the extent of their issue was. We've also suggested a few protocol upgrade options in order to rectify this. And the protocol option, that is overwhelmingly the most popular is the less intrusive one, which is to obviously fix the bug to fix the archive. So all the ledger entries

[03:00] that were archived and not restored will be fixed in the archive and so. When they're restored they will be restored to the correct value. But with regards to the ledger entries, that are live and have been restored incorrectly we will not be addressing them on the protocol level. But we have ensured with all affected issuers and protocols, that we've been communicating with. We're talking about around 20 protocols. That they do have ways to rectify this on their end. So for some issuers, it just means, that they need to adjust the supply to make sure, that it's it reflects what's on chain. A lot of the state changes have actually been benign and not had any meaningful impact. and some protocols have had ways to, kind of like upgrade out of these issues. And so I am going to stop talking

[04:00] for a bit right. Now and, happy to, take any questions. Justin, did you guys hear all this?, yes. It sounded great. And right. Now I'm just going to paste the blog post, that we just released, that explains this a little bit in the chat over here. So. If you want to sort of read a version of what Tor said, it's there. We also you'll see, that there's a link to a CAP there. The CAP is the suggested change, that Tor was talking about and I think Nico is here and will join us on stage in a minute to talk through the CAP. But first there is a question from Jome. This was completely random. So some entries were correctly archived and restored. Restored. It's not random in the sense, that this was not arbitrary. It was deterministic in the sense, that all protocols all validators actually behaved exactly the same. So the network did not fork based on this

[05:00] behavior. It was consistent. But it required a very kind of like specific arbitrary chain of events, that relate to how whisk handles live state prioritization between the bucket list, which includes all the live states and the evicted state. So not random. But definitely also not trivial to identify. Does, that answer your question? Okay, it looks like there are I mean I see someone saying I am late. How bad is this? As Tor pointed out and you can read, that blog post, that's posted above, this bug was discovered by Elliot friend who's here on this

[06:00] call. Who's who is a Senior Developer Advocate at the Stellar Development Foundation and he discovered it. While he was you know doing some work to get ready for a hackathon, that's coming up and you know short it did not take long at all and you can see the timeline there for there to be for the issue to be very quickly quarantined and the fix will be rolled out pretty soon. So. While it's a bug, that, you know, is very it's a serious bug. The impact is something, that we've like evaluated, talk to everyone who's been impacted about and, you know, it's definitely contained at this point. So I'll let you read the post and decide how bad it is. But my answer is I think, that the response has kept it pretty contained and has cut it off very quickly. But the other. So at this point we have I'm going to post here this is cap

[07:00] yeah and as Dimma points out above I mean you can read what he wrote in response to your question too. So, I know there's a lot of discussion going on. But at this point, I also think it's important to take this opportunity to look at the proposed solution, which is what I just pasted there. It's a Core Advancement Proposal 76. And we have some people from the core team to walk through this. Nico, do you want to do it or is it better. If Dimma does it? I can Yeah. Take a first stab at it. It. Guess hear me? Okay, perfect. All right. So yeah. So like at a high level what the CAP is describing is first what is actually in scope for the to kind of mitigate this problem. So like Toma was explaining earlier there's actually two

[08:00] types of entries, that u, that were corrupted. They both started in the same way where they basically entries got moved from the live ledger state into the archive and during, that process entries got corrupted. And then after, that some of those got restored and at, that point they were restored for all sorts of purpose. It could be for just reading them like a you know a lot of entries on in Soroban are just accessed for reads like a WAM for example is an example of, that. Others were also accessed for modification. And yeah. But what the CAP is putting in scope is the only the first category of entry. So

[09:00] basically the ones, that were moved into the archived and kind of stayed there. And and the solution as part of this is to basically go and take the value, that was supposed to be in the archive. And then override the archive with, that expected value. So the fix itself sounds fairly simple. U. Because it is the u the bit of a challenging part here is how can you all of you guys can trust us, that this is the right list and there's actually quite a bit of work, that went into this in the CAP. So the there's a full list of basically of in a CSV file, that you will find where you will see for each of those entries, that end up in the archive we have the ledger number

[10:00] where. When the entry got moved into the archive corrupted like I said. So in, that case we actually have in this CSV the value of the entry as it was at the moment it was about to get moved. And. Then we also have in the same row like the value, that of the corrupted u entry and. And then what happens. When we are going to u follow the this CAP right is the core is going to scan those entries one by one and see the ones, that match the corrupted state in the archive and then. If the. If it's there it should be. Because we also froze restoration at this point. Then the value will get

[11:00] replaced by what it should have been. So, that's kind of like the first part I guess of this fix. There's another one, that's this one is actually related to this second set of entries, that actually got restored. That's for the total lumen supply. They were about I think it's like three lumen around, that like of accounting discrepancy. So in the proposal what we are saying is, that well some lumen got burned in during this event we're going to just kind of for accounting purpose move, that burn as a into the fee pool. So, that's kind of what the mitigation is for, that. So in terms of like the like I said like the. So this is

[12:00] the CSV file what the what core is going to do as part of like in terms of like actual steps right to restore the entries in the archive to the right value in terms of like verification. So there like a few things, that can be done. There's first there's the list itself. This one was computed by instrumenting core and replay all those events, that are around eviction. Eviction. The version of core, that will go out with the protocol change will have this instrumentation and better than, that actually it will also have a way to basically use, that CSV file and check, that the modification those changes are the only changes, that happened in the in, that time period. So it's kind of a

[13:00] double you know double use in a way where the CSV file you can use it first to see what is the full list of impacted entries to also see, which ones will be restored and you can also use, that as a way to understand, that what will happen with Protocol 24 and also, which one, which of those entries will not be impacted by this protocol. Upgrade in, which case they will stay corrupted as they are today on the. So those are like the entries, that are in yeah, that got restored. So those are like live entries. So maybe I should stop here for a bit see. If there are like specific questions I just want to add one thing. Because I got some questions on this earlier today the patched version of core, that is currently in production by tier one

[14:00] validators bans every transaction, that tries to touch any of the state, that's been corrupted. That's those 87 ledger entries. So. If for some reason anyone on this call or anyone you're talking to is unable to get a transaction in and is getting a timeout. Because of just getting timeout. Then this might be. Because you're trying to touch, that state. And part of Protocol 24 is removing, that ban. So, that ban is supposed to be removed as soon as the protocol is in effect. Which is right. Now scheduled for Wednesday next week 5:00 p.m. EDC. And again, that's a small number of ledger entries, right? Yeah. Just for just for context,

[15:00] you know, ledger Stellar is a database. You can you know think of these ledger entries as row rows in the database. And Stellar has around 47 million rows in this database. Out of, which 80 87 have these issues. There's a question will Protocol 24 contain new ZK features? No. The the features, that were planned for Protocol 24 will. Now be pushed to the next protocol. Protocol 24 is just a stability upgrade. Mootz has a question to clarify this CAP focuses on managing the existing corrupted entries. Was there a cap/update, that could be shared, that

[16:00] addresses the root cause of generating corrupted entries? Yes. Definitely this Protocol 24 will fix the debug. Yeah, actually I thought we included the fix itself in the CAP. So. If we didn't, I'm sorry about, that. But yeah, it should be there. There. Yeah, Yeah, like we could add it to the CAP for posterity. Like we typically don't include bug fixes in the cup. Because it's like two lines fix and you do not do anything new from the protocol standpoint. Standpoint. Like you already have a CAP defined for this feature. The issue is not the protocol. But the issue is, that implementation was incorrect. But the CAP itself is [CAP-62](https://github.com/stellar/stellar-protocol/blob/master/core/cap-0062.md) I believe. So you know we got added to the CAP like

[17:00] that we also fixing the bug. But it's not, that historic historically done for the bug fixes. Sorry about, that. Does, that make sense to you? Of course, I asked as several people are typing. Just to confirm, will this require a network pause? No. I see there are some questions about the features, that were planned for Protocol 24, that will. Now be for Protocol 25. If you scroll up and you grab, that CAP, you can actually look at the different proposals for things, that relate to ZK features. And I think you can dig into those. But for now, I think we should

[18:00] kind of keep this focused on the current situation, the current upgrade. Because I think it's also important. I mean, Nico, you sort of talked through a lot of this. But can you just tell us what happens next? So in terms of you mean like implementation. So and all this. So like the team already has been very busy actually implementing this u this protocol change. Given the yeah the urgency of getting this voted as you know as soon as possible so, that we can you know like Toma was saying part of this is also allows the network to unblock those entries as well. So yeah it's a it's there are many reasons, that why we want this to

[19:00] happen as quickly as possible. The. So yeah in terms of next step what's going to happen is, that. So we are going to have builds of Stellar Core and the rest of the like platform type of software, that depends directly on Stellar Core released by, that's like Horizon RPC galaxy. Yeah. Yeah. Yeah. And. Then those will be released by Monday. And. Then what we expect to do is Tuesday will be the test net upgrade to this new protocol. And then we'll get the vote to with the validators to be scheduled on Wednesday and hopefully given, that we did a lot of work already with those validators the vote will actually be approved and meaning, that we'll be back in business in general

[20:00] at, that time. And so just in general to prepare. If people run infrastructure, that basically has Stellar Core embedded in it. So either Stellar Core for a validator or those things, that are on the platform side, that Nico mentioned RPC Horizon galaxy you'll need to upgrade right before the test net. If you want to your infrastructure to work on test net and before the mainnet floats. That means you have to like pick up the fixes, the new releases on Monday. But unlike other protocol upgrades, this doesn't require everyone to install new SDKs. Correct. Correct. That's correct. Yeah. It's only there's no impact to the XDR in particular. And. Because of, that, that means, that applications in general don't actually need to do anything. It's basically like about picking up the It's already about picking up the right version of core at

[21:00] this point. The reason we have to upgrade systems like RPC and Horizon is. Because there's actually a check in the those systems, that check, that the protocol version, that core is, that the network is running on. So in this case it will you know after the vote it will switch to 24. 24. So like the systems are actually built with a safety in place, that they will only ingest data from a protocol, that they understand. And. So basically this is this constant and, that's the only, change really in those downstream systems. Systems. I'd like to answer Adam's question. So Adam asked. If a reserve asset is added to the pool they are tokens created inside the contract it won't require a deposit of the actual assets to reconcile. So we did have a few of these ledger entries ended up being

[22:00] ledger entries, that relate to liquidity pools. And the remediation u is a bit different between different pools and different assets. So for some assets, that changed imbalance. If they have a centralized issuer it was fairly simple to basically add the backing asset and offchain so, that they can reconcile the issue. In some other situations it was almost trivial to burn. If if there was a eronous credit for some pools some liquidity pools are sorry are implemented in different ways. So for example the Aquarius pool is implemented in a way in, which actually adding an asset doesn't change the price or anything. Because

[23:00] Aquarius has like internal tracking of the reserves. And so manually adding a reserve doesn't actually impact price and, that added balance is unusable. It's not like, that for source swap. And so it's really different assets and different protocols like found different ways to fix it. But again we've talked to pretty much every affected protocol and issuer and ensured, that all of them have ways to fix the situation in the context of these 77 ledger entries. Sorry, I said the wrong number before. It's 77, not 87. And I can't stress enough how helpful every protocol and asset

[24:00] issuer have been. I think we started reaching out Friday night and Saturday morning and we've and everyone has been extremely understanding and collaborative and it's awesome to see the ecosystem come together like this. I see there's still some people typing in the chat. If the questions wind down is I think a lot of it's just sort of comments. I'd say. If you have a question, get it in now. It's telling me OrbitLens has a question. But Orbit asked, "Do we need to update the RPCs as well?" and George from the platform team said yes.

[25:00] Yes. Yeah. Is there a technical reason this must be a protocol version upgrade instead of a patch release? Well, yes. like it's a it's an update to the ledger and. Because of, that it has to happen basically on all machines at once. It was going to be like a patch release. yeah, we would only be able to kind of the change would happen basically on like whatever machine is running right on, that with, that patch version.

[26:00] Is this recorded for playback, Carsten? Yes, correct. Yeah, I would say in general. If you know you have further questions or it's a good idea to read, that blog. It just came out I think an hour ago, maybe even less. And also to read the CAP. and in general, I think. If you're interested in these kinds of issues, make sure, that you pay attention here or sign up for the Stellar Dev mailing list. Make sure, that you pay attention to the CAPs. we do try to be as transparent about any of these changes as possible. And obviously we you know through all of this we not only couldn't make a decision without all the feedback from the ecosystem about what to implement. But implementation is just one step in governance and the actual adoption of a protocol change on the network requires validators to vote it

[27:00] in. So in all of this we always are trying to talk to people including you know this call. But also online and various other platforms and we're trying to like put the work out there in a place where you can examine it and understand it and we certainly encourage you to do, that. In fact, with the CAP, there's a whole process for Core Advancement Proposal and as part of it, we put them into Final Comment Period. And. Because of the urgency here, we just fast forwarded this to Final Comment Period. And. So it's going to stay in Final Comment Period, which means, that you can write about it on the Stellar Dev mailing list until the time, that the validator vote happens, which should be on Wednesday. So, this CAP is officially in Final Comment Period. You know, we definitely urge you to take a look. If you have anything to say to add it.

[28:00] Orbit is pointing out the short timeline. Yeah, it is a short timeline. I agree. yeah, like the reason we are still kind we think this is best for the ecosystem is, that we are actually giving at this point like yeah like a you know almost a week notice, that this is coming. So the people should be able to prepare ahead of you know and allocate those two days for upgrading their infrastructure. Infrastructure. I think given the severity of having those entries blocked I think this is the probably the right trade-off.

[29:00] Nico, can you what will the experience be like for somebody, that needs to upgrade their RPC? RPC? Will it be difficult? So like Yeah. No to upgrade this is basically just like doing a regular kind of a software package update. U there's really no other steps to take. And for people, that don't I think you mentioned, that earlier the this, that core instance will get stuck until u until the package gets updated. It's not going to do like some strange things. It's just going to

[30:00] Anyone else have a question or anything to add? I think there were question I saw a question, that I don't think we can really answer to, that directly like on potential impact of like for specific protocols. I think yeah th those need to be answered by those protocols themselves. Like the assessment, you know, that we got from basically everyone at this point is, that people are going to be able to mitigate for the most part

[31:00] the impact of this corruption. I think Elliot, that the answer to Your question is what Nico just gave.

[32:00] Well, I'll give it a few more minutes for some of these comments or questions to come in. Anyone know where the bug came from slash how it got in? I mean like bugs or bugs. Yeah, it's kind of a they're always sad. What I can say is, that yeah we had multiple rounds of code review. We had

[34:00] Well, feel a little bit more typing. It seems to be witicisms more than questions. Thank you for being. So responsive to fix the issue. That's, that's really nice. Yes. Again, I also want to say echo what Tor said before. This has been like a really cool moment where a lot of engineers at SDF. But also a lot of people in the ecosystem have really stood up and provided information, given opinions, given feedback, reviewed data, done their own analysis. And. So this is like, you know, for what it's worth, it really does show, that there is just an ability to be super responsive in general across the ecosystem.

[35:00] Yeah. If you're not following over there in the CAP, there's actually a list CSV file, that has all the different columns, that got restored. So, you can actually look at all the restored entries. yeah. Or you can do some stuff with the RPC. Look at, that. We're learning here and

[36:00] sharpening our honing our chops. Yeah, that's correct. Right now, all you will get is a timeout from. If you try to interact with one of those entries. I see somebody said and may maybe this was a joke. I can't tell. It says or not, I guess there's no way to tell. So, this isn't going to cause Stellar to fork. Fork. No, this Well, I, that's a tricky construction. Because there's a negative in there. this will not cause Stellar to fork. That's my statement.

[37:00] I'm trying to even think through how it possibly would. I don't I can't even picture how it might Yeah, again the important I mean the place where we are right. Now like the issue was identified the functionality was turned off impacted ledger entries were temporarily quarantined fix will basically allow them to be uncaranted. And and allow the any of the ledger entries, that are currently archived. When they get restored they'll be restored correctly I believe is where we're at. But again all of, that is an implementation based on feedback from the ecosystem it actually requires validator ascent through a programmatic vote on

[38:00] the network to go live and take effect. It looks like Adam was experiencing a timeout message to save you from yourself. Okay, cool. I feel like we're winding down. and again, some takeaways, read the blog, read the CAP CAPs and Final Comment Period, join the Stellar dev mailing list. If you want to leave a comment. Look at, that thread, that persists about the issue. If you have questions or an experience, that you want to share, we will try to keep you updated as new things happen. Again we have sort of it seems like there is social consensus on a path forward for a fix, which is what is captured in, that CAP. As

[39:00] the Stellar Core team implements a solution and it becomes available we will let you know and shortly thereafter we will try to upgrade the network. To orbit's point it's a very short time frame for, that to happen. So, we're starting to talk to people. Now to let them know. But once this all the software is released, the actual upgrade process from a from an operational point of view should be pretty straightforward. So yeah, I really appreciate you all for joining this and maybe under different circumstances we can just hang and chat again sometime. This was nice. Thank you all.

</details>
