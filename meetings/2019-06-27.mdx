---
title: "Two-Part Payments and Preconditions"
description: "This overview highlights transaction data."
authors: johnny-goodnow
tags:
  - legacy
  - CAP-15
  - CAP-21
  - CAP-22
  - CAP-23
---

## [Public Discussion](https://groups.google.com/g/stellar-dev/c/va9Y7lkP4uI/m/K2W_AkvzCQAJ)

### Announcements

- [CAP-0015](https://github.com/stellar/stellar-protocol/blob/master/core/cap-0015.md) and [CAP-0021](https://github.com/stellar/stellar-protocol/blob/master/core/cap-0021.md) move to _Accepted_ today (after this meeting), barring no new concerns.
- [CAP-0021](https://github.com/stellar/stellar-protocol/blob/master/core/cap-0021.md) moves back to _Draft_ in order to resolve [CAP-0022](https://github.com/stellar/stellar-protocol/blob/master/core/cap-0022.md) prior to acceptance.

### Agenda

- [CAP-0023](https://github.com/stellar/stellar-protocol/blob/master/core/cap-0023.md) - _Two-Part Payments with BalanceEntry_
  - Focused on temporal separation between initiating a payment and receiving a payment.
  - Explicitly **does not** replace existing payment operations.
  - **David's initial framing:** ~10% additional complexity yields significantly more utility.

#### CAP-0023 Design Discussion

- **AuthorizeBalance**
  - Should include an optional `AccountID *revocableBy`.
  - Small increase in complexity but worth it for added control.
- **Threshold semantics**
  - `CreateBalance` should use the _medium_ threshold.
  - Authorization should mirror AllowTrust.
  - Claiming at a _low_ threshold may be acceptable, since low-threshold keys cannot otherwise act.
- **Operation naming**
  - Consider appending `Op` to operation names (XDR style / consistency).
- **NATIVE asset semantics**
  - AuthorizeBalance behavior for `NATIVE` assets is unspecified (invalid vs no-op).
  - Might be better to factor shared data structures out of both AuthorizeBalance and AllowTrustOp.
  - AuthorizeBalance operates by ID and is unaware of the asset of the BalanceEntry; this structure may still be useful for AllowTrust.
- **Why AuthorizeBalance exists**
  - Needed to authorize _both_ the account and the payment itself.
  - Necessary for deauthorization when assets are sent to bad actors.
  - Important for payment channels to ensure all parties are authorized before payout.
- **ACCOUNT_MERGE interaction**
  - BalanceEntries resemble hyper-specialized deterministic accounts.
  - They do **not** participate in merges and may be abandoned (with their own reserve).
  - This behavior should be explicitly documented in the CAP.
- **Global revoke scenarios**
  - In cases where assets must be returned for replacement, funds locked in BalanceEntries pose challenges.
  - AuthorizeBalance enables trustline authorization prior to account creation.
  - Even if authorization is revoked, reclaiming balances should still be possible.
- **Extensibility**
  - Consider extending `claimBy` using a union to allow future claim-by-signer functionality.
- **UX considerations**
  - Some concern that less-knowledgeable users may struggle with the flow.
  - Others believe wallet UX and the existing payment operation mitigate this risk.

### CAP-0021 / CAP-0022 & Payment Channel Implementation

- [CAP-0021](https://github.com/stellar/stellar-protocol/blob/master/core/cap-0021.md) - _Generalized transaction preconditions_
  - Moved out of Final Comment Period back to Draft due to concerns raised by CAP-0022.
  - May be implemented separately (branch or protocol version) for payment channels.
  - Preference is to resolve outstanding issues before acceptance.
- [CAP-0022](https://github.com/stellar/stellar-protocol/blob/master/core/cap-0022.md) - _Invalid transactions must have no effects_
  - Open question: adopt CAP-0022 as written, or pursue a stronger invariant (only fully executing transactions succeed).

### Follow-Up Actions

- [CAP-0023](https://github.com/stellar/stellar-protocol/blob/master/core/cap-0023.md) (Jon)
  - Add explicit behavior details regarding `ACCOUNT_MERGE`.
  - Evaluate low-threshold usage for `ClaimBalance`.
  - Append `Op` to operation names in XDR.
  - Extend BalanceEntry claimer via a union to support future signer-based claims or wildcard claimBy.
