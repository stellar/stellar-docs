---
title: "Payment Channel Readiness for CAP-0021"
description: "Discussion of the final implementation details and readiness of CAP-0021 (generalized transaction preconditions), including updated rules for handling incompatible transactions, expected Core/Horizon work, and how this unlocks payment-channel patterns, account recovery flows, and high-throughput apps."
authors:
  - david-mazieres
  - jonathan-jove
  - justin-rice
  - leigh-mcculloch
  - nicolas-barry
  - siddharth-suresh
  - tomer-weller
tags:
  - legacy
  - CAP-21
  - CAP-40
  - SEP-8
---

import YouTube from "@site/src/components/YouTube";

<YouTube ID="g41iei45yA4" />

This call served as the final readiness check for CAP-0021, focusing on whether any remaining technical questions would block sending it to the CAP committee. The group walked through the last set of spec tweaks, clarified how nodes should handle incompatible transactions, and compared those tradeoffs with existing “first-seen” behavior already present in other edge cases.

The discussion then shifted to practical rollout considerations: what changes are needed in Stellar Core and Horizon, what testing and overlay work might be the riskiest, and how much effort SDK updates are likely to require. The group also covered why it’s valuable to land these capabilities before they’re urgently needed, since payment-channel primitives can enable high-volume apps as well as new account recovery patterns.

### Key Topics

- Final spec tweaks
  - Reverted time points/durations back to unsigned (signed was deemed a bad idea and not worth optimizing for database convenience)
  - Added clearer notes on how bump-sequence and related behavior can invalidate transactions within the same ledger
- Handling incompatible transactions
  - Updated approach: keep the first incompatible transaction seen and discard later ones that can’t coexist in the same ledger
  - Rationale: consensus and propagation already require dealing with divergent “seen order” cases (e.g., same sequence/fee arriving at different nodes)
- Implementation readiness and scope
  - Stellar Core work includes overlay-related changes plus solid test coverage
  - Horizon likely needs transaction-queue adjustments to accommodate min-sequence-number behavior
  - SDK updates were described as relatively straightforward compared with larger past envelope changes
- Payment-channel viability and patterns
  - Experiments indicate CAP-0021 enables safe, predictable payment channels, including flows involving issued assets and trustlines
  - Regulated-asset considerations (e.g., SEP-8 style constraints) appear compatible with the channel designs explored
  - Performance exploration continues (including “single-message channel” ideas), but isn’t viewed as a blocker for acceptance
- Prioritization and “insurance policy” framing
  - Landing the capability earlier reduces risk if a high-throughput use case arrives suddenly
  - Also enables otherwise difficult patterns (notably account recovery-style flows) without complex workarounds

### Resources

- [CAP-0021 (generalized transaction preconditions)](https://github.com/stellar/stellar-protocol/blob/master/core/cap-0021.md)
- [CAP-0040](https://github.com/stellar/stellar-protocol/blob/master/core/cap-0040.md)
- [SEP-8](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0008.md)

<details>
  <summary>Video Transcript</summary>

[00:00] Hi everyone, welcome to the Stellar Open Protocol Discussion. In these meetings, as always, we discuss Core Advancement Proposal, CAPs, which are technical specs that suggest changes to the Stellar protocol and they're necessary to allow that protocol to continue to evolve to meet ecosystem needs. We live stream the meetings so that you can follow along. I do want to note it's a technical discussion so if you're watching, please take a look at the CAP link to in the show description: CAP 21. We do keep an eye on the discussion box and your comments there inform future decisions, but our goal today is to talk through some final questions about CAP 21, so we'll only really address questions here if they're directly related to that goal. Once again, this meeting is part of a

[01:00] CAPs life cycle. They are started on the Stellar dev mailing list and there's a link to that mailing list for anyone who wants to participate in future discussions. They're drafted and iterated on before they're drafted or before they end up in this discussion, in this meeting, and based on what happens in this meeting, they may get put up for a vote before the CAP committee who decides whether or not to accept or reject a CAP. After a vote, the CAP enters a week Final Comment Period so everyone has a last chance to raise questions on that same mailing list. If a CAP makes it through Final Comment Period, it's implemented in a major release of Stellar Core which is then put forward for network validators to vote on. Ultimately, at the end of the process, it is the network that decides on whether to accept major protocol changes. On that note, there is currently a validator vote to upgrade the network to Protocol 18, scheduled for November 3rd- that's next week- and so that upgrade would introduce automated market maker functionality to Stellar. So it's very exciting. It also introduces some breaking changes.

[02:00] So if you build on Stellar, please make sure to install up-to-date versions of any Stellar SDKs. You use any Stellar SDKs along with Stellar Core and Horizon if you run a node. But today we're discussing a different CAP destined potentially for a different protocol: CAP 21. CAP 21 lays the groundwork for building payment channels on Stellar. Payment channels allow multiple parties to transact off-chain and periodically settle on chain and, among other things, what they do is they make it a lot easier to build high volume use cases on Stellar. So CAP 21: it makes technical changes geared towards enabling payment channels are great for scaling network throughput. That's kind of my overview where we are with CAP 21. We've discussed it a few times, revisions were David made revisions recently based on the last discussion that we have, and so I think where we're at now is like: are there any questions, lingering issues, anything that we can go over with CAP 21,

[03:00] Especially anything that's preventing it from being put forward to the CAP committee for approval. So anyone got anything. I'm happy to summarize the changes: awesome, perfect, pretty minor. So you know there was this thing where, like we said that time points should be signed because, like databases were like have is more convenient, some databases have signed 64 bit numbers but like then we decided actually that was a bad idea. So it's mostly like kind of orthogonal to this proposal. It's just like since I we're making use of time points and durations and stuff, so that's reverted to unsigned. Well, go over the small changes. Then people wanted a note about, like the bump sequence, how, like that can like invalidate a transaction in the same block. The main change is that basically, when you have, when you see, two

[04:00] Transactions that are incompatible, they can't both be in the same block because, like, let's say, one has sequence number 12 and a min seq ledger gap of two and the other has, like, sequence number 11. You know, previously I can't remember what I said you took the one with like the highest or lowest sequence number, something. Now you just take the first one that you saw. And the reason I didn't do that in the first place, because I was worried about: well, now you're going to see a block and you're going to end up having to like fetch transactions that you don't have. It turns out you'll have to do that. You have to do that anyway because this kind of stuff can come out in other contexts, like if you have two transactions that have the same sequence number and the same fee. Then you know like, and they're flooded at the same time to different nodes. Well, yeah, like half the nodes might see one and half might see another, and so we're just doing the same thing. We just you keep whichever you saw first and you

[05:00] Discard anything you receive later that can't exist in the same block as the first one you received. Is what we David. Is that what we discussed before? Because I thought that was actually taking the lowest. I mean because I thought this was a potential way to artificially like delay forever, like that's right, you don't think the lowest pre-signed contractions right, like a typical of the house: first one is right, but like a bad. You know, a bad actor can always submit the lower one, right. So maybe it's a no, it doesn't matter, you just take the first one. You see, so if something's been flooded and the bad actor floods something incompatible, it just the validators won't accept that or they won't forward it, they would just well. It's more like you have to be first to submit your transaction, right, which

[06:00] Is kind of annoying from a security standpoint. First, like, if I have, like I think we discussed that I'm not exactly sure if it was relevant to the, to the protocol that is described in the cup. Yeah, because you have, like all some protocols, you have, like you know, many sequence numbers and the reason you have this gap is it allows you to kind of jump forward. So I can basically like delay that transaction in an arbitrary fashion, if I can have, if I have access to those pre-signed transactions. I don't remember actually I would need to go back to the protocol that is described in the cup. I think maybe it doesn't matter in this situation. Can people remember? I remember the problem with the.

[07:00] I remember the problem with the old one was that, yeah, you could keep submitting something that would, like you know, bump the age or whatever so, and so now it's, it doesn't matter, it's just like whichever one you, there's nothing, I mean, I guess there's potentially like a continued race, but there's nothing that like inherently guarantees that the attacker can win the race. The disclosure, yeah, like I'm looking at the protocol that described in the CAP, so, like the disclosure transaction, is it using the mean sec,

[08:00] Like those ranges all now? Yeah, so basically you can. And then the second one uses mince. So it's only the mean think age that would be affected, and we don't, I think we don't care in this context because, dude, it depends directly from the. Yeah, the disclosure is not impacted by this flood. First type of thing, right, because it doesn't have that mean age condition, okay, so then it's, I think yeah, like now I remember, like it's for this particular protocol. It's it, it's fine to take the, you know an arbitrary one, yeah, so I mean it doesn't really come up in this protocol because all of the disclosure transactions are compatible, like they could all. Yeah, exactly yeah, but you could all run them all in the same block, yeah,

[09:00] So does that mean that the way that things are written right now in CAP 21, the question this- take the first one, you see approach- seems to work for people? Cool, great, yeah, it's also simpler to implement. Yeah, I think we actually discussed some of that last time, which was: but it's not perfect in a way that, like, already, other situations aren't perfect, like two transactions with the same sequence, number and fee. So it doesn't make things worse. When you say the first that, you see, that means that is submitted first in real time. Yes, but of course the. I mean of course, before consensus, different validators will see things in different order, right, I think I don't propagate through the network, so, but I think we, you know we already,

[10:00] But I think we, you know we already accept the fact that you may need to kind of refetch the block, you know, while it's being nominated. So, David, are there other changes that we should walk through? That's it. Wow, John, I didn't have any issues when I mean there's some typos and stuff, but I don't know if they're, you know, worth going through. Lee, I remember that you were doing some like experiments on the kind of performance you can get out of this. I remember you were considering different kinds of cases and different like structures of payment channels that you could do like synchronous and asynchronous and all these other kinds of things. Do you want to give us like some context on what the kind of outcome of all of that was, what the limitations are of this proposal in the, in the land, of what you kind of were experimenting on? I don't know, because I like the.

[11:00] I don't know because I like the. It's very clear to me that this produces payment channels and they work, but it's not like, having not done any of the experiments myself, it's not clear to me what's the limitation, like, what's the best payment channel you can build here in terms of all these other things? Yeah, in terms of: yeah, so I think there's a couple of things here. So we've been doing experiments to validate: does this produce a payment channel that's safe? Does a producer- can you build a payment channel with this that's predictable, that interacts with things like issued assets? And, yeah, like, what sort of performance can you get out of it? I think the performance thing is something that we're still experimenting with. So, and it's still something that we're figuring that out, and in terms of everything else, what we've seen, you know, we have discovered-

[12:00] Is this better? Okay, yes, so what we're seeing is that it works really well with issued assets, and we've written up a more, a thorough sort of description about how you would implement this so that it's safe, you know, with trust lines and can be predictable with trust lines, and we have ideas as well for how this would work with regulated assets, things like the assets that use ecosystem standards like SEP 8 and it looks like it fits those, fit those use cases well as well. So I think the experimentation we've done to validate, does CAP 21 enable payment channels sufficiently? Then I think the answer is yes, it does, in terms of, like you know what problems we haven't solved yet. Like you

[13:00] Mentioned, you know asynchronous payment channels and we've kept 40 that we've discussed previously, that we want to, is sort of being batched together with CAP 21. We can do, you know, single message, payment channels, which is really, I think interesting. So I can send you a message and that's all that we have to do for you to receive everything you need to execute that payment. That doesn't actually have to be any further communication. But I think what we haven't figured out, everything you know for how to implement that type of thing. So I think there is still more experimentation to be done to figure out other like with those experiments, do we, does it make sense to wait to accept a CAP like this into pending the results of those experiments, because they might affect the CAP itself or are or not?

[14:00] Is that question directed at me, or I think so. Basically, it sounds like there are more experiments that you want to do to sort of verify or find out certain things about the way that these payment channels that are enabled by CAP 21 and CAP 40 would perform correct. So I mean I think we can experiment. We could experiment with this forever, yeah, and there's always aspects of this that we can improve. I think what we've proven so far, and what we've coupled with CAP 40 into CAP 21, is at a point where, like, I don't think we need to do more experimentation with it to try actually using it in some in use cases. So, yeah, I don't think this needs to be blocked on more experimentation. Great,

[15:00] Yeah, like, I think, like with the, at this point we're probably not going to be blocked on the actual CAP itself, like in terms of from a technical standpoint, I think it makes it's more of a available, of more like prioritization. And is that like, do we want to accept this now? Because we, typically, what we want to do is that we don't want to accept the CAP, that is going to linger for a year or whatever. So it's like, I think what I would like to see is either like- and that's a, you know, appealing to the ecosystem, like people you know coming forward, you know if they are really interested in this, or we're going to have to find somebody, identify ourselves, somebody in the ecosystem.

[16:00] So that would be my and that's. I think it's going to be kind of the next step for this one. I mean I think in terms of timing, like you, it's. You know, you need to kind of accept the CAP sometimes in order to attract the users, right, and if you look at, you know like obviously we've had things like multiplex accounts, where you know it's been a long road, but it seems like there's like valid use cases and so people are gonna be quite happy to have it in the long run. I think it's definitely the same thing in this because it like fundamentally adds new capabilities that people haven't thinking of, things like you know, in addition to payment channels, right, this also allows like new forms of account recovery and things like that. And but the thing that's the thing about this CAP is that it could be that we need it in like a big hurry, right, like it could be that you know it turns out some new use case comes along that is like super popular and requires like fairly high

[17:00] Transactional throughput, and so once something is in core, then it's like you know, people can update the applications to work on it much faster. But the cycle is such that you know if some amazing use case came along and then had kind of explosive growth that required payment channels, it would that project would basically die if it had to wait for it to like go through the Stellar Core release process. So I think we should get a version of this deployed into core where- and you know if we have to revise it. You know it's a union, right, we can have a subsequent version of this, but it's better to have something out there current. The things that you have to do to compensate for not having this range from. It's impossible. Like the account recovery stuff is like basically like almost impossible to like. You need like a huge number of like just extra accounts to each have their own

[18:00] Sequence number and stuff, and it's just like. So I have a question, Nico, which is: how do you estimate the cost of implementing this? Because obviously there's tension here between you know you want to see that there's ecosystem use cases, but, like David says, if you know, if like a monster use case shows up and the network is not ready in time, like is this, is there an opportunity cost here? I mean like, yeah, I mean it's like everything else, like I think we have to go like, I think most likely, from what it looks like the changes that are going to be the more complicated things in as part of that CAP, are probably going to be around the overlay type of changes. That's what it looks like to me. The latest change should make it simpler, right, because, well, you still have to do it in a safe and efficient way, and blah, I mean that's what it looks like,

[19:00] Especially because we have the prototype that we put together for the actual implementation to. This is one part, I think the. other part was around. I think the question mark on testing, like the test infrastructure that we have, which is kind of broken in the in this context, I'm not sure exactly how much work this is going to be. I mean like to answer the last question. I mean it's not the cheapest cup. You know we've done it's. I would probably put it as like a- you know medium in terms of like, complexity, you know whatever that means, you know. So, like if we were starting to, let's say, work on this like in q1 next year, it would probably be done in q1. I don't know the implications on like.

[20:00] I don't know the implications on like the SDKs and so on, though like, but it looks like they are basically not. Like there is not a whole lot going on there. It's very similar to the change we did for when we like the. I think like the- when we changed the envelope before without the actual. It's a little easier, yeah, it's like a little easier because there's no max account, which was the big no mess. It's still like. Yeah, like all the SDKs have to upgrade that situation. Yeah, I can talk about the SDKs a little bit, because I prototyped making them change the core Horizon and then the SDKs, and I obviously took shortcuts around testing. But the SDK part was very straightforward actually. So I think there'll be very little. It'll be a lot easier than when we introduce the envelope, a lot easier

[21:00] Than when we introduced must accounts and I think even the core changes were relatively straightforward in terms of when you just focus on the functionality. But then it definitely got a bit fuzzy when trying to figure out how to test this in the existing test tests, and I'm not that's familiar with the style called codebase. So it was definitely challenging. So I think that's probably right too. And then I think in Horizon has this transaction queue where you submit transactions, they go into a transaction queue, they get ordered by sequence number and then gets submitted when that sequence number is ready to be processed. So it allows people in the ecosystem who are using Horizon just submit transactions in any order and Horizon just sort of smooths that experience over for them. And I think there is some- you know, a little

[22:00] Bit of work to do there to make that work with min sequence numbers. But other than that, the rest of the Horizon changes were pretty straightforward as well. Something that I want to mention too is: see, Nico was like appealing to the ecosystem, like we want to find out what use cases people have for this. You know we've got Meridian coming up in soon and we are going to be talking about CAP 21, CAP 40, payment channels, how it actually works there, and we will talk about, you know, the performance. We should have the performance experiments done by them as well. So if that's something that's probably like worth watching.

[23:00] So it seems like where that leads us is technically, this CAP feels sound. There are further experiments that are happening to test performance issues. There's a question of whether or not we should prioritize implementation of it. That we can try to figure out offline, and we would love to hear from people in the ecosystem about any use cases, because that would definitely help identify this as a priority, although it's not necessary that we hear that, but we'd love to hear from anyone who might want to use this and, finally, there will be more info on this at Meridian, which is a good time to learn more out there and also possibly come to us with some idea of how you might use this. Does that all sound correct? Yeah, but you know it's also like this isn't also an insurance policy, right? You don't go around like asking people like you know what are your use cases for insurance or whatever, right?

[24:00] Like so, yeah, no, I understand, I don't know. I don't think it's necessary, right? I don't think that it has to be the sole criteria to make us decide how to prioritize this. But if someone is like I know what I need this for and they told us that would be helpful, right, yeah, but I don't think it's that's a good reason to delay accepting it today. Yeah, I mean, just like, procedurally, you're gonna get more data. You're always gonna get more information by delaying until it's too late. I mean, I think procedurally, we- there's one person, Jed- couldn't make it today, and so I think that actual acceptance would have to happen asynchronously, offline, and so for me, I think the takeaway is that we should put it in front of the

[25:00] CAP committee and see what you guys think about accepting. That's kind of where I'm at. I don't know any objections to that plan and CAP 40 as well. Because yeah, and so I guess only objection to CAP 40 was the CAP 21 hadn't been accepted yet. So that's correct. We should. People should go on record now as having any suggestions for CAP 40, or we should move forward with that one as well. No, it should move with at the same time, okay, cool. Well then, I think the next, the follow up action, is to basically put both of those and say, hey, CAP committee, take a look and see if they get approved, which we can do asynchronously. Is there anything else? Are we done for the day?

[26:00] I take that silences awesome. Well, once again, thanks everybody for joining, thanks so much for everyone watching and again, please make sure that you prepare for the Protocol 18 upgrade. The vote is on Tuesday, November or Wednesday, November 3rd, so install up-to-date software before then and, yeah, if you have anything exciting to say about payment channels. Make sure to join the discussion or check in with us, because we would love to know about use cases that this would enable, and we will see you next time and at Meridian. Thanks everybody.

</details>
