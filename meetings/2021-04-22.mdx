---
title: "Open Protocol Discussion"
authors:
  - david-mazieres
  - eric-saunders
  - karen-chang
  - leigh-mcculloch
  - nicolas-barry
  - jed-mccaleb
  - jonathan-jove
  - orbitlens
  - siddharth-suresh
  - tomer-weller
  - justin-rice
tags: [legacy]
---

import YouTube from "@site/src/components/YouTube";

<YouTube ID="EKUbj811XsU" />

- hello and welcome to the stellar open protocol discussion um so for those of you watching at home i just want to give a quick overview the goal of these meetings is to talk about and plan for changes to upcoming versions of the stellar protocol we go over core advancement proposals or caps for short these are open source specs that describe new features designed to evolve the protocol to meet ecosystem needs all caps begin with a draft and they go through a rigorous process before they're actually implemented in stellar core and even then they don't actually hit the network until validators vote to upgrade to the new version of the protocol that implements them so crucially not all drafts make it across the finish line right changes to the protocol they require deliberation diligence and meetings like this they're just one part in the cap life cycle so today we have two caps to discuss and again these are both drafts um cap 37 and cap 38 both of which have the same goal which is to introduce automated market makers or amms for short at the protocol level so automated automated market makers are a simple way to provide liquidity necessary for asset exchange you may have heard of things like uniswap they've shown that automated market makers are effective at providing an easy to access liquidity at scale they essentially allow for the creation of liquidity pools which are simple and non-interactive and which can attract large amounts of capital and enable high volumes of trading so the goal of both these proposals cap 37 and cap 38 is to add automated market makers to stellar in order to improve overall liquidity on the network they differ slightly but that they have the same goal so two things before we start one this is a technical discussion very technical so if you want to follow along i suggest that you read the caps and the recent developer mailing list threads about them both of which are linked to in the event description two amms are a big topic and the goal today is not to get to the end of the discussion about them rather we're just beginning the discussion so we'll start to bring key questions about these proposals to light so that the discussion and debate can continue on the stellar developers google group just getting started that group is open participation which means that if you have an opinion or some great insight about amms to share you too can join in just follow the link in the event description all right without further ado let us start to talk about amn so again we have these two proposals but they have a lot of questions um in common and then they also have some differences and we're sort of going to get into both today and the first sort of topic that we wanted to talk about was a question about reserve requirement and how it works in each of these caps so cap 37 has the pool creator uh the person who creates the liquidity pool paid for the pool ledger entry um and cap 38 does not increase the reserve requirement so i guess the first question is which model is better is there any concern about either model so reserve requirements well this isn't very deep but it's easier to reduce reserve requirements than increase them so you know if if there's doubt i guess it'd be more conservative to to have the reserve requirement initially maybe we can go over the motivation for not having reserve requirements because most ledger entries do uh yeah i can sound just kind of weird um anyway uh so in cat 38 that that version of the proposal does not have the reserve requirement and the the main motivation is basically uh it's it's not remotely obvious who should own this thing in the first place like why should any given account be responsible for paying this which is you know it can't be used by a single person in the first place intrinsically a multi-party thing and being the person who created it isn't necessarily a meaningful concept but more importantly it's not that there's no reserve requirement at all because the pool can't exist if there isn't at least one trust line for the pool uh for the pool share i should say uh so basically it's kind of like you get it like you know when you're the first person to create the pool you get it like half off you basically get two entries for the price of one um but then you know if there were a thousand people using the pool it would actually be like a thousand people paying a reserve for one single entry uh or if there were you know ten thousand people would be even more more like that so that's kind of the way that i see this motivation all right so there's no way to abuse this uh because you can't just create an infinite number of these you'll need infinite number of trust lines as well so so in other words basically the trust line it sort of serves as the reserve requirement rather than creating a new reserve requirement specific to a liquidity pool right that's a pretty good explanation of it yeah i mean i think like i mean that's a reasonable explanation yeah so it'd be a bummer if we changed our minds but yeah and later wanted to like increase it but that does seem reasonable um i mean if that's the case maybe we're done talking about reserve requirements like does anyone have anything else to to to say about them yeah we sort of started with the easiest topic just to warm up um so if that one's that easy and we can move on i guess like uh maybe so the reason i added that question in the first place was because um it was more like thinking for like like they are uh potentially very large uh i mean the the pool basically to describe it you need to basically describe you know what which assets are part of that pool uh right now we're only discussing concern products as part of this but you can imagine having a lot more complicated type of pools so maybe the the amount of data that is tied to this one pool could be much larger than what we are talking about now uh for example i think in the uh i think compound type of uh world they have like multi assets like more than two assets actually in your pool um and uh i think in if you have like kings or v3 type of stuff uh yeah now you have like those bitmaps that are in there as well i mean like the the cost of that becomes much larger so i don't know you know is it does that count really just as a single single ledger entry or do we need to do something better uh if we if right now we make it basically implicitly attached to a truss line we're kind of stuck with that model forever um as opposed to maybe if it had if it was separate we could imagine okay if we change our mind and it has to be more expensive because you know those things are gigantic um we can you know we have that as a a separate thing but maybe maybe that that's fun because yeah the creator like we can maybe give the first trust line free or something i mean kind of equivalent right like as part of this i mean the thing is like there shouldn't be like a gazillion of these things right so if it turns out that you know i mean i can imagine going forward that it turns out that there's any number of things like it might turn out that we really only want a few hundred of these uh liquidity pools in the network and so we would turn it into like an auction to see like which asset pairs are like you know worthy of of having the automated market maker or you know or it's just kind of the thing is even if it costs like 100 lumens to create one of these things it just wouldn't be that big a deal because that if it's actually a useful liquidity pool that cost would be amortized over a large number of users so i i guess it doesn't seem like it really matters um because i guess we could also say later on like hey price just went up but will grandfather in the existing liquidity pools or something so what happens what happens to the pool when the last trust line disappears uh i think in both proposals it's supposed to be automatically removed i'm just wondering if there's some kind of spammy edge case where people create and destroy trust lines quickly to get some kind of ephemeral pull advantage i mean i guess it could but like the nature of the pool it's not really useful if it's not sitting around right so and you you can't be a participant in the pool if your trust line doesn't exist because you wouldn't be able to hold the shares so i it's hard to see how you could get value from that i do think that like nikola has a good point about the the multi-asset pools you know like balancer type pools and i think in in that kind of a setting uh we could always say you know like okay well we're gonna charge fees for uh charge reserves for those types of pools but not for these types you know i think there's a lot of flexibility uh you know we already have a mechanism by which we can do this uh which is sponsorship so we wouldn't have to invent anything new it's just a matter of like do we think that that's even necessary at this point for me the answer's like probably no i mean like if we to me yeah i agree that right now we don't need it it's more like are we is it possible to add it later if we have to um if we don't if we're not careful basically because in the capital eight world i guess we would have to force people to wrap their trust land creation with some sort of like sponsorship thing or maybe responsible by default i don't know yeah maybe that maybe that's fine it just changes the cost of uh creating a trustline so maybe that's okay i mean what would what would the change look like like in general i'm not a fan of complicating today's thing because of potentially tomorrow but you want to like add like one field to the operation that's like the extra fee for creating the trust line or the extra reserve for creating the trust line or something i think we should just be on type so i think it wouldn't actually change the contract so it's actually fine yeah like we ever have a new type of of uh of pools that are like those gigantic things and we believe that they you know there should be no free riding on this um then we can always add like this uh like those would be sponsored basically instead of right now they would like the i mean right now you have the field that allows them to be sponsored except we don't use it all right i think we can move on okay so the next question is about dex integration which i think is a bigger bigger question so both proposals give access to liquidity from both pools and the decks but they they vary in their approach um john will you just walk us through the difference between cap 37 and cap 38 in their approaches to dex integration uh sure thanks uh so basically uh basically both of them put the access to trading with liquidity pools or automated market makers inside of path payment and that's the only access point to this functionality uh there is no like trade only with an uh trade only with the order broker trade only with the amm uh it's just one operation which is more like trade um now the the difference in how these work is that in cap 37 uh orbitz proposal like the idea is that you're going to try to always get the best price so you might imagine a situation where like the uh you know you have let's say you have an order and the price is at like a hundred dollars or something for whatever you're trying to buy and like the marginal price on the amn is at 95 right now but the amm has like really really small reserves so you might say like okay well first i'm gonna trade against the amm until the price hits a hundred dollars then i'll go and cross the order book and take that first order and then you know now i'm going to now the next price is at 105 and so i'm going to trade against the am until it goes to 105 etc and you do both stepping back and forth between the two uh depending on which one gives you the best margin price in cap 38 to kind of avoid that complexity uh the approach is basically just what if i what if i took the entire trade against the amm or what if i took the entire trade against the order book and just give you whichever of those two produces the best price so you would never do like some amn and some order book it would either be all order book oil a m sorry best price or best volume so even if the volume is tiny you would take it so i'm saying best price in the context of like uh uh imagine that i'm trying to trade a specified amount like i wanna i wanna you know buy three thousand widgets or something uh i'm gonna do whatever it takes to get the best price for those three thousand widgets if i can't get 3 000 widgets on one of the two options then uh that's not an option wait sorry so it's they're all or nothing now oh i see yeah because that's working that's right that's right okay but so in in the cap 37 example where it always tries to get the best price and may may execute part of it on it via the amm and part of it via the order book what does it do it it splits the amount that you want into a bunch of different path payments uh i guess i mean it's kind of hard to explain what it does at like an implementation level but it it's all it's like still going to come through as a single operation and just inside the implementation it's going to know to you know kind of do this incremental approach so it's completely invisible to the user right and so so in both uh proposals can you have arbitrage opportunities between the order book and the amm so in the cap37 proposal there are no arbitrage opportunities between the two because they get resolved automatically as you trade in the cap38 proposal there can be but the reality is that with like spreads as wide as they are on the order book today if there were ever a situation where there was an arbitrage opportunity between the amm and the order book there would also be an arbitrage opportunity between the amm and any external order book for the same product probably i mean like i can't i can't give you 100 guarantee on that but you know i think uh it's pretty common to have like spreads on the order book today greater than half percent so i would think that you know if you're looking at any more liquid place in the world that would probably get you into an arbitrage universe there first with the cap37 implementation would it be possible to to build an attack where you constantly switch between the order book and the pool like a with a single path name like is that a concern what uh what kind of it like what would this attack do exactly right it would take the minimum amount from the pool and it decides that the order book has the next best price and then after that it would switch back to the pool and just keep going back and forth while in cap 38 you would just choose one or the other right do you see what i'm saying so this is i mean like there can only in the world where there's exactly one order book and exactly one amm there can only be as many switches as there are offers in the worst case so like if there's 10 000 offers there could be ten thousand switches but there couldn't be twenty thousand that would be impossible does that make sense do i need to convince you of that i could no i think that makes sense okay um yeah the worst case behavior is to dex not you know that's always the answer one comment i have is that whatever we implement in core we have to be able to model it outside of core like Horizon has to be able to calculate the same thing to give you the best uh path payment and presumably third parties would also want to do that so we should bear that in mind like it can't be completely opaque what do people kind of feel about what's the good approach here i think one one important question here is like cap 37 seems to suggest that the dex is a valuable thing um and should be maintained and the markets will be maintained alongside because if the if if everything just migrates to the automatic market makers then have this like complexity of interleaving requests of no leaving offers seems to be like doesn't make sense right so the question is like do we think that the ecosystem is going to migrate um like are we are there use cases that automatic market makers are not providing a good solution for as much as the dex is i i think there are but it'll probably be per asset pair anywhere like if i had to predict i would say that for you know if i want to like you know do an ipo of my company on stellar i'm gonna just basically like put the order book there i mean it'll be offer my shares for sale like on the order book or something right um and if i'm trying to do like forex exchanges or whatever then probably the uh the um probably the the amm is going to be best so it it seems unfortunate that kind of like the more intermingling of these abstractions the harder it's going to be to like you know improve each individual one in the future the more complexity there's going to be and it's not clear uh what the payoff is going to be the market will do better with impermanent loss right so when there's knowledge outside of uh the blockchain the market will take advantage of it much more effectively than the amm yep seems like an argument to have it you know i'm not saying get rid of the the existing decks i'm just saying you know have uh have both but don't have them terribly intermingled like they sort of um ideally improvements to the mm don't need to like you know change the logic of the order book as you know as much as possible and vice versa so then it would just be a user choice more than anything whether to use the amm or use the dax a market maker choice the user would just get the best price available for a path payment right um but someone who's trying to make a market could either use our amm or if it's not good then they could use the um the decks comer i i would kind of ask you like can you think of anything where people would want to use like would have a good justification for using both on the same product because i agree with david like i can think of lots of cases where the amm will be better than the decks or lots of cases where i say the decks i should say the order book lots of cases where the order book would be better than the amms but i can't think of a case where people would be obviously indifferent between the two well i think what what could happen is that um you know that amms are used to like bootstrap a market but that then when the market is like you know a really big deal then some big market maker will come along and they would rather have the control of setting explicit limit orders because they can set have a lot of depth and they can kind of adjust to x uh you know external uh factors that affect the price and so they would prefer that and so i could see the amm is way to bootstrap a market and then like a full-on market maker using the the the order book once it makes sense for them to do that because there's enough volume that is profitable for them to make the market in the traditional way but cap38 would satisfy that without the extra complexity so at the moment it doesn't seem like anyone's arguing that the extra complexity of cop 37 is is worth uh has has a benefit um that makes it worth while really is that true is there anyone who who thinks cap37 and the super interleaved process is is substantially better but i think the argument for for that behavior is actually what um orbit wrote i think this morning on the dave mailing list which is trying to limit um like the number of times you have like this uh arbitrage opportunities between emm and the uh the existing order book the thing is that uh i don't know if you have any data really to kind of say that this is going to be a big problem inside uh like this is like inside a specific uh like even on the on the decks overall like you have pairs that i mean yeah are assets that represent the same thing right they're just issued by different people and that doesn't solve i mean cap 37 doesn't solve that so that's why i'm i'm kind of a in the camp of like starting with this simple thing first see how that goes and then adjust like based on that because yeah this interleaving um so far on you know the type of of things i'm saying it's actually very hard to even come up with with like environments or things that you want to happen if we want to change the uh what the mm is doing like if it's uh something more complicated than than constant product i'm not even sure we we can um yeah explain what we exp what we expect to happen like we want the best price but when you have like grounding and all those issues that come in play it it actually becomes really complicated to try to reason about this so i would delay that decision as much as possible that's that's my opinion and there's a chance that uh you know we'll want a third thing that's neither an amm nor the existing decks and so uh you know it's nice the idea that okay we can just have multiple approaches to this coexisting and they don't have to be tightly integrated that leaves us more flexibility in the future great anything else about dex integration or should we move on to the next topic great the next topic is pool parameter updates um i think sid was working on something related to this is that true yeah i wrote something on the that mailing list yesterday uh i can talk about that if you like yeah will you talk us through it yeah so it it's it's what i propose is uh an extension on what orbit pros where you include the uh the fee in the ledger header so instead of just having one fee you have you know all the fees you may want to use uh for example if you if you had a couple different constant product uh pools with different fees uh you have all them the ledger header and uh depending on which pool you're interacting on you would pull the fee from there uh this will allow you to upgrade the uh the fees without a protocol update uh the issue here though is that you know the more the more pools we add more parameters we add wherever we if we store this in the ledger head it'll get polluted wherever we decide to store it somewhere else uh like it may become an issue uh so that that was what i proposed i think niko had a had a different proposal uh related to storing the parameters in in the ledger pull key i believe and maybe you can talk about that right so i i guess like what i described was not necessarily um where to start i mean like there's like there are actually different concepts here um because let's see it is the other question after um so just maybe one thing that will help me can we just talk about what parameters there might be that that we would need to store other than right so like the type of things that uh i think uh people were talking about so for the obvious one is uh we have a proof uh a puffy uh right uh that's the one that is kind of the really the only parameter and a constant product pool we have other parameters also like minimum amounts that we want people to to be able to deposit like basically a unit you can think of it as a as a unit of deposit or withdrawal that helps with uh guaranteeing certain levels of liquidity basically when you do all those operations um what there's i think some of those uh when you have like the more than two assets type of course those have actually formulas that are getting even more complicated because now you have like different weights uh for those assets um i think those are like the the ones that are known right now right uh i think for like unison b3 type of pool you have like a step size also uh i mean yeah it's up to future so and there are a few other things that are like uh for example curve has this amplification factor uh and that would be something else that would have to be stored if we were to use that is is there an issue with storing all of this in the leisure header i'm assuming like you want to get two actually so the the one actually i guess like when i wrote this question what i was thinking at the time was more like there's this question of if you store the parameter as a global as opposed to be something that is um attached to the pull itself well that means is that if you want to ch if you change the value of that parameter so if you change the c for example you're actually changing the fee for every pool in existence every instance right um and actually have a hard time to kind of understand how that model works in a world where you have other parameters other than the key like for the fee maybe it works for other parameters i think it changes the dynamics of the pool so much that you're actually you're really talking about a very different pool at that point and it may not actually be something desirable this this first version is we are establishing the model that we want going forward and you know constant product is very special and i don't want to be stuck with that you know with whatever choice comes out of that so you're really focused here on the on the update like updating the what should it be possible to update the parameters on an existing pool it's kind of the main crux here i think it's yeah it derives from this choice right that is if it's a global that means when you update it you change everywhere right my stance on this is that like you shouldn't be able to retroactively update things uh you know if you wanted to switch to a different pool create the new pool uh move your money into there and let people vote with their feet or with their money however you want to say it uh my stance on this is more a ux thing than anything else uh you know what i really don't like seeing looking on my bank statement and being like oh i used to get 1.5 interest now i get one percent interest uh i didn't agree to that nobody told me until after my money had already been sitting there for however long so i don't think i want to impose that on to other people so a pool would have fixed parameters that could never change once it was initiated somehow so what you're saying that would be the stance that i would take on this um i think the only exception to this might be like perhaps we might make the exception that these can change during a protocol upgrade because generally we take the stance that we can change the rules on protocol upgrades uh and you know i don't think anybody would be super offended if all the validators plus all the developers plus went through this huge review process to agree like this is gonna be better uniformly for everybody so we should make it the de facto um but isn't nico's point that when you make the second pull if you wanted to change the fee in a second pull it would affect the fee in the first pull are they coupled like in in siddharth's proposal and i'll let him talk more about it but he's offering like these three different fear in his example he's offering these three different fee tiers and you can imagine being in the mid-tier fee uh you know you could have the low tier one the mid two one the high tier one and then you know the validators vote like okay we're gonna move the mid tier one from point five to point six or something like that so it would still be possible to be in a world where there are multiple pools and still have multiple fees but have them globally controlled so that existing ones get changed anyway not saying that i support that but i think that's possible but siddharth you can step in here if i'm not uh not hitting this correctly no that was right and that like the the nice thing here is that you and i don't know if this actually matters but you you control the the number of possible pools right i don't know if that matters for uh like liquid liquidity fragmentation right like if we if we allow if we end up allowing like 10 or 15 constant product pools like will that be an issue or do we assume that everyone will move to the most optimal optimal pool like i i'm not sure what will end up happening there i tend to think that people would have probably eventually settled down onto the right thing uh but i also don't think that's a particularly nice user experience uh it's like decision paralysis when you get to the grocery store and you're like wow there's a 37 brands of corn flakes which one am i gonna buy yeah why do you need that in your life so it's it does sound like like if we were to make any of the parameters mutable it would it would only be the fee right like if like we shouldn't change anything like the curve or anything like that uh for any of the you know if we add a new pool type like those should not be mutable right i don't think those should be mutable only from like i don't know uh their nikolas shared this uh this very cool defect report that colton long ago had shared with me and i shared with nikola nikon he posted it onto sellerdev which is about changing the curve parameters other than the fee i say defect report i guess i should say vulnerability whatever you want to call it and if you're interested more you should you should review that because it's very scary i almost feel like this shouldn't uh this shouldn't be a configurable uh parameter um and if if we do want to introduce a different fee we can might as well just introduce a new type of uh a new type of pool like i think that doing um like even if you don't change it for existing pools i'll still you know i'll i'll put some money into a pool one day uh get you know one specific fee and the next day after the configuration change it's a safe type of pool but now i'm getting like a different type of fee so that there's like it's just not explicit enough a couple of people have said why don't we just introduce a new pool or why don't we do this who is the we in this situation does that make sense uh i think there are two different ways one could take this one one way to introduce new types of pools would be that it's a protocol change you know like if we're gonna go from having only constant product pools to having constant product rules and um i don't know something curve-like or balancer with weights or whatever um we'd have to you know the stellar protocol developers you know people who work on caps whatever would have to make that happen uh another way to look at we this is this is an idea that nikola had a long time ago about having this like uh this notion of like um instead of letting people choose any fee they want or any whatever they want there are some configurations that the validators have voted on are good configurations uh when you're creating something you're basically choosing from that menu of good configurations and so in that setting we could be like validators you know they they voted on saying that like now the fee can be both 0.3 and 0.05 you know so depending on the context i think we could be either of those cool things are there more questions about parameters i mean i feel like there's still a little bit more thinking there that we can sort of do in conversation on the stellar dev list i i don't want to move on though if there's important things left to be said but i feel like we're sort of at a good point to move on right i agree like the next one is actually related and and maybe more interesting actually you want to explain it yeah multiple pull support yeah so it's basically um the two proposals are actually uh quite different there uh like cap 38 uh actually allows one asset pair to have arbitrary variations of pools for that one pair so the variation can be on the curve type it can be on any really any other parameter like we just talked about fee so you can imagine having um two pools on the same two constant product pools let's say on the same asset pair but one is going to be you know super low c and the other is like going to be a high fee and then you know the market kind of gets inside whatever um capital e7 identifies pools using the pool type and then related to the thing we are talking about earlier the the fee is global so at this point the only way you can have multiple pools on a given asset pair is if they defer on type do we want to have more of the first kind or the second second time right like which one is is uh is maybe more interesting we want to have like those uh a few number of options right in a for a given type or do we think that one type enough i think there are some like fundamental problems with the notion of like one instance of a pool per wait hold on actually let me make sure i understand do you mean one instance of a pool per pair per pair yeah of course all this is fair fair right yeah so one in i think there's some like fundamental denial of service flaws with one instance of a pool per pair which is the question of who gets to choose what that pool will be uh like is it going to be the hyphy one the low fee one is going to be curve you know uh i think basically basically if there can be multiple types of pools we probably have to say that all of them can exist for the same pool to avoid having some arbitrary and by arbitrary you can always take that to be adversarial decision maker like oh this is a super volatile uh asset pair um where like you know constant product with a high fee would be the best i'm going to put in you know a curve with a super low fee to make it so nobody can use this don't want that to happen but here like you have the um you know using cap37 as like the like maybe the as a talking point like the earlier we were talking about fees do we think that we want to have more than one few for constant product for a given pair i mean i think that we probably want to have more than one tea uh and not just uh force like people to pick like oh yeah this is the right fit for you because i think that different um different uh asset classes actually uh have different like risk profile and volatility profile and therefore you want to have a different fee you know like you basically want the the uh like crypto to crypto assets to have a different probably a different fee than the stable coin to stable coin type of uh type of fair right so yeah you can let them compete and like you were saying like you can't let a single person decide on which one is the first one so then how do you let the market decide i think that's kind of what i'm getting so it would bring market dynamics to bear on these given uncompeting pools i don't really like for me the reality is i don't really see what we're choosing between like the choices in my head are kind of like there is exactly one type of pool and we apply that uniformly across the board or there's one you know maybe you say like okay like you can have different curves but all the ones with the same curve have the same fee whatever like whatever you kind of take that model at you're kind of saying like i'm gonna try to fit all the pegs into a single shaped hole if you take that approach and if you don't take that approach then you're basically saying well like i'm gonna let the market decide what's the what's the non-stupid thing uh and i i don't like forcing pegs into holes that don't that they don't fit in so for me it seems kind of like a like a very kind of obvious choice but i'm i'm wondering if somebody sees the the argument that goes in the other direction like is there somebody who's like no like john you're definitely wrong well i think the argument i held before on on trying to force everybody into the same group is you avoid uh like splitting the liquidity but i'm not i'm not that's not my opinion either you know so i can't really support it but that i just wanted to call it out that's actually one of the argument that people call out yeah i mean i guess for me it kind of depends a lot on what the set of options are like you can imagine a world where like we just imagined that it was possible to create a constant product market maker with a fee at every thousandth of a percent there's no difference between i mean they're they're not literally identical but there's no material difference between a fiat point three percent or point three zero zero point three zero one percent or point two nine nine percent they're kind of like exactly the same and i think in that world you probably do have liquidity fragmentation between people doing effectively the exact same thing differently whereas you know in a world where you're like okay like you have two fees on your constant product one is like 0.05 and one is one percent for totally different asset classes i think there's going to be like a very obvious place that people are going to want to put their money in those kinds of cases and there won't be a lot of blurriness i'm not 100 sure but i think the the amount of liquidity fragmentation depends on how distinct the options are but even in that case if market dynamics work wouldn't people be drawn to the fool with the lower feet right if they were the same but one even had a tiny bit lower fee and then the two pools would be competing and they would actually that would push fees lower isn't that what you would expect uh not not necessarily like for example if the impermanent like if prices are moving a lot and so there's a lot of impermanent loss then people might make more money from the higher fee even if people traded less as a consequence and the other factor is if everybody's in the high fee pool then and like let's say that like let's suppose a world where there's 99 sorry 100 equivalent market makers 99 of them are in the big pool which has the high fees and the one other guy is in the small city pool uh in like the cap 38 proposal for like maybe some small trades would execute against the small pool the small fee pool but all the big trades would execute against the big fee pool because there'd be less slippage there and so maybe that person would end up making less money by being in the low fee pool and then they decide to join the high fuel pool anyway right so i think it's it's not obvious there's a bunch of different ways these kinds of things could shape out so i mean maybe the answer to this is no but i'm just wondering if there's any if it's it just seems better to have only one pool you know other than the fact that you would have to agree on the parameters um but i'm wondering if there's any way to kind of select the pool objectively like basically say that you know for any given pool you you you if there's if there's multiple pools for an asset pair you just pick the one that has the highest product or highest product plus reserve where people can pledge some reserve or something so you can let people sort of bid on on what they have because what you kind of want is like you want like you know in the kind of stellar fashion of like it's just to everyone's advantage to do what everybody else is doing which is kind of like the whole philosophy of stellar on some level you kind of would like market forces to decide this and so to the extent that then somebody a lot of people decide that you want to do something else then it should like make sense to move over to that that's something else but um i mean that's uh that's uh john uh briefly mentioned this uh my new idea uh earlier so that's kind of what i uh proposed earlier is basically try to kind of find a good middle ground right like you don't you don't want to have like a single pool you know where you're forcing to this one rate you know across all assets you know that's i think that's kind of uh trying to to that's too too uh prescriptive on the other hand if you allow people to set any price you know any fee and all that you end up with like this huge uh like you can't pick a pool basically like there are an infinite number of pools so the menu idea is to have validators actually describe the the combinations that you are that that you can use on the network and the combinations would be a combination for example like constant product you can have like low medium high c or something like that and then when you when you want to deposit uh assets in a pool you pick which of which which item on the menu you want right you can say okay this is like a stable coin one so i'm going to pick this scoff paying with this parameter right okay so here's i think you know this is probably not workable but just to like get some design point out there suppose that uh you know people can sponsor these uh these liquidity pools um using lumens um and basically you can propose any value any parameter you want however in order to introduce a new liquidity pool when there's already one for that uh for that asset pair two things have to happen one you have to pledge more lumens than the previous uh reserve as pledged and two you have to have it like as at least as much liquidity in terms or the product has to be at least as as great in terms of the assets you put in there so this would allow people to change when everybody wanted to change but it would sort of make it a little bit sticky what a i get what you're getting at here but uh like a kind of just practical implementation type question before we talk about this on the merits it's just like um what about the case when you have pools that were like the uh the product is a different number like the invariant is a different number uh you know the curve invariant is some really complicated thing that's really gross to write down uh and so they're obviously comparable there would be some there would be some requirement that for any pool that we introduce but there needs to be a depth metric which is a number and where somehow we believe that in general deeper markets are better than shallower how would you i guess like what would at like a high level what would an implementation of all of this kind of look like like in an abstract sense but like we need some new kinds of entries and stuff like what is it like how do you how do you say that you're voting for one of these pools like what does it mean for like if you're voting for a pool but the pool doesn't actually work yet what is what are how do all these things kind of work at a high level yeah i guess you have you have some number of uh let's say you have some number of um candidate pools and in order maybe in order to create a candidate pool you have to pledge sort of twice the base reserve that's pledged for the previous one or something so we can't get like an infinite number of these um and then for the candidate pools there's some amount of capital that's pledged and so if if one of the candidate pools suddenly gets more or more depth right there's some amount of capitalist pledge and if if at some point one of the candidate pools ends up with more depth than the existing pool then people would switch over so the basic assumption here is that like sort of 90 of the people participating in a liquidity pool would say hey like actually we want to go to a lower fee or something right and so um and so once everybody wants to do that they can make it happen but uh like you know a random person who's just trying to disrupt the existing market would have to like amass a lot of capital and essentially end up making a more liquid market in order to um in order to uh disrupt the existing market it's a kind of interesting idea i'd have to think about that a bit i like definitely have some concerns along the same line as somebody mentioned now i think eric mentioned about like this like ephemeral trust line type of thing you can imagine somebody putting a lot of putting their money where their mouth is in like a huge amount and then you know five ledgers later being like i just did that to screw you guys all up and then just pulling their money back on the other hand if what they did is provided people like really low fee transactions for five ledgers like is it so bad like they could have done the same thing by placing offers on the order book right it's a fair point so we only have five minutes left um and and i think that's fine because i think a lot of these questions can we can continue to sort of talk about them or to think about some of the suggestions that were raised and deal with them on the stellar debt mailing list there were two other topics that we didn't really get into uh one was compliance um and one was rounding do we want to take a second to talk about either of those right now would that be useful or is it is it too much to take on either one of those topics in the last four minutes uh it seems hard and for me i mean i'm like i'm very interested in talking about these but uh in detail it just seems like it'll be unsatisfying to get into them now okay that makes sense to me i mean i think then the the question is what what is what are the next steps after this meeting do we i feel like it is to continue the discussion on stellar death but are there other follow-up actions that need to happen in order to make that make that possible i'm still trying to understand whether we've narrowed down the scope of which pools can exist and uh which ones can't like for a given asset pair have we agreed we can only have one pool or could we have multiple pools with different kinds of curve for that asset pair for example like i would love to write that down well i think what we were talking about was that we i think they we agreed that there would be more than one pool per asset there um what we are talking about last was more about the governance that goes with introducing a new pool like you can do it in many ways the good news is that we don't necessarily have to solve that i think in this version because right now we're introducing only one one constant product and um i'm not sure we want to introduce in the first version the support for more than one rate right like we can basically for now like i think that's what capital e8 says or even capital e7 uh that is there's only one rate um and i'm it's probably fine for the very first version but uh it's interesting to think about how to to change that in the future right if you'd be willing david i'd be like very interested to see like a high-level write-up of what you were describing so i can think about that more deeply yeah maybe i can just draft something by email or something yeah that'd be fine it doesn't have to be super formal sure and i noticed for the future but there was the idea of a menu right that was sort of validator determined there was this idea of you can replace by better with some depth metric um were there any other contenders for ways to do this well that was the question in the first thing right that was don't even allow to have more than one right um yeah which which is a third option sure okay there's also the free-for-all option anarchy i love the anarchy every time i'm listening to this i'm like this is we're talking about anarchy or we're talking about like soviet style communism or we're talking about just like free market capitalism i feel like there's ideologies behind all these choices you know john's like there should only be one one kind of corn flake right i can go for like three kinds of corn flakes just to be fair cool yeah you want the you know you're on the special occasion it's your birthday conflict right man i hope you have some like something like flat uh pink blueberry pancakes on your birthday not cornflakes um i don't even know okay that's time uh thanks everybody and thanks everyone who's watching at home again uh this discussion will continue on the stellar dev google group uh which you can find a link to uh in the actual event description there's already a lot that's happened there and we will continue to have these discussions in these meetings to start to hammer out more of these proposals but again two proposals a lot of discussion many things that we covered today but many more things to cover um look there to see what's happening this conversation will happen both sort of asynchronously there and synchronously here in the future and we really appreciate everyone for being here thanks everyone

This session kicked off the automated market maker (AMM) effort. Two competing drafts—CAP-0037 and CAP-0038—were presented, each aiming to combine Stellar’s orderbook with constant-product pools so anyone can supply or consume liquidity without standing orders.

Key discussion threads:

- Resource management and fee economics: who sponsors the pool accounts, how LP share trustlines should be charged reserves, and how to prevent “free riding” from contracts that never post reserves.
- DEX integration strategies: CAP-0037’s “always take the best marginal price” routing versus CAP-0038’s deterministic sequencing of pool and orderbook fills, plus the UX consequences of hiding the routing details behind path payments.
- Pool operations (deposit/withdraw rounding, claimable incentives, slippage protections) and the plan for continuing the debate on the developer mailing list before either draft moves forward.

<details>
  <summary>Video Transcript</summary>

[00:00] Hello and welcome to the Stellar Open Protocol Discussion. So for those of you watching at home, I just want to give a quick overview. The goal of these meetings is to talk about and plan for changes to upcoming versions of the Stellar protocol. We go over Core Advancement Proposal, or CAPs for short. These are open source specs that describe new features designed to evolve the protocol to meet ecosystem needs. All CAPs begin with a draft and they go

[01:00] Through a rigorous process before they're actually implemented in Stellar core. And even then they don't actually hit the network until validators vote to upgrade to the new version of the protocol that implements them. So, crucially, not all drafts make it across the finish line right changes to the protocol. They require deliberation, diligence and meetings like this. They're just one part in the CAP life cycle. So today we have two CAPs to discuss, and again, these are both drafts- CAP 37 and CAP 38- both of which have the same goal, which is to introduce automated market makers- or AMMs for short, at the protocol level. So automated market makers are a simple way to provide liquidity necessary for asset exchange. You may have heard of things like uniswap. They've shown that automated market makers are effective at providing an easy to access liquidity at scale. They essentially allow for the creation of liquidity pools which are simple and non interactive and which can attract large amounts of capital and enable high volumes of trading. So the goal of both these proposals, CAP 37 and CAP 38,

[02:00] Is to add automated market makers to Stellar in order to improve overall liquidity on the network. They differ slightly, but that they have the same goal. So two things before we start. One: this is a technical discussion, very technical, so if you want to follow along, I suggest that you read the CAPs and the recent developer mailing list threads about them, both of which are linked to in the event description. Two: AMMs are a big topic and the goal today is not to get to the end of the discussion about them. Rather, we're just beginning the discussion. So we'll start to bring key questions about these proposals to light so that the discussion and debate can continue. On the Stellar developers google group just getting started. That group is open participation, which means that if you have an opinion or some great insight about AMMs to share, you too can join in. Just follow the link in the event description. All right, without further ado, let us start to talk about amn. So again, we have these two proposals, but they have a lot of questions in common and then they also have some differences, and we're sort of going

[03:00] To get into both today. And the first sort of topic that we wanted to talk about was a question about reserve requirement and how it works in each of these CAPs. So CAP 37 has the pool creator, the person who creates the liquidity pool, paid for the pool ledger entry, and CAP 38 does not increase the reserve requirement. So I guess the first question is: which model is better? Is there any concern about either model? So reserve requirements: well, this isn't very deep, but it's easier to reduce reserve requirements than increase them. So you know, if there's doubt, I guess it'd be more conservative to have the reserve requirement initially. Maybe we can go over the motivation for not having reserve requirements because most ledger entries do.

[04:00] Yeah, I can sound just kind of weird, anyway. So in CAP 38, that version of the proposal does not have the reserve requirement and the main motivation is basically, it's not remotely obvious who should own this thing in the first place. Like why should any given account be responsible for paying this, which is, you know, it can't be used by a single person in the first place, intrinsically a multi party thing, and being the person who created it isn't necessarily a meaningful concept. But more importantly, it's not that there's no reserve requirement at all because the pool can't exist if there isn't at least one trust line for the pool share. I should say so. Basically, it's kind of like you get it like you know, when you're the first person to create the pool, you get it like half off. You basically get two entries for the price of one. But then you know, if there were a

[05:00] Thousand people using the pool, it would actually be like a thousand people paying a reserve for one single entry. Or if there were, you know, ten thousand people would be even more like that. So that's kind of the way that I see this motivation. All right, so there's no way to abuse this, because you can't just create an infinite number of these. You'll need infinite number of trust lines as well. So in other words, basically the trust line it sort of serves as the reserve requirement, rather than creating a new reserve requirement specific to a liquidity pool. Right, that's a pretty good explanation of it. Yeah, I mean, I think, like I mean that's a reasonable explanation. Yeah, so it'd be a bummer if we changed our minds, but yeah, and later wanted to like increase it, but that does seem reasonable.

[06:00] I mean, if that's the case, maybe we're done talking about reserve requirements, like does anyone have anything else to say about them? Yeah, we sort of started with the easiest topic just to warm up. So if that one's that easy and we can move on, I guess, like maybe. So the reason I added that question in the first place was because it was more like thinking for, like they are potentially very large. I mean the, pool, basically to describe it, you need to basically describe you know what, which assets are part of that pool. Right now we're only discussing concern products as part of this, but you can imagine having a lot more complicated type of pools, so maybe the

[07:00] Amount of data that is tied to this one pool could be much larger than what we are talking about now. For example, I think in the, I think compound type of world. they have like multi assets, like more than two assets actually in your pool, and I think in if you have like kings or v3 type of stuff. Yeah, now you have like those bitmaps that are in there as well. I mean like the cost of that becomes much larger. So I don't know, you know, is it? Does that count really just as a single ledger entry, or do we need to do something better? If we, if right now we make it basically implicitly attached to a truss line. We're kind of stuck with that model forever as opposed to maybe if it had, if it was separate- we could imagine, okay, if we change our mind- and it has to be more expensive because, you know, those things are gigantic- we can, you know we have that as a

[08:00] Separate thing, but maybe that a fun because, yeah, the creator, like we can maybe give the first trust line free or something I mean kind of equivalent, right, like as part of this. I mean the thing is like there shouldn't be like a gazillion of these things, right. So if it turns out that, you know, I mean I can imagine, going forward that it turns out that there's any number of things like it might turn out that we really only want a few hundred of these liquidity pools in the network and so we would turn it into like an auction to see like which asset pairs are, like you know, worthy of having the automated market maker or you know, or it's just kind of. The thing is, even if it costs like 100 lumens to create one of these things, it just wouldn't be that big a deal because that if it's actually a useful liquidity pool, that cost would be amortized over a large number of users, so I guess it doesn't seem like it really matters, because I guess we could also say,

[09:00] Because I guess we could also say later on, like hey, price just went up, but will grandfather in the existing liquidity pools or something. So what happens to the pool when the last trust line disappears? I think in both proposals it's supposed to be automatically removed. I'm just wondering if there's some kind of spammy edge case where people create and destroy trust lines quickly to get some kind of ephemeral pull advantage. I mean, I guess it could, but like the nature of the pool, it's not really useful if it's not sitting around, right so and you can't be a participant in the pool if your trust line doesn't exist because you wouldn't be able to hold the shares, So I it's hard to see how you could get value from that. I do think that, like nikola has a good point about the multi asset pools. You know like balancer type pools,

[10:00] And I think in that kind of a setting, we could always say, you know, like, okay, well, we're gonna charge fees for charge reserves for those types of pools, but not for these types. You know, I think there's a lot of flexibility. You know we already have a mechanism by which we can do this, which is sponsorship, so we wouldn't have to invent anything new. It's just a matter of like. Do we think that that's even necessary at this point? For me, the answer's like, probably no. I mean like if we? To me, yeah, I agree that right now we don't need it. It's more like: are we, is it possible to add it later if we have to, if we don't, if we're not careful? Basically because in the capital eight world, I guess we would have to force people to wrap their trust land creation with some sort of like sponsorship

[11:00] Thing, or maybe responsible by default, I don't know. Yeah, maybe that maybe that's fine. It just changes the cost of creating a trustline, so maybe that's okay. I mean, what would the change look like? In general, I'm not a fan of complicating today's thing because of potentially tomorrow, but you want to like, add, like one field to the operation. That's like the extra fee for creating the trust line or something. I think we should just be on type. So I think it wouldn't actually change the contract. So it's actually fine. Yeah, like we ever have a new type of pools that are like those gigantic things and we believe that they- you know there should be no free riding on this- then we can always add like this, like those would be sponsored. Basically, instead of right now they would like the. I mean right now you have the field that allows them to be sponsored, except we don't use it.

[12:00] All, right, I think we can move on, okay. So the next question is about DEX integration, which I think is a bigger question. So both proposals give access to liquidity from both pools and the DEX, but they vary in their approach. John. Will you just walk us through the difference between CAP 37 and CAP 38 in their approaches to DEX integration? Sure, thanks. So basically, both of them put the access to trading with liquidity pools or automated market makers inside of path payment and that's the only access point to this functionality. There is no like trade only with the order broker, trade only with the AMM. It's just one operation which is more like trade. Now the difference in how these work is that in CAP 37 OrbitLens proposal, like, the idea is that you're going to

[13:00] Try to always get the best price. So you might imagine a situation where, like the you know you have, let's say you have an order and the price is at like a hundred dollars or something for whatever you're trying to buy, and like the marginal price on the amn is at 95 right now, but the AMM has like really small reserves, So you might say like, okay, well, first I'm gonna trade against the AMM until the price hits a hundred dollars, then I'll go and cross the orderbook and take that first order. And then you know, now I'm going to now, the next price is at 105, and so I'm going to trade against the am until it goes to 105, etc. And you do both, stepping back and forth between the two, depending on which one gives you the best margin price. In CAP 38, to kind of avoid that complexity, the approach is basically: just what if I took the entire trade, against the AMM? Or what if I took the entire trade against the orderbook and just give you whichever of those two produces

[14:00] The best price? So you would never do like some amn and some orderbook. It would either be all orderbook: oil a- m- sorry, best price or best volume. So even if the volume is tiny, you would take it. So I'm saying best price in the context of like. Imagine that I'm trying to trade a specified amount like I wanna. I wanna, you know, buy three thousand widgets or something. I'm gonna do whatever it takes to get the best price for those three thousand widgets. If I can't get 3 000 widgets on one of the two options, then that's not an option. Wait, sorry, so it's they're all or nothing now. Oh, I see, yeah, because that's working. That's right okay, But so in the CAP 37 example, where it? always tries to get the best price and may execute part of it on it via the AMM and part of it via the orderbook? What does it do? It splits the amount that you want into a bunch of different path payments,

[15:00] I guess. I mean it's kind of hard to explain what it does at like an implementation level, but it it's all it's like still going to come through as a single operation and just inside the implementation it's going to know to you know kind of do this incremental approach, so it's completely invisible to the user, right. And so in both proposals can you have arbitrage opportunities between the orderbook and the AMM. So in the CAP 37 proposal there are no arbitrage opportunities between the two because they get resolved automatically as you trade. In the CAP 38 proposal there can be. But the reality is that with like spreads as wide as they are on the orderbook today, if there were ever a situation where there was an arbitrage opportunity between the AMM and the orderbook, there would also be an arbitrage opportunity between the AMM and any external orderbook for the same product.

[16:00] Probably I mean like I can't, give you 100 guarantee on that. But you know, I think, it's pretty common to have like spreads on the orderbook today, greater than half percent. So I would think that you know if you're looking at any more liquid place in the world. That would probably get you into an arbitrage universe there. First, with the CAP 37 implementation, would it be possible to build an attack where you constantly switch between the orderbook and the pool, like a with a single path name? Like is that a concern? What kind of it? Like what would this attack do? Exactly? Right, it would take the minimum amount from the pool and it decides that the orderbook has the next best price and then after that it would switch back to the pool and just keep going back and forth, while in CAP 38 you would just choose one or the other right. Do you see what I'm saying?

[17:00] So this is I mean like there can only in. the world where there's exactly one orderbook and exactly one AMM, there can only be as many switches as there are offers in the worst case. So like if there's 10 000 offers, there could be ten thousand switches, but there couldn't be twenty thousand. That would be impossible. Does that make sense? Do I need to convince you of that? I could, no, I think that makes sense. Okay, yeah, the worst case behavior is to DEX not, you know, that's always the answer. One comment I have is that whatever we implement in core, we have to be able to model it outside of core. Like Horizon has to be able to calculate the same thing to give you the best path payment, and presumably third parties would also want to do that. So we should bear that in mind. Like it can't be completely opaque.

[18:00] What do people kind of feel about? What's the good approach here? I think one important question here is: like CAP 37 seems to suggest that the DEX is a valuable thing and should be maintained and the markets will be maintained alongside. Because if the, if everything just migrates to the automatic market, makers then have this like complexity of interleaving requests, of no leaving offers seems to be like doesn't make sense, right. So the question is like: do we think that the ecosystem is going to migrate like are we? Are there use cases that automatic market makers are not

[19:00] Providing a good solution for as much as the DEX is? I think there are, but it'll probably be per asset pair anywhere, like if I had to predict, I would say that for you know, if I want to like you know, do an ipo of my company on Stellar. I'm gonna just basically like put the orderbook there. I mean it'll be offer my shares for sale, like on the orderbook or something right. And if I'm trying to do like forex exchanges or whatever, then probably the AMM is going to be best. So it seems unfortunate that kind of like: the more intermingling of these abstractions, the harder it's going to be to, like you know, improve each individual one in the future. The more complexity there's going to be and it's not clear what the payoff is going to be. The market will do better with impermanent loss, right? So when there's knowledge outside of the blockchain, the market will take advantage of it much more effectively than the AMM. Yep, seems like an argument to have it.

[20:00] You know I'm not saying get rid of the. existing DEX. I'm just saying, you know, have both, but don't have them terribly intermingled like they sort of. Ideally, improvements to the mm don't need to, like you know, change the logic of the orderbook, as you know, as much as possible, and vice versa. So then it would just be a user choice more than anything, whether to use the AMM or use the DEX- a market maker choice. The user would just get the best price available for a path payment right, but someone who's trying to make a market could either use our AMM, or if it's not good, then they could use the DEX. Comer, I would kind of ask you like, can you think of anything where people would want to use, like would have a good justification for using both on the same product? Because I agree with David? Like I can think of lots of cases where the AMM will be better than the DEX, or lots of cases where I say the DEX, I should say the orderbook.

[21:00] Lots of cases where the orderbook would be better than the AMMs, but I can't think of a case where people would be obviously indifferent between the two. Well, I think what could happen is that you know that AMMs are used to like bootstrap a market, but that then, when the market is like you know, a really big deal, then some big market maker will come along and they would rather have the control of setting explicit limit orders, because they can set, have a lot of depth and they can kind of adjust to x, you know, external factors that affect the price, and so they would prefer that and so I could see the AMM is way to bootstrap a market and then like a full on market maker using the orderbook once it makes sense for them to do that, because there's enough volume that is profitable for them to make the market in the traditional way. But CAP 38 would satisfy that without the extra complexity. So at the moment it doesn't seem like

[22:00] Anyone's arguing that the extra complexity of CAP 37 is worth, has a benefit that makes it worth while really, is that true? Is there anyone who thinks CAP 37 and the super interleaved process is substantially better? But I think the argument for that behavior is actually what orbit wrote, I think this morning on the dave mailing list, which is trying to limit, like, the number of times you have, like this, arbitrage opportunities between emm and the existing orderbook. The thing is that I don't know if you have any data really to kind of say that this is going to be

[23:00] A big problem inside, like this is like inside a specific, like, even on the DEX overall. Like you have pairs that I mean yeah, are assets that represent the same thing, right, they're just issued by different people and that doesn't solve. I mean, CAP 37 doesn't solve that. So that's why I'm kind of a in the camp of like starting with this simple thing, first see how that goes and then adjust, like based on that. Because, yeah, this interleaving- so far on, you know the type of things I'm saying- it's actually very hard to even come up with like environments or things that you want to happen. If we want to change the, what the mm is doing, like if it's something more complicated than constant product, I'm not even sure

[24:00] We can, yeah, explain what we exp, what we expect to happen, like we want the best price, but when you have like grounding and all those issues that come in play, it actually becomes really complicated to try to reason about this. So I would delay that decision as much as possible. That's my opinion and there's a chance that you know we'll want a third thing. That's neither an AMM nor the existing DEX, and so you know it's nice the idea that, okay, we can just have multiple approaches to this coexisting and they don't have to be tightly integrated. That leaves us more flexibility in the future. Great. Anything else about DEX integration, or should we move on to the next topic? is pool parameter updates.

[25:00] I think sid was working on something related to this. Is that true? Yeah, I wrote something on the that mailing list yesterday. I can talk about that if you like. Yeah, will you talk us through it? Yeah, so it. It's. What I propose is an extension on what orbit? Pros, where you include the fee in the ledger header. So, instead of just having one fee, you have, you know, all the fees you may want to use. For example, if you had a couple different constant product pools with different fees, you have all them, the ledger header and, depending on which pool you're interacting on, you would pull the fee from there. This will allow you to upgrade the fees without a protocol update. The issue here, though, is that you know, the more pools we add, more parameters we add wherever we. If we store this in the ledger head, it'll get polluted wherever we decide to store it somewhere else.

[26:00] Like it may become an issue. So that was what I proposed. I think Niko had a different proposal related to storing the parameters in the ledger pull key, I believe, and maybe you can talk about that right. So I guess, like, what I described was not necessarily where to start. I mean like there's like there are actually different concepts here, because, let's see, it is the other question after. So just maybe one thing that will help me, can we just talk about what parameters there might be that we would need to store other than right? So like the type of things that I think people were talking about. So, for the obvious one is: we have a proof, a puffy right.

[27:00] That's the one that is kind of the really the only parameter and a constant product pool. We have other parameters also, like minimum amounts that we want people to be able to deposit like basically a unit. You can think of it as a unit of deposit or withdrawal that helps with guaranteeing certain levels of liquidity. Basically, when you do all those operations, what there's, I think some of those when you have like the more than two assets type. Of course, those have actually formulas that are getting even more complicated because now you have like different weights for those assets. I think those are like the ones that are known right now, right, I think for like

[28:00] Right now, right, I think for like unison b3 type of pool. You have like a step size also. I mean yeah, it's up to future. So- and there are a few other things that are like, for example, curve has this amplification factor and that would be something else that would have to be stored if we were to use that. Is there an issue with storing all of this in the leisure header. I'm assuming, like you want to get two actually, so the one, actually, I guess, like when I wrote this question, what I was thinking at the time, was more: like, there's this question of if you store the parameter as a global as opposed to be something that is attached to the pull itself, well, that means is that, if you want to ch, if you change the value of that parameter, so if you change the c, for

[29:00] Example, you're actually changing the fee for every pool in existence, every instance. Right, and actually have a hard time to kind of understand how that model works in a world where you have other parameters other than the key, like for the fee. Maybe it works for other parameters, I think it changes the dynamics of the pool so much that you're actually you're really talking about a very different pool at that point and it may not actually be something desirable. This first version is: we are establishing the model that we want going forward and you know, constant product is very special and I don't want to be stuck with that, you know, with whatever choice comes out of that. So you're really focused here on the update. Like updating the

[30:00] What? Should it be possible to update the parameters on an existing pool? It's kind of the main crux here. I think it's yeah, it derives from this choice, right, that is, if it's a global, that means when you update it, you change everywhere, right? My stance on this is that, like, you shouldn't be able to retroactively update things. You know, if you wanted to switch to a different pool, create the new pool, move your money into there and let people vote with their feet or with their money, however you want to say it. My stance on this is more a ux thing than anything else. You know what I really don't like seeing looking on my bank statement and being like: oh, I used to get 1 5 interest, now I get one percent interest. I didn't agree to that. Nobody told me until after my money had already been sitting there for however long. So I don't think I want to impose that on to other people. So a pool would have fixed parameters

[31:00] That could never change once it was initiated somehow. So what you're saying, that would be the stance that I would take on this. I think the only exception to this, might be like: perhaps we might make the exception that these can change during a protocol upgrade, because generally we take the stance that we can change the rules on protocol upgrades. And you know, I don't think anybody would be super offended if all the validators plus went through this huge review process to agree like this is gonna be better uniformly for everybody. So we should make it the de facto. But isn't Nico's point that when you make the second pull, if you wanted to change the fee in a second pull, it would affect the fee in the first pull? Are they coupled like in Siddharth's proposal? And I'll let him talk more about it. But he's offering like these three different fear. In his example he's offering these three different fee tiers and you can imagine being in the mid tier fee. You know

[32:00] You could have the low tier one, the mid, two one, the high tier one, and then you know the validators vote like, okay, we're gonna move the mid tier one from point five to point six or something like that. So it would still be possible to be in a world where there are multiple pools and still have multiple fees, but have them globally controlled so that existing ones get changed anyway. Not saying that I support that, but I think that's possible. But, Siddharth, you can step in here if I'm not hitting this correctly. No, that was right and that, like, the nice thing here is that you and I don't know if this actually matters, but you control the number of possible pools, right? I don't know if that matters for, like liquid liquidity fragmentation, right, like if we allow, if we end up allowing like 10 or 15 constant product pools, like will that be an issue? Or do we assume that everyone will move to the most optimal pool? Optimal pool, like I I'm not sure what will end up happening there.

[33:00] I tend to think that people would have probably eventually settled down onto the right thing, but I also don't think that's a particularly nice user experience. It's like decision paralysis when you get to the grocery store and you're like, wow, there's a 37 brands of corn flakes. Which one am I gonna buy? Yeah, why do you need that in your life? So it's. It does sound like if we were to make any of the parameters mutable, it would only be the fee, right, like if? Like we shouldn't change anything like the curve or anything like that for any of the. You know, if we add a new pool type? Like those should not be mutable, right, I don't think those should be mutable only from like I don't know their. Nikolas shared this very

[34:00] Cool defect report that colton, long ago, had shared with me and I shared with nikola, nikon. He posted it onto sellerdev- which is about changing the curve parameters other than the fee. I say defect report, I guess I should say vulnerability, whatever you want to call it. And if you're interested more, you should review that because it's very scary. I almost feel like this shouldn't be a configurable parameter. And if we do want to introduce a different fee, we can might as well just introduce a new type of pool. Like I think that a new type of pool, like I think that doing like, even if you don't change it for existing pools, I'll still, you know, I'll put

[35:00] Some money into a pool one day, get you know one specific fee and the next day, after the configuration, change. It's a safe type of pool, but now I'm getting like a different type of fee, so that there's like it's just not explicit enough. A couple of people have said: why don't we just introduce a new pool, or why don't we do this? Who is the we in this situation? Does that make sense? I think there are two different ways one could take this. One way to introduce new types of pools would be that it's a protocol change. You know, like, if we're gonna go from having only constant product pools to having constant product rules and I don't know something curve like or balancer with weights or whatever we'd have to. You know the Stellar protocol developers, you know

[36:00] People who work on CAPs, whatever would have to make that happen. Another way to look at we- this is an idea that nikola had a long time ago about having this like, this notion of like, instead of letting people choose any fee they want or any whatever they want, there are some configurations that the validators have voted on are good configurations. When you're creating something, you're basically choosing from that menu of good configurations and so in that setting we could be like validators. You know they voted on saying that, like now, the fee can be both 0 3 and 0 05 you know. So, depending on the context, I think we could be either of those cool things. Are there more questions about parameters? I mean, I feel like there's still a little bit more thinking there that we can sort of do in conversation on the Stellar dev list. I don't want to move on, though if there's important things left to be said,

[37:00] But I feel like we're sort of at a good, point to move on. Right, I agree like the next one is actually related and maybe more interesting actually you want to explain it. Yeah, multiple pull support. Yeah, so it's basically the two proposals are actually quite different there. Like CAP 38 actually allows one asset pair to have arbitrary variations of pools for that one pair, so the variation can be on the curve type. It can be on any, really any other parameter, like we just talked about fee. So you can imagine having two pools on the same, two constant product pools, let's say, on the same asset pair, but one is going

[38:00] To be, you know, super low c and the other is like going to be a high fee and then you know, the market kind of gets inside whatever capital. E7 identifies pools using the pool type and then, related to the thing we are talking about earlier, the fee is global. So at this point the only way you can have multiple pools on a given asset pair is if they defer on type. Do we want to have more of the first kind or the second time, right like which one is maybe more interesting? We want to have, like those,

[39:00] A few number of options right in a for a given type, or do we think that one type enough? I think there are some like fundamental problems with the notion of like one instance of a pool per wait, hold on, actually, let me make sure I understand. Do you mean one instance of a pool per pair? Yeah, of course all this is fair, right, yeah, so one in? I think there's some like fundamental denial of service flaws, with one instance of a pool per pair, which is the question of who gets to choose what that pool will be like. Is it going to be the hyphy one? The low fee one is going to be curve. You know, I think, basically, if there can be multiple types of pools, we probably have to say that all of them can exist for the same pool to avoid having some arbitrary- and by arbitrary you can

[40:00] Always take that to be adversarial decision maker- like: oh, this is a super volatile asset pair where, like you know, constant product with a high fee would be the best. I'm going to put in, you know, a curve with a super low fee to make it so nobody can use this. Don't want that to happen, but here, like you have the, you know, using CAP 37 as, like the like maybe the as a talking point. Like the earlier we were talking about fees, do we think that we want to have more than one few? I mean, I think that we probably want to have more than one tea and not just force like people to pick, like, oh yeah, this is the right fit for you, because

[41:00] I think that different, asset classes actually have different like risk profile and volatility profile and therefore you want to have a different fee. You know, like you basically want the like crypto to crypto assets to have a different, probably a different fee than the stable coin to stable coin. Type of fair right. So yeah, you can let them compete and, like you were saying, like you can't let a single person decide on which one is the first one. So then how do you let the market decide? I think that's kind of what I'm getting. So it would bring market dynamics to bear on these, given uncompeting pools.

[42:00] I don't really like. For me, the reality is I don't really see what we're choosing between. Like the choices in my head are kind of like there is exactly one type of pool and we apply that uniformly across the board, or there's one you know. Maybe you say like okay, like you can have different curves, but all the ones with the same curve have the same fee, whatever, like whatever you kind of take that model at, you're kind of saying like I'm gonna try to fit all the pegs into a single shaped hole. If you take that approach. And if you don't take that approach, then you're basically saying, well, like I'm gonna let the market decide what's the non stupid thing? And I don't like forcing pegs into holes that don't that they don't fit in. So for me it seems kind of like a very kind of obvious choice. But I'm wondering if somebody sees the argument that goes in the other direction, like: is there somebody who's like no, like John, you're definitely wrong.

[43:00] Well, I think the argument I held before on trying to force everybody into the same group is: you avoid, like, splitting the liquidity. But I'm not. That's not my opinion either, you know. So I can't really support it, but that I just wanted to call it out. That's actually one of the argument that people call out. Yeah, I mean, I guess for me it kind of depends a lot on what the set of options are like. You can imagine a world where, like we just imagined that it was possible to create a constant product market maker with a fee at every thousandth of a percent. There's no difference between. I mean they're not literally identical, but there's no material difference between a fiat point three percent or point three zero one percent or point two nine percent.

[44:00] They're kind of like exactly the same. And I think in that world you probably do have liquidity fragmentation between people doing effectively the exact same thing differently, whereas, you know, in a world where you're like, okay, like you have two fees on your constant product- one is like 0 05 and one is one percent- for totally different asset classes, I think there's going to be like a very obvious place that people are going to want to put their money in those kinds of cases and there won't be a lot of blurriness. I'm not 100 sure, but I think the amount of liquidity fragmentation depends on how distinct the options are. But even in that case, if market dynamics work, wouldn't people be drawn to the fool with the lower feet? Right if they were the same, but one even had a tiny bit lower fee, and then the two pools would be competing and they would actually that would push fees lower. Isn't that what you would expect? Not necessarily. Like, for example,

[45:00] If the impermanent, like if prices are moving a lot and so there's a lot of impermanent loss, then people might make more money from the higher fee, even if people traded less as a consequence. And the other factor is, if everybody's in the high fee pool, then and like, let's say that, like, let's suppose a world where there's 99- sorry, 100- equivalent market makers, 99 of them are in the big pool, which has the high fees, and the one other guy is in the small city pool, in like the CAP 38 proposal for like, maybe some small trades would execute against the small pool, the small fee pool, but all the big trades would execute against the big fee pool because there'd be less slippage there, and so maybe that person would end up making less money by being in the low fee pool and then they decide to join the high fuel pool anyway, right? So I think it's not obvious. There's a bunch of different ways these kinds of things could shape out.

[46:00] So I mean, maybe the answer to this is no, but I'm just wondering if there's any. If it's, it just seems better to have only one pool, you know, other than the fact that you would have to agree on the parameters. But I'm wondering if there's any way to kind of select the pool objectively, like basically say that you know, for any given pool, you, if there's multiple pools for an asset pair, you just pick the one that has the highest product or highest product plus reserve where people can pledge some reserve or something, so you can let people sort of bid on what they have, because what you kind of want, is like you want, like you know, in the kind of Stellar fashion of like it's just to everyone's advantage to do what everybody else is doing, which is kind of like the whole philosophy of Stellar. On some level, you kind of would like market forces to decide this, and so to the extent that then somebody, a lot of people, decide that you want to do something else, then it should like make sense to move over to that. That's something else. But I mean that's John briefly mentioned this. My new idea

[47:00] Earlier, so that's kind of what I proposed earlier is basically try to kind of find a good middle ground, right, like you don't want to have like a single pool. You know where you're forcing to this one rate, you know across all assets. You know that's. I think that's kind of trying to. That's too prescriptive on the other hand, if you allow people to set any price, you know any fee and all that you end up with like this huge, like you can't pick a pool, basically like there are an infinite number of pools. So the menu idea is to have validators actually describe the combinations that you are, that you can use on the network, and the combinations would be a combination, for example, like constant product, you can have like low, medium, high, c or something like that, and then when you want to deposit assets in a

[48:00] Pool, you pick which of which item on the menu you want, right, you can say, okay, this is like a stable coin one, so I'm going to pick this scoff paying with this parameter, right, okay? So here's- I think you know this is probably not workable, but just to like, get some design point out there. Suppose that you know, people can sponsor these liquidity pools, using lumens, and basically you can propose any value, any parameter you want. However, in order to introduce a new liquidity pool when there's already one, for that asset pair, two things have to happen: one, you have to pledge more lumens than the previous reserve as pledged, and two, you have to have it like as at least as much liquidity in terms or the product has to be at least as great in terms of the assets you put in there. So this would allow people to change when everybody wanted to change,

[49:00] But it would sort of make it a little. bit sticky. What a? I get what you're getting at here, but like a kind of just practical implementation type question, before we talk about this on the merits, it's just like what about the case when you have pools that were like the product is a different number, the invariant is a different number. You know the curve, invariant is some really complicated thing. That's really gross to write down, and so they're obviously comparable. There would be some requirement that for any pool that we introduce, but there needs to be a depth metric which is a number and where somehow we believe that, in general, deeper markets are better than shallower.

[50:00] How would you, I guess, like what would at like a high level, what would an implementation of all of this kind of look like in an abstract sense, but like we need some new kinds of entries and stuff like what is it like? How do you say that you're voting for one of these pools? Like what does it mean for, like, if you're voting for a pool but the pool doesn't actually work yet, what is, what are? How do all these things kind of work at a high level? Yeah, I guess you have some number of, let's say, you have some number of candidate pools and in order, maybe, in order to create a candidate pool, you have to pledge sort of twice the base reserve that's pledged for the previous one or something. So we can't get like an infinite number of these. And then for the candidate pools, there's some amount of capital that's pledged, and so if one of the candidate pools suddenly gets more or more depth, right, there's some amount of capitalist pledge, and if at

[51:00] Some point one of the candidate pools ends up with more depth than the existing pool, then people would switch over. So the basic assumption here is that, like sort of 90 of the people participating in a liquidity pool would say, hey, like actually we want to go to a lower fee or something right. And so once everybody wants to do that, they can make it happen. But, like you know, a random person who's just trying to disrupt the existing market would have to, like amass a lot of capital and essentially end up making a more liquid market in order to- disrupt the existing market. It's a kind of interesting idea. I'd have to think about that a bit. I like definitely have some concerns along the same line, as somebody mentioned now, I think eric mentioned- about, like this, like ephemeral trust line type of thing. You can imagine somebody putting a lot of putting their money where their mouth is in like a huge amount, and then you know

[52:00] Five ledgers later being like I just did, that to screw you guys all up and then just pulling their money back. On the other hand, if what they did is provided people like really low fee transactions for five ledgers, like is it so bad? Like they could have done the same thing by placing offers on the orderbook, right, it's a fair point. So we only have five minutes left and I think that's fine because I think a lot of these questions can we can continue to sort of talk about them or to think about some of the suggestions that were raised and deal with them. On the Stellar debt mailing list, there were two other topics that we didn't really get into. One was compliance and one was rounding. Do we want to take a second to talk about either of those right now? Would that be useful or is it too much to take on either one of those topics in the last four minutes? It seems hard and for me, I mean, I'm like I'm very interested in talking about these, but in detail,

[53:00] It just seems like it'll be unsatisfying to get into them now. Okay, that makes sense to me, I mean. I think then the question is: what are the next steps after this meeting? Do we- I feel like it is, to continue the discussion on Stellar death? But are there other follow up actions that need to happen in order to make that possible? I'm still trying to understand whether we've narrowed down the scope of which pools can exist and which ones can't like for a given asset pair. Have we agreed we can only have one pool? Or could we have multiple pools with different kinds of curve for that asset pair, for example? Like, I would love to write that down. Well, I think what we were talking about was that we, I think they, we agreed that there would be more than one pool per asset there.

[54:00] What we are talking about last was more about the governance that goes with introducing a new pool. Like you can do it in many ways. The good news is that we don't necessarily have to solve that. I think in this version because right now we're introducing only one constant product and I'm not sure we want to introduce in the first version the support for more than one rate. Right, like we can basically for now, like I think that's what capital e8 says, or even capital e7. That is, there's only one rate and I'm it's probably fine for the very first version, but it's interesting to think about how to change that in the future. Right, if you'd be willing, David, I'd be like very interested to see like a high level write up of what you were describing so I can

[55:00] Of what you were describing so I can think about that more deeply yeah maybe I can just draft something by email or something yeah that'd be fine it doesn't have to be super formal sure and I noticed for the future but there was the idea of a menu right that was sort of validator determined there was this idea of you can replace by better with some depth metric were there any other contenders for ways to do this well that was the question in the first thing right that was don't even allow to have more than one right yeah which is a third option sure okay there's also the free for all option anarchy I love the anarchy every time I'm listening to this I'm like this is we're talking about anarchy or we're talking about like soviet style communism or we're talking about just like free market capitalism I feel like there's ideologies behind all these choices you know John's like there should only be one kind of corn flake

[56:00] Right I can go for like three kinds of corn flakes just to be fair cool yeah you want the you know you're on the special occasion it's your birthday conflict right man I hope you have some like something like flat pink blueberry pancakes on your birthday not cornflakes I don't even know okay that's time thanks everybody and thanks everyone who's watching at home again this discussion will continue on the Stellar dev google group which you can find a link to in the actual event description there's already a lot that's happened there and we will continue to have these discussions in these meetings to start to hammer out more of these proposals but again two proposals a lot of discussion many things that we covered today but many more things to cover look there to see what's happening this conversation will happen both sort of asynchronously there and synchronously here in the future

[57:00] And we really appreciate everyone for being here thanks everyone

</details>
