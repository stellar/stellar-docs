import fs from "fs";
import path from "path";

module.exports = async ({ defaultSidebarItemsGenerator, ...args }) => {
  const docs = args.docs.filter(
    (item) => !/horizon.*\.(api|tag)\.mdx$/.test(item.source)
  );

  // Get the sidebar items that are generated by default
  const sidebarItems = await defaultSidebarItemsGenerator({ ...args, docs });

  const apisOverviewCategory = sidebarItems.find(
    (item) => item.type === "category" && item.label.toLowerCase() === "apis overview",
  );

  if (apisOverviewCategory) {
    const horizonCategory = apisOverviewCategory.items.find(
      (item) => item.type === "category" && item.label.toLowerCase() === "horizon",
    );

    if (horizonCategory) {
      const apiReference = horizonCategory.items.find(
        (item) => item.type === "category" && item.label.toLowerCase() === "api reference",
      );

      if (apiReference) {
        const resources = apiReference.items.find(
          (item) =>
            item.type === "category" && item.label.toLowerCase() === "resources",
        );
        const aggregations = apiReference.items.find(
          (item) =>
            item.type === "category" && item.label.toLowerCase() === "aggregations"
        )

        const sidebarPath = path.join(
          args.version.contentPath,
          args.item.dirName,
          "./apis/horizon/api-reference/sidebar.ts",
        );

        if (resources && fs.existsSync(sidebarPath)) {
          const generatedApiSidebar = require(sidebarPath)[0];

          const categories = resources.items.filter(
            (item) => item.type === "category",
          );

          categories.forEach((category) => {
            const generatedCategory = generatedApiSidebar.items.find(
              (item) => item.type === "category" && item.label === category.label,
            );

            if (generatedCategory) {
              category.items = [...category.items, ...generatedCategory.items];
            }
          });
        }

        if (aggregations && fs.existsSync(sidebarPath)) {
          const generatedApiSidebar = require(sidebarPath)[1];

          const categories = aggregations.items.filter(
            (item) => item.type === "category",
          );

          categories.forEach((category) => {
            const generatedCategory = generatedApiSidebar.items.find(
              (item) => item.type === "category" && item.label === category.label,
            );

            if (generatedCategory) {
              category.items = [...category.items, ...generatedCategory.items];
            }
          });
        }

      }
    }
  }

  // return the sidebar items
  return sidebarItems;
};
