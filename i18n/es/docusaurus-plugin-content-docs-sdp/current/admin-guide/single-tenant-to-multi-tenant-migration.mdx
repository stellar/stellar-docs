---
title: Gu칤a de migraci칩n de 1.x a 2.x
description: Gu칤a de migraci칩n de inquilino 칰nico a inquilino m칰ltiple.
keywords:
  - migration
  - single-tenant
  - multi-tenant
  - SDP
  - 1.x
  - 2.x
sidebar_position: 70
---

import { CodeExample } from "@site/src/components/CodeExample";

Aqu칤 encontrar치s los pasos necesarios para migrar una aplicaci칩n existente de la Stellar Disbursement Platform (SDP) de inquilino 칰nico (`1.x`) a una versi칩n de inquilino m칰ltiple (`2.x+`).

## 쯇or qu칠 migrar?

A partir de la versi칩n `2.x`, la SDP proporciona una arquitectura de inquilino m칰ltiple, donde m칰ltiples organizaciones pueden gestionar desembolsos bajo una infraestructura unificada mientras mantienen conjuntos de datos y gesti칩n de fondos separados.

Las nuevas funciones y correcciones solo se publicar치n en la versi칩n de inquilino m칰ltiple.

La versi칩n de inquilino m칰ltiple tambi칠n se adapta a escenarios de inquilino 칰nico, a trav칠s de una configuraci칩n simplificada que se describir치 m치s adelante en este documento.

:::caution

Esta gu칤a fue preparada y probada con bases de c칩digo `1.1.7 -> 2.1.0`. Si est치s en una versi칩n posterior, es posible que las nuevas migraciones de base de datos causen un error al seguir estos pasos.

Tienes la opci칩n de usar la versi칩n `2.1.0` para realizar esta migraci칩n, y luego actualizar a la 칰ltima versi칩n despu칠s de completar la migraci칩n.

:::

## Preparaci칩n para las migraciones

### Detener la versi칩n de inquilino 칰nico 游뚾

Antes de proceder con la migraci칩n, aseg칰rate de que la versi칩n de inquilino 칰nico de la SDP no est칠 en ejecuci칩n. Esto es crucial para prevenir cualquier inconsistencia de datos o conflictos durante el proceso de migraci칩n.

### Prevenci칩n de doble gasto 游뚿

Para evitar el doble gasto, aseg칰rate de que ning칰n pago est칠 en estado `PENDING`, de lo contrario, esto podr칤a resultar en tener el mismo pago enviado de manera independiente por las instancias de inquilino 칰nico y de inquilino m칰ltiple. Puedes hacer esto revisando la tabla `payments` por cualquier pago en estado `PENDING`:

<CodeExample>

```sql
SELECT * FROM public.payments WHERE status = ANY(array['PENDING']::payment_status[]);
```

</CodeExample>

De manera similar, revisa la tabla `submitter_transactions` por cualquier transacci칩n en estado `PENDING`:

<CodeExample>

```sql
SELECT * FROM public.submitter_transactions WHERE status = ANY(array['PROCESSING']::transaction_status[]);
```

</CodeExample>

Si hay alg칰n pago en estado `PENDING` o transacciones en estado `PROCESSING`, deber칤as esperar a que se procesen y se transicionen a `SUCCESS` o `FAILED` antes de continuar con la migraci칩n.

### Eliminar cuentas de canal 游빛

En la versi칩n `2.x`, las cuentas de canal est치n cifradas utilizando el `CHANNEL_ACCOUNT_ENCRYPTION_PASSPHRASE`, que es un entorno diferente del que se utiliz칩 en la versi칩n de inquilino 칰nico (`DISTRIBUTION_SEED`). Para evitar problemas, eliminemos todas las cuentas de canal existentes en la versi칩n de inquilino 칰nico antes de la migraci칩n:

<CodeExample>

```bash
./stellar-disbursement-platform channel-accounts delete --delete-all-accounts
```

</CodeExample>

### Copia de seguridad y configuraci칩n de base de datos 游

Haz una copia de seguridad de tu base de datos de inquilino 칰nico antes de proceder con la migraci칩n. En este punto, la instancia de inquilino 칰nico debe estar detenida, y no debe haber pagos en estado `PENDING` ni `PROCESSING` en submitter_transactions.

Tambi칠n se recomienda que crees una nueva base de datos para la versi칩n de inquilino m칰ltiple para evitar cualquier p칠rdida de datos. Usa el volcado de la base de datos de inquilino 칰nico para poblar el estado inicial de esta de inquilino m칰ltiple. A partir de este punto, cada vez que nos referimos a **la base de datos**, nos referiremos a la nueva base de datos de inquilino m칰ltiple que se cre칩 a partir de un volcado de la base de datos de inquilino 칰nico.

As칤 es como puedes hacer la copia de seguridad y la restauraci칩n:

<CodeExample>

```bash
pg_dump --dbname=$singleTenantDB > sdp-singleTenant.sql
createdb $multiTenantDB
psql --dbname=$multiTenantDB < sdp-singleTenant.sql
```

</CodeExample>

## Cambios explicados

Entre los cambios introducidos en la versi칩n de inquilino m칰ltiple, los m치s significativos son:

1. **Infraestructura**: la versi칩n de inquilino m칰ltiple incluye un corredor de eventos (Kafka) como un componente de infraestructura adicional que es altamente recomendado para configuraciones de inquilino m칰ltiple, especialmente cuando se requiere un alto rendimiento.
2. **Variables de entorno**: la versi칩n de inquilino m칰ltiple introduce nuevas variables de entorno para configurar el corredor de eventos, as칤 como variables adicionales relevantes para la multi-tenencia.
3. **Segregation of Funds**: the multi-tenant version introduces the concept of a distribution account for each tenant, which is used to submit transactions on behalf of the tenant. Tambi칠n existe la cuenta de distribuci칩n HOST, que se utiliza para financiar las cuentas de distribuci칩n de los inquilinos y las cuentas de canal TSS.
4. **Comandos CLI**: algunos comandos de CLI han sido revisados para ser conscientes del inquilino, mientras que otros han sido incluidos para soportar nuevas caracter칤sticas de inquilino m칰ltiple.
5. **Estructura de la base de datos**: la estructura de la base de datos ha sido revisada para acomodar la multi-tenencia y las tablas ahora est치n distribuidas en m칰ltiples esquemas, proporcionando aislamiento entre los inquilinos.

### Infraestructura

Para la configuraci칩n de la infraestructura, SDP Multi-tenant ofrece modos operativos flexibles.

#### Corredor de eventos frente a trabajos programados

Los administradores pueden elegir entre usar un corredor de eventos para operaciones impulsadas por eventos, o trabajos programados para operaciones peri칩dicas. Se recomiendan corredores de eventos para configuraciones de inquilino m칰ltiple, ya que proporcionan una forma escalable y confiable de manejar eventos, mientras que los trabajos programados son recomendados para configuraciones locales o SDPs de inquilino 칰nico. Adem치s, los corredores de eventos proporcionan una comunicaci칩n m치s r치pida entre servicios.

#### Versi칩n de Anchor Platform

Mientras que la versi칩n de inquilino 칰nico us칩 [`stellar/anchor-platform:2.1.3`](https://hub.docker.com/layers/stellar/anchor-platform/2.1.3/images/sha256-e6ef4b17a8d3e5d1455fa3d8f5f7e2a2b9534ad749584ff5446d685eb07837e9?context=explore), la versi칩n de inquilino m칰ltiple requiere [`stellar/anchor-platform:2.6.0`](https://hub.docker.com/layers/stellar/anchor-platform/2.6.0/images/sha256-913fa2461d36d5150724a172ca46f8c76284a3890b60a9d5709fe0c606af78b9) o posterior.

### Variables de entorno

A continuaci칩n se presentan las variables de entorno que se han agregado o modificado en la versi칩n de inquilino m칰ltiple.

Variables de entorno generales:

- `ADMIN_ACCOUNT`: El nombre de usuario de la cuenta de administrador utilizada para autenticar las solicitudes HTTP al servidor de administraci칩n. Las solicitudes dirigidas a la administraci칩n deben agregar el encabezado "Authorization", formateado como Base64 codificado `"ADMIN_ACCOUNT:ADMIN_API_KEY"`.
- `ADMIN_API_KEY`: La clave API de la cuenta de administrador utilizada para autenticar las solicitudes HTTP al servidor de administraci칩n. Las solicitudes dirigidas a la administraci칩n deben agregar el encabezado "Authorization", formateado como Base64 codificado `"ADMIN_ACCOUNT:ADMIN_API_KEY"`.
- `ADMIN_PORT`: el puerto del servidor de administraci칩n utilizado para crear y gestionar inquilinos. El valor por defecto es 8003.
- `INSTANCE_NAME`: el nombre de la instancia de SDP que se mostrar치 en el archivo `stellar.toml`. Ejemplo: "SDP Testnet".
- `SINGLE_TENANT_MODE`: Cuando se establece en `"true"`, habilita el modo de inquilino 칰nico, que es 칰til para el desarrollo local o configuraciones de inquilino 칰nico. Adem치s de establecerlo en verdadero, necesitar치s configurar el inquilino predeterminado llamando a la solicitud [`POST /tenants/default-tenant`](../api-reference/default-tenant.api.mdx).
- `TENANT_XLM_BOOTSTRAP_AMOUNT`: La cantidad de XLM que la cuenta Stellar HOST depositar치 en la cuenta de distribuci칩n del inquilino para su arranque.

Variables de entorno para la configuraci칩n de cuentas Stellar:

- `CHANNEL_ACCOUNT_ENCRYPTION_PASSPHRASE`: Una clave privada ed25519 compatible con Stellar utilizada para cifrar/desfijar las claves privadas de las cuentas de canal. Cuando no est치 configurado, se utilizar치 el valor de la opci칩n 'distribution-seed', que fue utilizada en la versi칩n de inquilino 칰nico. **Atenci칩n**, al migrar desde el inquilino 칰nico, establecer esta configuraci칩n en algo diferente del antiguo `DISTRIBUTION_SEED` impedir치 que el c칩digo pueda descifrar las cuentas de canal.
- `DISTRIBUTION_ACCOUNT_ENCRYPTION_PASSPHRASE`: Una clave privada ed25519 compatible con Stellar utilizada para cifrar/desfijar las claves privadas de las cuentas de distribuci칩n en memoria.

Variables de entorno para la configuraci칩n del corredor de eventos:

- `BROKER_URLS`: Una lista separada por comas de las URL del corredor de mensajes.
- `CONSUMER_GROUP_ID`: Especifica un ID de grupo para los consumidores del corredor.
- `EVENT_BROKER_TYPE`: Especifica el tipo de corredor de eventos que se utilizar치. Opciones: "KAFKA", "NONE". El valor por defecto es "Kafka".
- `KAFKA_SECURITY_PROTOCOL`: Define el protocolo de seguridad para Kafka. Opciones: PLAINTEXT, SASL_PLAINTEXT, SASL_SSL, SSL.
- `KAFKA_SASL_USERNAME`: Especifica el nombre de usuario SASL de Kafka, requerido cuando el protocolo de seguridad de Kafka se establece en `SASL_PLAINTEXT` o `SASL_SSL`.
- `KAFKA_SASL_PASSWORD`: Especifica la contrase침a SASL de Kafka, requerida cuando el protocolo de seguridad de Kafka se establece en `SASL_PLAINTEXT` o `SASL_SSL`.
- `KAFKA_SSL_ACCESS_KEY`: La clave de acceso de Kafka (almacenamiento de claves) en formato PEM, requerida cuando el protocolo de seguridad de Kafka se establece en `SSL`.
- `KAFKA_SSL_ACCESS_CERTIFICATE`: El certificado de acceso SSL de Kafka en formato PEM que coincide con la clave de acceso de Kafka, requerido cuando el protocolo de seguridad de Kafka se establece en `SSL`.

Variables de entorno del programador:

- `ENABLE_SCHEDULER`: Por defecto "false". Esto habilita trabajos programados que reemplazan las operaciones de un corredor para sincronizar pagos entre SDP y TSS, as칤 como para enviar invitaciones a receptores. Deber칤a establecerse en "true" cuando el corredor de eventos est칠 deshabilitado. It should be set to "true" when the event broker is disabled.
- `SCHEDULER_PAYMENT_JOB_SECONDS`: Interval in seconds for the job that synchronizes payments between SDP and TSS. Minimum is 5s.
- `SCHEDULER_RECEIVER_INVITATION_JOB_SECONDS`: Interval in seconds for the job that submits receiver invitations. El m칤nimo es 5s.

Del lado de Anchor Platform, debemos establecer las siguientes variables:

- `SEP10_HOME_DOMAINS="localhost:8000, *.stellar.local:8000"`: una lista separada por comas de dominios principales utilizados para [SEP-10]. Esto deber칤a contener los dominios de las instancias de inquilino de la SDP.
- `SEP10_HOME_DOMAIN=""`: esto deber칤a ser una cadena vac칤a para la versi칩n de inquilino m칰ltiple.
- `SEP10_WEB_AUTH_DOMAIN=<localhost:8080>`: el dominio principal de la instancia de la Anchor Platform.

### Segregaci칩n de fondos

En la versi칩n de inquilino m칰ltiple, los fondos de los inquilinos est치n aislados entre s칤 **a menos que el inquilino sea creado con `"distribution_account_type": "DISTRIBUTION_ACCOUNT.STELLAR.ENV"`**. Para m치s informaci칩n sobre los tipos de cuentas de distribuci칩n, consulta la secci칩n de [Provisionamiento de inquilinos](./tenant-provisioning.mdx#creating-tenants).

Las cuentas de canal, por otro lado, son compartidas entre inquilinos, y son creadas por la cuenta de distribuci칩n HOST, configurada en la variable de entorno `DISTRIBUTION_SEED`. Las cuentas de canal est치n cifradas utilizando la variable de entorno `CHANNEL_ACCOUNT_ENCRYPTION_PASSPHRASE`, o el `DISTRIBUTION_SEED` si la primera no est치 configurada. En la versi칩n de inquilino 칰nico, las cuentas de canal estaban cifradas por el `DISTRIBUTION_SEED`. En la versi칩n de inquilino 칰nico, las cuentas de canal estaban encriptadas por el `DISTRIBUTION_SEED`.

### Comandos CLI

Los siguientes comandos de CLI se actualizaron para ser conscientes del inquilino:

#### Migraciones de base de datos y poblaci칩n

Los comandos de inquilino 칰nico para la migraci칩n de la base de datos y la pre-poblaci칩n sol칤an ser:

<CodeExample>

```bash
./stellar-disbursement-platform db migrate up           # 丘멆잺 DECOMISSIONED in 2.x!
./stellar-disbursement-platform db auth migrate up      # 丘멆잺 2.x REQUIRES A (NEW) TENANT-AWARE FLAG!
./stellar-disbursement-platform db setup-for-network    # 丘멆잺 2.x REQUIRES A (NEW) TENANT-AWARE FLAG!
```

</CodeExample>

Los nuevos comandos de inquilino m칰ltiple son:

<CodeExample>

```bash
./stellar-disbursement-platform db admin migrate up
./stellar-disbursement-platform db tss migrate up
./stellar-disbursement-platform db auth migrate up --all
./stellar-disbursement-platform db sdp migrate up --all
./stellar-disbursement-platform db setup-for-network --all
```

</CodeExample>

Por favor, ten en cuenta que algunos comandos requieren una bandera consciente del inquilino, que puede ser:

- `--all`: para ejecutar estas migraciones en todos los inquilinos.
- `--tenant-id`: para especificar el ID del inquilino para ejecutar las migraciones.

#### Cuentas de canal

El comando ensure se actualiz칩 de utilizar la bandera `--num-channel-accounts-ensure` a usar un argumento posicional:

<CodeExample>

```bash
./stellar-disbursement-platform channel-accounts ensure --num-channel-accounts-ensure 1 # OLD WAY
./stellar-disbursement-platform channel-accounts ensure 1                               # NEW WAY
```

</CodeExample>

### Estructura de la base de datos

En la versi칩n actualizada, la estructura de la base de datos ha sido revisada para acomodar la multi-tenencia. Como resultado, las tablas ahora est치n distribuidas en m칰ltiples esquemas, y se han introducido nuevas tablas para soportar la arquitectura de inquilino m칰ltiple. Los siguientes esquemas son utilizados en la versi칩n de inquilino m칰ltiple:

- **admin**: alberga tablas asociadas a la administraci칩n de inquilinos. Sirve como el punto central para gestionar informaci칩n relacionada con inquilinos y resolver nombres de esquemas de inquilinos basados en IDs de inquilinos. Ninguna de estas tablas exist칤a en la versi칩n de inquilino 칰nico.
- **sdp\_&lt;nombre del inquilino&gt;**: son esquemas por inquilino que est치n precedidos por `sdp_`. Por ejemplo, para los inquilinos BlueCorp y RedCorp, los esquemas provisionados se llamar칤an `sdp_bluecorp` y `sdp_redcorp`, respectivamente. Estos esquemas contienen todas las tablas necesarias para la operaci칩n de la SDP adaptadas a cada inquilino, incluida la autenticaci칩n de usuarios por inquilino.
- **tss**: es un esquema dedicado al Servicio de Presentaci칩n de Transacciones (TSS). Las tablas TSS no pertenecen a ning칰n inquilino, aunque cada transacci칩n TSS contiene una columna que indica a qu칠 inquilino pertenece.

Estos cambios permiten el aislamiento de los datos de los inquilinos por esquema, asegurando que los datos de cada inquilino se mantengan separados de los dem치s.

## Gu칤a de migraci칩n paso a paso

:::tip

El proyecto tiene un [script](https://github.com/stellar/stellar-disbursement-platform-backend/blob/4420bba6628546918dfcca027ac504898121fed9/internal/integrationtests/scripts/singletenant_to_multitenant_db_migration_test.sh) que realiza estos pasos, as칤 como un [CI](https://github.com/stellar/stellar-disbursement-platform-backend/blob/4420bba6628546918dfcca027ac504898121fed9/.github/workflows/singletenant_to_multitenant_db_migration_test.yml) que asegura que estos pasos funcionen. Puedes usarlos como referencia. Puedes usarlos como referencia.

:::

Usando la nueva base de datos creada a partir del volcado de la base de datos de inquilino 칰nico como punto de partida (como se describe en la secci칩n de [Copia de seguridad y configuraci칩n de la base de datos](#database-backup--setup-)), ahora podemos proceder con los pasos de migraci칩n a continuaci칩n.

### Desplegar la nueva versi칩n

Para transitar a una configuraci칩n de inquilino m칰ltiple, despliega la 칰ltima versi칩n de la SDP `2+`. Si est치s utilizando gr치ficos Helm, puedes obtener el gr치fico Helm del [repositorio de gr치ficos de SDP](https://github.com/stellar/helm-charts/pull/80).

### Ejecutando migraciones iniciales de base de datos

Tras el despliegue de la SDP de inquilino m칰ltiple, el siguiente paso es realizar las iniciales **migraciones de base de datos**. No incluye a칰n las tablas espec칤ficas del inquilino, se crear치n m치s adelante.

Comandos de migraci칩n:

<CodeExample>

```bash
./stellar-disbursement-platform db admin migrate up
./stellar-disbursement-platform db tss migrate up
```

</CodeExample>

Estos comandos crear치n las tablas de administraci칩n de inquilinos en el esquema **admin** y las tablas del Servicio de Presentaci칩n de Transacciones en el esquema **tss**, respectivamente.

### Nuevo proceso de aprovisionamiento de inquilinos

Despu칠s de aplicar con 칠xito las migraciones de base de datos, el siguiente paso es aprovisionar un nuevo inquilino. Esto se logra haciendo una solicitud HTTP a la **API de administraci칩n**.

Ten en cuenta que se aprovisionar치 a los inquilinos con todas las migraciones por inquilino incluidas.

#### Iniciando el servidor API de SDP

Para facilitar el aprovisionamiento de inquilinos, inicia el servidor SDP usando el comando:

<CodeExample>

```bash
./stellar-disbursement-platform serve
```

</CodeExample>

#### Publicando en la API de administraci칩n

- **Puerto de la API**: La API de Admin es accesible en el puerto `8003` por defecto. Esta configuraci칩n del puerto se puede ajustar alterando la variable de entorno `ADMIN_PORT`.
- **Autenticaci칩n**: La API de Admin emplea Autenticaci칩n B치sica para asegurar el acceso. Para autenticarte, completa el encabezado de la solicitud "Authorization" con `"Authorization: Basic ${Base64(ADMIN_ACCOUNT:ADMIN_API_KEY)}"`.

Aqu칤 hay un script de shell que se puede usar para crear un inquilino a trav칠s de la API de Admin:

<CodeExample>

```bash
ADMIN_ACCOUNT="SDP-admin"
ADMIN_API_KEY="api_key_1234567890"
basicAuthCredentials=$(echo -n "$ADMIN_ACCOUNT:$ADMIN_API_KEY" | base64)
AuthHeader="Authorization: Basic $basicAuthCredentials"

tenant="bluecorp"
baseURL="http://$tenant.stellar.local:8000"
sdpUIBaseURL="http://$tenant.stellar.local:3000"
ownerEmail="owner@$tenant.org"
# NOTE: please refer to the distribution_account_type values in the API reference
distributionAccountType="DISTRIBUTION_ACCOUNT.STELLAR.DB_VAULT"

curl -X POST http://localhost:8003/tenants \
     -H "Content-Type: application/json" \
     -H "$AuthHeader" \
     -d '{
            "name": "'"$tenant"'",
            "organization_name": "Blue Corp",
            "base_url": "'"$baseURL"'",
            "sdp_ui_base_url": "'"$sdpUIBaseURL"'",
            "owner_email": "'"$ownerEmail"'",
            "owner_first_name": "john",
            "owner_last_name": "doe",
            "distribution_account_type": "'"$distributionAccountType"'"
     }'
```

</CodeExample>

En el SDP de varios inquilinos, ciertas configuraciones que anteriormente se gestionaban a trav칠s de variables de entorno en la configuraci칩n de inquilino 칰nico ahora se almacenan en la tabla **tenants** en el esquema de administraci칩n. Este cambio permite que cada inquilino tenga su propia configuraci칩n personalizada.

El campo **name** es importante porque es el identificador del inquilino. Los otros campos se pueden establecer con los mismos valores utilizados en las variables de entorno de la versi칩n sin inquilino.

### Importando tus datos

Ahora que hemos provisionado un nuevo inquilino, podemos importar nuestros datos en 칠l. Necesitamos copiar los datos de nuestras antiguas tablas al nuevo esquema de inquilino.

Ten en cuenta que las siguientes tablas no necesitan ser copiadas:

- **_gorp_migrations_**
- **_auth_migrations_**
- **_organizations_**

Para ayudar con el proceso de importaci칩n, hemos agregado una funci칩n al esquema de `admin` que copiar치 los datos de las tablas v1 ubicadas en el esquema p칰blico al nuevo esquema de inquilino. La funci칩n se llama `import_tenant_data_from_v1_to_v2` y recibe como par치metro el nombre del inquilino. El nombre del inquilino debe ser el mismo que el `$name` utilizado en la llamada de la API para crear el inquilino.

<CodeExample>

```sql
    SELECT admin.migrate_tenant_data_from_v1_to_v2('tenant_name')
```

</CodeExample>

Esto concluye la migraci칩n de los datos del SDP a la versi칩n de varios inquilinos. El siguiente paso es eliminar las antiguas tablas que ya no son necesarias.

### Eliminar tablas antiguas

Ahora, el 칰nico paso que falta es eliminar las tablas de inquilino 칰nico que no deber칤an estar en la base de datos de varios inquilinos:

<CodeExample>

```sql
BEGIN TRANSACTION;

DROP TABLE public.messages CASCADE;
DROP TABLE public.payments CASCADE;
DROP TABLE public.disbursements CASCADE;
DROP TABLE public.receiver_verifications CASCADE;
DROP TABLE public.receiver_wallets CASCADE;
DROP TABLE public.auth_user_password_reset CASCADE;
DROP TABLE public.auth_user_mfa_codes CASCADE;
DROP TABLE public.receivers CASCADE;
DROP TABLE public.auth_users CASCADE;
DROP TABLE public.wallets_assets CASCADE;
DROP TABLE public.assets CASCADE;
DROP TABLE public.wallets CASCADE;
DROP TABLE public.organizations CASCADE;
DROP TABLE public.gorp_migrations CASCADE;
DROP TABLE public.auth_migrations CASCADE;
DROP TABLE public.submitter_transactions CASCADE;
DROP TABLE public.channel_accounts CASCADE;

COMMIT;
```

</CodeExample>

### Conclusi칩n 游꿀

Esto deber칤a concluir la migraci칩n de datos de la versi칩n de inquilino 칰nico a la versi칩n de varios inquilinos del SDP. Por favor, aseg칰rate de ejecutar una prueba e2e para garantizar que todo funcione como se espera.

[SEP-10]: https://stellar.org/protocol/sep-10
