---
title: Hacer Que Tu Billetera Sea Compatible con SDP
sidebar_position: 80
---

import { CodeExample } from "@site/src/components/CodeExample";

Recuerda que cualquier instancia de SDP necesitar谩 un acuerdo con un proveedor de billetera antes de enviar desembolsos a esa billetera. Esto asegura que las billeteras se sientan c贸modas recibiendo fondos de tu organizaci贸n y regula cualquier acuerdo comercial entre las organizaciones. La billetera necesitar谩 permitir la lista blanca del dominio de SDP antes de que el SDP pueda enviar desembolsos a esa billetera. Cuando el dominio de la billetera es a帽adido a un SDP, efectivamente est谩 siendo incluido en la lista blanca por el SDP. Ambas partes listando la otra les permite recuperar el archivo stellar.toml y verificar la clave de firma necesaria para el apret贸n de manos [SEP-10](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0010.md).

En esta p谩gina, cubriremos los aspectos t茅cnicos de la integraci贸n de SDP-Billetera, incluyendo c贸mo a帽adir una billetera en la base de datos de SDP, c贸mo validar y admitir los enlaces de registro utilizando el [deep linking](https://en.wikipedia.org/wiki/Mobile_deep_linking) de la aplicaci贸n m贸vil, c贸mo iniciar el flujo de registro de usuario en la billetera usando [SEP-24](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0024.md), y un enfoque recomendado para manejar [deferred deep linking].

## A帽adir una Billetera a un SDP

La lista predeterminada de billeteras SDP depende de qu茅 red se est茅 utilizando (testnet o pubnet). La red se pasa como una variable de entorno y luego la lista de billeteras puede ser sembrada apropiadamente al iniciar SDP a trav茅s del comando de CLI `./stellar-disbursement-platform db setup-for-network`, de acuerdo con una lista codificada de billeteras conocidas. Alternativamente, las billeteras pueden ser insertadas directamente en la base de datos de SDP a trav茅s de un comando SQL. Ambos m茅todos requieren agregar el nombre de la billetera, la p谩gina de inicio, el dominio del cliente SEP-10 y el esquema del enlace profundo.

Para insertarlo directamente en la base de datos, actualiza tus valores y ejecuta la siguiente consulta de Postgres. Aseg煤rate de verificar tu base de datos y espacio de nombres primero.

<CodeExample>

```sql
INSERT INTO wallets (name, homepage, deep_link_schema, sep_10_client_domain)
VALUES ('Vibrant Assist', 'https://vibrantapp.com', 'https://vibrantapp.com/sdp', 'api.vibrantapp.com');
```

</CodeExample>

Para configurar una billetera a trav茅s del c贸digo, a帽谩dela a la secci贸n de testnet o pubnet de `DefaultWalletsNetworkMap`. Esto se usar谩 cuando ejecutes el comando CLI `./stellar-disbursement-platform db setup-for-network`, que actualiza la base de datos de SDP y hace que la billetera est茅 disponible para nuevos desembolsos. A帽ade tu nueva billetera siguiendo el mismo formato que ya est谩 presente en el c贸digo.

<CodeExample>

```go
var DefaultWalletsNetworkMap = WalletsNetworkMapType{
	utils.PubnetNetworkType: {
		{
			Name:              "Vibrant Assist",
			Homepage:          "https://vibrantapp.com/assist",
			DeepLinkSchema:    "https://vibrantapp.com/sdp",
			SEP10ClientDomain: "api.vibrantapp.com",
		},
	},
	utils.TestnetNetworkType: {
		{
			Name:              "Vibrant Assist",
			Homepage:          "https://vibrantapp.com",
			DeepLinkSchema:    "https://vibrantapp.com/sdp-dev",
			SEP10ClientDomain: "api-dev.vibrantapp.com",
		},
		{
			Name:              "Demo Wallet",
			Homepage:          "https://demo-wallet.stellar.org",
			DeepLinkSchema:    "https://demo-wallet.stellar.org",
			SEP10ClientDomain: "demo-wallet-server.stellar.org",
		},
	},
}
```

</CodeExample>

## Experiencia de Registro del Destinatario

La experiencia de registro del destinatario es primordial para que esta aplicaci贸n sea fluida y f谩cil de usar. Esto requiere que la billetera admita [deferred deep linking], que se discutir谩 en una secci贸n posterior. Una buena descripci贸n de la experiencia de registro es la siguiente:

1. El destinatario recibe un mensaje de invitaci贸n notific谩ndole que tiene un pago esperando de la organizaci贸n y le solicita hacer clic en un [deep link](https://en.wikipedia.org/wiki/Mobile_deep_linking) para abrir o instalar y abrir una aplicaci贸n de billetera

2. Cuando el destinatario abre la aplicaci贸n de billetera, la billetera a bordo inmediatamente al destinatario, crea una cuenta Stellar y una l铆nea de confianza para el activo deseado, inicia una transacci贸n de dep贸sito [SEP-24](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0024.md) con el SDP, y abre la p谩gina de registro del SDP como una pantalla de superposici贸n/iframe dentro de la aplicaci贸n.

3. El usuario confirma su n煤mero de tel茅fono y fecha de nacimiento directamente con el SDP, sin compartir ning煤n dato con la billetera, y despu茅s de que finaliza el registro, el usuario es enviado de nuevo a la aplicaci贸n de billetera. Aqu铆 est谩n las pantallas que demuestran estos pasos:

  

![Flujo de Registro](/assets/sdp/27.png)

4. El usuario recibe el pago en cuesti贸n de segundos

## Enlace Profundo de Registro

Una vez que el usuario ha instalado la aplicaci贸n de billetera, la billetera deber铆a ser capaz de interpretar un [deep link](https://en.wikipedia.org/wiki/Mobile_deep_linking) que sigue el formato registrado en el SDP para iniciar el [Procedimiento de Registro de Billetera](#wallet-registration-procedure). El formato de enlace profundo admitido por el SDP sigue este formato:

```url
https://<host-with-optional-path>?asset=<asset>&domain=<domain>&name=<name>&signature=<signature>
```

- `asset`: el activo Stellar.
- `domain`: el dominio que aloja el archivo `stellar.toml` de SDP. La billetera necesitar谩 usarlo tanto para obtener el archivo `stellar.toml`, como para poblar el campo `home_domain` en la transacci贸n de GET de desaf铆o [SEP-10](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0010.md).
- `name`: el nombre de la organizaci贸n que env铆a pagos.
- `signature`: una firma de la clave de firma de [SEP-10](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0010.md) de SDP.

:::info

Ten en cuenta que el enlace profundo es espec铆fico para cada SDP, organizaci贸n pagadora y activo. No es espec铆fico por receptor individual. No hay riesgo en compartir el enlace con receptores que forman parte del mismo desembolso. El enlace ser谩 el mismo para m煤ltiples receptores y demostrar谩n su identidad como parte del flujo de dep贸sito [SEP-24](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0024.md).

:::

A continuaci贸n se muestra un ejemplo de un enlace de registro (firmado)

```url
https://vibrantapp.com/sdp-dev?asset=USDC-GBBD47IF6LWK7P7MDEVSCWR7DPUWV3NY3DTQEVFL4NAT4AQH3ZLLFLA5&domain=ap-stellar-disbursement-platform-backend-dev.stellar.org&name=Stellar+Test&signature=fea6c5e805a29b903835bea2f6c60069113effdf1c5cb448d4948573c65557b1d667bcd176c24a94ed9d54a1829317c74f39319076511512a3e697b4b746ae0a
```

En este ejemplo, el host es `https://vibrantapp.com/sdp-dev` y la firma es el resultado de firmar la siguiente url (sin firmar) utilizando la clave de firma [SEP-10](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0010.md) `SBUSPEKAZKLZSWHRSJ2HWDZUK6I3IVDUWA7JJZSGBLZ2WZIUJI7FPNB5`, siendo la clave p煤blica `GBFDUUZ5ZYC6RAPOQLM7IYXLFHYTMCYXBGM7NIC4EE2MWOSGIYCOSN5F`:

```url
https://vibrantapp.com/sdp-dev?asset=USDC-GBBD47IF6LWK7P7MDEVSCWR7DPUWV3NY3DTQEVFL4NAT4AQH3ZLLFLA5&domain=ap-stellar-disbursement-platform-backend-dev.stellar.org&name=Stellar+Test
```

En este ejemplo, la firma es `fea6c5e805a29b903835bea2f6c60069113effdf1c5cb448d4948573c65557b1d667bcd176c24a94ed9d54a1829317c74f39319076511512a3e697b4b746ae0a`.

A continuaci贸n se muestra un fragmento de JavaScript que demuestra c贸mo verificar la firma:

```js
#!/usr/bin/env node

const { Keypair } = require("stellar-sdk");

// The SDP's stellar.toml SIGNING_KEY
//
// For security, this should ideally be fetched from
// https://<domain>/.well-known/stellar.toml on demand
const keypair = Keypair.fromPublicKey(
  "GBFDUUZ5ZYC6RAPOQLM7IYXLFHYTMCYXBGM7NIC4EE2MWOSGIYCOSN5F",
);
console.log("public key:", keypair.publicKey());

let url =
  "https://vibrantapp.com/sdp-dev?asset=USDC-GBBD47IF6LWK7P7MDEVSCWR7DPUWV3NY3DTQEVFL4NAT4AQH3ZLLFLA5&domain=ap-stellar-disbursement-platform-backend-dev.stellar.org&name=Stellar%20Test";
let signature =
  "fea6c5e805a29b903835bea2f6c60069113effdf1c5cb448d4948573c65557b1d667bcd176c24a94ed9d54a1829317c74f39319076511512a3e697b4b746ae0a";

console.log(
  "verified:",
  keypair.verify(
    Buffer.from(url.toString(), "utf8"),
    Buffer.from(signature, "hex"),
  ),
);
```

### Procedimiento de Registro de Billetera

Al abrir el [deep link](https://en.wikipedia.org/wiki/Mobile_deep_linking) de registro, estos son los pasos que la billetera deber铆a seguir para hacer cumplir las medidas de seguridad y privacidad esperadas en este flujo, y permitir que el usuario ingrese su informaci贸n directamente con el SDP:

1.  Confirma que el `domain` del enlace profundo est谩 en la lista blanca de la billetera. Esto es crucial para autenticar desde una billetera de confianza.
2. Obt茅n el archivo toml de SDP en `{domain}/.well-known/stellar.toml` y confirma que la variable `SIGNING_KEY` est茅 poblada.
3. Verifica que la firma del enlace de registro se haya realizado utilizando `SIGNING_KEY` similar a la funci贸n `keypairPk.verify(...)` en el fragmento anterior, y que la firma sea v谩lida con el contenido del enlace.
4. Verifica el `asset` del enlace y confirma que el usuario destinatario tenga una l铆nea de confianza para ese activo. Crea una si no existe.
5. (Opcional) Usa el `name` del enlace para actualizar la interfaz de usuario de la billetera.
6. Inicia el flujo de dep贸sito [SEP-24](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0024.md) con ese activo usando el valor de `TRANSFER_SERVER_SEP0024` del archivo toml de SDP.
   - Esto incluye utilizar [SEP-10](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0010.md) para autenticar al usuario con el servidor SDP. Por favor nota que el SDP requiere que tanto el campo `client_domain` como el `home_domain` sean proporcionados en la solicitud `GET <WEB_AUTH_ENDPOINT>`, y deben establecerse de la siguiente manera:
     - `client_domain`: el dominio del servidor de billetera que expone el archivo `stellar.toml` del servidor de billetera.
   - `home_domain`: el dominio del servidor de SDP que estaba presente en el enlace de registro.
   - `account`: la cuenta Stellar de la billetera del receptor.
7. Lanza el flujo de dep贸sito en un navegador _in-app_ interactivo dentro de tu aplicaci贸n m贸vil, siguiendo las instrucciones en la especificaci贸n [SEP-24](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0024.md).
   - ATENCIN: la billetera no debe, bajo ninguna circunstancia, extraer o intentar extraer el contenido del navegador _in-app_ para obtener la informaci贸n del destinatario.
   - NOTA: se recomienda encarecidamente usar un navegador _in-app_ en lugar de una webview.
8.  隆Felicidades! El usuario destinatario puede ahora completar los formularios en el navegador _in-app_ y registrarse para recibir su pago .

Adem谩s, la billetera deber铆a guardar el enlace y/o atributos del enlace y asociarlo con el usuario receptor individual por estas razones:

1. As铆 es como la billetera sabr谩 que el usuario est谩 asociado con una cierta organizaci贸n o SDP.
2. Guardar los datos es 煤til para reportar y solucionar problemas, especialmente si la billetera necesita justificar la fuente de fondos por motivos regulatorios o fiscales.
3. Si la organizaci贸n pagadora quiere pagar cualquier tarifa de retiro cobrada por la billetera o el serviciador, la billetera necesitar谩 saber qu茅 usuarios y transacciones deber铆an ser facturadas hacia arriba.

### Enlaces Profundos Diferidos

Es muy probable que el destinatario previsto no tenga instalada la aplicaci贸n de billetera necesaria en su dispositivo. Por esta raz贸n, las billeteras deber铆an soportar el concepto de [deferred deep linking], que habilita el siguiente flujo:

1. La acci贸n inicial del destinatario de hacer clic en el enlace profundo deber铆a redirigirlo a la tienda de aplicaciones correspondiente para descargar la aplicaci贸n de billetera.
2. Despu茅s de instalar y abrir la aplicaci贸n, el destinatario deber铆a ser redirigido al flujo de incorporaci贸n t铆pico de la billetera.
3. Una vez que el usuario se haya incorporado con 茅xito, la billetera deber铆a usar la informaci贸n incluida en el enlace profundo para iniciar el [Procedimiento de Registro de Billetera](#wallet-registration-procedure).

El deep linking diferido es una caracter铆stica com煤nmente soportada por numerosas soluciones de deep linking m贸vil, existen servicios de terceros que pueden ser usados para implementar esta funcionalidad, como Singular, Branch, AppsFlyer, Adjust y otros. [Aqu铆](https://medium.com/bumble-tech/universal-links-for-android-and-ios-1ddb1e70cab0) hay una publicaci贸n de blog con m谩s informaci贸n sobre c贸mo implementar [deferred deep linking].

El SDP soporta un formato de enlace b谩sico, como `https://<host-with-optional-path>`. Si el sistema de deep linking de tu billetera necesita una estructura m谩s compleja, tendr谩s que gestionar esto con una aplicaci贸n web. Esta aplicaci贸n deber铆a ser propiedad del proveedor de la billetera, y deber铆a ser capaz de recibir el enlace profundo, interpretarlo y dirigir al usuario a la ubicaci贸n correcta.

