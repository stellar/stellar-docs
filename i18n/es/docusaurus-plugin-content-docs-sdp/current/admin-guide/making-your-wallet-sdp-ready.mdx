---
title: Hacer Que Tu Billetera Sea Compatible con SDP
sidebar_position: 50
---

import { CodeExample } from "@site/src/components/CodeExample";

Recuerda que cualquier instancia de SDP necesitar치 un acuerdo con un proveedor de billetera antes de enviar desembolsos a esa billetera. Esto asegura que las billeteras se sientan c칩modas recibiendo fondos de tu organizaci칩n y regula cualquier acuerdo comercial entre las organizaciones. La billetera necesitar치 permitir la lista blanca del dominio de SDP antes de que el SDP pueda enviar desembolsos a esa billetera. Cuando el dominio de la billetera es a침adido a un SDP, efectivamente est치 siendo incluido en la lista blanca por el SDP. Ambas partes listando la otra les permite recuperar el archivo stellar.toml y verificar la clave de firma necesaria para el apret칩n de manos [SEP-10].

En esta p치gina, cubriremos los aspectos t칠cnicos de la integraci칩n de SDP-Billetera, incluyendo c칩mo a침adir una billetera en la base de datos de SDP, c칩mo validar y admitir los enlaces de registro utilizando el [deep linking] de la aplicaci칩n m칩vil, c칩mo iniciar el flujo de registro de usuario en la billetera usando [SEP-24], y un enfoque recomendado para manejar [deferred deep linking].

## A침adir una Billetera a un SDP

La lista predeterminada de billeteras SDP depende de qu칠 red se est칠 utilizando (testnet o pubnet). La red se pasa como una variable de entorno y luego la lista de billeteras puede ser sembrada apropiadamente al iniciar SDP a trav칠s del comando de CLI `./stellar-disbursement-platform db setup-for-network`, de acuerdo con una lista codificada de billeteras conocidas. Alternativamente, las billeteras pueden ser insertadas directamente en la base de datos de SDP a trav칠s de un comando SQL. Ambos m칠todos requieren agregar el nombre de la billetera, la p치gina de inicio, el dominio del cliente SEP-10 y el esquema del enlace profundo.

Para insertarlo directamente en la base de datos, actualiza tus valores y ejecuta la siguiente consulta de Postgres. Aseg칰rate de verificar tu base de datos y espacio de nombres primero.

<CodeExample>

```sql
INSERT INTO wallets (name, homepage, deep_link_schema, sep_10_client_domain)
VALUES ('Vibrant Assist', 'https://vibrantapp.com', 'https://vibrantapp.com/sdp', 'api.vibrantapp.com');
```

</CodeExample>

Para configurar una billetera a trav칠s del c칩digo, a침치dela a la secci칩n de testnet o pubnet de `DefaultWalletsNetworkMap`. Esto se usar치 cuando ejecutes el comando CLI `./stellar-disbursement-platform db setup-for-network`, que actualiza la base de datos de SDP y hace que la billetera est칠 disponible para nuevos desembolsos. A침ade tu nueva billetera siguiendo el mismo formato que ya est치 presente en el c칩digo.

<CodeExample>

```go
var DefaultWalletsNetworkMap = WalletsNetworkMapType{
	utils.PubnetNetworkType: {
		{
			Name:              "Vibrant Assist",
			Homepage:          "https://vibrantapp.com/assist",
			DeepLinkSchema:    "https://vibrantapp.com/sdp",
			SEP10ClientDomain: "api.vibrantapp.com",
		},
	},
	utils.TestnetNetworkType: {
		{
			Name:              "Vibrant Assist",
			Homepage:          "https://vibrantapp.com",
			DeepLinkSchema:    "https://vibrantapp.com/sdp-dev",
			SEP10ClientDomain: "api-dev.vibrantapp.com",
		},
		{
			Name:              "Demo Wallet",
			Homepage:          "https://demo-wallet.stellar.org",
			DeepLinkSchema:    "https://demo-wallet.stellar.org",
			SEP10ClientDomain: "demo-wallet-server.stellar.org",
		},
	},
}
```

</CodeExample>

:::caution

Por favor aseg칰rate de actualizar la configuraci칩n apropiada en el lado de Anchor Platform, de acuerdo con la gu칤a de [Anchor Platform Integration Points](anchor-platform-integration-points#manual-synchronization-of-custom-assets-and-wallets).

:::

## Experiencia de Registro del Destinatario

La experiencia de registro del destinatario es primordial para que esta aplicaci칩n sea fluida y f치cil de usar. Esto requiere que la billetera admita [deferred deep linking], que se discutir치 en una secci칩n posterior. Una buena descripci칩n de la experiencia de registro es la siguiente:

1. El destinatario recibe un mensaje de invitaci칩n notific치ndole que tiene un pago esperando de la organizaci칩n y le solicita hacer clic en un [deep link] para abrir o instalar y abrir una aplicaci칩n de billetera

2. Cuando el destinatario abre la aplicaci칩n de billetera, la billetera a bordo inmediatamente al destinatario, crea una cuenta Stellar y una l칤nea de confianza para el activo deseado, inicia una transacci칩n de dep칩sito [SEP-24] con el SDP, y abre la p치gina de registro del SDP como una pantalla de superposici칩n/iframe dentro de la aplicaci칩n.

3. El usuario confirma su n칰mero de tel칠fono y fecha de nacimiento directamente con el SDP, sin compartir ning칰n dato con la billetera, y despu칠s de que finaliza el registro, el usuario es enviado de nuevo a la aplicaci칩n de billetera. Aqu칤 est치n las pantallas que demuestran estos pasos:

   ![Flujo de Registro](/assets/SDP/SDP25.png)

4. El usuario recibe el pago en cuesti칩n de segundos

## Enlace Profundo de Registro

Una vez que el usuario ha instalado la aplicaci칩n de billetera, la billetera deber칤a ser capaz de interpretar un [deep link] que sigue el formato registrado en el SDP para iniciar el [Procedimiento de Registro de Billetera](#wallet-registration-procedure). El formato de enlace profundo admitido por el SDP sigue este formato:

```url
https://<host-with-optional-path>?asset=<asset>&domain=<domain>&name=<name>&signature=<signature>
```

- `asset`: el activo Stellar.
- `domain`: el dominio que aloja el archivo `stellar.toml` de SDP. La billetera necesitar치 usarlo tanto para obtener el archivo `stellar.toml`, como para poblar el campo `home_domain` en la transacci칩n de GET de desaf칤o [SEP-10].
- `name`: el nombre de la organizaci칩n que env칤a pagos.
- `signature`: una firma de la clave de firma de [SEP-10] de SDP.

:::info

Ten en cuenta que el enlace profundo es espec칤fico para cada SDP, organizaci칩n pagadora y activo. No es espec칤fico por receptor individual. No hay riesgo en compartir el enlace con receptores que forman parte del mismo desembolso. El enlace ser치 el mismo para m칰ltiples receptores y demostrar치n su identidad como parte del flujo de dep칩sito [SEP-24].

:::

A continuaci칩n se muestra un ejemplo de un enlace de registro (firmado)

```url
https://vibrantapp.com/sdp-dev?asset=USDC-GBBD47IF6LWK7P7MDEVSCWR7DPUWV3NY3DTQEVFL4NAT4AQH3ZLLFLA5&domain=ap-stellar-disbursement-platform-backend-dev.stellar.org&name=Stellar+Test&signature=fea6c5e805a29b903835bea2f6c60069113effdf1c5cb448d4948573c65557b1d667bcd176c24a94ed9d54a1829317c74f39319076511512a3e697b4b746ae0a
```

En este ejemplo, el host es `https://vibrantapp.com/sdp-dev` y la firma es el resultado de firmar la siguiente url (sin firmar) utilizando la clave de firma [SEP-10] `SBUSPEKAZKLZSWHRSJ2HWDZUK6I3IVDUWA7JJZSGBLZ2WZIUJI7FPNB5`, siendo la clave p칰blica `GBFDUUZ5ZYC6RAPOQLM7IYXLFHYTMCYXBGM7NIC4EE2MWOSGIYCOSN5F`:

```url
https://vibrantapp.com/sdp-dev?asset=USDC-GBBD47IF6LWK7P7MDEVSCWR7DPUWV3NY3DTQEVFL4NAT4AQH3ZLLFLA5&domain=ap-stellar-disbursement-platform-backend-dev.stellar.org&name=Stellar+Test
```

En este ejemplo, la firma es `fea6c5e805a29b903835bea2f6c60069113effdf1c5cb448d4948573c65557b1d667bcd176c24a94ed9d54a1829317c74f39319076511512a3e697b4b746ae0a`.

A continuaci칩n se muestra un fragmento de JavaScript que demuestra c칩mo verificar la firma:

```js
#!/usr/bin/env node

const { Keypair } = require("stellar-sdk");

// The SDP's stellar.toml SIGNING_KEY
//
// For security, this should ideally be fetched from
// https://<domain>/.well-known/stellar.toml on demand
const keypair = Keypair.fromPublicKey(
  "GBFDUUZ5ZYC6RAPOQLM7IYXLFHYTMCYXBGM7NIC4EE2MWOSGIYCOSN5F",
);
console.log("public key:", keypair.publicKey());

let url =
  "https://vibrantapp.com/sdp-dev?asset=USDC-GBBD47IF6LWK7P7MDEVSCWR7DPUWV3NY3DTQEVFL4NAT4AQH3ZLLFLA5&domain=ap-stellar-disbursement-platform-backend-dev.stellar.org&name=Stellar%20Test";
let signature =
  "fea6c5e805a29b903835bea2f6c60069113effdf1c5cb448d4948573c65557b1d667bcd176c24a94ed9d54a1829317c74f39319076511512a3e697b4b746ae0a";

console.log(
  "verified:",
  keypair.verify(
    Buffer.from(url.toString(), "utf8"),
    Buffer.from(signature, "hex"),
  ),
);
```

### Procedimiento de Registro de Billetera

Al abrir el [deep link] de registro, estos son los pasos que la billetera deber칤a seguir para hacer cumplir las medidas de seguridad y privacidad esperadas en este flujo, y permitir que el usuario ingrese su informaci칩n directamente con el SDP:

1. 游뚿 Confirma que el `domain` del enlace profundo est치 en la lista blanca de la billetera. Esto es crucial para autenticar desde una billetera de confianza.游뚿
2. Obt칠n el archivo toml de SDP en `{domain}/.well-known/stellar.toml` y confirma que la variable `SIGNING_KEY` est칠 poblada.
3. Verifica que la firma del enlace de registro se haya realizado utilizando `SIGNING_KEY` similar a la funci칩n `keypairPk.verify(...)` en el fragmento anterior, y que la firma sea v치lida con el contenido del enlace.
4. Verifica el `asset` del enlace y confirma que el usuario destinatario tenga una l칤nea de confianza para ese activo. Crea una si no existe.
5. (Opcional) Usa el `name` del enlace para actualizar la interfaz de usuario de la billetera.
6. Inicia el flujo de dep칩sito [SEP-24] con ese activo usando el valor de `TRANSFER_SERVER_SEP0024` del archivo toml de SDP.
   - Esto incluye utilizar [SEP-10] para autenticar al usuario con el servidor SDP. Por favor nota que el SDP requiere que tanto el campo `client_domain` como el `home_domain` sean proporcionados en la solicitud `GET <WEB_AUTH_ENDPOINT>`, y deben establecerse de la siguiente manera:
     - `client_domain`: el dominio del servidor de billetera que expone el archivo `stellar.toml` del servidor de billetera.
   - `home_domain`: el dominio del servidor de SDP que estaba presente en el enlace de registro.
   - `account`: la cuenta Stellar de la billetera del receptor.
7. Lanza el flujo de dep칩sito en un navegador _in-app_ interactivo dentro de tu aplicaci칩n m칩vil, siguiendo las instrucciones en la especificaci칩n [SEP-24].
   - ATENCI칍N: la billetera no debe, bajo ninguna circunstancia, extraer o intentar extraer el contenido del navegador _in-app_ para obtener la informaci칩n del destinatario.
   - NOTA: se recomienda encarecidamente usar un navegador _in-app_ en lugar de una webview.
8. 游꿀 춰Felicidades! El usuario destinatario puede ahora completar los formularios en el navegador _in-app_ y registrarse para recibir su pago 游꿀.

Adem치s, la billetera deber칤a guardar el enlace y/o atributos del enlace y asociarlo con el usuario receptor individual por estas razones:

1. As칤 es como la billetera sabr치 que el usuario est치 asociado con una cierta organizaci칩n o SDP.
2. Guardar los datos es 칰til para reportar y solucionar problemas, especialmente si la billetera necesita justificar la fuente de fondos por motivos regulatorios o fiscales.
3. Si la organizaci칩n pagadora quiere pagar cualquier tarifa de retiro cobrada por la billetera o el serviciador, la billetera necesitar치 saber qu칠 usuarios y transacciones deber칤an ser facturadas hacia arriba.

### Enlaces Profundos Diferidos

Es muy probable que el destinatario previsto no tenga instalada la aplicaci칩n de billetera necesaria en su dispositivo. Por esta raz칩n, las billeteras deber칤an soportar el concepto de [deferred deep linking], que habilita el siguiente flujo:

1. La acci칩n inicial del destinatario de hacer clic en el enlace profundo deber칤a redirigirlo a la tienda de aplicaciones correspondiente para descargar la aplicaci칩n de billetera.
2. Despu칠s de instalar y abrir la aplicaci칩n, el destinatario deber칤a ser redirigido al flujo de incorporaci칩n t칤pico de la billetera.
3. Una vez que el usuario se haya incorporado con 칠xito, la billetera deber칤a usar la informaci칩n incluida en el enlace profundo para iniciar el [Procedimiento de Registro de Billetera](#wallet-registration-procedure).

El deep linking diferido es una caracter칤stica com칰nmente soportada por numerosas soluciones de deep linking m칩vil, existen servicios de terceros que pueden ser usados para implementar esta funcionalidad, como Singular, Branch, AppsFlyer, Adjust y otros. [Aqu칤](https://medium.com/bumble-tech/universal-links-for-android-and-ios-1ddb1e70cab0) hay una publicaci칩n de blog con m치s informaci칩n sobre c칩mo implementar [deferred deep linking].

El SDP soporta un formato de enlace b치sico, como `https://<host-with-optional-path>`. Si el sistema de deep linking de tu billetera necesita una estructura m치s compleja, tendr치s que gestionar esto con una aplicaci칩n web. Esta aplicaci칩n deber칤a ser propiedad del proveedor de la billetera, y deber칤a ser capaz de recibir el enlace profundo, interpretarlo y dirigir al usuario a la ubicaci칩n correcta.

[deep linking diferido]: https://en.wikipedia.org/wiki/Mobile_deep_linking#Deferred_deep_linking
[deep link]: https://en.wikipedia.org/wiki/Mobile_deep_linking
[deep linking]: https://en.wikipedia.org/wiki/Mobile_deep_linking
[sep-10]: https://stellar.org/protocol/sep-10
[sep-24]: https://stellar.org/protocol/sep-24
