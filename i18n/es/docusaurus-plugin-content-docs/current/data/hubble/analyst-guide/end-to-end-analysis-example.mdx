---
title: Ejemplo de análisis de fin a fin
sidebar_position: 40
---

import create_data_source from "/img/hubble/create-data-source.png";
import bq_connector from "/img/hubble/bq-connector.png";
import add_contract_data from "/img/hubble/add-contract-data.png";
import create_report from "/img/hubble/create-report.png";
import select_data_sources from "/img/hubble/select-data-sources.png";
import add_pie_chart from "/img/hubble/add-pie-chart.png";
import pie_contract_data from "/img/hubble/pie-contract-data.png";
import pie_config from "/img/hubble/pie-config.png";
import pie_chart_durability from "/img/hubble/pie-chart-durability.png";
import click_add_data from "/img/hubble/click-add-data.png";
import add_custom_query from "/img/hubble/add-custom-query.png";
import add_column_chart from "/img/hubble/add-column-chart.png";
import column_chart_config from "/img/hubble/column-chart-config.png";
import expired_entry_column_chart from "/img/hubble/expired-entry-column-chart.png";
import add_quick_filter from "/img/hubble/add-quick-filter.png";
import filter_contract from "/img/hubble/filter-contract.png";
import persistent_only from "/img/hubble/persistent-only.png";
import filtered_report from "/img/hubble/filtered-report.png";

Esta página te guiará a través de un caso de uso extremo a extremo con Hubble y [Google Looker Studio](https://cloud.google.com/looker-studio?hl=en)

## Prerrequisitos

1. Asegúrese de que se ha conectado a Hubble siguiendo las instrucciones en la página [Connecting](./connecting.mdx)
2. Tienes acceso a [Google Looker Studio](https://cloud.google.com/looker-studio?hl=en)
3. Has leído y entendido las [Mejores prácticas](https://developeropers.stellar.org/docs/data/hubble/analyst-guide/optimizing-queries#mejor-prácticas) para consultar datos de BigQuery

## Crear un panel de análisis de métricas Soroban

### Adjuntar fuentes de datos al Studio de Looker

1. Selecciona `Crear --> Fuente de datos`

<img src={create_data_source} width="200" />

2. Encuentra y selecciona el `BigQuery Google Connector`

<img src={bq_connector} width="300" />

3. Encuentre las tablas deseadas que desea conectar. Para este ejemplo querrá añadir una fuente de datos para:
   1. `crypto-stellar.crypto_stellar.contract_data`

<img src={add_contract_data} width="600" />

### Crear un nuevo informe (panel)

1. Selecciona `Create --> Report`

<img src={create_report} width="200" />

2. Añade tus fuentes de datos desde arriba

<img src={select_data_sources} width="300" />

3. Insert a `Pie chart`

<img src={add_pie_chart} width="200" />

4. Elige `contract_data` como la `fuente de datos`

<img src={pie_contract_data} width="300" />

5. Elige `closed_at` como la `Dimensión del Rango de Fecha` y `contract_durability` como la `Dimension`

<img src={pie_config} width="300" />

6. Ahora debería tener un gráfico de pie mostrando el porcentaje de Durabilidad de Datos de Contrato Persistente VS Temporal VS

<img src={pie_chart_durability} width="500" />

### Usar SQL personalizado para crear un gráfico

1. En tu informe, haz clic en `Añadir datos` que estará cerca de la parte inferior derecha de tu ventana

<img src={click_add_data} width="500" />

2. Selecciona `BigQuery` y elige `CLAVE DE CUSTOM` y selecciona el `Proyecto de Facturación` deseado donde se cargará la consulta

<img src={add_custom_query} width="500" />

3. Añade la siguiente consulta y haz clic en `Añadir`

```sql
-- Find the latest ledger sequence within Hubble.
-- This may be slightly behind the actual Stellar latest ledger
-- because Hubble is scheduled to run and insert data at 5 minute intervals
with latest_ledger_in_hubble as (
  select
    max(sequence) as latest_ledger_sequence
  from `crypto-stellar.crypto_stellar.history_ledgers`
),

-- Find all the ttl that have expired
expired_ttl as (
  select
    key_hash
    , live_until_ledger_seq
    -- Saving the date to aggregate on at the final step of the query
    , date(closed_at) as ledger_date
  from `crypto-stellar.crypto_stellar_dbt.ttl_current`
  where true
    -- Filter for expired entries only with the use of latest_ledger_sequence
    and live_until_ledger_seq < (select latest_ledger_sequence from latest_ledger_in_hubble)
)

-- Aggregate based on the month and contract durability type
select
  date_trunc(et.ledger_date, month) as month_agg
  , cd.contract_durability
  , count(1) as expired_entry_count
from expired_ttl as et
  join `crypto-stellar.crypto_stellar_dbt.contract_data_current` as cd
    on et.key_hash = cd.ledger_key_hash
where true
  -- Optionally filter for a specific date/date range
  and et.ledger_date between '2024-02-01' and '2024-06-30'
group by 1,2
order by 1 desc, 2
```

4. Insert `Column chart`

<img src={add_column_chart} width="200" />

5. Selecciona `BigQuery Custom SQL` como tu `Fuente de datos`, `month_agg` como `Dimension`, `contract_durability` como `Breakdown Dimension, y `expired_entry_count`como la `métrica\`

<img src={column_chart_config} width="300" />

6. Ahora debería tener un gráfico de columna (gráfico de barras) mostrando las entradas de contrato soroban caducadas

<img src={expired_entry_column_chart} width="500" />

:::note

Ten en cuenta que entre `2024-02-01` y `2024-06-30` no hay muchas entradas persistentes caducadas

:::

7. Haga clic en `+Añadir filtro rápido` para aplicar un filtro a lo largo de todo el informe

<img src={add_quick_filter} width="500" />

8. Selecciona `contract_durability` para filtrar por los valores de `contract_durability`

<img src={filter_contract} width="500" />

9. Selecciona sólo `ContractDataDurabilityPersistent` y haz clic en `Apply`

<img src={persistent_only} width="500" />

10. Ahora tus cartas deben ser filtradas y mostrar sólo los datos de `ContractDataDurabilityPersistent`

<img src={filtered_report} width="500" />
