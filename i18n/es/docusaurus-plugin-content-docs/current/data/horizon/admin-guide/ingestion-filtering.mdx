---
title: Filtro de Ingestión
order: 46
---

## Resumen

El Filtrado de Ingestion permite a los operadores de Horizon reducir drásticamente la huella de almacenamiento de los datos históricos en la base de datos Horizon mediante la lista blanca de Activos y/o Cuentas que son relevantes para sus operaciones.

### ¿Por qué es útil:

Anteriormente, la única forma de limitar el almacenamiento de datos fue limitando el rango temporal de la historia mediante la retención de rodadura (por ejemplo, los últimos 30 días). La función de filtrado permite a los usuarios almacenar un período de tiempo más largo en la base de datos Horizon para sólo activos en la lista blanca, cuentas, y sus entidades históricas relacionadas (transacciones, operaciones, operaciones, transacciones, etc.).

Para más contexto, ejecutar una instancia de Horizon `full` sin filtrar actualmente requiere más de 30TB de espacio en disco (hasta junio de 2023) con un crecimiento del almacenamiento a razón de aproximadamente 1TB/mes. Como prueba de rendimiento, filtrar hasta 100 de las cuentas más activas y activos reduce el almacenamiento en más del 90%. Para la mayoría de las aplicaciones que están interesadas en un conjunto aún más limitado de activos y cuentas, el ahorro de almacenamiento debería superar el 99%. Otros beneficios incluyen la reducción de los costos operativos para el mantenimiento del almacenamiento, la mejora de las métricas de salud de la base de datos y el rendimiento de las consultas.

### Cómo funciona:

La función de filtrado opera durante la ingestión en procesos **en vivo** y **en intervalos históricos**. Le dice al proceso de ingestión que sólo acepte transacciones entrantes que coincidan con una regla de filtro, cualquier transacción que no coincida con las reglas de filtrado se omite por ingestión y por lo tanto no se almacena en la base de datos.

Algunos aspectos clave a tener en cuenta sobre el comportamiento de filtrado:

- Si los filtros de activos y cuentas están habilitados y cada filtro está provisto con al menos una regla, entonces las transacciones se almacenan en la base de datos cuando cualquier regla de cualquiera de los filtros coincide con la transacción dada.
- El filtrado sólo se aplica a la ingestión de datos históricos en la base de datos, no afecta cómo el proceso de ingestión mantiene los datos actuales almacenados en la base de datos, que es la última entrada de contabilidad conocida para cada entidad única dentro de las cuentas, las líneas de confianza, los pozos de liquidez, las ofertas. Sin embargo, los datos del estado actual consumen una cantidad relativamente pequeña de la capacidad total de almacenamiento.
- Cuando se cambian las reglas de filtro, sólo se aplican a procesos de ingestión existentes (**en vivo** y **en intervalo histórico**). No desencadenan ningún filtrado retroactivo o relleno de los datos históricos existentes en la base de datos.
  - Cuando las reglas de filtro se actualizan para incluir cuentas adicionales o activos en la lista blanca, las transacciones relacionadas desde la ingestión **en vivo** sólo aparecerán en los datos históricos de la base de datos una vez que las reglas de filtro hayan sido actualizadas usando la API de administración. Lo mismo se aplica a la ingestión de **rango histórico**, donde las nuevas reglas de filtro sólo afectarán a los datos del contador actual dentro de su rango configurado en el momento de la actualización.
  - Actualizar las reglas de filtro para incluir cuentas adicionales o activos no activa el relleno automático relacionado con las nuevas entidades en la base de datos histórica. Para incluir en la base de datos el historial anterior de las nuevas entidades incluidas en la lista blanca, puede ejecutar manualmente un nuevo [Rango de Ingestión Histórica](./ingestion.mdx#ingesting-historical-data) después de actualizar las reglas de filtro.
  - Cuando las reglas de filtro se actualizan para eliminar cuentas o activos previamente definidos en la lista blanca, los datos históricos de la base de datos no serán eliminados o filtrados de forma retroactiva en base a las reglas actualizadas. Los datos se almacenan en las tablas de historial durante la vida de la base de datos o hasta que se exceda el archivo `HISTORY_RETENTION_COUNT`. Una vez alcanzado el límite de retención, Horizon purgará todos los datos históricos relacionados con los bordes antiguos, independientemente de cualquier regla de filtrado.
- El filtrado no afectará el rendimiento o la tasa de rendimiento de un proceso de ingestión, seguirá siendo consistente si las reglas de filtro están presentes o no.

Las reglas de filtro definen listas blancas de las siguientes entidades soportadas:

- Id de cuenta
- Activo id (canónico)

Dado que todas las transacciones relacionadas con las entidades de la lista blanca están incluidas, todos los datos de las series históricas de tiempo relacionados con esas transacciones se guardan en el db de la historia del horizonte, incluyendo la propia transacción, todas las operaciones en la transacción, y referencias a cualquier entidad auxiliar desde las operaciones.

## Configuración:

El filtrado está habilitado por defecto sin reglas de filtro definidas. Cuando no se definen reglas de filtro, significa efectivamente que no se produce ningún filtrado de datos ingeridos. Para empezar a filtrar, es necesario definir al menos una regla de filtro:

- habilitar el puerto admin de Horizon con el parámetro de configuración ambiental `ADMIN_PORT=XXXX`, esto le permitirá acceder al puerto.
- definir listas blancas de filtro. enviar solicitudes de API HTTP de administración para ver y actualizar las reglas de filtro:

  Consulte [Horizon Admin API Docs](https://github.com/stellar/go/blob/master/services/horizon/internal/httpx/static/admin_oapi. ml) que también se publican en instancias de ejecución Horizon como documento Open API 3.0 en el Puerto Admin cuando está activado en `http://localhost:<admin_port>/`. Puedes pegar el contenido de esa url en cualquier herramienta de OAPI como [Swagger](https://editor. wagger.io/) que renderizará un explorador visual de los puntos finales de la API. En el editor de swagger también puede cargar el Horizon admin.oapi.yml publicado directamente como una url, elija `File->Importar URL`:

  ```
   https://raw.githubusercontent.com/stellar/go/master/services/horizon/internal/httpx/static/admin_oapi.yml
  ```

  Seguir detalles y ejemplos de cargas de solicitud/respuesta para leer y actualizar las reglas de filtro para estos extremos:

  ```
  /ingestion/filters/account
  /ingestion/filters/asset
  ```

  Al elegir el botón `Probarlo` en cualquiera de los puntos finales se mostrarán los ejemplos `curl` de toda la petición HTTP.

## Caso de Uso de Ejemplo:

Como emisor de activos, He emitido 4 activos y estoy interesado en todos los datos de transacción relacionados con esos activos, incluyendo cuentas de clientes que interactúan con esos activos a través de las siguientes operaciones:

- Operaciones
- Efectos
- Pagos
- Saldos reclamables
- Operaciones

Me gustaría guardar la historia completa de todas las transacciones relacionadas con la génesis de esos activos.

### Requisitos previos:

Ha instalado Horizon con base de datos vacía y tiene **en vivo** ingestión activada.

### Pasos:

1. Configurar una regla de filtro con 4 activos listados en blanco POST'ing the request to Horizon ADMIN API `<horizon_host>:<ADMIN_PORT>/ingestion/filters/asset`.

```
curl -X 'PUT' \
  'http://localhost:4200/ingestion/filters/asset' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "whitelist": [
    "USDC:GAFRNZHK4DGH6CSF4HB5EBKK6KARUOVWEI2Y2OIC5NSQ4UBSN4DR456U",
    "DOTT:GAFRNZHK4DGH6CSF4HB5EBK6KARUOVWEI2Y2OIC5NSQ4UBSN4DR456U",
    "ABCD:GAFRNZHK4DGH6CSF4HB5EBKK6KARUOVWEI2Y2OIC5NSQ4UBSN4DR456U",
    "EFGH:GAFRNZHK4DGH6CSF4HB5EBK6KARUOVWEI2Y2OIC5NSQ4UBSN4DR456U"
  ],
  "habilitado": true
}'
```

2. Dado que se trata de una nueva base de datos horizontal, y de las primeras reglas de filtrado, no hay nada más que hacer, y efectivamente pararse aquí.

3. Sin embargo, en aras del ejercicio, supongamos que ya tenías Horizon corriendo durante un tiempo y la base de datos poblada basada en algunas reglas de filtro, y estas nuevas reglas eran listas blancas adicionales que acaba de añadir. En este caso, eliges si quieres retro-activamente rellenar datos históricos sobre la base de datos de horizonte para estas nuevas entidades de la lista blanca desde un tiempo anterior hasta el presente, porque fueron borrados originalmente a tiempo de ingestión anterior y no incluidos en la base de datos. Si decides volver a rellenar, entonces ejecutas un proceso de ingestión de Horizon **rango histórico**, consulta [Rango Histórico de Ingestión](./ingestion.mdx#ingesting-historical-data) para obtener pasos:
