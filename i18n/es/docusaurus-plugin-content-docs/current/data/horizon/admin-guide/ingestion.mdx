---
title: Ingestion
sidebar_position: 45
---

import { CodeExample } from "@site/src/components/CodeExample";

Horizon API proporciona la mayor parte de su utilidad a través de datos ingeridos, y su servidor Horizon puede ser configurado para escuchar e ingerir los resultados de la transacción de la red Stellar. Ingestion permite el acceso de la API al estado actual (por ejemplo, el saldo de alguien) y al estado histórico (por ejemplo, el historial de transacciones de alguien).

## Tipos de Ingestión

Hay dos casos de ingestión primaria para las operaciones de Horizonte:

- Ingesar datos **en vivo** para mantenerse al día con los últimos contornos de la red, acumulando una ventana deslizante de los contadores antiguos;
- Ingesando datos **históricos** para agregar de forma retroactiva datos de red de un intervalo de tiempo en el pasado a la base de datos.

## Determinar espacio de almacenamiento

Debería pensar detenidamente en el marco temporal histórico de los datos ingeridos que desea conservar en la base de datos de Horizon. Los requisitos de almacenamiento para las transacciones en la red Stellar son sustanciales y están creciendo sin límites con el tiempo. Esto es algo que puede que necesites monitorear y reevaluar continuamente a medida que la red siga creciendo. Hemos descubierto que la mayoría de las organizaciones necesitan sólo una pequeña fracción de los datos históricos recientes para satisfacer sus casos de uso. A través del análisis de patrones de tráfico en la instancia Horizon de SDF, vemos que la mayoría de las peticiones son de datos muy recientes.

Para mantener su huella de almacenamiento pequeña, recomendamos lo siguiente:

- Usa la ingestión **en vivo**, usa una ingestión **histórica** sólo en casos excepcionales limitados.
- Si su aplicación requiere acceso a todos los datos de red, no se puede hacer ningún filtrado recomendamos limitar la retención histórica de los datos ingeridos a una ventana de deslizamiento de 1 mes (HISTORY_RETENTION_COUNT=518400) que es por defecto establecida por Horizon.
- Si tu aplicación puede trabajar en un [conjunto de datos de red filtrados](./ingestion-filtering.mdx) basado en cuentas y activos específicos, recomendamos aplicar reglas de filtro de ingendencia. Al usar reglas de filtro, proporciona beneficio de la elección en un período de retención más largo histórico, ya que el filtrado está reduciendo el tamaño total de la base de datos a tal grado, La retención histórica (`HISTORY_RETENTION_COUNT`) puede establecerse en términos de años en lugar de meses o incluso deshabilitada (`HISTORY_RETENTION_COUNT=0`).
- Si no puedes limitar la ventana de retención de tu historial a 30 días y no puedes usar reglas de filtro, te recomendamos considerar [Stellar Hubble Data Warehouse](. /../hubble/README.mdx) para cualquier dato histórico.

### Ingesting Live Data

Esta opción está habilitada por defecto y es el modo recomendado de ingestión a ejecutar. Se controla con el parámetro de configuración de entorno `INGEST`. Consulte [Configuration](./configuring.mdx) para ver cómo una instancia de Horizon realiza el rol de ingestión.

Para requerimientos de alta disponibilidad, **recomendamos implementar más de una instancia de ingesting en vivo**, ya que esto hace más fácil evitar tiempos de inactividad durante las actualizaciones y añade resistencia, asegurándose de tener siempre los últimos datos de red (consulte [Ingestion Role Instance](. configuring.mdx#multiple-instance-deployment)).

### Ingestando Datos Históricos

Importar datos de red de un rango de fechas pasado a la base de datos:

<CodeExample>

```
rango de db estelar-horizonte <start> <end>
```

</CodeExample>

Ejecutar cualquier rango histórico de ingestión requiere coordinación con la configuración de retención de datos elegida. Al establecer un límite temporal en la historia con `HISTORY_RETENTION_COUNT=<LEDGER_COUNT>`, el límite temporal tiene prioridad y cualquier dato ingerido más allá de ese límite será automáticamente purgado.

Normalmente, la única vez que se necesita para ejecutar la ingestión histórica es una vez cuando se arranca un sistema después de la primera implementación, a partir de ese punto la ingestión **en vivo** mantendrá la base de datos poblada con la ventana de deslizamiento esperada de los datos históricos. Tal vez una excepción sea si crees que tienes un hueco en la base de datos causado por la ingestión **en vivo** caída, en cuyo caso puede correr un rango de ingestión histórica para llenar esencialmente el hueco.

Usted puede ejecutar la ingestión histórica en paralelo en segundo plano mientras que su servidor principal de Horizon realiza por separado **en vivo** la ingestión. Si el rango especificado se solapa con los datos ya en la base de datos, está bien y simplemente será sobrescrito, efectivamente idempotente.

#### Trabajadores de Ingestión Paralelo

Puede paralelizar la ingestión del rango de contadores históricos de destino dividiéndolo en rebanadas secuenciales de rangos más pequeños y ejecutar el comando de rango más largo de db para cada subrango en paralelo como un proceso separado en la misma o una máquina diferente. La regla abreviada para el mejor rendimiento es identificar el número de núcleos de CPU disponibles por máquina objetivo, si multi-core, luego añade `--parallel-workers <num of cores>` al comando, esto permitirá que el comando se paralelice aún más internamente dentro de un solo proceso usando múltiples hilos y subdivididos en rangos más pequeños.

<CodeExample>

```
# rango objetivo 1 30000, en una sola máquina con 1 núcleo de CPU
horizon1> estelar-horizonte del rango más alto de db 1 30000

# rango objetivo 1 30000, en una sola máquina con 4 núcleos de CPU
horizontal1> rango estelar-horizonte db rango más alto 1 30000 --parallel-workers 4

# rango de destino 1 30000, en dos máquinas, cada uno tiene 2 núcleos de CPU
horizon1> rango estelar-horizontal del horizonte del rango más alto de db 1 15000 --parallel-workers 2
horizon2> stellar-horizonte del rango más alto de 15001 30000 --parallel-workers 2
```

</CodeExample>

### Notas

#### Algunos puntos finales pueden no estar disponibles durante la ingestión **en vivo**

- Los puntos finales que muestran la información actual del estado de ingestión **en vivo** pueden devolver el error `503 Service Unavailable`/`Still Ingesting`. Un ejemplo es el punto final `/paths` (construido usando ofertas). Estos extremos estarán disponibles después de que la ingestión **en vivo** haya terminado de sincronizar y ponerse al día (normalmente en un par de minutos).

#### Si han transcurrido más de cinco minutos sin nuevos datos ingeridos:

- Verificar que la máquina anfitrión cumple con la [Prerequisites]recomendada (./prerequisites.mdx).

- Compruebe la salida del log de Horizon.
  - Si hay muchos mensajes `level=error`, puede apuntar a un problema ambiental, la incapacidad de acceder a la base de datos.
  - La ingesta de **Live** emitirá dos líneas de registro de claves aproximadamente una vez cada 5 segundos basándose en el último libro de contabilidad emitido desde la red. Coja la salida del log Horizon y grep para la presencia de estas líneas con un filtro:
    ```
    tail -f horizon.log | grep -E 'Ledger procesado|Ledger cerrado'
    ```
    Si no ves la salida de este pipeline cada par de segundos para un nuevo contador entonces la ingestión no se está ejecutando, mire los registros completos y vea si algún mensaje alternativo está imprimiendo razones al contrario. Puede ver líneas que mencionan "ponerse al día" cuando se conecta a una red de pubnet, ya que puede tomar hasta 5 minutos para que el proceso del núcleo cautivo iniciado por Horizon alcance la red de pubnet.
  - Compruebe el uso de la RAM en la máquina, es posible que el sistema funcione con poca memoria RAM y esté usando memoria de intercambio que resultará en un rendimiento lento. Verificar que la máquina anfitrión cumple con la RAM mínima [prerequisites](./prerequisites.mdx).
  - Verifique las velocidades de lectura/escritura en el volumen que está usando el actual directorio de trabajo para el proceso horizontal. Basado en [prerequisites](./prerequisites.mdx), el volumen debe tener al menos 10mb/s, una manera de verificar esto más o menos en la línea de comandos de la máquina host(linux/mac):
    ```
    sudo dd if=/dev/cero of=/tmp/test_speed.img bs=1G count=1
    ```

#### Monitoreo del Proceso de Ingestión

Para implementaciones de alta disponibilidad, se recomienda implementar el monitoreo del proceso de ingestión para la visibilidad del rendimiento/salud. Consulte [Monitoring](./monitoring.mdx) para acceder a registros y métricas desde Horizon. Stellar publica el ejemplo [Horizon Grafana Dashboard](https://grafana. om/grafana/tablero/13793-estelar-horizon/), lo que demuestra consultas contra mediciones clave del horizonte, específicamente mire el `Retraso Local de Ingestion [Ledgers]` y `Última edad del Edger` en el panel `Resumen de Salud`.
