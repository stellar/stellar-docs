---
title: Monitoreo
sidebar_position: 60
---

import { CodeExample } from "@site/src/components/CodeExample";

## Métricas

Las métricas se emiten desde Horizon a través de HTTP en [el formato de exposición basado en texto de facto](https://github.com/prometheus/docs/blob/main/content/docs/instrumenting/exposition_formats.md#text-based-format). Las métricas se publican en la ruta _private_ `/metrics` del puerto Admin de Horizon, que es un servicio opcional que se iniciará y estará vinculado por el proceso Horizon a la red de loopback máquina anfitriona (localhost o 127. .0.1). Para habilitar el puerto de Administración, añada el parámetro de configuración de entorno `ADMIN_PORT=XXXX`, el punto final de las métricas será accesible en la máquina host como `localhost:<ADMIN_PORT>/metrics`. Puede verificar esto apuntando a cualquier navegador que pueda acceder a esta dirección, imprimirá todas las claves de métricas.

### Exportando

Una vez que el puerto Admin está habilitado, el extremo de las métricas Horizon puede ser "desguazado" mediante una infraestructura externa de monitoreo. Ya que la salida de las métricas está codificada en [formato estándar basado en texto](https://github.com/prometheus/docs/blob/main/content/docs/instrumenting/exposition_formats. d#text-based-format) será compatible para su uso con muchos tipos de infraestructura de monitorización que interactúan con el mismo formato estándar.

En el caso de Horizon, las métricas se publican en el puerto Admin HTTP que está vinculado a la interfaz de red de bucle back de la máquina anfitriona (127. .0.1), por lo que los sistemas o servicios de control externos no pueden llegar directamente al puerto. Para exponer las métricas de forma segura, recomendamos seguir el patrón del exportador, que es una estrategia común de desguace de métricas.

Un ejemplo de mundo real para exportar desde una instalación de Horizon de metal desnudo (Horizon se ha instalado directamente en un sistema operativo), usa [FluentBit y el exportador de Prometheus](https://docs. luentbit.io/manual/pipeline/outputs/prometheum-exporter) en la misma máquina anfitriona que Horizon está corriendo. FluentBit realizará un simple tubería de reenvío de puertos en la máquina anfitrión. Configura la entrada para ser el `localhost:<ADMIN_PORT>/metrics` de Horizon y la salida para ser el `host` y `port` que representa la interfaz de red y el puerto de destino en la máquina host, y luego configurar su infraestructura de monitoreo para raspar esa dirección de host.

En entornos orquestres de contenedores como Kubernetes, puede utilizar la misma estrategia de exportador. Asumimos que ya tienes una implementación de infraestructura de métricas como Prometheus y la configuración de Grafana en el clúster a través del [Operador de Prometheus](https://github. El operador/operador/prometheusian), y sólo tendrá que configurar esa infraestructura para rascar la pod Horizon basado en la ADMIN_PORT.

### Modelo de datos

Hay numerosas teclas de métricas de aplicación emitidas por Horizon en tiempo de ejecución, codificadas en cuatro tipos de formatos de exposición: `counter`, `gauge`, `histogram`, `Resumy`. Cada llave está calificada con etiquetas para una mayor granularidad. Para resumir, podemos destacar las agrupaciones de teclas métricas por una función común indicada en el prefijo de su nombre:

- `go_`: golang specfic runtime performance
- `horizon_txsub_`: atributos del subsistema de submisión de transacciones Horizon si está habilitado.
- `horizon_stellar_core_`: atributos de tiempo de ejecución de la red estelar reportados por el núcleo cautivo.
- `horizon_order_book_`: atributos de tiempo de ejecución del libro de órdenes en memoria mantenido por Horizon de la red estelar actual
- `horizon_log_`: contadores de cuántos mensajes de registro se imprimen en cada nivel de gravedad
- `horizon_ingest_`: mediciones de rendimiento y aspectos de estado del subsistema de ingestión interna de Horizon
- `horizon_http_`: estadísticas y mediciones del servicio de API HTTP de Horizon, todos los aspectos de la carga de solicitud/respuesta y los tiempos.
- `horizon_history_`: estadísticas sobre los contadores históricos ingeridos de Horizon
- `horizon_db_`: mediciones en el rendimiento de la base de datos, tiempos de consulta por endpoints, estadísticas de agrupación
- `process_`: mediciones de computación genéricas del host

Y para cada clave, habrá una posibilidad de 0 o más etiquetas, el formato de salida serializado (exposición) sigue esta plantilla:

```
<metrics_key_name>{label_1="value",label_2="value",,,} <value>
```

En lugar de listar todas las claves de métricas individuales en documentos, como cambian a menudo, la recomendación es realizar un HTTP GET contra el endpoint de las métricas Horizon,`localhost:<ADMIN_PORT>/metrics`, usando cualquier cliente http (navegador, curl, wget, etc) y la respuesta tendrá las teclas de métricas y meta información adicional sobre cada clave métrica para descripción y tipo (contador, gauge, histogram, resumy), como ejemplo para una clave, `horizon_http_requests_duration_seconds`:

```
# HELP horizon_http_requests_duration_seconds HTTP requests durations, sliding window = 10m
# TYPE horizon_http_requests_duration_seconds summary
horizon_http_requests_duration_seconds{method="GET",route="/",status="200",streaming="false",quantile="0.5"} 0. 00186958
horizon_http_requests_duration_seconds{method="GET",route="/",status="200",streaming="false",quantile="0.9"} 0.00043625
horizon_http_requests_duration_seconds{method="GET",route="/",status="200",streaming="false",quantile="0.99"} 0.000645
...

```

### Consultas

Construye consultas contra el modelo de datos de métricas para resaltar el rendimiento de un determinado despliegue Horizonte. Consulte el [Panel de control de Grafana Horizon](https://grafana.com/grafana/dashboards/13793-stellar-horizon/) de Stellar para ver ejemplos de métricas para obtener el rendimiento de la aplicación:

- Número de solicitudes por minuto.
- Número de peticiones por ruta (las rutas más populares).
- Tiempo promedio de respuesta por ruta.
- Tiempo máximo de respuesta para peticiones que no sean de streaming.
- Número de solicitudes de streaming vs. no streaming.
- Número de solicitudes por tasa limitada.
- Lista de IPs limitadas por tasas.
- IPs únicas.
- Los SDKs/aplicaciones más populares enviando peticiones a un nodo Horizon determinado.
- Tiempo promedio de ingestión de un contador.
- Tiempo promedio de ingestión de una transacción.

Elige la [pestaña de revisiones](https://grafana. om/grafana/dashboards/13793-stellar-horizon/?tab=revisions), y descargue el archivo fuente del dashboard para tener acceso al código fuente de Grafana y consultas de métricas que construyen cada panel en paneles.

### Alertas

Una vez que las consultas se desarrollan en un panel de control de Grafana, permite que un paso a seguir añada [reglas de alerta](https://grafana. om/docs/grafana/latest/alerting/alerting-rules/create-grafana-managed-rule/) basado en consultas específicas para activar notificaciones cuando se superan los umbrales.

He aquí algunas alertas de ejemplo a considerar con posibles causas y soluciones.

| Alerta                                                  | Causa                                                                                            | Solución                                                                                                       |
| ------------------------------------------------------- | ------------------------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------- |
| Picos en número de solicitudes                          | Ataque Potential DoS                                                                             | balance de la carga de red o configuraciones de cambio de contenido                                            |
| Ingestion lenta                                         | los recursos de computación del servidor de hosts son bajos                                      | incrementar especificaciones de cómputo                                                                        |
| Las respuestas de la API HTTP están devolviendo errores | los recursos de computación del servidor de host son bajos o se pierde la red a la base de datos | revisa el [Horizon logs](#logs) para ver qué errores están siendo emitidos, restringe la causa raíz desde allí |

## Registros

Horizon saldrá de los registros al estándar del sistema operativo. Se registrará en todos los aspectos del tiempo de ejecución, incluyendo peticiones HTTP e ingestión. Por lo general, hay muy pocos mensajes de gravedad emitidos por `warn` o `error`. El nivel de gravedad por defecto registrado en Horizon está configurado a `LOG_LEVEL=info`, este parámetro de configuración de entorno puede establecerse en uno de `trace, debug, info, advertencia, error`. La verbosidad de la salida del log es inversa del nivel de gravedad elegido. Es decir. para la mayoría de los registros detallados usar 'trace', para los registros menos detallados usar 'error'.

Para implementaciones de producción, recomendamos usar el ajuste de gravedad predeterminado del nivel `info` y elegir una estrategia de captura de registros dependiendo del despliegue.

- Despliegue de metal desnudo directo al sistema operativo, redireccionar el estándar del proceso Horizon a un archivo en el disco y aplicar una herramienta de rotación de registro en el archivo como [logrotate](https://man7. rg/linux/man-pages/man8/logrotate.8.html) para gestionar el uso de espacio en disco.
- Despliegue orquestado en Kubernetes, use una pila EFK/ELK en el clúster y se puede configurar para capturar el estándar fuera de Horizon pod.

## Perfil de tiempo de ejecución

Horizon está escrito en Golang, por lo tanto se ha permitido emitir opcionalmente el diagnóstico de tiempo de ejecución de Golang y la salida de perfiles [pprof](https://go.dev/doc/diagnostics). Los puntos finales pprof HTTP están alojados en el puerto HTTP de administración de Horizon, se puede activar añadiendo el parámetro de configuración de entorno `ADMIN_PORT=XXXX`, ya que el enlace del puerto de administración está deshabilitado por defecto.

Dos de los perfiles predefinidos estándar son publicados:

`localhost:<ADMIN_PORT>/debug/pprof/heap` - heap profiling

`localhost:<ADMIN_PORT>/debug/pprof/profile` - cpu profiling

Utilice la herramienta de línea de comandos pprof de Go para acceder a los puntos finales publicados y visualizar los datos de diagnóstico que se emiten en el perfil. Un breve ejemplo de uso de la herramienta pprof desde la línea de comandos para empezar, usando `web` para mostrar una representación gráfica de las asignaciones actuales del montón:

```
$ go tool pprof http://localhost:6060/debug/pprof/heap
Obtener perfil sobre HTTP desde http://localhost:6060/debug/pprof/heap
Perfil guardado en ./pprof/pprof.stellar-horizon.alloc_objects. lloc_space.inuse_objects.inuse_space.022.pb.gz
Archivo: stellar-horizonte
Tipo: inuse_space
Modo interactivo (escribe "help" para comandos, "o" para opciones)
(pprof) web
```

## ¡Estoy atascado! ¡Ayuda!

Si alguno de los pasos anteriores no funciona o se le impide configurar correctamente Horizon, por favor únase a nuestra comunidad y háganoslo saber. Publica una pregunta en [nuestro intercambio de Stack](https://stellar.stackexchange.com/) o habla con nosotros en [Horizon Discord](https://discord.com/channels/897514728459468821/91246606060960766012) para pedir ayuda.
