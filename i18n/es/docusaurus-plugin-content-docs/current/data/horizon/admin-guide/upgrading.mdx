---
title: Actualizando
sidebar_position: 80
---

import { Alert } from "@site/src/components/Alert";
import { CodeExample } from "@site/src/components/CodeExample";

Aquí describiremos los pasos recomendados para actualizar una instalación de Horizon 2.x.

### Requisitos previos

- Un despliegue Horizon existente consistente en una o más instancias de Horizon.
- Todas las instancias están en la misma versión 2.x para comenzar.
- Si [bare-metal](./installing.mdx#bare-metal) instala, tiene shell, o acceso a la línea de comandos a cada host que tenga una instalación Horizon.
- Si [implementado directamente en Docker daemon](./installing.mdx#containerized), tienes acceso a la línea de comandos al host que está ejecutando el daemon de Docker.
- Si [implementado en Kubernetes con carta Helm](./installing. dx#helm-chart-installation), tiene herramientas de línea de comandos kubectl y helm en su estación de trabajo y un usuario con niveles de acceso apropiados para cambiar los recursos en el espacio de nombres de destino del despliegue Horizon en el cluster.

### Evaluar la instalación actual

- Identificar la lista de todas las instancias de Horizon que necesitan ser actualizadas.

  - Instalaciones de metal desnudo: la lista de hosts es gestionada por usted.
  - Despliegues de Docker daemon: la lista de hosts y contenedores en ejecución es administrada por usted.
  - Instalaciones de Kubernetes: obtenga la lista de pods desplegados desde su instalación anterior de Helm, tendrán una anotación para `release=your_helm_horizon_installation_name`:

    <CodeExample>

    ```bash
    kubectl obtener pods -l release=su_helm_horizon_installation_name -n <your_horizon_namespace>
    ```

    </CodeExample>

- Identifique su versión actual de software Horizonte:

  - Obtener acceso a la línea de comandos al sistema operativo de cada instancia Horizonte:
    - Instalaciones de Bare-metal, esto es normalmente ssh en Linux o powershell en Windows.
    - Daemon de Docker, usa `docker exec -it <containerid> /bin/bash`
    - Para implementaciones de Kubernetes, usa `kubectl exec -it <pod_name> -n <horizon_namespace> -- /bin/bash`
  - En la línea de comandos de cada instancia, ejecuta `stellar-horizonton version`

- Todas las instancias deben informar de la misma versión, si no, el sistema puede ser incoherente, use esta actualización como oportunidad para establecer consistencia y conseguir que todos estén en la misma versión.

### Determinar la versión de destino para actualizar

Ahora que conoces tu versión actual de Horizon, visita [Horizon Releases](https://github.com/stellar/go/releases) y elige la siguiente versión mayor por encima de tu versión actual para actualizar. Sigue los pasos [recomendados por GitHub para comparar lanzamientos](https://docs.github. om/es/repositories/releasing-projects-on-github/comparing-releases), haga clic en el menú desplegable 'Comparar' de la versión elegida, y luego seleccione su versión actual y GH mostrará las diferencias entre las versiones, seleccione la pestaña `Archivos cambiados`, y vaya a `services/horizon/CHANGELOG. d`, resaltará las nuevas notas de la versión para los cambios que han ocurrido entre su versión actual y la nueva versión que ha seleccionado. Revise esto y busque las secciones `Breaking Changes`, `State Rebuild` y `DB Schema Migration` para su consideración, ya que estos últimos dos también mencionarán el tiempo esperado para que la reconstrucción del estado o la migración de db se apliquen respectivamente.

### Instalar la nueva versión

Ahora que usted ha indentificado la nueva versión y está consciente de los impactos potenciales desde la actualización a la nueva versión basada en notas de lanzamiento, como reconstrucciones de estado y migraciones de db, usted está informado y listo para proceder con la actualización.

Actualizar implementos de producción debería aprovechar un despliegue secundario de copia de seguridad, también conocido como [modelo azul/verde](./scaling.mdx#scaling-to-multiple-instances) y realizar la actualización en la implementación inactiva primero. Esto evitará el tiempo de inactividad del sistema a sus usuarios externos, ya que la actualización tiene lugar en el despliegue inactivo.

Una buena estrategia para actualizar Horizon y aplicable a implementaciones individuales o de múltiples instancias: cierre todas las instancias, instalar una nueva versión de Horizon en una de las instancias de ejecución primero. La razón es que el software de Horizon sólo iniciará `State Rebuild` y `DB Schema Migration` acciones relacionadas con una actualización en una instancia que detecta ingestión ha sido habilitada con el parámetro de configuración, `INGEST=true`. Esto reduce la complejidad para usted durante la actualización ya que sólo necesita centrarse en una instancia y evita potenciales procesos de ingestión de Horizon simultánea intentando la misma actualización en la base de datos.

- Instalaciones de metal desnudo, detienen el proceso Horizon en todas las instancias primero, entonces entra en una instancia configurada para la ingestión, y usa el gestor de paquetes apt en linux.

  <CodeExample>

  ```bash
  sudo apt update
  sudo apt install stellar-horizon=new_horizon_debian_pkg_version
  ```

  </CodeExample>

  Reinicia Horizon usando la configuración ya en su lugar, pero incluye la variable de entorno `APPLY_MIGRATIONS=true`, esto activará Horizon para ejecutar automáticamente cualquier migración de db que detecte.

- Daemon Docker, detiene primero todos los contenedores docker, luego elige un contenedor que tenga activado la ingestión establecer la nueva etiqueta para la imagen basada en el lanzamiento publicado en dockerhub - [stellar/stellar-horizon](https://hub. ocker. om/r/stellar/stellar-horizon/tags), y reinicie el contenedor en docker daemon, incluya `APPLY_MIGRATIONS=true` variable de entorno al envase del contenedor, esto activará Horizon para ejecutar automáticamente cualquier migración de db que detecte.

- Para instalaciones de casco en Kubernetes, primero use su herramienta Helm cli para detener todas las instancias de Horizon escalando todas las instalaciones de Horizon (para la ingesta y web) a 0 replicas, que has creado anteriormente en [ejecutar pasos](. running.mdx).

  <CodeExample>

  ```bash
  helm actualizar all-my-horizont-installations \
  --namespace my-horizont-namespace-on-cluster \
  --set ingest.replicaCount=0 \
  --set web.replicaCount=0
  ```

  </CodeExample>

  Ahora, use el helm para iniciar una sola instancia Horizon desde una instalación de casco que tiene la ingestión habilitada en clúster kubernetes, establecerá el `global. mage.horizon.tag` a la etiqueta de lanzamiento publicada en [stellar/stellar-horizon](https://hub.docker.com/r/stellar/stellar-horizon/tags)

  <CodeExample>

  ```bash
  casco de actualización mi-horizonte \
  --namespace my-ěon-namespace-on-cluster \
  --set global.image.horizon.tag=new_horizon_release_number \
  --set ingest.horizonConfig.applyMigrations=True \
  --set ingest.replicaCount=1
  ```

  </CodeExample>

### Confirmando la actualización en una instancia de ingestión única primero

Si tiene una infraestructura [monitoring](./monitoring.mdx), entonces tiene dos opciones para evaluar el estado de actualización:

- Ver las salidas de las métricas usando paneles de control de grafito que aprovechan las consultas en el [modelo de datos de métricas Horizontes](. monitoring.mdx#data-model) para comprobar las estadísticas clave como ingestión y los ledgers de red están avanzando y en paso.

- Ver la ruta de url 'status' del servidor web Horizon en la instancia actualizada:

  <CodeExample>

  ```bash
  curl http://localhost:8000/
  ```

  </CodeExample>

  La respuesta será el código de estado HTTP 200 y el cuerpo de la respuesta será una estructura de datos json basada en texto con información de diagnóstico en la versión actual de software Horizon, y números de contador para ingestión y red, actualizar la url cada 5 segundos más o menos, y debería ver la ingestión y los números de registro de red avanzando y en paso, indicando una buena conexión a la red y la ingestión.

Si las métricas y/o las respones de url de Horizon 'status' no indican un estado saludable basado en el avance de la ingesta del libro de mayores, dos pasos para probar:

- Un retraso en que Horizon alcance un estado saludable después de que se espere una actualización y legíta para cualquier caso de actualización donde `State Rebuild` o `DB Migration` se notó en el lanzamiento delta como parte anterior [Determinar la versión de destino para el paso de actualización](#determine-the-target-version-for-upgrade). Normalmente, las notas también mencionarán las expectativas relativas de los plazos para que se completen las que se pueda tener en cuenta cuánto tiempo esperar al retraso.
- Revisa los registros de la instancia actualizada para confirmar lo que está sucediendo. Cualquier `State Rebuild` o `DB Migration` iniciada será mencionado. Por ejemplo, una migración de db se notará en registros con las siguientes líneas para inicio y finalización:
  ```
  2023/09/22 18:27:01 Aplicando migraciones de DB...
  2023/09/22 18:27:01 aplicó con éxito 5 migraciones de Horizon
  ```

### Actualizar todas las instancias restantes

En este punto, ha actualizado una instancia de ingestión a la nueva versión Horizon, ha actualizado automáticamente la base de datos si es necesario y la instancia se está ejecutando con estado saludable. Ahora, instale la misma versión de software Horizon en el resto de las instancias, reiniciando cada una después de la actualización. Para las instalaciones de metal desnudo y demoníaco que probablemente serán autoexplicativas sobre cómo lograr lo que para el resto de las instancias en las instalaciones de gráficos de helm, ejecuta la actualización de casco de nuevo, configurando la etiqueta de imagen y restaurando el `replicaCount` original:

<CodeExample>

```bash
helm actualizar all-my-horizont-installations \
--namespace my-Execuon-namespace-on-cluster \
--set ingest.replicaCount=1 \
--set web.replicaCount=1 \
--set global.image.horizon.tag=new_horizon_release_number \
--set ingest.horizonConfig.applyMigrations=False
```

</CodeExample>

Para implementaciones de producción siguiendo la copia de seguridad caliente o el modelo azul/verde, esta es la oportunidad de confirmar que el despliegue inactivo ha tomado la actualización correctamente y estable, en cuyo momento, cambie los balanceadores de carga ahora para reenviar el tráfico a la implementación inactiva, haciéndola el despliegue activo. Ahora, puede tomar tiempo para realizar la misma actualización en el otro despliegue que ahora está inactivo.
