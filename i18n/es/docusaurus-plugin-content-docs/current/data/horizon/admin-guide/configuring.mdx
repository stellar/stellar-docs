---
title: Configurando
sidebar_position: 30
---

import { Alert } from "@site/src/components/Alert";

## Prerrequisitos

- Ha identificado el método [installation](./installing.mdx) para el sistema host:

  - Para el metal salvaje, tienes dos ejecutables instalados en la ruta del sistema de operación host: `stellar-horizon` y `stellar-core`.
  - Para ejecutar la imagen de Horizon con Docker daemon, usarás el [stellar/stellar-horizon](https://hub.docker.com/r/stellar/stellar-horizon) alojado en Docker Hub. Ya has movido la imagen estelar/estelar-horizonte a través de `docker pull stellar/stellar-horizon:<tag_version>` en el anfitrión. Esta imagen contiene el 'stellar-horizon' y 'stellar-core' dentro.
  - Para Kubernetes con [Horizon Helm Chart](https://github.com/stellar/helm-charts/tree/main/charts/horizon), has seguido el [Instalar Horizon con Helm Chart](./installing.mdx#helm-chart-installation).

- [Inicializar base de datos](#initialize-horizonon-database)

Ahora está listo para identificar los parámetros de configuración necesarios para realizar tres roles importantes:

- **Conociendo las solicitudes de sólo lectura de API** a través de una API HTTP basada en la web;
- **Ingesting ledgers** de los nodos principales de la red estelar para mantener su visión del mundo actualizada;
- **Envío de transacciones** a través de una API HTTP basada en la web, reenviando la solicitud de envío de transacciones a la red Stellar.

Para realizar estos roles, puede elegir uno de los dos modos de despliegue a continuación (despliegue de una sola instancia o despliegue de múltiples instancias). Cada uno tiene sus propios parámetros de configuración.

## Despliegue de una sola instancia

Ejecuta `stellar-horizon` en un proceso único o/s y ejecutará los tres roles simultáneamente.

| variable de entorno       | ejemplo                             |
| ------------------------- | ----------------------------------- |
| `DATABASE_URL`            | postgres://localhost/horizon_pubnet |
| `NETWORK`                 | pubnet                              |
| `HISTORY_RETENTION_COUNT` | 518400                              |

## Despliegue de múltiples instancias

En esta variante de despliegue escalable, se ejecutan múltiples instancias de `stellar-horizon`, cada una ejecutando un subconjunto de los roles. Esto le permite escalar horizontalmente cada una de las funciones de rol de forma independiente.

### Instancia de Rol de Ingestión

Debes asignar **al menos** una instancia para realizar una ingestión continua para capturar la actividad de red. Esto limitará el almacenamiento de la actividad de red ingerida en la base de datos a nuestra recomendación de una ventana deslizante de los últimos 30 días.

| variable de entorno       | ejemplo                               |
| ------------------------- | ------------------------------------- |
| `DATABASE_URL`            | postgres://localhost/horizon_pubnet   |
| `NETWORK`                 | pubnet                                |
| `HISTORY_RETENTION_COUNT` | 518400                                |
| \`DISABLE_TX_SUB          | verdad                                |

### Instancia de Rol API

Usted puede ejecutar ninguna o múltiples instancias para servir solicitudes de API de sólo lectura. Tenga en cuenta que no hay necesidad de definir la configuración de red aquí, ya que Horizon sólo lee desde la base de datos.

| variable de entorno    | ejemplo                               |
| ---------------------- | ------------------------------------- |
| `DATABASE_URL`         | postgres://localhost/horizon_pubnet   |
| `INGESTAR`             | falso                                 |
| \`DISABLE_TX_SUB       | verdad                                |

### Instancia de Rol de Envío de Transacción

Usted puede ejecutar ninguna o múltiples instancias para atender solicitudes de envío de transacciones. Si ejecuta una instancia con el envío de transacción habilitado, el despliegue Horizon es requerido para que al menos una instancia realice el rol de ingestión en la misma base de datos. El envío de transacciones horizontales depende de que esta ingestión **en vivo** tenga lugar contra la base de datos para confirmar el estado de envío de tx.

Si se planea realizar la ingestión en una instancia separada, añada `INGEST=false` en este caso, de lo contrario no incluya el parámetro, Horizon predeterminado a `INGEST=true`. Cuando una instancia habilitada para enviar una transacción tiene `INGEST=true` efectiva, configurará automáticamente el parámetro relacionado `STELAR_CORE_URL` para usar la instancia del núcleo cautivo iniciada internamente y el despliegue no necesita establecer el valor de configuración explícitamente.

Si se establece `INGEST=false`, entonces **debe** definir la variable `STELLAR_CORE_URL` en esta instancia habilitada de envío de transacción, ya que no habrá una instancia del núcleo cautivo internamente alojada como parte de la ingestión disponible para referencia, en su lugar el `STELAR_CORE_URL` proporciona la capacidad de definir la URL de un puerto HTTP de instancia principal a la que Horizon enviará envíos de transacciones.

| variable de entorno    | ejemplo                             |
| ---------------------- | ----------------------------------- |
| `DATABASE_URL`         | postgres://localhost/horizon_pubnet |
| `STELLAR_CORE_URL`     | http://ejemplo.watcher.core:11626   |
| `INGESTAR`             | falso                               |

## Notas

### Ingestion

Si ha configurado su despliegue para llevar a cabo el rol de ingestión, es **fuertemente** recomendado revisar [Ingestion](. ingestion.mdx) primero y [Filtering](. ingestion-filtering.mdx) segundo y factor que en los parámetros de configuración para lograr el mejor rendimiento en relación con los requisitos de su aplicación antes de continuar.

- Horizon creará un subdirectorio bajo el directorio de trabajo actual del proceso o/s para almacenar archivos de datos de tiempo de ejecución cautivos. Consulte [Prerequisites](./prerequisites.mdx) para el tipo y la cantidad de almacenamiento recomendado. Puede anular esta ubicación con la variable de entorno opcional `CAPTIVE_CORE_STORAGE_PATH`, en un directorio en el sistema de archivos donde el núcleo cautivo almacenará los archivos de tiempo de ejecución.

### \`DISABLE_TX_SUB

Este parámetro de configuración es opcional, configurado como FALSE por defecto. Controla si Horizon aceptará peticiones HTTP al punto final de la API `/tx` y se redireccionará a la red. Consulte [Cuentas del canal](../../../learn/encyclopedia/transactions-specialized/channel-accounts.mdx) para algunas recomendaciones sobre optimizaciones opcionales de las transacciones del cliente.

- Cuando se establece en FALSE, requiere que el proceso de ingestión **vive** se ejecute en la misma base de datos porque Horizon depende de nuevos ledgers de la red para confirmar un estado de envío de transacciones. Horizon reportará un error de inicio si no detecta ingestión **en vivo**. Requiere que `INGEST=true` o `STELAR_CORE_URL` se definan para acceder a una instancia del núcleo.
- Cuando el envío de la transacción está desactivado estableciéndola en TRUE, Horizon devolverá 405 en POSTs a /tx.

### `NETWORK`

Este parámetro de configuración es opcional, puede ser una de las redes públicas de Stellar, 'pubnet', o 'testnet'. Activa Horizon para configurar automáticamente las configuraciones restantes de Horizon y generar la correcta configuración de toml/cfg. Si sólo necesita Horizon para conectarse a una de esas redes estelares públicas, esto se encargará de todas las configuraciones relacionadas.

- Si desea conectar Horizon a una red estelar diferente a pubnet o testnet o anular cualquiera de los valores predeterminados que iniciará el uso de `NETWORK`, las variables de entorno clave que se pueden establecer son: `HISTORY_ARCHIVE_URLS`, `CAPTIVE_CORE_CONFIG_PATH`, `NETWORK_PASSPHRASE`, `CAPTIVE_CORE_STORAGE_PATH`, `STELAR_CORE_URL`.

### `URL DB`

Este parámetro de configuración es requerido, especifica la base de datos Horizon. Su valor sigue este formato: `dbname=<pg_dbname> user=<pg_user_name> password=<pg_user_pwd> host=<host_address>`

### `LOG_IVEL`

Este parámetro de configuración es opcional, puede ser uno de 'info', 'error', 'debug'.

### `HISTORY_RETENTION_COUNT`

Este parámetro de configuración es opcional, determina la ventana deslizante máxima de los datos históricos de la red para retener en la base de datos desde la ingestión. El valor se expresa como contador de contadores absolutos, que es una manera indirecta de definir una duración de tiempo, cada libro de conteo es de aproximadamente 5 segundos. Está predeterminado a 0, lo que significa que no borrará ningún historial de la base de datos. Para promulgar la ventana de deslizamiento recomendada de un mes, establezca esto a 518400, que es el número aproximado de contadores en 30 días. Consulte [Calcular Recursos](./prerequisites.mdx) para ver cómo el espacio de almacenamiento de base de datos está estrechamente relacionado con esta configuración.

## Pasar configuraciones al horizonte

El binario `stellar-horizon` busca variables de entorno de proceso para la configuración. Dependiendo de cómo se instaló Horizon, el método que realice para configurar el entorno del proceso dirá:

- Metal desnudo
  - Administrador de paquetes: utilice variables de entorno O/S para pasar configuraciones. Hay muchas herramientas que puedes usar para gestionarlas, como [direnv](http://direnv.net/) o [dotenv](https://github.com/bkeepers/dotenv).
  - [Administrador de Paquetes](./installing.mdx#package-manager): el contenedor `stellar-Firston-cmd` proporcionado iniciará un nuevo proceso y creará variables de entorno en el proceso a partir de `full/default/stellar-horizon` y luego iniciará el 'stellar-horizon'. Para configurar las configuraciones, edite el archivo en `mañana/default/stellar-horizon`.
    <Alert>
      This script invokes Horizon with the `stellar` user, so make sure that
      permissions for the user are set up accordingly. El directorio de trabajo actual
      debe tener permisos de escritura para este usuario y el usuario debe ser capaz de
      ejecutar los binarios `stellar-horizon` y `stellar-core`; etc.
    </Alert>
- Contenedor
  - No-Helm: pasar todos los parámetros de configuración a la imagen docker de horizonte como [variables de entorno docker](https://docs.docker.com/engine/reference/commandline/run/#env).
  - Helm: pasar todos los parámetros de configuración en el [comando de instalación Helm](https://helm.sh/docs/helm/helm_install/) como un archivo de valores.

## Inicializar base de datos Horizon

Antes de ejecutar el servidor Horizon por primera vez, debe inicializar la base de datos Horizon. Esta base de datos será utilizada para toda la información producida por Horizon, principalmente información histórica sobre las transacciones que se han producido en la red Stellar.

Para preparar una base de datos para el uso de Horizon, primero asegúrese de que está en blanco. Es más fácil crear una nueva base de datos en su servidor PostgreSQL específicamente para uso de Horizon. Recomendamos crear un nuevo usuario(rol) en postgres dedicado a la base de datos de Horizon y asignar ese usuario(rol) como el propietario de esta base de datos.

Para ilustrar un ejemplo usando `psql`, primero inicia sesión en el servidor de base de datos usando la herramienta de línea de comandos `psql` como superusuario, y luego crear el nuevo usuario(role) y la base de datos para Horizon:

```
postgres=#
postgres=# CREATE EL horizonte del ROLE CON LOGIN;
CREATE ROLE
postgres=#
postgres=# CREATE DATABASE el horizonte OWNER;
CREATE DATABASE
postgres=#
```

Además, puedes establecer una contraseña en tu nuevo usuario postgres `horizon` con `ALTER USER`.

Una vez completado, puede componer el valor completo del parámetro de configuración para el acceso de db `DATABASE_URL="dbname=Texton user=artison password=<value_here> host=<address_of_pg_server>"`.

A continuación, ejecute el binario Horizon para instalar el esquema en el db vacío desde la línea de comandos. En este ejemplo, asuma que el shell actual no tiene `DATABASE_URL` en el entorno todavía, así que exporte primero a shell:

```
$ export DATABASE_URL="dbname=horizonte user=horizonte password=<value_here> host=<address_of_pg_server>"
$ estelar-horizonte db init
```

### Configuración de Postgres Opcionales

Basándonos en observaciones de rendimiento a lo largo del tiempo, recomendamos configuraciones adicionales de Postgres(postgresql.conf), pero no son necesarias:

- Establece `random_page_cost=1` si estás usando almacenamiento SSD. Con esta configuración, Query Planner hará un mejor uso de índices, especialmente para consultas `JOIN`. Hemos notado una gran mejora de la velocidad para algunas consultas con este ajuste.

\_ Para mejorar la disponibilidad de la ingestión, api, servidores de envío de transacciones se recomienda establecer los siguientes valores:

- `tcp_keepalives_idle`: 10 segundos
- `tcp_keepalives_interval`: 1 segundo
- `tcp_keepalives_count`: 5

Con la configuración anterior, si no hay consultas de un cliente determinado durante 10 segundos, Postgres debería comenzar a enviar paquetes de keepalive TCP. Se reintentará 5 veces cada segundo. Si no hay respuesta del cliente después de ese tiempo se eliminará la conexión.

## Siguiente paso

Una vez que la configuración esté completa, ¡ya está listo para proceder a [Ejecutar Horizon](./running.mdx)!
