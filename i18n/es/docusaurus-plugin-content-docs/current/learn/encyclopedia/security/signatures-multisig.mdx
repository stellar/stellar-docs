---
title: Firmas y Multifirma
sidebar_position: 20
---

import { CodeExample } from "@site/src/components/CodeExample";

:::note

Esta sección detalla la firma de transacciones contractuales no inteligentes. Para la autenticación relacionada con las transacciones de contratos inteligentes, consulte [authorization](./authorization.mdx)

:::

Las firmas son autorización para transacciones en la red. Las transacciones siempre necesitan autorización de al menos una clave pública para ser válida y, en general, la firma proviene de la cuenta de origen. Algunas veces las transacciones requieren más firmas, lo que entraremos en la sección Multisig.

Las firmas de transacción se crean firmando el contenido del objeto de transacción con una clave secreta. Stellar utiliza el esquema de firmas ed25519, pero también existe un mecanismo para añadir otros tipos de esquemas de claves públicas y privadas. Se considera que una transacción con una firma adjunta tiene autorización de esa clave pública.

### Umbrales

Cada operación cae por debajo de un umbral específico: bajo, medio, o alto con un nivel numérico entre 0-255 (para leer más sobre esto vea nuestra sección sobre [Operaciones y Transacciones](. /../fundamentals/transactions/operations-and-transactions.mdx#operations)). Este umbral determina qué peso de firma es necesario para autorizar una operación.

Para ver el umbral de cada operación, vea nuestra [sección de Lista de Operaciones](../../fundamentals/transactions/list-of-operations.mdx).

Los clientes pueden establecer su propio peso de firma, valores de umbral y claves de firma adicionales con la operación Opciones de ajuste. De forma predeterminada, todos los niveles de umbral de operación se establecen en 0, y la clave maestra se establece en el peso 1. Para la mayoría de los casos, se recomienda establecer umbrales tales que `bajo <= medio <= alto`.

Si el peso de la clave maestra se fija en 0, no se puede utilizar para firmar transacciones, incluso para operaciones con un valor umbral de 0. Tenga mucho cuidado al ajustar el peso de su clave maestra a 0. Hacerlo puede bloquearte permanentemente fuera de tu cuenta (aunque si hay otros firmantes listados en la cuenta, todavía pueden seguir firmando transacciones.)

### Autorización

Para determinar si una transacción tiene la autorización necesaria para ejecutarse, se añaden los pesos de todas las firmas en el sobre de la transacción. Si esta suma es igual o mayor que el umbral para ese tipo de operación, entonces la operación está autorizada.

Este plan es muy flexible. Puede requerir que muchos firmantes autoricen pagos desde una cuenta en particular. Puedes tener una cuenta para la que cualquier número de personas pueda autorizar. Puede tener una clave maestra que conceda acceso o revoca el acceso de otros. Soporta cualquier m de n setup.

## Multifirma

En algunos casos, una transacción puede necesitar más de una firma:

- Si la transacción tiene operaciones con múltiples cuentas de origen, requiere la firma de la cuenta de origen para cada operación
- Firmas adicionales son requeridas si la cuenta asociada a la transacción tiene varias claves públicas

Cada firmante adicional más allá de la clave maestra incrementa el saldo mínimo de la cuenta en una reserva base. Se pueden adjuntar hasta 20 firmas a una transacción. Una vez que se alcanza el umbral de firmas, si hay firmas pendientes, la transacción fallará. Por ejemplo, si su transacción requiere tres firmas, proporcionando más de tres firmas, incluso si todas son válidas, resultará en un error de transacción fallido: `TX_BAD_AUTH_EXTRA`. Este diseño se debe a que la verificación de firmas innecesaria tiene un gran efecto en el rendimiento antes de aceptar transacciones en consenso.

### Alternar tipos de firma

Para habilitar algunas características avanzadas de contratos inteligentes hay un par de tipos de firma adicionales. Estos tipos de firmas también tienen pesos y se pueden añadir y eliminar de forma similar a los tipos normales de firmas. Pero en lugar de comprobar una firma criptográfica para obtener autorización, tienen un método diferente de probar la validez de la red.

#### Transacción pre-autorizada

Es posible que una cuenta autorice previamente una transacción en particular añadiendo el hash de la futura transacción como un firmante en la cuenta. Para ello, necesita preparar la transacción de antemano con el número de secuencia apropiado. Entonces puede obtener el hash de esta transacción y añadirla como un firmante a la cuenta.

Los signatarios de este tipo se eliminan automáticamente de la cuenta cuando se aplica una transacción coincidente, independientemente de si la transacción tiene éxito o falla. En caso de que una transacción coincidente nunca sea enviada, el firmante permanece, y debe ser eliminado manualmente utilizando la operación Opciones de ajuste.

Este tipo de firmante es especialmente útil en cuentas de escrow. Puede preautorizar dos transacciones diferentes. Ambos podrían tener el mismo número de secuencia pero diferentes destinos. Esto significa que sólo uno de ellos puede ser ejecutado.

#### Hash(x)

:::note

La firma de Hash(x) es un concepto diferente de los hash de transacción. Los hash de la transacción son identificadores únicos generados al aplicar una función hash criptográfica a los datos de una transacción en una cadena de bloques. Sirven como huella digital y permiten a los usuarios verificar y hacer referencia a las transacciones en la red. Hash(x) es un tipo de firma.

:::

Añadir una firma de tipo hash(x) permite a cualquiera que sepa x firmar la transacción. Este tipo de firmante es especialmente útil en [swaps atómicos de cadenas cruzadas](https://en.bitcoin.it/wiki/Atomic_cross-chain_trading) que son necesarios para protocoles inter-blockchain como [lightning networks](https://lightning.network/).

Primero, cree un valor aleatorio de 256 bits, al que llamamos x. El hash SHA256 de ese valor puede ser añadido como un signer de tipo hash(x). Luego, para autorizar una transacción, se añade x como una de las firmas de la transacción. Tenga en cuenta que x será conocido por el mundo tan pronto como una transacción sea enviada a la red con x como una firma. Esto significa que cualquiera podrá firmar esa cuenta con el firmante de hash(x) en ese momento. A menudo desea que haya firmas adicionales para que alguien debe tener una clave secreta particular y saber x para alcanzar el umbral de peso necesario para autorizar las transacciones en la cuenta.

## Ejemplos

- Ejemplo 1: Anclajes
- Ejemplo 2: Cuentas conjuntas
- Ejemplo 3: Cuentas de gastos
- Ejemplo 4: Cuentas de empresa

### Ejemplo 1: Anclajes

Usted ejecuta un ancla que le gustaría mantener su clave de emisión fuera de línea. De esa manera, es menos probable que un actor malo pueda hacerse con la clave del ancla y empezar a emitir crédito de forma inapropiada. Sin embargo, tu ancla necesita autorizar a las personas que tienen crédito ejecutando la operación `Establecer banderas de línea confiable`. Antes de emitir crédito a una cuenta, debes verificar que la cuenta está bien.

Multisig te permite hacer todo esto sin exponer la clave maestra de tu fondo. Puedes añadir otra clave de firma a tu cuenta con la operación `Configurar opciones`. Esta clave adicional debe tener un peso bajo el umbral medio de su cuenta de anclaje. Dado que `Set Trust Line Flags` es una operación de umbral bajo, esta clave adicional autoriza a los usuarios a mantener el crédito de su fondo. Pero, dado que `Payment` es una operación de umbral medio, esta clave no permite a nadie que comprometa su ancla emitir crédito.

Configuración de su cuenta:

<CodeExample>

```
Peso de la llave maestra: 2
Peso de clave adicional de firma: 1
Umbral bajo: 0
Umbral medio: 2
Umbral alto: 2
```

</CodeExample>

### Ejemplo 2: Cuentas conjuntas

Usted quiere crear una cuenta conjunta con la compañía de la empresa y Carina de tal manera que cualquiera de ustedes pueda autorizar un pago. También desea configurar la cuenta para que, si decide cambiar de firmantes (e. ., quitar o añadir alguien), una operación de alto umbral, todos los 3 deben estar de acuerdo. Añades la lista de firmas a la cuenta conjunta. También se asegura de que se necesitan todos los pesos clave para limpiar el umbral alto, pero solo uno para limpiar el umbral medio.

Configuración de cuenta conjunta:

<CodeExample>

```
Peso de la llave maestra: 1
Umbral bajo: 0
Umbral medio: 0
Umbral alto: 3
Peso de la clave de firma de la empresa: 1
Peso de la clave de firma de la carina: 1
```

</CodeExample>

### Ejemplo 3: Cuentas de gastos

Usted controla completamente una cuenta de gastos, pero quiere que sus dos compañeros de trabajo Diyuan y Emil puedan autorizar transacciones desde esta cuenta. Añade las claves de firma de Diyuan y Emil's a la cuenta de gastos. Si Diyuan o Emil salen de la empresa, puede eliminar su clave de firma, una operación de alto umbral.

Configuración de la cuenta de gastos:

<CodeExample>

```
Peso de la llave maestra: 3
Umbral bajo: 0
Umbral medio: 0
Umbral alto: 3
Peso clave del diyuan: 1
Peso de la llave de la mil: 1
```

</CodeExample>

### Ejemplo 4: Cuentas de empresa

**Advertencia**: este ejemplo implica ajustar el peso de la clave maestra de una cuenta a 0. Tenga mucho cuidado si decide hacer eso: esa clave ya no podrá firmar ningún tipo de transacción, así que corre el riesgo de bloquearse permanentemente de su cuenta. Asegúrate de haber reflexionado detenidamente sobre lo que estás haciendo, de que entiendes las implicaciones y de que cambies de peso en el orden correcto.

Su empresa quiere crear una cuenta que requiere que 3 de 6 empleados acepten cualquier transacción de esa cuenta.

Configuración de la cuenta de la empresa:

<CodeExample>

```
Peso de la Clave Maestra: 0 (Apagada para que esta cuenta no pueda hacer nada sin un empleado.
Umbral bajo: 3
Umbral medio: 3
Umbral alto: 3
Peso clave 1 del Empleado: 1
Peso 2 del Empleado 2: 1
Peso 3 del Empleado: 1
Peso de la clave 4 del Empleado: 1
Peso de la clave 5 del Empleado: 1
Peso 6 del Empleado: 1
```

</CodeExample>
