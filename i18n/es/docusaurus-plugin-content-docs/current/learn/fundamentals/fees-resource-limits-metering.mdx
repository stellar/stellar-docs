---
title: Comisiones, límites de recursos y medición
sidebar_position: 70
---

import CanvasFeeGraphs from "@site/src/components/CanvasFeeGraphs";

## Resumen de cuotas

Stellar requiere una comisión para todas las transacciones que se realicen al contador. Esto ayuda a prevenir el spam y prioriza las transacciones durante las sobretensiones del tráfico. Todas las comisiones se pagan usando el token nativo Stellar, el [lumen (o XLM)](./lumens.mdx).

Hay dos tipos de tarifas en Stellar:

**Tarifa de recurso: _sólo se aplica a transacciones de contratos inteligentes_**. La cantidad que el remitente debe pagar por su transacción para ejecutar. Esta cantidad se basa en el consumo de recursos de una transacción y en el estado del almacenamiento de la red (descrito en la [sección de precios dinámicos de almacenamiento](#dynamic-pricing-for-storage)). Lea sobre las tarifas de recursos [below](#resource-fee).

**Cuota de inclusión:** la cantidad máxima que el remitente está dispuesto a pagar para que la transacción se incluya en el registro. Leer más [below](#inclusion-fee).

Cuando compite por espacio en el contador, las transacciones de contratos inteligentes _sólo_ compiten con otras transacciones de contratos inteligentes, y las transacciones que no ejecutan un contrato inteligente son _sólo_ compitiendo con otras transacciones que no ejecutan un contrato inteligente.

Los lumens recogidos de las comisiones de transacción van a una cuenta bloqueada y no son entregados ni utilizados por nadie.

## Cuota de recursos

Todas las transacciones de contratos inteligentes requieren una tarifa de recurso, además de una cuota de inclusión:

`Tarifa de Transacción (Tx.fee) = Tarifa de Recursos (sorobanData.resourceFee) + Tarifa de Inclusión`

![Soroban Fees](/assets/soroban_fees.png) _\* Diagrama: las cajas de líneas sólidas son lo que realmente está presente en la transacción, mientras que las líneas punteadas son derivadas._

Smart contracts on Stellar use a multidimensional resource fee model that charges fees for several resource types using [network-defined rates](../../networks/resource-limits-fees.mdx). La comisión de recursos se calcula basándose en el consumo de recursos declarado en la transacción y puede fluctuar basado en una comisión de escritura de almacenamiento mutable (más en la [sección de precios dinámicos de almacenamiento](#dynamic-pricing-for-storage) más abajo). Si la transacción intenta exceder los límites de recursos declarados, fallará. Si la transacción utiliza menos recursos de los declarados, no habrá reembolsos [(con un par de excepciones)](#refundable-and-non-refundable-resource-fees).

La cuota de recursos depende de los siguientes recursos:

- **Instrucciones:** el número de instrucciones de CPU que utiliza la transacción, medido por el entorno host;
- **Acceso al libro mayor:** leyendo o escribiendo cualquier entrada del libro principal (cualquier clave de almacenamiento en el contexto del contrato);
- **E/S del Ledger:** el número de bytes leídos o escritos en el ledger;
- **Tamaño de la transacción:** tamaño de la transacción enviada a la red en bytes;
- **Tamaño de los eventos y el valor devuelto:** el tamaño de los eventos producidos por el contrato y el valor devuelto de la función del contrato de alto nivel — tanto los eventos como el valor de retorno se incluyen en los metadatos de la transacción;
- **Alquiler de espacio Ledger:** el pago de las extensiones TTTL de la entrada del libro de contadores (por ejemplo, pagos de alquiler) y pagos de alquiler para aumentar el tamaño de la entrada del libro de notas. Consulte la sección [archivo de estado](../encyclopedia/storage/state-archival.mdx) para obtener más información sobre el alquiler de contratos inteligentes.

:::note

Algunos parámetros pueden contribuir a múltiples componentes de tasas. Por ejemplo, el tamaño de la transacción se carga para la propagación de la red (ya que el ancho de banda de la red es limitado) y para el almacenamiento histórico (ya que el almacenamiento del historial del contador no es libre).

:::

Los detalles de implementación para el cálculo de las comisiones son proporcionados por el siguiente [library](https://github.com/stellar/rs-soroban-env/blob/main/soroban-env-host/src/fees.rs). Esta biblioteca es utilizada por el protocolo para calcular los honorarios y por lo tanto puede ser considerada canónica. Las tasas de comisión de recursos se pueden actualizar basándose en el consenso de los validadores de la red.

Encuentre las tarifas actuales de los recursos en la página [Límites y tarifas de recursos](../../networks/resource-limits-fees.mdx) en la sección Redes .

### Gastos de recursos reembolsables y no reembolsables

La comisión de recursos se calcula con una porción de comisiones no reembolsables y una porción de comisiones reembolsables: `ResourceFee(sorobanData.resourceFee) = tarifa de recurso no reembolsable + comisiones de recursos reembolsables`.

**Cuotas no reembolsables:** calculadas a partir de instrucciones de CPU, bytes de lectura, bytes de escritura y ancho de banda (tamaño de la transacción, incluyendo sus firmas).

**Gastos reembolsables:** calculados a partir del alquiler, los eventos y el valor de devolución. Los cargos reembolsables se cobran desde la cuenta de origen antes de que la transacción se ejecute y luego se reembolsen basándose en el uso real. Sin embargo, la transacción fallará si `refundableFee` no es suficiente para cubrir el uso real de recursos.

### Encuentra la tarifa de recursos de una transacción

La mejor manera de encontrar la comisión de recursos requerida para cualquier transacción de contrato inteligente es usar el [punto final de `simulateTransaction`](../encyclopedia/contract-development/contract-interactions/transaction-simulation. dx) desde el RPC, que le permite enviar una transacción de prevuelo que devolverá los valores de recursos necesarios y la comisión de recursos.

### Limitaciones de recursos

:::note

Sólo las transacciones de contratos inteligentes están sujetas a limitaciones de recursos.

:::

El tiempo de cierre del contable de Stellar se limita a unos segundos, impidiendo la ejecución de transacciones arbitrariamente grandes, independientemente de los costos de recursos involucrados. Todos los recursos mencionados en la sección anterior están sujetos a un límite por transacción. La memoria de una transacción (RAM) también está limitada, aunque no está sujeta a ninguna carga.

Los límites de recursos son determinados por un voto del validador y pueden ser ajustados basándose en el uso de la red y las necesidades del ecosistema con un consentimiento del validador.

Encuentra los límites actuales de recursos en la página [Límites y tarifas de recursos](../../networks/resource-limits-fees.mdx) en la sección Redes .

## Tasa de inclusión

La cuota de inclusión es la oferta máxima (una oferta denota una cuota dinámica, lo que significa que varía en función de ciertas condiciones de red) el remitente está dispuesto a pagar para que la transacción se incluya en el registro. La tasa de inclusión es igual al número de operaciones en la transacción multiplicada por la tarifa base efectiva para el contable dado: `tarifa de inclusión = # de operaciones * tarifa base efectiva`

**Tarifa efectiva base:** la comisión requerida por operación para que una transacción llegue al contador. Esto no puede ser inferior a 100 trazos por operación (el mínimo de red).

**Stroop:** la unidad más pequeña de un lumen, una décima millonésima parte de un lumen (.0000001 XLM).

:::note

Las transacciones pueden tener hasta 100 operaciones por transacción excepto para las transacciones que ejecutan un contrato inteligente. Las transacciones inteligentes por contrato solo están permitidas una operación por transacción (a menos que la transacción obtenga [fee-bumped](../encyclopedia/transactions-specialized/fee-bump-transacciones. dx); esto añadiría otra operación), y los límites se especifican en las instrucciones de CPU y otros límites de recursos.

:::

Cuando establece una tarifa base para una transacción, está especificando la cantidad máxima que está dispuesto a pagar por operación en esa transacción. Esto no significa necesariamente que pagarás esa cantidad. Sólo se te cobrará la cantidad más baja necesaria para que tu transacción llegue al contador. Si el tráfico de la red es ligero y el número de operaciones o transacciones enviadas está por debajo del límite del contador de red (configurado por los validadores: actualmente 1, 00 operaciones no inteligentes-contrato y 100 transacciones de contratos inteligentes), sólo pagará el mínimo de la red (configurado por validadores, actualmente 100 golpes).

Alternativamente, su transacción puede no hacerlo al contable si la tarifa base efectiva es mayor que su oferta de comisión base. Cuando el tráfico de la red excede el límite de los mayores, la red entra en [modo de sobreprecio](#precio de cirujano), y su tarifa base efectiva se convierte en su oferta máxima.

Las cuotas se deducirán de la cuenta de origen a menos que haya una transacción de comisión que indique lo contrario. Aprenda más sobre las transacciones con comisiones en la [sección de Transacción de Fee-Bump](../encyclopedia/transactions-specialized/fee-bump-transactions.mdx).

## Aumento y precios dinámicos

### Aumento de precios

La red puede entrar en el modo de sobrecarga de precios bajo dos caras: 1. cuando el número de operaciones enviadas a un contador excede la capacidad de la red (1.000 operaciones para transacciones que no ejecutan contratos inteligentes), o 2. si hay competencia entre transacciones de contratos inteligentes para un recurso en particular (instrucciones, acceso a la entrada de ledger (lecturas y escrituras), E/S de ledger (bytes de lectura y bytes escritos) y el tamaño total de las transacciones a aplicar). Durante este tiempo, la red utiliza la dinámica del mercado para decidir qué transacciones incluir en el contable. Las transacciones que ofrecen una oferta máxima de comisión base más alta lo convierten en el libro primero.

Durante el modo de precios de sobretensión, las transacciones se ordenan en función de su cantidad de cuota de inclusión, y el usuario paga la cuota mínima de inclusión en su conjunto de transacciones. Por ejemplo, si hay cinco transacciones con tasas de inclusión respectivas de 2, 3, 4, 4 y 5 XLM, y sólo cuatro de ellos un hacer al contador, luego todas las transacciones incluidas pagan la cuota de inclusión de 3 XLM. Si las cinco transacciones pueden llegar al contador (lo que significaría que la red no está en modo de sobreprecio), cada uno pagaría la cuota mínima de inclusión de 100 stroops (. 001 XLM).

Si hay múltiples transacciones que ofrecen la misma tasa de inclusión, pero no todas encajan en el contador, las transacciones son seleccionadas aleatoriamente para que las operaciones totales de todo el conjunto no superen los 1.000. El resto de las transacciones son empujadas al siguiente contable o descartadas si han estado esperando durante demasiado tiempo. Si su transacción es descartada, Horizon devolverá un error de tiempo de espera.

:::note

Se recomienda aplicar [ledger linunds](./transactions/operations-and-transactions.mdx#ledger-bounds) o [time linunds](./transactions/operations-and-transactions. dx#time-linunds) a las transacciones — o bien su transacción lo hace al contador o falla, dependiendo de su tiempo y/o parámetros del contador.

:::

\*_Es más probable que pagues una tasa de inclusión más alta al enviar transacciones de contratos inteligentes. _ Las transacciones con contratos inteligentes tienen límites más estrictos que las transacciones que no interactúan con contratos inteligentes y por lo tanto experimentarán un aumento de los precios con mayor frecuencia. Es más probable que pague su oferta máxima de cuota de inclusión o, al menos, la oferta mínima de cuota de inclusión en su conjunto de transacciones. Por lo tanto, usted debe planificar su estrategia de licitación de tasas en consecuencia.

### Precios dinámicos para almacenamiento

El tamaño de la base de datos de almacenamiento de Stellar está determinado por dos fuerzas: la tasa de adiciones (escrituras) y la tasa de eliminaciones (desalojos). Stellar ha establecido un umbral de crecimiento de mayor a un valor constante (el parámetro de red `BucketListTargetSizeBytes`, implementado para prevenir el crecimiento explosivo del estado y sujeto a cambios basados en el voto del validador). Debido a que hay una capacidad fija, los gastos de escritura se basan en el tamaño del libro de contabilidad y pueden alterarse dinámicamente en función de ese tamaño.

Cuando el tamaño del libro de contabilidad es grande, hay una mayor demanda de espacio de almacenamiento, lo que causa una mayor tasa de escritura. Con el tiempo, las entradas se archivan, reduciendo el tamaño total del contador y, por lo tanto, reduciendo los precios del almacenamiento. Este modelo de comisión está diseñado como si el tamaño de la base de datos representara la demanda actual de almacenamiento en un instante dado.

Las tarifas escritas crecerán gradualmente con el tiempo cuando el tamaño de la base de datos esté por debajo del umbral de crecimiento y crezca linealmente, pero con un factor de 1.000x después de superar ese umbral. Esto es una protección contra el spam y no se anticipa en circunstancias normales.

## Medición

La medición es un mecanismo en el entorno anfitrión que tiene en cuenta los costos de los recursos incurridos durante la ejecución de un contrato inteligente. Los resultados de la medición actúan como la verdad canónica del costo de ejecución de un contrato inteligente y sirven como un aporte para los cálculos de las tasas.

El entorno de ejecución de contratos inteligentes de Stellar comprende un anfitrión y un invitado. El host encapsula funcionalidades compartidas para todos los contratos, incluyendo objetos de host, funciones y un intérprete Wasm (VM). El entorno invitado es donde se interpreta y ejecuta el contrato compilado de Wasm. Se puede encontrar una discusión detallada sobre estos entornos en [Conceptos del entorno](../encyclopedia/contract-development/environment-concepts.mdx).

La división entre el entorno host y huésped y sus funcionalidades compartidas necesita un enfoque único de la contabilidad de recursos. En particular, los recursos necesarios para ejecutar las instrucciones de Wasm y las funciones de host en ejecución deben ser contabilizados de manera unificada, con costos en términos de instrucciones de CPU y bytes de memoria.

Consideremos dos contratos: A y B, ambos que comprenden el mismo número de instrucciones de Wasm. Si Contract A llama repetidamente funciones de host para cálculos complejos mientras que Contract B ejecuta operaciones aritméticas puras dentro de la MV, El contrato A debería ser más costoso, y esta diferencia debería estar representada con precisión en el proceso de medición.

La medición garantiza la equidad, frena la manipulación y los ataques de los recursos, y genera una medida determinista y reproducible de los costos de los recursos de ejecución.

### Metodología

Mantener equivalencia en la medición entre el huésped y el invitado, los costos de cálculo en ambos lados se expresan en términos de instrucciones de CPU y bytes de memoria (que representan el uso de CPU y RAM). La medición y el control de límites ocurren dentro del entorno de host, y los modelos numéricos precalificados aseguran que los resultados sean deterministas.

### Tipos de costo

La medición se segmenta en componentes host, denominados **tipos de coste**. Cada tipo de costo puede ser visto como una “meta instrucción” que simboliza una operación de host específica con una complejidad conocida que depende de una entrada en tiempo de ejecución. Por ejemplo, el tipo de coste `computeSha256Hash` representa el costo de calcular el hash SHA256 de un array de bytes.

:::info

La ejecución de las instrucciones de Wasm se contabiliza como un tipo de coste de host `WasmInsnExec`, que tiene un costo constante de CPU por instrucción de Wasm. Esta metodología trata las instrucciones de los huéspedes y las ejecuciones de los anfitriones de manera equivalente.

:::

Encuentra una lista completa de los tipos de coste del host y sus definiciones aquí: [`ContractCostType`](https://github.com/stellar/stellar-xdr/blob/e372df9f677961aac04c5a4cc80a3667f310b29f/Stellar-contract-config-setting.x#L92-L155).

### Parámetros de costo

Los tipos de coste se seleccionan cuidadosamente a:

1. Servir como bloques de construcción completos para todos los costos significativos de ejecución del contrato;
2. Asegúrese de que el costo de cada componente aumente como máximo linealmente (es decir, constante o lineal) con respecto a su entrada. Es decir, `y = a + bx`, donde `y` es la salida de costo, `x` es la entrada, y `a` & `b` son los parámetros constantes y lineales, respectivamente.

Cada tipo de costo tiene un modelo separado para ambos tipos de recursos (CPU y memoria).

Los parámetros para cada modelo, `a` y `b`, son calibrados y colocados fuera de línea contra entradas de varios tamaños. La colección de todos los parámetros de coste del modelo de las entradas configurables de la red (ver [`ConfigSettingsEntry`](https://github.com/stellar/stellar-xdr/blob/e372df9f677961aac04c5a4cc80a3667f310b29f/Stellar-contract-config-setting.x#L223-L226) puede actualizarse a través de consenso.

### proceso de medición

Antes de la ejecución del contrato, el entorno anfitrión se prepara con los parámetros de costo y un presupuesto que define los límites de recursos. La medición se implementa para medir el consumo acumulado de recursos durante la ejecución del anfitrión.

Durante la ejecución, cada vez que un componente (un bloque de código que define un tipo de costo) es encontrado, el modelo correspondiente calcula la salida del recurso a partir de la entrada de tiempo de ejecución e incrementa el contador en consecuencia. El medidor comprueba el consumo acumulado contra el límite presupuestario. Si se sobrepasa el límite, se produce un error y se termina la ejecución.

Si la ejecución del contrato concluye dentro de los límites de recursos especificados, el total medido de instrucciones de CPU se registra y utiliza como la entrada para el cálculo de tasas. Aunque el uso de memoria no está incluido en el cálculo de tasas, está sujeto a los límites de los recursos.

## Estrategias de Precios de Inclusión

Durante las últimas tres horas, las estadísticas de tasas de inclusión en la red Mainnet se pueden ver a continuación.

<CanvasFeeGraphs />

Existen tres métodos primarios para abordar las fluctuaciones de tasas de inclusión y los precios de superación:

- [**Método 1:**](#set-the-highest-fee-youre-nbable-paying) estableció la comisión más alta que estés pagando. Esto no significa que pagará esa cantidad por cada transacción — sólo pagará lo que sea necesario para entrar en el registro. En circunstancias normales (no cirujanos), usted sólo pagará la tarifa estándar incluso con una tarifa máxima más alta. Este método es simple, conveniente y eficiente, pero aún puede fallar potencialmente.
- [**Método 2:**](#fee-bumps-on-past-transactions) vuelve a enviar una transacción con una comisión más alta usando una transacción de comisión

### Establece la comisión más alta que estés cómodo pagando

En general es una buena idea elegir la comisión más alta que estás dispuesto a pagar por la operación para que tu transacción llegue al titular. Los desarrolladores de Wallet pueden querer ofrecer a los usuarios una oportunidad de especificar su propia cuota base, aunque puede que tenga más sentido establecer un cargo base global persistente que esté por encima de la tasa de mercado, ya que al usuario promedio probablemente no le importa si está pagando 0. céntimos o 0,00008 céntimos.

Recuerde que es más probable que pague su oferta de comisión máxima con transacciones por contrato inteligente.

### Gastos en transacciones pasadas

Incluso con una política liberal de pago de tasas, es posible que la transacción no llegue al contable debido a fondos insuficientes o aumentos repentinos de las tasas. Las transacciones con recargos pueden resolver este problema. El siguiente fragmento muestra cómo volver a enviar una transacción con una tarifa más alta (siempre y cuando tenga el sobre de transacción original):

<CodeExample>

```js
// Deja que `lastTx` sea una transacción que falla en el envío debido a altas comisiones, y
// `lastFee` ser la cuota máxima (expresada como int) dispuesta a ser pagada por
// `account` para `lastTx`.
server.submitTransaction(lastTx).catch(function (error) {
  if (isFeeError(error)) {
    let bump = sdk.TransactionBuilder. uildFeeBumpTransaction(
      cuenta, // cuenta que PAY la nueva cuota
      última * 10, // nueva cuota
      lastTx, // el servidor (entero) fallando en la transacción
      . etworkPassphrase
    );
    bump.sign(someAccount);
    servidor de retorno. ubmitTransaction(bump);
  }
  // ...other error conditions...
}).then(...);
```

</CodeExample>

Supongamos que usted envía dos transacciones distintas con la misma cuenta fuente y número de secuencia; la segunda transacción es una transacción de cobro de tasas. En ese caso, la segunda transacción se incluirá en la cola de transacciones, reemplazando la primera transacción si y sólo si la oferta de comisión de la segunda transacción es de al menos 10 veces la oferta de comisión de la primera transacción.

Este valor normalmente se puede encontrar en el campo `fee_charged` de la respuesta de transacción en el caso de error `tx_insufficient_fee`.
