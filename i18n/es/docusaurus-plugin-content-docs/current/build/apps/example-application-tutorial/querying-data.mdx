---
title: Consultando datos
sidebar_position: 70
---

Su aplicación consultará datos de Horizon (una de las APIs de Stellar) a lo largo de su funcionalidad. Información como saldos de cuentas, historial de transacciones, números de secuencia para transacciones, disponibilidad de activos y más se almacenan en la base de datos de Horizon.

Aquí tienes una lista de algunas consultas comunes que harás.

:::note

En otros lugares de este tutorial, hemos omitido las descripciones JSDoc y la tipeación para una presentación limpia. Aquí, estamos incluyendo aquellos para hacer estas funciones más copiables/pegar-able.

:::

## Importaciones y tipos

```js title="/src/lib/stellar/horizonQueries.js"
importar { error } desde "@sveltejs/kit";
importar {
  Server,
  TransactionBuilder,
  Networks,
  StrKey,
  Asset,
} de "stellar-sdk";

const horizonl = "https://Texton-testnet. vendedor. rg";
const server = new Server(horizonl);

/**
 * @module $lib/stellar/horizonQueries
 * @description Una colección de funciones que ayuda a consultar la información
 * de la [API de Horizonte](https://developers. tellar.org/api/horizon). Esta
 * nos permite abstruir y simplificar algunas interacciones para que no tengamos que tener un
 * _todo_ contenido en nuestro `*. archivos velte`.
 */

// Importaremos algunas definiciones de tipo que ya existen dentro del paquete
// `stellar-sdk`, para que nuestras funciones sepan qué esperar.
/** @typedef {import('stellar-sdk'). erverApi.AccountRecord} AccountRecord */
/** @typedef {import('stellar-sdk').Horizon.ErrorResponseData} ErrorResponseData */
/** @typedef {import('stellar-sdk'). erverApi.PaymentOperationRecord} PaymentOperationRecord */
/** @typedef {import('stellar-sdk').Horizon.BalanceLine} BalanceLine */
/** @typedef {import('stellar-sdk').Horizon. alanceLineAsset} BalanceLineAsset */
/** @typedef {import('stellar-sdk').Transaction} Transacción */
/** @typedef {import('stellar-sdk').ServerApi.PaymentPathRecord} PaymentPathPathRecord */ /
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/lib/stellar/horizonQueries.js

## fetchAccount

Da un número de secuencia de una cuenta, saldos de activos y líneas de confianza.

```js title="/src/lib/stellar/horizonQueries.js"
/**
 * Fetches and returns details about an account on the Stellar network.
 * @async
 * @function fetchAccount
 * @param {string} publicKey Public Stellar address to query information about
 * @returns {Promise<AccountRecord>} Object containing whether or not the account is funded, and (if it is) account details
 * @throws {error} Will throw an error if the account is not funded on the Stellar network, or if an invalid public key was provided.
 */
export async function fetchAccount(publicKey) {
  if (StrKey.isValidEd25519PublicKey(publicKey)) {
    try {
      let account = await server.accounts().accountId(publicKey).call();
      return account;
    } catch (err) {
      // @ts-ignore
      if (err.response?.status === 404) {
        throw error(404, "account not funded on network");
      } else {
        // @ts-ignore
        throw error(err.response?.status ?? 400, {
          // @ts-ignore
          message: `${err.response?.title} - ${err.response?.detail}`,
        });
      }
    }
  } else {
    throw error(400, { message: "invalid public key" });
  }
}
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/lib/stellar/horizonQueries.js

## obtener saldos de cuenta

Obtiene saldos existentes para una `publicKey` dada.

```js title="/src/lib/stellar/horizonQueries.js"
/**
 * Obtiene y devuelve los detalles del saldo de una cuenta en la red Stellar.
 * @async
 * @function fetchAccountBalances
 * @param {string} publicKey Public Stellar address holding balances to query
 * @returns {Promise<BalanceLine[]>} Array conteniendo información de saldo para cada activo que la cuenta posee
 */
export async function fetchAccountBalances(publicKey) {
  const { balances } = await fetchAccount(publicKey);
  saldos de retorno;
}
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/lib/stellar/horizonQueries.js

## obtener pagos recientes

Encuentra cualquier pago realizado hacia o desde la `publicKey` dada (incluye: pagos, rutas de pago y fusiones de cuentas).

```js title="/src/lib/stellar/horizonQueries.js"
/**
 * Fetches and returns recent `payment`, `createAccount` operations that had an effect on this account.
 * @async
 * @function fetchRecentPayments
 * @param {string} publicKey Public Stellar address to query recent payment operations to/from
 * @param {number} [limit] Number of operations to request from the server
 * @returns {Promise<PaymentOperationRecord[]>} Array containing details for each recent payment
 */
export async function fetchRecentPayments(publicKey, limit = 10) {
  const { records } = await server
    .payments()
    .forAccount(publicKey)
    .limit(limit)
    .order("desc")
    .call();
  return records;
}
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/lib/stellar/horizonQueries.js

## enviar

Enviar una transacción firmada a la red Estelar.

```js title="/src/lib/stellar/horizonQueries.js"
/**
 * Submits a Stellar transaction to the network for inclusion in the ledger.
 * @async
 * @function submit
 * @param {Transaction} transaction Built transaction to submit to the network
 * @throws Will throw an error if the transaction is not submitted successfully.
 */
export async function submit(transaction) {
  try {
    await server.submitTransaction(transaction);
  } catch (err) {
    throw error(400, {
      // @ts-ignore
      message: `${err.response?.title} - ${err.response?.data.extras.result_codes}`,
    });
  }
}
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/lib/stellar/horizonQueries.js

## fetchAssetsWithHomeDomains

Creamos un nuevo tipo `HomeDomainBalanceLine` que incluye la información de balance de la confianza de un usuario, y también añade el `home_domain` del emisor de activos. Si estás usando algo más para la seguridad de tipo (o nada en absoluto), siéntete libre de adaptar o ignorar el `@typedef`s que hemos incluido aquí.

Luego, mira todas las cuentas emisoras y devuelve sólo las que tienen un `home_domain` establecido en la cuenta.

```js title="/src/lib/stellar/horizonQueries.js"
/**
 * @typedef {Object} HomeDomainObject
 * @property {string} home_domain Domain name the issuer of this asset has set for their account on the Stellar network.
 */

/** @typedef {BalanceLineAsset & HomeDomainObject} HomeDomainBalanceLine */

/**
 * Fetches `home_domain` from asset issuer accounts on the Stellar network and returns an array of balances.
 * @async
 * @function fetchAssetsWithHomeDomains
 * @param {BalanceLine[]} balances Array of balances to query issuer accounts of
 * @returns {Promise<HomeDomainBalanceLine[]>} Array of balance details for assets that do have a `home_domain` setting
 */
export async function fetchAssetsWithHomeDomains(balances) {
  let homeDomains = await Promise.all(
    balances.map(async (asset) => {
      // We are only interested in issued assets (i.e., not LPs and not XLM)
      if ("asset_issuer" in asset) {
        // Fetch the account from the network, and add its info to the array, along with the home_domain
        let account = await fetchAccount(asset.asset_issuer);
        if ("home_domain" in account) {
          return {
            ...asset,
            home_domain: account.home_domain,
          };
        }
      }
    }),
  );

  // Filter out any null array entries before returning
  // @ts-ignore
  return homeDomains.filter((balance) => balance);
}
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/lib/stellar/horizonQueries.js

## establecer rutas

Encuentre las rutas de envío estrictas disponibles entre un activo/cantidad fuente y la cuenta de recepción.

```js title="/src/lib/stellar/horizonQueries.js"
/**
 * Fetches available paths on the Stellar network between the destination account, and the asset sent by the source account.
 * @async
 * @function findStrictSendPaths
 * @param {Object} opts Options object
 * @param {string} opts.sourceAsset Stellar asset which will be sent from the source account
 * @param {string|number} opts.sourceAmount Amount of the Stellar asset that should be debited from the srouce account
 * @param {string} opts.destinationPublicKey Public Stellar address that will receive the destination asset
 * @returns {Promise<PaymentPathRecord[]>} Array of payment paths that can be selected for the transaction
 * @throws Will throw an error if there are no available payment paths.
 */
export async function findStrictSendPaths({
  sourceAsset,
  sourceAmount,
  destinationPublicKey,
}) {
  let asset =
    sourceAsset === "native"
      ? Asset.native()
      : new Asset(sourceAsset.split(":")[0], sourceAsset.split(":")[1]);
  let response = await server
    .strictSendPaths(asset, sourceAmount.toString(), destinationPublicKey)
    .call();
  if (response.records.length > 0) {
    return response.records;
  } else {
    throw error(400, { message: "no strict send paths available" });
  }
}
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/lib/stellar/horizonQueries.js

## encontrar rutas recibidas

Encuentre las rutas de recepción estrictas disponibles entre una cuenta de origen y la recepción de activos/cantidad.

```js title="/src/lib/stellar/horizonQueries.js"
/**
 * Fetches available paths on the Stellar network between the source account, and the asset to be received by the destination.
 * @async
 * @function findStrictReceivePaths
 * @param {Object} opts Options object
 * @param {string} opts.sourcePublicKey Public Stellar address that will be the source of the payment operation
 * @param {string} opts.destinationAsset Stellar asset which should be received in the destination account
 * @param {string|number} opts.destinationAmount Amount of the Stellar asset that should be credited to the destination account
 * @returns {Promise<PaymentPathRecord[]>} Array of payment paths that can be selected for the transaction
 * @throws Will throw an error if there are no available payment paths.
 */
export async function findStrictReceivePaths({
  sourcePublicKey,
  destinationAsset,
  destinationAmount,
}) {
  let asset =
    destinationAsset === "native"
      ? Asset.native()
      : new Asset(
          destinationAsset.split(":")[0],
          destinationAsset.split(":")[1],
        );
  let response = await server
    .strictReceivePaths(sourcePublicKey, asset, destinationAmount.toString())
    .call();
  if (response.records.length > 0) {
    return response.records;
  } else {
    throw error(400, { message: "no strict receive paths available" });
  }
}
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/lib/stellar/horizonQueries.js

## Consulta al experto estelar

Stellar Expert es un explorador de bloques de terceros indispensable como herramienta para entender lo que está sucediendo en la red Stellar. En nuestra página `/dashboard/assets`, estamos rellenando una lista de líneas de confianza de activos que un usuario podría elegir añadir a su cuenta Stellar. Obtenemos esta lista de activos de la API de Stellar Expert.

:::note

Stellar Expert emplea su propio algoritmo para determinar la calidad de un activo. Este algoritmo considera cosas como el número de pagos realizados usando un activo, el número de cuentas que poseen ese activo, cuánto del activo está disponible en el DEX o en los pozos de liquidez, etc. Estos rangos no son una "determinación final" de la calidad de un activo por ningún medio. y son más parecidos a una observación de la cual los activos Stellar ven la mayor utilización y actividad de la red.

:::

Hemos creado nuestro propio tipo `RankedAsset`, así que BasicPay sabe cómo interactuar con estos objetos. Y luego estamos recuperando los diez activos más valorados de la Stellar Expert API.

```js title="/src/lib/utils/stellarExpert.js"
const network = "testnet";
const baseUrl = `https://api.stellar. xpert/explorer/${network}`;

/**
 * Un objeto de activo que ha sido devuelto por nuestra consulta a Stellar. xpert
 * @typedef {Object} RankedAsset
 * @property {string} asset identifier
 * @property {number} traded_amount Total traded (in stroops)
 * @property {number} payments_amount total payments amount (in stroops)
 * @property {number} created Timestamp of the first recorder operation with asset
 * @property {number} supply Total issued asset supply
 * @property {Object} trustlines Trustlines established to an asset
 * @property {number} trades Total number of trades
 * @property {number} payments Total number of payments
 * @property {string} domain Associated `home_domain`
 * @property {Object} tomlInfo Asset information from stellar. oml file
 * @property {Object} rating Composite asset rating
 * @property {number} paging_token token
 * @see {@link https://stellar. xpert/openapi. tml#tag/Asset-Info-API/operation/getAllAssets}
 */

/**
 * Obtiene y devuelve los activos más valorados, según los cálculos de Stellar.Expert.
 * @async
 * @function fetchAssets
 * @returns {Promise<RankedAsset[]>} Array de objetos que contienen detalles para cada activo
 */
export async function fetchAssets() {
  let res = await fetch(
    `${baseUrl}/asset? {new URLSearchParams({
      // estos son todos los valores predeterminados, pero podrías personalizarlos si fuera necesario
      de búsqueda: "",
      orden: "valoración",
      order: "desc",
      limit: "10",
      cursor: "0",
    })}`,
  );
  let json = await res. son();

  let records = json._embedded.records;
  registros de retorno;
}
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/lib/utils/stellarExpert.js
