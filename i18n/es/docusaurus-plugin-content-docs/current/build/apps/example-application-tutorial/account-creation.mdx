---
title: Creación de cuenta
sidebar_position: 20
---

Las cuentas son la estructura central de datos en Stellar y sólo pueden existir con un par de claves válido (una clave pública y secreta) y el balance mínimo requerido de XLM. Lea más en la [sección Cuentas].

## Experiencia de usuario

Para empezar, nuestro usuario creará una cuenta. En BasicPay, la página de registro mostrará un par de claves público y secreto aleatorio que el usuario puede seleccionar con la opción de elegir un nuevo conjunto si lo prefiere.

:::info

Puesto que estamos construyendo una [aplicación no custodial], la clave secreta cifrada sólo vivirá en el navegador. Nunca se compartirá con un servidor ni con nadie.

:::

![claves públicas y privadas](/assets/public-and-private-keys.png)

A continuación, activaremos al usuario para enviar un pincode para cifrar su clave secreta antes de que se guarde en su navegador `localStorage` (esto es manejado por el [`js-stellar-wallets` SDK]). El usuario tendrá que recordar su pincode para futuros inicios de sesión y enviar transacciones.

Con BasicPay, cuando el usuario haga clic en el botón “Signup”, se le pedirá que confirme su pincode. Cuando lo hacen, se activa la operación 'create_account', y la cuenta del usuario se financia automáticamente con XLM para el saldo mínimo (a partir de 10,000 XLM).

![cuenta financiada](/assets/funded-account.png)

Cuando esté listo para mover la aplicación a Pubnet, las cuentas tendrán que ser financiadas con XLM real. Esto es algo que la aplicación puede cubrir depositando XLM en la cuenta del usuario con el uso de [reservas patrocinadas], o el usuario puede cubrir el saldo requerido con su propio XLM.

## Implementación de código

Crearemos una 'tienda' de Svelte para interactuar con el par de claves generado aleatoriamente por nuestro usuario. La tienda aprovechará algunos de los SDK `js-stellar-wallets` para cifrar/descifrar el par de claves, así como las transacciones de signos.

### Creando la tienda `walletStore`

Nuestro `walletStore` hará algunas cosas posibles a lo largo de nuestra aplicación.

1. Podemos "registrar" un par de claves, que cifra el par de claves, lo almacena en el almacenamiento del navegador, y mantiene un seguimiento del `keyId` de ese par de claves.
2. Podemos "firmar" transacciones proporcionando el pincode para descifrar el par de claves.
3. Podemos "confirmar" que el pincode es válido para el par de claves almacenado (o que coincide para los registros).

```js title="/src/lib/stores/walletStore.js"
import { persisted } from "svelte-local-storage-store";
import { KeyManager, KeyManagerPlugins, KeyType } from "@stellar/wallet-sdk";
import { TransactionBuilder } from "stellar-sdk";
import { error } from "@sveltejs/kit";
import { get } from "svelte/store";

// We are wrapping this store in its own function which will allow us to write
// and customize our own store functions to maintain consistent behavior
// wherever the actions need to take place.
function createWalletStore() {
  // Make a `persisted` store that will determine which `keyId` the
  // `keyManager` should load, when the time comes.
  const { subscribe, set } = persisted("bpa:walletStore", {
    keyId: "",
    publicKey: "",
  });

  return {
    subscribe,

    // Registers a user by storing their encrypted keypair in the browser's
    // `localStorage`.
    register: async ({ publicKey, secretKey, pincode }) => {
      try {
        // Get our `KeyManager` to interact with stored keypairs
        const keyManager = setupKeyManager();

        // Use the `keyManager` to store the key in the browser's local
        // storage
        let keyMetadata = await keyManager.storeKey({
          key: {
            type: KeyType.plaintextKey,
            publicKey: publicKey,
            privateKey: secretKey,
          },
          password: pincode,
          encrypterName: KeyManagerPlugins.ScryptEncrypter.name,
        });

        // Set the `walletStore` fields for the `keyId` and `publicKey`
        set({
          keyId: keyMetadata.id,
          publicKey: publicKey,
          // Don't include this in a real-life production application.
          // It's just here to make the secret key accessible in case
          // we need to do some manual transactions or something.
          devInfo: {
            secretKey: secretKey,
          },
        });
      } catch (err) {
        console.error("Error saving key", err);
        throw error(400, { message: err.toString() });
      }
    },

    // Compares a submitted pincode to make sure it is valid for the stored, encrypted keypair.
    confirmCorrectPincode: async ({
      pincode,
      firstPincode = "",
      signup = false,
    }) => {
      // If we are not signing up, make sure the submitted pincode successfully
      // decrypts and loads the stored keypair.
      if (!signup) {
        try {
          const keyManager = setupKeyManager();
          let { keyId } = get(walletStore);
          await keyManager.loadKey(keyId, pincode);
        } catch (err) {
          throw error(400, { message: "invalid pincode" });
        }
        // If we are signing up for the first time (thus, there is no stored
        // keypair), just make sure the first and second pincodes match.
      } else {
        if (pincode !== firstPincode) {
          throw error(400, { message: "pincode mismatch" });
        }
      }
    },

    // Sign and return a Stellar transaction
    sign: async ({ transactionXDR, network, pincode }) => {
      try {
        // Get our `keyManager` to interact with stored keypairs
        const keyManager = setupKeyManager();

        // Use the `keyManager` to sign the transaction with the
        // encrypted keypair
        let signedTransaction = await keyManager.signTransaction({
          transaction: TransactionBuilder.fromXDR(transactionXDR, network),
          id: get(walletStore).keyId,
          password: pincode,
        });
        return signedTransaction;
      } catch (err) {
        console.error("Error signing transaction", err);
        throw error(400, { message: err.toString() });
      }
    },
  };
}

// We export `walletStore` as the variable that can be used to interact with the wallet store.
export const walletStore = createWalletStore();

// Configure a `KeyManager` for use with stored keypairs.
const setupKeyManager = () => {
  // We make a new `KeyStore`
  const localKeyStore = new KeyManagerPlugins.LocalStorageKeyStore();

  // Configure it to use `localStorage` and specify a(n optional) prefix
  localKeyStore.configure({
    prefix: "bpa",
    storage: localStorage,
  });

  // Make a new `KeyManager`, that uses the previously configured `KeyStore`
  const keyManager = new KeyManager({
    keyStore: localKeyStore,
  });

  // Configure the `KeyManager` to use the `scrypt` encrypter
  keyManager.registerEncrypter(KeyManagerPlugins.ScryptEncrypter);

  // Return the `KeyManager` for use in other functions
  return keyManager;
};
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/lib/stores/walletStore.js

### Creando la cuenta en la red Stellar

Después de que hayamos registrado al usuario, necesitamos financiar la cuenta en la red Stellar. Como se ha comentado anteriormente, hay múltiples maneras de completar esta tarea, pero estamos usando Friendbot para asegurar que el usuario tiene algún XLM de Testnet con el que experimentar.

```js title="/src/lib/stellar/horizonQueries.js"
// Realiza un depósito en una cuenta usando la utilidad Friendbot en el Testnet.
export async function fundWithFriendbot(publicKey) {
  consola. og(`i am requesting a friendbot funding for ${publicKey}`);
  await server.friendbot(publicKey).call();
}
```

Fuente: https://github.com/stellar/basic-payment-app/blob/main/src/lib/stellar/horizonQueries.js

### Usando la tienda `walletStore`

Nuestro `walletStore` se utiliza en un montón de lugares en nuestra aplicación, especialmente en el modal de confirmación al pedir a un usuario que introduzca su código pincode. Siga leyendo cómo lo hemos hecho.

[sección de cuentas]: ../../../learn/fundamentals/stellar-data-structures/accounts.mdx
[aplicación no custodial]: ../application-design-considerations.mdx#non-custodial-service
[`js-stellar-wallets` sdk]: https://github.com/stellar/js-stellar-wallets
[reservas patrocinadas]: ../../../learn/encyclopedia/transactions-specialized/sponsored-reserves.mdx
[lista de contactos]: ./contactos-lista
