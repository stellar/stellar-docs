---
title: Modal de confirmación
sidebar_position: 22
---

Dado que el par de claves del usuario es cifrado con un pincode y almacenado en su navegador, de vez en cuando necesitaremos preguntarles para que ese pincode firme una transacción o demuestre que se les debe permitir realizar alguna acción o ver algunos datos.

## Experiencia de usuario

El usuario debe ser informado de cualquier acción que pueda tener lugar, especialmente cuando los fondos estén en la línea. Para garantizar esto, solicitaremos abiertamente su confirmación a través de pincode antes de que se haga algo. La aplicación no tiene forma de conocer el código pin de un usuario, por lo que no puede descifrar su par de claves sin su confirmación.

La ventana modal que hemos implementado facilita este flujo de confirmación siempre que lo necesitamos.

![modal de confirmación](/assets/confirm-pincode.png)

## Implementación de código

Nuestra función modal utiliza el paquete `svelte-simple-modal` para darnos un punto de partida versátil. Si necesita instalarlo ahora.

```bash npm2yarn
npm install --save-dev svelte-simple-modal
```

### Envolver el resto de nuestra aplicación en la modal

En el lado Svelte, este componente modal será un "envoltorio" alrededor del resto de nuestra aplicación, que nos permite activar la modal desde cualquier lugar que necesitemos, y debería comportarse de forma similar, sin importar qué.

```html title="/src/routes/+layout.svelte"
<script>
  import "../app.postcss";

  // We will use a `writable` Svelte store to trigger our modal
  // highlight-next-line
  import { writable } from "svelte/store";

  // We have a custom close button for consistent styling, but this is NOT a requirement.
  // highlight-start
  import ModalCloseButton from "$lib/components/ModalCloseButton.svelte";
  import Modal from "svelte-simple-modal";
  const modal = writable(null);
  // highlight-end
</script>

// highlight-next-line
<Modal
  show="{$modal}"
  closeButton="{ModalCloseButton}"
  classContent="rounded bg-base-100"
>
  <slot />
  // highlight-next-line
</Modal>
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/routes/+layout.svelte

### Crear un componente modal reutilizable Svelte

Para evitar reinventar la rueda cada vez que necesitamos un modal, crearemos un componente reutilizable que pueda adaptarse a la mayoría de nuestras necesidades. Entonces, cuando necesitamos la modal de confirmación, podemos pasar un objeto de accesorios para personalizar el comportamiento del modal.

:::note

En nuestros archivos de componentes `*.svelte`, **no** sumiremos en el marcado HTML fuera de las etiquetas `<script>`. La sintaxis Svelte usada en HTML se utiliza principalmente para iterar y es bastante comprensible de leer.

:::

Las partes básicas de este componente se ven así:

```html title="/src/lib/components/ConfirmationModal.svelte"
<script>
  importar { copy } desde "svelte-copy";
  importar { CopyIcon } desde "svelte-feather-icons";
  importar { errorMessage } desde "$lib/stores/alertsStore";
  importar { walletStore } de "$lib/stores/walletStore";
  importar { Networks, TransactionBuilder } de "stellar-sdk";

  // Un "context" de Svelte se utiliza para controlar cuando se 'abre' y 'close` un determinado
  // modal desde dentro de otros componentes
  import { getContext } from "svelte";
  const { close } = getContext("simple-modal");

  export let title = "Vista previa de la transacción";
  export let body =
    "Please confirm the transaction below in order to sign and submit it to the network. ;
  export let confirmButton = "Confirmar";
  export let rejectButton = "Rechazar";
  export let hasPincodeForm = true;
  export let transactionXDR = "";
  export let transactionNetwork = "";
  export let firstPincode = "";

  let isWaiting = false;
  let pincode = "";
  $: transacción = transactionXDR
    ? Constructor de transacciones. romXDR(
        transactionXDR,
        transactionNetwork || Red. ESTNET,
      )
    : nulo;
</script>

<! - HTML ha sido omitido de este tutorial. Por favor, compruebe el archivo de origen -->
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/lib/components/ConfirmationModal.svelte

### Activar el componente modal al registrarse

Ahora podemos utilizar este componente modal siempre que necesitemos confirmar algo del usuario. Por ejemplo, aquí es cómo se activa la modal cuando alguien se registra.

```html title="/src/routes/signup/+page.svelte"
<script>
  importar { Keypair } desde "stellar-sdk";
  importar TruncatedKey desde "$lib/components/TruncatedKey. velte";
  import ConfirmationModal from "$lib/components/ConfirmationModal. velte";
  importar { goto } desde "$app/navigation";
  import { walletStore } from "$lib/stores/walletStore";
  import { fundWithFriendbot } from "$lib/stellar/horizonQueries";

  // El contexto `open` Svelte se utiliza para abrir la modal de confirmación
  import { getContext } from "svelte";
  const { open } = getContext("simple-modal");

  // Define algunas variables de componentes que se utilizarán a lo largo de la página
  let keypair = Keypair. andom();
  $: publicKey = par de claves. ublicKey();
  $: secretKey = par de claves. ecret();
  let showSecret = false;
  let pincode = "";

  // Esta función se ejecuta cuando el usuario envía el formulario que contiene la clave
  // pública y su código pincode. Pasamos un objeto de accesorios que corresponde a las declaraciones
  // series de `export let` hechas en nuestro componente modal.
  const signup = () => {
    open(ConfirmationModal, {
      firstPincode: pincode,
      título: "Confirmar Pincode",
      cuerpo: "Por favor, vuelva a escribir su pincode de 6 dígitos para cifrar la clave secreta. ,
      rejectButton: "Cancelar",
    });
  };
</script>

<! - HTML ha sido omitido de este tutorial. Por favor, compruebe el archivo de origen -->
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/routes/signup/+page.svelte

### Personalizar el comportamiento de confirmación y rechazo

Ahora, como estos componentes han sido escritos hasta ahora, no _do_ nada cuando el usuario introduce su pincode o hace clic en un botón. ¡Vamos a cambiar eso!

Dado que el comportamiento de confirmación debe variar en función de las circunstancias (por ejemplo, diferentes acciones para el registro, envío de transacciones, etc.). , necesitamos una forma de pasar eso como un apoyo cuando abrimos la ventana modal.

En primer lugar, en nuestro componente modal, declaramos una función tonta para actuar como un prop, así como una función "interna" que llamará a la función de apoyo durante el curso de ejecución.

```html title="/src/lib/components/ConfirmationModal.svelte"
<script>
  /* ... */

  // `onConfirm` es una función de apoyo que será anulada del componente
  // que lanza la modal
  export let onConfirm = async () => {};
  // `_onConfirm` se ejecuta cuando el usuario hace clic en el botón "confirm"
  // del modal, y llama (in-turn) a la función `onConfirm` proporcionada
  const _onConfirm = async () => {
    isWaiting = true;
    try {
      // Nos aseguramos de que el usuario ha proporcionado el código pin correcto
      await walletStore. onfirmPincode({
        pincode: pincode,
        firstPincode: firstPincode,
        signup: firstPincode ? true : false,
      });

      // Llamamos a la función `onConfirm` que fue dada a la modal por
      // el componente exterior.
      esperando onConfirm(pincode);

      // Ahora podemos cerrar esta ventana modal
      close();
    } catch (err) {
      // Si hubo un error, establecemos nuestra alerta `errorMessage`
      errorMessage. et(err.body. essage);
    }
    isWaiting = false;
  };

  // Como arriba, `onReject` es una función de accesorios que será anulada
  // del componente que lanza la modal
  export let onReject = () => {};
  // Al igual que arriba, `_onReject` se ejecuta cuando el usuario hace clic en el botón
  // del "rechazo" del modal, y llama (si se proporciona) al `onReject`
  // function
  const _onReject = () => {
    // Llamamos a la función `onReject` que fue dada a la modal por el componente
    // exterior.
    onReject();
    close();
  };
</script>

<! - HTML ha sido omitido de este tutorial. Por favor, compruebe el archivo de origen -->
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/lib/components/ConfirmationModal.svelte

Ahora que nuestro componente modal está configurado para hacer uso de una función prop para confirmación y rechazo, podemos declarar lo que esas funciones deben hacer dentro de la página que genera el modal.

```html title="/src/routes/signup/+page.svelte"
<script>
  /* ... */

  // highlight-start
  const onConfirm = async (pincode) => {
    // Register the encrypted keypair in the user's browser
    await walletStore.register({
      publicKey: publicKey,
      secretKey: secretKey,
      pincode: pincode,
    });

    // Fund the account with a request to Friendbot
    await fundWithFriendbot(publicKey);

    // If the registration was successful, redirect to the dashboard
    if ($walletStore.publicKey) {
      goto("/dashboard");
    }
  };
  // highlight-end

  const signup = () => {
    open(ConfirmationModal, {
      firstPincode: pincode,
      title: "Confirm Pincode",
      body: "Please re-type your 6-digit pincode to encrypt the secret key.",
      rejectButton: "Cancel",
      // highlight-next-line
      onConfirm: onConfirm,
    });
  };
</script>

<!-- HTML has been omitted from this tutorial. Please check the source file -->
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/routes/signup/+page.svelte

Como puedes ver, en realidad no necesitábamos una función 'onReject' personalizada, así que no pasamos una. ¡Sin daño, sin impuros!
