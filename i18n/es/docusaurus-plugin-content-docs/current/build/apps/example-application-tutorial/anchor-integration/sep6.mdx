---
title: "SEP-6: API de depósito y retirada"
sidebar_position: 30
---

import useBaseUrl from "@docusaurus/useBaseUrl";

SEP-6 permite a carteras y otros clientes interactuar directamente con los anclajes sin que el usuario tenga que abandonar el monedero para ir al sitio del anchor. En esta integración, la información de un usuario de KYC es recolectada y manejada por el monedero y enviada al ancla _en nombre de_ el usuario.

## Encuentra el `TRANSFER_SERVER` del ancla

Antes de que podamos preguntar algo acerca de _how_ para hacer una transferencia SEP-6, tenemos que averiguar _where_ para descubrir esa información. Afortunadamente, el protocolo SEP-1 describe campos estandarizados para averiguar lo que necesitamos.

```js title=/src/lib/stellar/sep1.js
// Obtiene y devuelve el punto final utilizado para las interacciones de transferencia SEP-6.
export async function getTransferServerSep6(domain) {
  let { TRANSFER_SERVER } = await fetchStellarToml(domain);
  return TRANSFER_SERVER;
}
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/lib/stellar/sep1.js

## Obtener `/info`

Ahora que sabemos dónde se encuentra el servidor de transferencias, BasicPay necesita obtener el endpoint `/info` del servidor de transferencia del anclador para entender los métodos de transferencia soportados ([depósito, retiro, deposit-exchange](https://stellar. rg/protocol/sep-6#info)) y puntos finales disponibles, así como características adicionales que pueden estar disponibles durante las transferencias.

:::note

En este momento, BasicPay sólo soporta los métodos de transferencia `depósito` y `retirada`. Una versión futura de este tutorial incorporará los métodos de transferencia `*-exchange`.

:::

```js title=/src/lib/stellar/sep6.js
import { getTransferServerSep6 } from "$lib/stellar/sep1";

// Obtiene y devuelve información básica sobre lo que soporta el servidor de transferencia SEP-6.
export async function getSep6Info(domain) {
  let transferServer = await getTransferServerSep6(domain);
  let res = await fetch(`${transferServer}/info`);
  let json = await res. son();
  return json;
}
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/lib/stellar/sep6.js

## Mostrar elementos interactivos

Puesto que muchos de los extremos SEP-6 (y SEP-24) requieren autenticación, esperamos hasta que nuestro usuario esté [autenticado con SEP-10](. sep10.mdx) antes de mostrar qué tipos de transferencias están disponibles. Cuando tienen un token de autenticación válido, podemos mostrar algunos botones que el usuario puede usar para iniciar una transferencia.

El usuario puede iniciar uno de los métodos de transferencia (en BasicPay, sólo se admiten depósitos y retiros) haciendo clic en el botón “Deposit” o “Retirar” debajo de un activo soportado.

![sep6](/assets/sep6_deposit_delet.png)

```html title=/src/routes/dashboard/transfers/+page.svelte
<script>
  /* Esta etiqueta <script> ha sido abreviada para la simplicidad */

  // Importamos cosas de paquetes externos que serán necesarios
  importar { LogInIcon, LogOutIcon } de "svelte-feather-icons";

  // Importamos algunas de nuestras funciones `$lib`
  importar { getSep6Info } de "$lib/stellar/sep6";

  // El contexto `open` Svelte se utiliza para abrir la modal de confirmación
  importar { getContext } desde "svelte";
  const { open } = getContext("simple-modal");

  /* . . */
</script>

<!-- HTML ha sido omitido de este tutorial. Por favor revisa el archivo de origen -->
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/routes/dashboard/transfers/+page.svelte

## Un componente modal especial SEP-6

Si vuelves a nuestra [sección modal de confirmación](../confirmation-modal.mdx), diseñamos nuestro componente modal para que sea útil para cualquier cosa que necesitemos. Bueno, eso es _casi_ verdadero. El hecho es que las interacciones SEP-6 son simplemente complejas. Para facilitar esa complejidad, hemos creado un modal de transferencia SEP-6 construido con propósito. Hay **tanto** que no podíamos cubrir todo lo que hace aquí. Sin embargo, cubriremos los bits principales y enlazaremos a los archivos fuente pertinentes.

El propio componente modal se ha dividido en varios componentes Svelte más pequeños. Echa un vistazo a este archivo fuente para empezar a buscar cómo lo hemos puesto juntos: https://github.com/stellar/basic-payment-app/blob/main/src/routes/dashboard/transfers/components/TransferModalSep6.svelte

### Iniciando la modal SEP-6

Los botones anteriores usarán la función `launchTransferModalSep6` para mostrar la modal al usuario. Así es como se define en ese mismo archivo.

```html title=/src/routes/dashboard/transfers/+page.svelte
<script>
  /* Esta etiqueta <script> ha sido abreviada para la simplicidad */

  // Importamos cualquier componente Svelte que necesitemos
  importar TransferModalSep6 de ". components/TransferModalSep6.svelte";

  // Lanzar el modal SEP-6 para iniciar el proceso de transferencia y reunir información del usuario.
  const launchTransferModalSep6 = ({
    homeDomain,
    assetCode,
    assetIssuer,
    endpoint,
    sep6Info,
  }) => {
    // Abrir el modal de transferencia SEP-6, suministrando los accesorios relevantes para nuestro tipo de transferencia
    // deseado.
    open(TransferModalSep6, {
      homeDomain: homeDomain,
      assetIssuer: assetIssuer,
      transferData: {
        endpoint: endpoint,
      },
      formDatos: {
        account: data.publicKey,
        asset_code: assetCode,
      },
      sep6Info: sep6Info,
      // Esta función `submitPayment` se describe más adelante.
      submitPayment: submitPayment,
    });
  };
</script>

<! - HTML ha sido omitido de este tutorial. Por favor, compruebe el archivo de origen -->
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/routes/dashboard/transfers/+page.svelte

Una vez lanzado, el `TransferModalSep6` guiará al usuario a través de un "asistente" para reunir toda la información requerida y, en última instancia, crear la transferencia.

### Paso del módulo 1: Detalles de la transferencia

BasicPay solicita al usuario que introduzca información adicional como tipo de transferencia, destino y cantidad. Parte de esto está prepoblado basado en qué botón hizo clic el usuario. Sin embargo, el usuario puede cambiar cualquiera de los campos si así lo desea.

Perdonaremos la muestra de código en esta sección, ya que es principalmente Svelte cosas que están sucediendo. Puedes ver la fuente aquí: https://github.com/stellar/basic-payment-app/blob/main/src/routes/dashboard/transfers/components/TransferDetails.svelte

<img src={useBaseUrl("/assets/sep6_transfer_details.png")} width="45%" />

### Modal Paso 2: Recopilar información de KYC

Para averiguar qué infraestructura el ancla ha puesto a nuestra disposición para usar, necesitamos consultar el SEP-1 `stellar' del anclaje. oml` archivo para el campo `KYC_SERVER`. Si esto no está definido, BasicPay recurrirá al uso de `TRANSFER_SERVER` para estas solicitudes.

```js title=/src/lib/stellar/sep1.js
// Obtiene y devuelve el punto final usado para las interacciones KYC SEP-12.
export async function getKycServer(domain) {
  let { KYC_SERVER, TRANSFER_SERVER } = await fetchStellarToml(domain);
  // Si `KYC_SERVER` no está definido en el archivo TOML del dominio, `TRANSFER_SERVER`
  // será usado
  return KYC_SERVER ? TRANSFER_SERVER;
}
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/lib/stellar/sep1.js

Nuestro modal SEP-6 luego consulta el punto final SEP-12 del anclador para los campos KYC requeridos con una solicitud `GET`, y presentamos estos campos para que el usuario los complete.

<img src={useBaseUrl("/assets/sep6_kyc.png")} width="45%" />

```js title=/src/lib/stellar/sep12.js
import { getKycServer } from "$lib/stellar/sep1";

// Envía una solicitud `GET` para consultar el estado de KYC para un cliente, devuelve el estado actual del envío de KYC
export async function getSep12Fields({ authToken, homeDomain }) {
  let kycServer = await getKycServer(homeDomain);

  let res = await fetch(`${kycServer}/customer`, {
    method: "GET",
    cabeceras: {
      "Content-Type": "application/json",
      Autorización: `Portador ${authToken}`,
    },
  });
  let json = await res. son();

  return json;
}
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/lib/stellar/sep12.js

Una vez más, la presentación de los campos que el usuario debe completar está más en el lado Svelte de las cosas, por lo que no compartiremos esos detalles aquí. Sin embargo, la fuente de este componente está disponible aquí: https://github.com/stellar/basic-payment-app/blob/main/src/routes/dashboard/transfers/components/KYCInformation.svelte

### Paso de modal 3: Ponga campos KYC e informe del estado

Ahora que el usuario ha proporcionado la información necesaria para los requerimientos del ancla KYC, podemos enviarlos al servidor KYC del ancla con una solicitud `PUT`.

```js title=/src/lib/stellar/sep12.js
// Envía una solicitud `PUT` al servidor KYC, enviando los campos suministrados para el registro del cliente.
export async function putSep12Fields({ authToken, fields, homeDomain }) {
  let kycServer = await getKycServer(homeDomain);

  let res = await fetch(`${kycServer}/customer`, {
    method: "PUT",
    modo: "cors",
    cabeceras: {
      "Content-Type": "application/json",
      Autorización: `Bearer ${authToken}`,
    },
    cuerpo: JSON. tringify(fields),
  });
  let json = await res.json();

  return json;
}
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/lib/stellar/sep12.js

BasicPay recibe de la ancla un mensaje de estado para que el usuario lo vea. Una vez que el mensaje de estado es `ACCEPTED`, ¡finalmente podemos enviar la solicitud de transferencia real!

<img src={useBaseUrl("/assets/kyc_accepted.png")} width="50%" />

Este componente del modal SEP-6, como la mayoría de ellos, está casi totalmente relacionado con Svelte. Para mantener este tutorial (un poco) desordenado, te referiremos a la fuente del componente, que puedes encontrar aquí: https://github.com/stellar/basic-payment-app/blob/main/src/routes/dashboard/transfers/components/KYCStatus.svelte

### Paso 4: Enviar transferencia

BasicPay hace esta solicitud tomando todos los campos que han sido recolectados durante este proceso y envolviéndolos en una URL que contiene parámetros de consulta: [example](https://testanchor. tellar.org/sep6/deposit?account=GAXQIC2BSZ5HZP3BD6RZQSD3LB66TB6A2TA5W3LZX2VDFMBAKHC4B62J&asset_code=SRT&type=bank_account&amount=11)

Enviamos una solicitud `GET` a la URL con nuestro token de autorización en los encabezados, y el ancla la toma desde ahí!

```js title=/src/lib/stellar/sep6.js
// Inicia una transferencia usando el protocolo SEP-6.
exportar función asíncrona initiateTransfer6({
  authToken,
  endpoint,
  formData,
  domain,
}) {
  let transferServer = await getTransferServerSep6(domain);
  let searchParams = new URLSearchParams(formData);

  let res = await fetch(`${transferServer}/${endpoint}?${searchParams}`, {
    method: "GET",
    modo: "cors",
    cabeceras: {
      "Content-Type": "application/json",
      Autorización: `Bearer ${authToken}`,
    },
  });
  let json = await res. son();

  if (!res.ok) {
    arrojar error(res. tatus, {
      message: json.error,
    });
  } else {
    return json;
  }
}
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/lib/stellar/sep12.js

A continuación, guardamos los detalles de la transferencia en la tienda `transfersStore` y mostramos la respuesta del servidor de transferencia al usuario. Luego esperamos a que cierren el modal.

:::note

La única razón por la que guardamos algo acerca de la transferencia en BasicPay es para ayudarnos a realizar un seguimiento de los anclajes con los que el usuario ha iniciado las transferencias. De lo contrario, no podríamos consultar un historial de transferencias (como en la página `/dashboard`).

:::

### (Sometimes) Paso 5: Enviar un pago estelar

En una transacción de retiro, BasicPay también construirá y presentará al usuario una transacción Stellar para que firme con su código clave. ¡Aquí finalmente tendremos que volver a nuestro modal "regular" que _es_ tan bueno en tantas cosas!

```html title=/src/routes/dashboard/transfers/+page.svelte
<script>
  /* This <script> tag has been abbreviated for simplicity */

  // Define some component variables that will be used throughout the page
  let paymentXDR = "";
  let paymentNetwork = "";

  // After a withdraw transaction has been presented to the user, and they've confirmed with the correct pincode, sign and submit the transaction to the Stellar network.
  const onPaymentConfirm = async (pincode) => {
    // Use the walletStore to sign the transaction
    let signedTransaction = await walletStore.sign({
      transactionXDR: paymentXDR,
      network: paymentNetwork,
      pincode: pincode,
    });
    // Submit the transaction to the Stellar network
    await submit(signedTransaction);
  };

  // Builds a Stellar payment to present to the user which will complete a transfer to the Anchor.
  let submitPayment = async ({
    withdrawDetails,
    assetCode,
    assetIssuer,
    amount,
  }) => {
    let { transaction, network_passphrase } = await createPaymentTransaction({
      source: data.publicKey,
      destination: withdrawDetails.account_id,
      asset: `${assetCode}:${assetIssuer}`,
      amount: amount,
      memo: withdrawDetails.memo
        ? Buffer.from(withdrawDetails.memo, "base64")
        : undefined,
    });

    // Set the component variables to hold the transaction details
    paymentXDR = transaction;
    paymentNetwork = network_passphrase;

    // We close the SEP-6 modal, and open the regular confirmation modal
    close();
    open(ConfirmationModal, {
      transactionXDR: paymentXDR,
      transactionNetwork: paymentNetwork,
      onConfirm: onPaymentConfirm,
    });
  };

  /* ... */
</script>

<!-- HTML has been omitted from this tutorial. Please check the source file -->
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/routes/dashboard/transfers/+page.svelte
