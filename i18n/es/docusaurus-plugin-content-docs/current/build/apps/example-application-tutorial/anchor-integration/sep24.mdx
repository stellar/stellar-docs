---
title: "SEP-24: Alojamiento de depósito y retiro"
sidebar_position: 40
---

import sep24_transfers from "/assets/sep24_transfers.png";

SEP-24 proporciona una forma estándar para que las carteras y los anclajes interactúen haciendo que el usuario abra una vista web alojada por un ancla para recoger y manejar la información de KYC. En esta integración, la información de un usuario KYC es recogida y manejada enteramente por el ancla. En su mayor parte, después de que se haya abierto la vista web del anclaje, BasicPay tendrá poco conocimiento de lo que está sucediendo.

:::info

Recuerda, SEP-24 depende de [autenticación SEP-10]. Todo a continuación asume que el usuario se ha autenticado correctamente con el servidor de anclas, y BasicPay tiene acceso a un token de autenticación no caducado para enviar con sus peticiones.

:::

## Encuentra el `TRANSFER_SERVER_SEP0024` del anclador

Antes de que podamos preguntar algo acerca de _how_ para hacer una transferencia SEP-24, tenemos que averiguar _where_ para descubrir esa información. Afortunadamente, el protocolo SEP-1 describe campos estandarizados para averiguar lo que necesitamos.

```js title=/src/lib/stellar/sep1.js
// Obtiene y devuelve el punto final utilizado para las interacciones de transferencia SEP-24.
export async function getTransferServerSep24(domain) {
  let { TRANSFER_SERVER_SEP0024 } = await fetchStellarToml(domain);
  return TRANSFER_SERVER_SEP0024;
}
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/lib/stellar/sep1.js

## Obtener `/info`

Nuestra aplicación solicitará el punto final `/info` del servidor de transferencia del anclador para entender los métodos de transferencia soportados (depósito, retirada) y puntos finales disponibles, así como características adicionales que pueden estar disponibles durante las transferencias.

<img src={sep24_transfers} width="70%" />

```js title=/src/lib/stellar/sep24.js
// Obtiene y devuelve información básica sobre lo que soporta el servidor de transferencias SEP-24.
export async function getSep24Info(domain) {
  let transferServerSep24 = await getTransferServerSep24(domain);

  let res = await fetch(`${transferServerSep24}/info`);
  let json = await res. son();

  if (!res.ok) {
    arrojar error(res. tatus, {
      message: json.error,
    });
  } else {
    return json;
  }
}
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/lib/stellar/sep24.js

## El usuario hace clic en "depósito" o "retirada"

Ahora que tenemos toda la información del SEP-24 que el ancla nos ha puesto a nuestra disposición. le corresponde al usuario iniciar el proceso de iniciación. En BasicPay, lo hacen simplemente haciendo clic en un botón que luego activará la función `launchTransferWindowSep24`.

:::note

Este archivo estaba bastante cubierto en la [sección SEP-6]. Presentaremos aquí las adiciones que hacemos a este archivo, aunque no repetiremos las cosas que ya hemos cubierto. Recuerde revisar los archivos de origen para ver la imagen completa.

:::

```html title=/src/routes/dashboard/transfers/+page.svelte
<script>
  /* This <script> tag has been abbreviated for simplicity */

  // Launch the interactive SEP-24 popup window for the user to interact directly with the anchor to begin a transfer.
  const launchTransferWindowSep24 = async ({
    homeDomain,
    assetCode,
    assetIssuer,
    endpoint,
  }) => {
    // We initiate the transfer from the SEP-24 server, and get the
    // interactive URL back from it
    let { url } = await initiateTransfer24({
      authToken: $webAuthStore[homeDomain],
      endpoint: endpoint,
      homeDomain: homeDomain,
      urlFields: {
        asset_code: assetCode,
        account: data.publicKey,
      },
    });

    /* ... */
  };
</script>

<!-- HTML has been omitted from this tutorial. Please check the source file -->
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/routes/dashboard/transfers/+page.svelte

## Recuperar la URL interactiva

BasicPay entonces inicia un método de transferencia enviando una solicitud `POST` al punto final “Deposit” SEP-24 o “Retiro SEP-24”. El anclaje envía una URL interactiva que BasicPay abrirá como ventana emergente para que el usuario complete y confirme la transferencia.

```js title=/src/lib/stellar/sep24.js
// Inicia una transferencia usando el protocolo SEP-24.
exportar función asíncrona initiateTransfer24({
  authToken,
  endpoint,
  homeDomain,
  urlFields = {},
}) {
  let transferServerSep24 = await getTransferServerSep24(homeDomain);

  let res = await fetch(
    `${transferServerSep24}/transactions/${endpoint}/interactive`,
    {
      method: "POST",
      modo: "cors",
      cabeceras: {
        "Content-Type": "application/json",
        Autorización: `portador ${authToken}`,
      },
      cuerpo: JSON. tringify(urlFields),
    },
  );
  let json = await res.json();

  if (!res. k) {
    tiro error(res. tatus, {
      message: json.error,
    });
  } else {
    return json;
  }
}
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/lib/stellar/sep24.js

## Lanza la ventana emergente y escucha un callback

BasicPay no necesita (o quiere) saber todo lo que sucede entre el usuario y el anclaje durante una transferencia SEP-24. Sin embargo, _do_ queremos saber cuando la interacción ha terminado, ya que puede que necesitemos tomar alguna acción en ese momento. Por lo tanto, añadimos un callback a la URL interactiva y abrimos la ventana emergente.

:::caution

Puesto que BasicPay es una aplicación completamente de cliente, no podemos proporcionar un callback como URL. Así que estamos usando un callback `postMessage`. Para obtener más información sobre los detalles de estas opciones de devolución de llamada, consulte [esta sección de la especificación SEP-24].

:::

```html title=/src/routes/dashboard/transfers/+page.svelte
<script>
  /* Esta etiqueta <script> ha sido abreviada por la simplicidad */

  // Lanza la ventana emergente interactiva SEP-24 para que el usuario interactúe directamente con el ancla para iniciar una transferencia.
  const launchTransferWindowSep24 = async ({
    homeDomain,
    assetCode,
    assetIssuer,
    endpoint,
  }) => {
    /* ... */

    // Agregamos nuestro método de callback al final de la URL y lanzamos la ventana emergente
    // ventana para que el usuario interactúe con
    let interactiveUrl = `${url}&callback=postMessage`;
    let popup = window. pen(interactiveUrl, "bpaTransfer24Window", "popup");

    // Escuchamos el callback `message` desde la ventana emergente
    window. ddEventListener("message", async (event) => {
      /* . . */
    });
  };
</script>

<!-- HTML ha sido omitido de este tutorial. Por favor, compruebe el archivo de origen -->
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/routes/dashboard/transfers/+page.svelte

## Completar transferencia

Una vez que el usuario haya terminado con la ventana interactiva desde el ancla, serán devueltos a BasicPay. Almacenamos los detalles de la transferencia en la tienda `transfersStore` (recuerda, esto es sólo para que podamos rastrear qué anclas a buscar para las transferencias más adelante).

```html title=/src/routes/dashboard/transfers/+page.svelte
<script>
  /* Esta etiqueta <script> ha sido abreviada por la simplicidad */

  // Lanza la ventana emergente interactiva SEP-24 para que el usuario interactúe directamente con el ancla para iniciar una transferencia.
  const launchTransferWindowSep24 = async ({
    homeDomain,
    assetCode,
    assetIssuer,
    endpoint,
  }) => {
    /* . . */

    // Escuchamos el callback `message` desde la ventana emergente
    . ddEventListener("mensaje", async (event) => {
      // Cerrar la ventana interactiva si todavía no es
      popup?. lose();

      // Almacena la transferencia en el almacenamiento local
      del navegador. ddTransfer({
        homeDomain: homeDomain,
        protocol: "sep24",
        assetCode: assetCode,
        transferID: evento. ata.transacción. d,
      });

      /* ... */
    });
  };
</script>

<!-- HTML ha sido omitido de este tutorial. Por favor, compruebe el archivo de origen -->
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/routes/dashboard/transfers/+page.svelte

## (Sometimes) Enviar un pago estelar

En una transacción de retiro, BasicPay también construirá y presentará al usuario una transacción Stellar para que firme con su código clave.

```html title=/src/routes/dashboard/transfers/+page.svelte
<script>
  /* Esta etiqueta <script> ha sido abreviada por la simplicidad */

  // Lanza la ventana emergente interactiva SEP-24 para que el usuario interactúe directamente con el ancla para iniciar una transferencia.
  const launchTransferWindowSep24 = async ({
    homeDomain,
    assetCode,
    assetIssuer,
    endpoint,
  }) => {
    /* . . */

    // Escuchamos el callback `message` desde la ventana emergente
    . ddEventListener("message", async (event) => {
      /* . . */

      // Si el usuario ha solicitado un retiro con el ancla, necesitarán
      // enviar una transacción estelar que envíe el activo desde
      // la cuenta del usuario a una cuenta controlada por el fondo.
      si (event.data. rancho. ind === "retirada") {
        // Genera una transacción con los detalles necesarios para completar
        // la transferencia
        let { transaction, network_passphrase } =
          await createPaymentTransaction({
            source: data. ublicKey,
            destino: event.data.transaction. ithdraw_anchor_account,
            activo: `${assetCode}:${assetIssuer}`,
            cantidad: evento. ata.transaction.amount_in,
            memo: Buffer.from(event.data.transaction. ithdraw_memo, "base64"),
          });

        // Establecer las variables del componente para mantener los detalles de la transacción
        paymentXDR = transacción;
        paymentNetwork = network_passphrase;

        // Abrir la modal de confirmación para que el usuario confirme o rechace
        // la transacción de pago estelar. Proveemos nuestra función personalizada
        // `onPaymentConfirm` que será llamada como parte del proceso de confirmación
        // modal.
        open(ConfirmationModal, {
          transactionXDR: paymentXDR,
          transactionNetwork: paymentNetwork,
          onConfirm: onPaymentConfirm,
        });
      }
    });
  };
</script>

<! - HTML ha sido omitido de este tutorial. Por favor, compruebe el archivo de origen -->
```

**Fuente:** https://github.com/stellar/basic-payment-app/blob/main/src/routes/dashboard/transfers/+page.svelte

[autenticación sep-10]: ./sep10.mdx
[sep-6 sección]: ./sep6.mdx
[esta sección de la especificación sep-24]: https://www.stellar.org/protocol/sep-24#adding-parameters-to-the-url
