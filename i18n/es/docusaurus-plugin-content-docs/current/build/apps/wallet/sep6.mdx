---
title: Depósito programático y retirada
sidebar_position: 60
---

import { LanguageSpecific } from "@site/src/components/LanguageSpecific";

import { WalletCodeExample as CodeExample } from "@site/src/components/WalletCodeExample";
import Header from "./component/header.mdx";

<Header WIPLangs={["kotlin"]} />

El Estándar [SEP-6] define una forma para que los anclajes y monederos interactúen en nombre de los usuarios. Los monederos utilizan este estándar para facilitar los intercambios entre activos en cadena (como monedas estables) y activos fuera de cadena (como fiat, u otros recursos de red como BTC).

Tenga en cuenta que esto es para depósitos y retiros de _programmatic_. Para depósitos alojados y retiros, donde el anclaje interactúa con carteras interactivamente usando una ventana emergente, por favor vea [Hosted Deposit and Withdrawal](./sep24.mdx).

## Obtener información de ancla

Empecemos con la creación de un objeto sep6, que usaremos para todas las interacciones SEP-6:

<CodeExample>

```typescript
const sep6 = anchor.sep6();
```

```dart
var sep6 = anchor.sep6();
```

</CodeExample>

Primero, obtengamos información sobre el soporte del ancla para [SEP-6]. Esta solicitud no requiere autenticación, y devolverá información genérica, como monedas soportadas, y características soportadas por el anchor. Puedes obtener una lista completa de los campos devueltos en la [especificación SEP-6](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0006.md#info).

<CodeExample>

```typescript
const info = await sep6.info();
```

```dart
var info = await sep6.info();
```

</CodeExample>

## Iniciar un depósito

Antes de empezar, asegúrese de que se ha conectado al ancla y ha recibido un token de autenticación, como se describe en la guía de cartera [Stellar Authentication]. Utilizaremos `authToken` en los ejemplos siguientes como el token de autenticación [SEP-10] , obtenido anteriormente.

Para iniciar una operación, necesitamos conocer un activo. Puedes codificar esto. Asegúrese de que es uno que está incluido en la respuesta de información anterior.

:::info

Antes de comenzar con el flujo de depósito, asegúrese de que la cuenta de usuario ha [establecido una línea de confianza](./stellar.mdx#modify-assets-trustlines) para el activo con el que está trabajando.

:::

Empecemos con un depósito básico. Utilizaremos `account` para representar la clave pública de nuestra cuenta.

<CodeExample>

```typescript
const deposit = await sep6.deposit({
  authToken,
  params: {
    asset_code,
    account,
  },
});
```

```dart
var deposit = await anchor.sep6().deposit(
  Sep6DepositParams(assetCode: assetCode, accountt: accountId),
  authToken,
);
```

</CodeExample>

Hay varios tipos de respuestas, dependiendo de si el ancla necesita más información. Todos los depósitos y retiros tendrán estos mismos tipos de respuesta:

### 1. Respuesta exitosa

Si la respuesta es exitosa (HTTP 200), entonces el anclaje está procesando el depósito. Si necesita información adicional, la comunicará cuando proporcione [información de transacción](#getting-transaction-info).

### 2. Aún procesando, o denegado

Si un HTTP 403 con datos: `customer_info_status` es devuelto, significa que la acción todavía está procesando o no aceptada. En este caso, el campo `more_info_url` debe tener un enlace que describa los siguientes pasos.

Un ejemplo de respuesta:

```
{
  "type": "customer_info_status",
  "status": "denied",
  "more_info_url": "https://api.example.com/kycstatus?account=GACW7NONV43MZIFHCOKCQJAKSJSISSICFVUJ2C6EZIW5773OU3HD64VI"
}
```

### 3. Necesita más información de KYC

Otra respuesta común es un HTTP 403, con la respuesta: `non_interactive_customer_info_needed`. En este caso, el ancla necesita más información de KYC a través de [SEP-12].

Un ejemplo de respuesta:

```
{
  "type": "non_interactive_customer_info_needed",
  "fields" : ["family_name", "given_name", "address", "tax_id"]
}
```

Vamos a mostrar cómo una cartera puede manejar esta situación. Primero, obtenemos el objeto de respuesta al depósito. Si la respuesta incluye este error, entonces podemos ver los campos que faltan el anclaje que requiere.

<CodeExample>

```typescript
if (deposit.type === "non_interactive_customer_info_needed") {
  // manejar mostrar los campos faltantes al usuario
  console.log(deposit.fields);
}
```

```dart
if (deposit is Sep6MissingKYC) {
  print(deposit.fields);
}
```

</CodeExample>

La cartera necesitará manejar la visualización al usuario que campos faltan. Y luego para añadir esos campos, podemos utilizar la clase sep12 así.

<CodeExample>

```typescript
const sep12 = await anchor.sep12(authToken);

// añadiendo la información de kyc faltante (datos de muestra)
await sep12. dd({
  sep9Info: {
    family_name: "smith",
    given_name: "john",
    dirección: "123 street",
    tax_id: "123",
  },
});
```

```dart
var sep12 = await anchor. ep12(authToken);

// añadiendo la información de kyc que faltan (datos de ejemplo)
var sep9Info = {
  'family_name': 'smith',
  'given_name': 'john',
  'address': '123 street',
  'tax_id': '123',
};

var addResponse = await sep12. dd(sep9Info);
```

</CodeExample>

Entonces, podemos volver a llamar al método de depósito como antes y debería tener éxito.

Puede encontrar más información sobre cómo enviar información de KYC usando [SEP-12] en [Proporcionar información de KYC](#providing-kyc-info).

## Proporcionando información de KYC

Un anclaje puede responder a una solicitud de depósito o retiro diciendo que necesitan información adicional de KYC. Para solucionar esto, [SEP-6] soporta añadir la información de KYC de un cliente a través de [SEP-12]. El usuario puede enviar la información requerida usando el objeto sep12 como abajo.

Añadamos algo de información de KYC para nuestra cuenta usando datos de muestra. Los datos binarios (por ejemplo, datos de imagen), deben enviarse en un campo separado. Los campos permitidos para enviar al ancla están descritos en [SEP-9].

<CodeExample>

```typescript
const sep12 = await anchor.sep12(authToken);

await sep12. dd({
  sep9Info: {
    first_name: "john",
    last_name: "smith",
    email_address: "123@gmail. om",
    bank_number: "12345",
    bank_account_number: "12345",
  },
  sep9BinaryInfo: {
    photo_id_front: Buffer. rom("./ruta/a/image/front"),
    photo_id_back: Buffer.from("./ruta/to/image/back"),
  },
});
```

```dart
var sep12 = await anchor.sep12(authToken);

var sep9Info = {
  'first_name': 'john',
  'last_name': 'smith',
  'email_address': '123@gmail. om',
  'bank_number': '12345',
  'bank_account_number': '12345',
};

var photoIdFront = await Util. eadFile('./path/to/image/front');
var photoIdBack = await Util.readFile('. path/to/image/back');

var sep9Files = {
  'photo_id_front': photoIdFront,
  'photo_id_back': photoIdBack,
};

await sep12.add(sep9Info, sep9Files: sep9Files);
```

</CodeExample>

## Iniciar retiro

Comenzar un retiro es similar al depósito y tiene los mismos tipos de respuesta que se describió anteriormente.

<CodeExample>

```typescript
const resp = await sep6. ithdraw({
  authToken,
  params: {
    asset_code: "SRT",
    accountt: accountKp. ublicKey,
    tipo: "bank_account",
    dest: "123",
    dest_extra: "12345",
  },
});
```

```dart
var params = Sep6WithdrawParams(
    assetCode: 'SRT',
    account: accountId,
    type: 'bank_account',
    dest: '123',
    destExtra: '12345',
);

var resp = await anchor.sep6().withdraw(params, authToken);
```

</CodeExample>

## Obtener información de intercambio

Si el ancla soporta cotizaciones [SEP-38] , puede soportar depósitos que hacen un puente entre activos no equivalentes. Por ejemplo, un anclaje recibe BRL a través de transferencia bancaria y a cambio envía USDC (de valor equivalente menos honorarios) al usuario en Stellar.

Las funciones de intercambio de sep6 permiten a un usuario iniciar un depósito de cambio o retiro con el fondo, y el anclaje puede comunicar los siguientes pasos al usuario.

Primero, empecemos un intercambio de depósitos con datos de muestra. Los activos se describen utilizando el esquema [SEP-38].

<CodeExample>

```typescript
const resp = await sep6.depositExchange({
  authToken,
  params: {
    destination_asset:
      "stellar:SRT:GCDNJUBQSX7AJWLJACMJ7I4BC3Z47BQUTMHEICZLE6MU4KQBRY6B",
    source_asset: "iso4217:USD",
    amount: "10",
  },
});
```

```dart
var params = Sep6DepositExchangeParams(
    destinationAssetCode: 'SRT',
    sourceAssetId: FiatAssetId('USD'),
    amount: '10',
);

var resp = await anchor.sep6().depositExchange(params, authToken);
```

</CodeExample>

La respuesta sigue los mismos tipos que todos los depósitos y retiros para el SEP-6.

Ahora vamos a crear un intercambio de retiros, que siga el mismo formato que el intercambio de depósitos. También especificamos su retiro de cuenta bancaria usando el campo `type`.

<CodeExample>

```typescript
const resp = await sep6. ithdrawExchange({
  authToken,
  params: {
    destination_asset: "iso4217:USD",
    source_asset:
      "stellar:SRT:GCDNJUBQSX7AJWLJACMJ7I4BC3Z47BQUTMHEICZLE6MU4KQBRYG5JY6B", Monto
    : "10",
    : "bank_account",
  },
});
```

```dart
var params = Sep6WithdrawExchangeParams(
    sourceAssetCode: 'SRT',
    destinationAssetId: FiatAssetId('USD'),
    amount: '10',
    type: 'bank_account',
);

var resp = await anchor.sep6().Remove Exchange(params, authToken);
```

</CodeExample>

La respuesta sigue los mismos tipos que todos los depósitos y retiros para el SEP-6.

## Obteniendo información de la transacción

En el flujo típico, la cartera obtendría datos de transacción para notificar a los usuarios sobre las actualizaciones de estado. Esto se hace a través del punto final [SEP-6] `GET /transaction` y `GET /transactions`.

### Transacción de seguimiento

Veamos cómo usar el sdk para rastrear los cambios de estado de las transacciones. Utilizaremos la clase `Watcher` para este propósito. Primero, inicialicémoslo y comiencemos a rastrear una transacción.

<CodeExample>

```typescript
const watcher = anchor.sep6().watcher();

const { stop, refresh } = watcher.watchOneTransaction({
  authToken,
  assetCode,
  id: txId,
  onSuccess,
  onMessage,
  onError,
});
```

```dart
var watcher = anchor.sep6.watcher();
var result = watcher.watchOneTransaction(authToken, 'transaction id');

result.controller. tream. isten(
  (event) {
    if (event is StatusChange) {
      print('Status changed to ${event.status}. Transacción: ${event.transaction.id}');
    } else if (event is ExceptionHandlerExit) {
      print('Exception handler exited the job');
    } más si (event is StreamControllerClosed) {
      print('Controlador de Stream cerrado. Trabajo realizado');
    }
  }
);
```

</CodeExample>

Alternativamente, podemos rastrear múltiples transacciones para el mismo activo.

<CodeExample>

```typescript
const watcher = anchor.sep6().watcher();

const { stop, refresh } = watcher.watchAllTransactions({
  authToken,
  assetCode,
  onMessage,
  onError,
});
```

```dart
var watcher = anchor.sep6.watcher();
var result = watcher.watchAsset(authToken, asset);

result.controller.stream. isten(
  (event) {
    if (event is StatusChange) {
      print('Status changed to ${event.status}. Transacción: ${event.transaction.id}');
    } else if (event is ExceptionHandlerExit) {
      print('Exception handler exited the job');
    } más si (event is StreamControllerClosed) {
      print('Controlador de Stream cerrado. Trabajo realizado');
    }
  }
);
```

</CodeExample>

### Obteniendo transacción

Mientras que la clase `Watcher` ofrece potentes capacidades de seguimiento, a veces es necesario simplemente buscar una transacción (o transacciones) una vez. La clase `Anchor` te permite obtener una transacción por ID, ID de transacción estelar o ID de transacción externa:

<CodeExample>

```typescript
const transaction = await anchor
  .sep6()
  .getTransactionBy({ authToken, id: transactionId });
```

```dart
var transaction = await anchor.sep6().getTransactionBy(
    authToken: authToken,
    id: transactionId,
);
```

</CodeExample>

También es posible obtener transacciones por el activo.

<CodeExample>

```typescript
const transactions = await anchor.sep6().getTransactionsForAsset({
  authToken,
  assetCode,
});
```

```dart
var transactions = await anchor.sep6().getTransactionsForAsset(
  authToken: authToken,
  assetCode: assetCode,
);
```

</CodeExample>

[sep-6]: https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0006.md
[sep-9]: https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0009.md
[sep-10]: https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0010.md
[sep-12]: https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0012.md
[sep-38]: https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0038.md
[autenticación estelar]: ./sep10.mdx
