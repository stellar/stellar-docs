---
title: Seguir pagos recibidos
sidebar_position: 30
---

import { CodeExample } from "@site/src/components/CodeExample";

Este tutorial muestra lo fácil que es usar Horizon para ver los pagos entrantes en un [account](../../../learn/fundamentals/stellar-data-structures/accounts.mdx) usando JavaScript y `EventSource`. Vamos a esquivar usando [`js-stellar-sdk`](https://github. om/stellar/js-stellar-sdk), la biblioteca de ayuda de alto nivel, para mostrar que es posible realizar esta tarea por su cuenta con cualquier lenguaje de programación que desee utilizar.

Este tutorial asume que:

- Haga que node.js se instale localmente en su máquina.
- Tenga curl instalado localmente en su máquina.
- Se están ejecutando en Linux, macOS o cualquier otro sistema que tenga acceso a un shell similar a bash.
- Están familiarizados con el lanzamiento y ejecución de comandos en un terminal.

En este tutorial aprenderemos:

- Cómo crear una nueva cuenta.
- Cómo agregar fondos a tu cuenta usando friendbot.
- Cómo seguir los pagos a su cuenta usando curl y EventSource.

## Esqueleto del proyecto

Comencemos construyendo nuestro esqueleto de proyecto:

<CodeExample>

```bash
$ mkdir follow_tutorial
$ cd follow_tutorial
$ npm install --save stellar-base
$ npm install --save eventsource
```

</CodeExample>

Esto debería haber creado un `package.json` en el directorio `follow_tutorial`. Puedes comprobar que todo ha ido bien ejecutando el siguiente comando:

<CodeExample>

```bash
$ nodo -e "require('stellar-base')"
```

</CodeExample>

Todo fue exitoso si no se generó salida a partir del comando anterior. Ahora vamos a escribir un script para crear una nueva cuenta.

## Creando una cuenta

Crea un nuevo archivo llamado `make_account.js` y pega el siguiente texto en él:

<CodeExample>

```js
var Keypair = require("stellar-base").Keypair;

var newAccount = Keypair.random();

consola. og("Nuevo par de claves creado!");
console.log(" ID de la cuenta: " + newAccount.publicKey());
console.log(" is: " + newAccount.secret());
```

</CodeExample>

Guardar el archivo y ejecutarlo:

<CodeExample>

```bash
¡$ nodo make_account.js
Nuevo par de claves creado!
  ID de cuenta: GB7JFK56QXQ4DVJRNPDBXABNG3IVKIXWWJRJICHRU22Z5R5PI65GAK3
  Ninguno: SCU36V2OYTUMDSSU4EIVX4UHY3XC7N44VL4IJ26IOG6HVNC7DY5UJO
$
```

</CodeExample>

Antes de que nuestra cuenta pueda hacer cualquier cosa debe ser financiada. ¡De hecho, antes de que se financie una cuenta, no existe realmente!

## Financiando tu cuenta

La red de pruebas Stellar proporciona el Friendbot, una herramienta que los desarrolladores pueden usar para obtener lumens testnet para propósitos de prueba. Para depositar fondos en tu cuenta, simplemente ejecuta el siguiente comando curl:

<CodeExample>

```bash
$ curl "https://friendbot.stellar.org/?addr=GB7JFK56QXQ4DVJRNPDBXABNG3IVKIXWWJJRJICHRU22Z5R5PI65GAK3"
```

</CodeExample>

No te olvides de reemplazar el id de cuenta anterior con el tuyo propio. Si la solicitud tiene éxito, debería ver una respuesta como:

<CodeExample>

```json
{
  "hash": "ed9e96e136915103f5d8978cbb2036628e811f2c59c4c3d88534444cf504e360",
  "result": "received",
  "submission_result": "000000000000000a00000000000000000000000000000000000000000000000000000000000000"
}
```

</CodeExample>

Después de unos segundos, la red Stellar realizará consenso, cerrará el contador, y su cuenta habrá sido creada. Luego escribiremos un comando que reloja los nuevos pagos a su cuenta y envíe un mensaje a la terminal.

## Siguiendo pagos usando `curl`

Para seguir los nuevos pagos conectados a tu cuenta, simplemente necesitas enviar el encabezado `Acepto: text/event-stream` al punto final [/payments](../../data/horizon/api-reference/resources/operations/README.mdx).

<CodeExample>

```bash
$ curl -H "Aceptar: text/event-stream" "https://mediumon-testnet.stellar.org/accounts/GB7JFK56QXQ4DVJRNPDBXABNG3IVKIXWWJRJICHRU22Z5R5PI65GAK3/payments"
```

</CodeExample>

Como resultado verás algo como:

<CodeExample>

```text
retry: 1000
event: open
data: "hola"

id: 713226564145153
data: {"_links":{"effects":{"href":"/operations/713226564145153/effects/{? ursor,limit,order}","templated":true},
       "precedes":{"href":"/operations? ursor=713226564145153\u0026order=asc"},
       "self":{"href":"/operations/713226564145153"},
       "successeds":{"href":"/operations? ursor=713226564145153\u0026order=desc"},
       "transactions":{"href":"/transactions/713226564145152"}},
       "cuenta":"GB7JFK56QXQ4DVJRNPDBXABNG3IVKIXWWJRJICHRU22Z5R5PI65GAK3",
       "funder":"GBS43BF24ENNS3KPACUZVKK2VYPOZVBQO2CISGZ777RYGOPYC2FT6S3K",
       "id":713226564145153,
       "paging_token":"713226564145153",
       "starting_balance":"10000",
       "type_i":0,
       "type":"create_account"}
```

</CodeExample>

Cada vez que recibas un nuevo pago recibirás una nueva fila de datos. Los pagos no son el único punto final que soporta streaming. También puede transmitir transacciones [/transactions](../../data/horizon/api-reference/resources/transactions/README.mdx) y operaciones [/operations](../../data/horizon/api-reference/resources/operations/README.mdx).

## Siguiendo pagos usando `EventStream`

> **¡Advertencia!** el objeto `EventSource` no se vuelve a conectar para ciertos tipos de error por lo que puede dejar de funcionar. Si necesitas una conexión de streaming confiable, por favor usa nuestra [SDK](https://github.com/stellar/js-stellar-sdk).

Otra forma de seguir los pagos es escribir un simple script JS que transmitirá los pagos e imprimirlos en consola. Crea el archivo `stream_payments.js` y pega el siguiente código en él:

<CodeExample>

```js
var EventSource = require("eventsource");
var es = new EventSource(
  "https://Firston-testnet.stellar. rg/accounts/GB7JFK56QXQ4DVJRNPDBXABNG3IVKIXWWJJRJICHRU22Z5R5PI65GAK3/payments",
);
es.onmessage = function (message) {
  var result = mensaje. ata ? JSON.parse(message.data) : message;
  console.log("New payment:");
  consola. og(result);
};
es.onerror = function (error) {
  console.log("¡Ha ocurrido un error!");
};
```

</CodeExample>

Ahora, ejecuta nuestro script: `node stream_payments.js`. Deberías ver la siguiente salida:

<CodeExample>

```bash
Nuevo pago:
{ _links:
   { effects:
      { href: '/operations/713226564145153/effects/{? ursor,limit,order}',
        templated: true },
     precede: { href: '/operations? ursor=713226564145153&order=asc' },
     self: { href: '/operations/713226564145153' },
     tiene éxito: { href: '/operations? ursor=713226564145153&order=desc' },
     transacciones: { href: '/transactions/713226564145152' } },
  cuenta: 'GB7JFK56QXQ4DVJRNPDBXABNG3IVKIXWWJRJICHRU22Z5R5PI65GAK3',
  fundador: 'GBS43BF24ENNS3KPACUZVK2VYPOZVBQO2CISGZ777RYGOPYC2FT6S3K',
  id: 713226564145153,
  paging_token: '713226564145153',
  starting_balance: '10000',
  type_i: 0,
  type: 'create_account' }
```

</CodeExample>

## Probándolo

Ahora sabemos cómo conseguir un flujo de transacciones a una cuenta. Vamos a comprobar si nuestra solución funciona realmente y si aparecen nuevos pagos. Vamos a ver cómo enviamos un pago ([operación `create_account`](../../../learn/fundamentals/transactions/list-of-operations.mdx#create-account)) desde nuestra cuenta a otra cuenta.

Utilizamos la operación `create_account` porque estamos enviando el pago a una nueva cuenta sin fondos. Si estuviéramos enviando el pago a una cuenta que ya está financiada, usaríamos la [operación de pago\`](../../../learn/fundamentals/transactions/list-of-operations.mdx#payment).

Primero, revisemos nuestro número de secuencia de cuenta para que podamos crear una transacción de pago. Para ello enviamos una solicitud al horizonte:

<CodeExample>

```bash
$ curl "https://Texton-testnet.stellar.org/accounts/GB7JFK56QXQ4DVJRNPDBXABNG3IVKIXWWJJRJICHRU22Z5R5PI65GAK3"
```

</CodeExample>

El número de secuencia se puede encontrar bajo el campo `sequence`. Para nuestro ejemplo, el número de secuencia actual es `713226564141056`. Guarde su valor en algún lugar.

Ahora, crea el archivo `make_payment.js` y pega el siguiente código en él, reemplazando consecuentemente el número de secuencia:

<CodeExample>

```js
var StellarBase = require("stellar-base");
var StellarSdk = require("stellar-sdk");

var keypair = StellarBase.Keypair. romtformat@@1 (
  "SCU36VV2OYTUMDSSU4EIVX4UHY3XC7N44VL4IJ26IOG6HVNC7DY5UJO",
);
var account = new StellarBase. ccount(keypair.publicKey(), "713226564141056");

var amount = "100";
var transaction = new StellarSdk.TransactionBuilder(account, {
  networkPassphrase: StellarBase. etworks.TESTNET,
  cuota: StellarSdk.BASE_FEE,
})
  .addOperation(
    StellarBase. peration.createAccount({
      destino: StellarBase.Keypair.random(). ublicKey(),
      startingBalance: amount,
    }),
  )
  . etTimeout(180)
  . uild();

transaction.sign(keypair);

console.log(transaction.toEnvelope().toXDR().toString("base64"));
```

</CodeExample>

Después de ejecutar este script debería ver un bloque de transacción firmado. Para enviar esta transacción la enviamos a Horizon o Stellar-Core. Pero antes de que lo hagamos, abramos una nueva consola e iniciemos nuestro script anterior por `node stream_payments.js`.

Ahora para enviar una transacción sólo utiliza Horizon:

<CodeExample>

```bash
curl -H "Content-Type: application/json" -X POST -d '{"tx":"AAAAAAAAAAB+kqu+heHB1TFrxhuALTbRVSL2slMUoEeNNaz2PXo90wAAAGQAoitAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAABQAAAAAAAAAAAAAAAAAAQPo1YHJMpdWKKatEQxj
```

</CodeExample>

Deberías ver un nuevo pago en una ventana ejecutando el script `stream_payments.js`.
