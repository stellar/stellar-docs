---
title: Desplegar un contrato de Wasm bytecode instalado usando un contrato de despliegue
---

<head>
  <title>
    {`Deploy a contract from installed Wasm bytecode using a deployer contract`}
  </title>
  <meta charSet="utf-8" />
  <meta
    property="og:title"
    content="Deploy a contract from installed Wasm bytecode using a deployer contract"
  />
  <meta
    property="og:description"
    content="Deploy a contract from installed Wasm bytecode using a deployer contract"
  />
</head>

## Resumen

Esta guía recorre el proceso de despliegue de un contrato inteligente desde el bytecode instalado de Wasm usando un contrato de implementación. Cubriremos la configuración de su entorno, cargaremos el código de bytes de Wasm e implementaremos e inicializaremos un contrato atómicamente.

### Requisitos previos:

- Entendimiento básico del [lenguaje de programación de Rust](https://www.rust-lang.org/). Para subir a Rust, echa un vistazo a [Rustlings](https://github.com/rust-lang/rustlings) o [The Rust book](https://doc.rust-lang.org/book/).
- Familiaridad con [Stellar smart contracts](../../smart-contracts/getting-started/hello-world.mdx)
- Cargo instalado, [CLI estelar](../../smart-contracts/getting-started/setup.mdx#install-the-stellar-cli) y Soroban SDK

### Configurar entorno

El [ejemplo del implementador](https://github.com/stellar/soroban-examples/tree/v20.2.0/deployer) demuestra cómo implementar contratos usando un contrato.

1. Clonar el repositorio de ejemplos de Soroban:

```bash
git clon -b v20.2.0 https://github.com/stellar/soroban-examples
```

2. Navegar al Ejemplo de Desplegador:

```bash
cd soroban-ejemplos/desplegador/desplegador
```

:::note

Para que este ejemplo funcione, debes navegar a `deployer/contracts` y `deployer/deployer` y ejecutar el comando `stellar contract build` en cada directorio para generar los archivos de destino.

:::

3. Ejecutar tests:

En el `deployer/deployer`, ejecuta el siguiente comando:

```bash
prueba de carga
```

Debería ver la salida indicando las pruebas pasadas:

```bash
ejecutando 2 pruebas
test test::test_deploy_from_contract ... ok
test test::test_deploy_from_address ... ok
```

### Resumen del código

```rust title="deployer/deployer/src/lib.rs"
#[contract]
pub struct Deployer;

#[contractimpl]
impl Deployer {
    /// Despliega el contrato Wasm y después de implementar invoca la función init
    /// del contrato con los argumentos dados.
    ///
    /// Esto tiene que ser autorizado por `deployer` (a menos que la instancia `Deployer`
    /// en sí misma sea usada como deployer). De esta manera toda la operación es atómica
    /// y no es posible iniciar el contrato.
    ///
    /// Devuelve la dirección del contrato y el resultado de la función init.
    pub desplegado (
        env: Env,
        desplegador: Dirección,
        wasm_hash: BytesN<32>,
        sal: BytesN<32>,
        init_fn: Symbol,
        init_args: Vec<Val>,
    ) -> (Dirección, Val) {
        // Omitir autorización si el deployer es el contrato actual.
        si el desplegador != env. urrent_contract_address() {
            deployer. equire_auth();
        }

        // Despliega el contrato usando el Wasm subido con un hash dado.
        let deployed_address = env
            . eployer()
            . ith_address(deployer, salt)
            . eploy(wasm_hash);

        // Invoca la función init con los argumentos dados.
        let res: Val = env. nvoke_contract(&deployed_address, &init_fn, init_args);
        // Devuelve el ID del contrato desplegado y el resultado de
        // invocando el resultado inicial.
        (deployed_address, res)
    }
}
```

## Cómo funciona

El contrato de despliegues proporciona un mecanismo para desplegar otros contratos de forma segura y determinista. Garantiza que el despliegue sea autorizado por la dirección especificada del desplegador y soporta la inicialización atómica del contrato recientemente desplegado. Esto garantiza que el contrato se inicializa correctamente inmediatamente después del despliegue, evitando cualquier problema potencial con contratos no inicializados.

### Desglose de la función

- `env: Env`: El objeto Env representa el entorno de ejecución del contrato actual. Proporciona métodos para interactuar con el blockchain y otros contratos, así como realizar varias operaciones.
- `deployer: Dirección`: La dirección de la entidad que está solicitando el despliegue del contrato. Esta dirección se utilizará para autorizar el despliegue.
- `wasm_hash: BytesN<32>`: El hash del bytecode de Wasm del contrato a ser desplegado y ya debe estar instalado y en el contador. Este hash se utiliza para identificar de forma única el código del contrato.
- `salt: BytesN<32>`: Un valor único utilizado para derivar la dirección del contrato desplegado. La misma combinación de dirección del desplegador y sal siempre producirá la misma dirección del contrato desplegado, lo que garantizará direcciones deterministas del contrato.
- `init_fn: Symbol`: El nombre de la función de inicialización que se llamará en el contrato recién desplegado.
- `init_args: Vec<Val>`: Un vector de argumentos, especificado como ` objetos{type: value}`, a ser pasado a la función de inicialización del contrato desplegado.

### Pasos de función

```rust
if deployer != env.current_contract_address() {
   deployer.require_auth();
}
```

La función comprueba si la dirección `deployer` es la misma que la dirección del contrato actual. Si no es así, requiere la autorización de la dirección del desplegador para asegurarse de que el desplegador ha permitido este despliegue.

```rust
let deployed_address = env
   .deployer()
   .with_address(deployer, salt)
   .deploy(wasm_hash);
```

- Utiliza el método `env.deployer()` para crear un objeto de deployer.
- `with_address(deployer, salt)` especifica la dirección del desplegador y la sal para derivar la dirección del nuevo contrato.
- `deploy(wasm_hash)` implementa el contrato usando el hash de código de byte Wasm proporcionado y devuelve la dirección del contrato recién desplegado.

```rust
let res: Val = env.invoke_contract(&deployed_address, &init_fn, init_args);
```

- Invoca la función de inicialización especificada (`init_fn`) en el contrato recientemente desplegado (`deployed_address`), pasando los argumentos de inicialización proporcionados (`init_args`).
- El resultado de esta llamada a función se almacena en `res`.

```rust
(dirección_desplegada, res)
```

Devuelve una tupla que contiene la dirección del contrato recientemente desplegado y el resultado de la función de inicialización.

### Construir los contratos

Para construir el contrato en un archivo `.wasm`, utiliza el comando `stellar contract build`. Este comando construye tanto el contrato de despliegue como el contrato de prueba.

```sh
construcción de contrato estelar
```

Ambos archivos `.wasm` deben encontrarse en ambos directorios `target` del contrato después de construir ambos contratos:

```
objetivo/wasm32-unknown-unknown/release/soroban_deployer_contract.wasm
```

```
objetivo/wasm32-unknown-unknown/release/soroban_deployer_test_contract.wasm
```

## Ejecutar el contrato

Antes de implementar el contrato de prueba con el implementador, instale el contrato de prueba Wasm usando el comando `install`. El comando `install` imprimirá el hash derivado del archivo Wasm que debe ser usado por el deployer.

```sh
stellar contract install \
--wasm contract/target/wasm32-unknown-unknown/release/soroban_deployer_test_contract.wasm \
--source-account alice \
--network testnet
```

Al desplegar un contrato inteligente en la red, debe especificar una identidad que se utilizará para firmar las transacciones. Cambia la `alice` [identity] a la tuya.

[identidad]: ../../smart-contracts/getting-started/setup.mdx#configure-an-identity

El comando imprime el hash como hex. Se verá algo como `6bc6d975ef99c057231481c40f69f4c2a8a89ac56e8826ef0378f8e5c6abc4be`.

También necesitamos desplegar el contrato `Desployer`:

```sh
despliegue de contrato estelar \
  --wasm deployer/target/wasm32-unknown-unknown/release/soroban_deployer_contract.wasm \
  --source alice \
  --network testnet
```

Esto devolverá la dirección del deployer. Por ejemplo: `CDKYZMA3OXR54YAHOQ5D4EWDFDT3ZNKKRYKQT7MGPWH22ZVD2DX2BJID`.

Entonces el contrato de despliegue puede ser invocado con el valor hash de Wasm arriba.

```sh
stellar contract invoke \
  --id CDKYZMA3OXR54YAHOQ5D4EWDFDT3ZNKKRYKQT7MGPWH22ZVD2DX2BJID \
  --source alice \
  --network testnet \
  -- \
  deploy \
  --deployer CDKYZMA3OXR54YAHOQ5D4EWDFDT3ZNKKRYKQT7MGPWH22ZVD2DX2BJID \
  --salt 123 \
  --wasm_hash 6bc6d975ef99c057231481c40f69f4c2a8a89ac56e8826ef0378f8e5c6abc4be \
  --init_fn init \
  --init_args '[{"u32":8}]'
```

sustituye `alice` por tu propia identidad

La invocación del contrato del desplegador devolverá la dirección del Contrato (por ejemplo: `CCTVFX6BFTQHTGAHA5TY4YZQJRUKRE2RNUTGVBNKE3PJF5C7CI53APY`) del contrato de prueba recientemente desplegado.

Invoca el contrato de prueba desplegado usando la dirección devuelta desde el comando anterior.

```sh
stellar contract invoke \
  --id CCTVFX6BFTQHTGAHA5TY4YZQJRUKRE2RNUTGVBNKE3PJF5C7CI53APY \
  --source alice \
  --network testnet \
  -- \
  valor
```

Debería recibir algo como la siguiente salida:

```json
8
```
