---
title: Eventos
description: Publicar eventos desde un contrato inteligente.
sidebar_position: 10
---

<head>
  <title>Publicar eventos desde un contrato inteligente.</title>
  <meta charSet="utf-8" />
  <meta property="og:title" content="Publicar eventos desde un contrato inteligente." />
  <meta
    property="og:description"
    content="Publicar eventos desde un contrato inteligente. Los eventos del contrato permiten a los contratos emitir información sobre lo que el contrato está haciendo utilizando la función de publicación de eventos del entorno. "
  />
</head>

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";
import { getPlatform } from "@site/src/helpers/getPlatform";

El [ejemplo de eventos] demuestra cómo publicar eventos desde un contrato. Este ejemplo es una extensión del [ejemplo de almacenamiento de datos].

[![Abrir en Codespaces](https://github.com/codespaces/badge.svg)][open-in-github-codespaces]

[![Abrir en Codeanywhere](https://codeanywhere.com/img/open-in-codeanywhere-btn.svg)][open-in-code-anywhere]

[open-in-github-codespaces]: https://github.com/codespaces/new?repo=stellar/soroban-examples&editor=web
[open-in-code-anywhere]: https://app.codeanywhere.com/#https://github.com/stellar/soroban-examples
[ejemplo de eventos]: https://github.com/stellar/soroban-examples/tree/v22.0.1/events
[ejemplo de almacenamiento de datos]: ../getting-started/storing-data.mdx

## Ejecutar el ejemplo

Primero pasa por el proceso de [Configuración] para tener tu entorno de desarrollo configurado, luego clona la etiqueta `v22.0.1` del repositorio `soroban-examples`:

[configuración]: ../getting-started/setup.mdx

```
git clone -b v22.0.1 https://github.com/stellar/soroban-examples
```

O bien, puedes evitar la configuración del entorno de desarrollo y abrir este ejemplo en [GitHub Codespaces][open-in-github-codespaces] o en [Code Anywhere][open-in-code-anywhere].

Para ejecutar las pruebas del ejemplo, navega al directorio `events`, y usa `cargo test`.

```
cd events
cargo test
```

Deberías ver la salida:

```
running 1 test
test test::test ... ok
```

## Código

```rust title="events/src/lib.rs"
const COUNTER: Symbol = symbol_short!("COUNTER");

#[contract]
pub struct IncrementContract;

#[contractimpl]
impl IncrementContract {
    /// Increment increments an internal counter, and returns the value.
    pub fn increment(env: Env) -> u32 {
        // Get the current count.
        let mut count: u32 = env.storage().instance().get(&COUNTER).unwrap_or(0); // If no value set, assume 0.

        // Increment the count.
        count += 1;

        // Save the count.
        env.storage().instance().set(&COUNTER, &count);

        // Publish an event about the increment occuring.
        // The event has two topics:
        //   - The "COUNTER" symbol.
        //   - The "increment" symbol.
        // The event data is the count.
        env.events()
            .publish((COUNTER, symbol_short!("increment")), count);

        // Return the count to the caller.
        count
    }
}
```

Ref: https://github.com/stellar/soroban-examples/tree/v22.0.1/events

## Cómo funciona

Este contrato de ejemplo extiende el ejemplo de incremento publicando un evento cada vez que se incrementa el contador.

Los eventos del contrato permiten a los contratos emitir información sobre lo que su contrato está haciendo.

Los contratos pueden publicar eventos utilizando la función de publicación de eventos de los entornos.

```rust
env.events().publish(topics, data);
```

### Temas de eventos

Los temas se definen convenientemente utilizando una tupla. En el código de ejemplo se utilizan dos temas de tipo `Symbol`.

```rust
env.events().publish((COUNTER, symbol_short!("increment")), ...);
```

:::tip

Los temas no tienen que estar hechos del mismo tipo.

:::

### Datos del evento

Un evento también contiene un objeto de datos de cualquier valor o tipo, incluyendo tipos definidos por contratos utilizando `#[contracttype]`. En el ejemplo, los datos son el conteo `u32`. En el ejemplo, los datos son el conteo `u32`.

```rust
env.events().publish(..., count);
```

### Publicar

Publicar un evento se realiza llamando a la función `publish` y dándole los temas y datos. La función no retorna nada si tiene éxito, y causa pánico en caso de falla. Las razones de fallo pueden incluir entradas mal formadas (por ejemplo, el conteo de temas excede el límite) y agotar el presupuesto de recursos (TBD). Una vez publicado exitosamente, el nuevo evento estará disponible para aplicaciones que consuman los eventos.

```rust
env.events().publish((COUNTER, symbol_short!("increment")), count);
```

:::caution

Los eventos publicados se descartan si una invocación de contrato falla debido a un pánico, agotamiento del presupuesto, o cuando el contrato retorna un error.

:::

## Pruebas

Abre el archivo `events/src/test.rs` para seguir adelante.

```rust title="events/src/test.rs"
#[test]
fn test() {
    let env = Env::default();
    let contract_id = env.register(IncrementContract, ());
    let client = IncrementContractClient::new(&env, &contract_id);

    assert_eq!(client.increment(), 1);
    assert_eq!(client.increment(), 2);
    assert_eq!(client.increment(), 3);

    assert_eq!(
        env.events().all(),
        vec![
            &env,
            (
                contract_id.clone(),
                (symbol_short!("COUNTER"), symbol_short!("increment")).into_val(&env),
                1u32.into_val(&env)
            ),
            (
                contract_id.clone(),
                (symbol_short!("COUNTER"), symbol_short!("increment")).into_val(&env),
                2u32.into_val(&env)
            ),
            (
                contract_id,
                (symbol_short!("COUNTER"), symbol_short!("increment")).into_val(&env),
                3u32.into_val(&env)
            ),
        ]
    );
}
```

En cualquier prueba, lo primero que siempre se requiere es un `Env`, que es el entorno de Soroban en el que el contrato se ejecutará.

```rust
let env = Env::default();
```

El contrato se registra con el entorno utilizando el tipo de contrato.

```rust
let contract_id = env.register(IncrementContract, ());
```

Todas las funciones públicas dentro de un bloque `impl` que está anotado con el atributo `#[contractimpl]` tienen una función correspondiente generada en un tipo de cliente generado. El tipo de cliente se llamará igual que el tipo de contrato con `Client` añadido. Por ejemplo, en nuestro contrato el tipo de contrato es `IncrementContract`, y el cliente se llama `IncrementContractClient`.

```rust
let client = IncrementContractClient::new(&env, &contract_id);
```

El ejemplo invoca el contrato varias veces.

```rust
assert_eq!(client.increment(), 1);
```

El ejemplo afirma que se publicaron los eventos.

```rust
assert_eq!(
    env.events().all(),
    vec![
        &env,
        (
            contract_id.clone(),
            (symbol_short!("COUNTER"), symbol_short!("increment")).into_val(&env),
            1u32.into_val(&env)
        ),
        // ...
    ]
);
```

## Construir el contrato

Para construir el contrato, usa el comando `stellar contract build`.

```sh
stellar contract build
```

Un archivo `.wasm` debería generarse en el directorio `target`:

```
target/wasm32v1-none/release/soroban_events_contract.wasm
```

## Ejecutar el contrato

Si tienes [`stellar-cli`] instalado, puedes invocar funciones del contrato utilizándolo.

<Tabs groupId="platform" defaultValue={getPlatform()}>

<TabItem value="unix" label="macOS/Linux">

```sh
stellar contract invoke \
    --wasm target/wasm32v1-none/release/soroban_events_contract.wasm \
    --id 1 \
    -- \
    increment
```

</TabItem>

<TabItem value="windows" label="Windows (PowerShell)">

```powershell
stellar contract invoke `
    --wasm target/wasm32v1-none/release/soroban_events_contract.wasm `
    --id 1 `
    -- `
    increment
```

</TabItem>

</Tabs>

La siguiente salida debería ocurrir utilizando el código anterior.

```json
1
#0: event: {"ext":"v0","contractId":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],"type":"contract","body":{"v0":{"topics":[{"symbol":[67,79,85,78,84,69,82]},{"symbol":[105,110,99,114,101,109,101,110,116]}],"data":{"u32":1}}}}
```

Se genera un único evento `#0`, que es el evento del contrato que publicó el contrato. El evento contiene los dos temas, cada uno un `symbol` (mostrado como bytes), y el objeto de datos que contiene el `u32`.

[`stellar-cli`]: ../getting-started/setup.mdx#install-the-stellar-cli
