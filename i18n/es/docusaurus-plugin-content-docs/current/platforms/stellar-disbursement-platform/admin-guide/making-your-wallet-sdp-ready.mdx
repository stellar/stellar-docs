---
title: Preparar tu Wallet para SDP
sidebar_position: 80
---

Recuerda que cualquier instancia de SDP necesitar谩 un acuerdo con un proveedor de wallet antes de enviar desembolsos a esa wallet. Esto asegura que las wallets est茅n c贸modas recibiendo fondos de tu organizaci贸n y regula cualquier arreglo comercial entre las organizaciones. La wallet necesitar谩 incluir en su lista blanca el dominio del SDP antes de que el SDP pueda enviar desembolsos a esa wallet. Cuando se a帽ade el dominio de la wallet a un SDP, se est谩 incluyendo efectivamente en la lista blanca por parte del SDP. Ambas partes listando a la otra les permite recuperar el archivo stellar.toml y verificar la clave de firma necesaria para el handshake [SEP-10](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0010.md).

En esta p谩gina, cubriremos los aspectos t茅cnicos de la integraci贸n SDP-Wallet, incluyendo c贸mo a帽adir una Wallet en la base de datos del SDP, c贸mo validar y soportar los enlaces de registro usando [deep linking](https://en.wikipedia.org/wiki/Mobile_deep_linking) de aplicaciones m贸viles, c贸mo iniciar el flujo de registro de usuario en la wallet usando [SEP-24](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0024.md), y un enfoque recomendado para manejar [deferred deep linking](https://en.wikipedia.org/wiki/Mobile_deep_linking#Deferred_deep_linking).

## Agregar una Wallet a un SDP

La lista predeterminada de wallets SDP depende de qu茅 red se est茅 usando (testnet o pubnet). La red se pasa como variable de entorno y luego la lista de wallets se puede inicializar apropiadamente al iniciar el SDP mediante el comando CLI `./stellar-disbursement-platform db setup-for-network`, de acuerdo con una lista fija de wallets conocidas. Alternativamente, las wallets se pueden insertar directamente en la base de datos del SDP mediante un comando SQL. Ambos m茅todos requieren a帽adir el nombre de la wallet, p谩gina principal, dominio cliente SEP-10 y esquema de deep link.

Para insertarlo directamente en la base de datos, actualiza tus valores y ejecuta la siguiente consulta en Postgres. Aseg煤rate de revisar primero tu base de datos y el espacio de nombres.

<CodeExample>

```sql
INSERT INTO wallets (name, homepage, deep_link_schema, sep_10_client_domain)
VALUES ('Vibrant Assist', 'https://vibrantapp.com', 'https://vibrantapp.com/sdp', 'api.vibrantapp.com');
```

</CodeExample>

Para configurar una wallet mediante c贸digo, a帽谩dela a la secci贸n de testnet o pubnet de `DefaultWalletsNetworkMap`. Esto se usar谩 cuando ejecutes el comando CLI `./stellar-disbursement-platform db setup-for-network`, que actualiza la base de datos SDP y hace que la wallet est茅 disponible para nuevos desembolsos. A帽ade tu nueva wallet siguiendo el mismo formato ya presente en el c贸digo.

<CodeExample>

```go
var DefaultWalletsNetworkMap = WalletsNetworkMapType{
	utils.PubnetNetworkType: {
		{
			Name:              "Vibrant Assist",
			Homepage:          "https://vibrantapp.com/assist",
			DeepLinkSchema:    "https://vibrantapp.com/sdp",
			SEP10ClientDomain: "api.vibrantapp.com",
		},
	},
	utils.TestnetNetworkType: {
		{
			Name:              "Vibrant Assist",
			Homepage:          "https://vibrantapp.com",
			DeepLinkSchema:    "https://vibrantapp.com/sdp-dev",
			SEP10ClientDomain: "api-dev.vibrantapp.com",
		},
		{
			Name:              "Demo Wallet",
			Homepage:          "https://demo-wallet.stellar.org",
			DeepLinkSchema:    "https://demo-wallet.stellar.org",
			SEP10ClientDomain: "demo-wallet-server.stellar.org",
		},
	},
}
```

</CodeExample>

## Experiencia de Registro del Receptor

La experiencia de registro del receptor es fundamental para que esta aplicaci贸n sea fluida y f谩cil de usar. Esto requiere que la wallet soporte [deferred deep linking](https://en.wikipedia.org/wiki/Mobile_deep_linking#Deferred_deep_linking), que se discutir谩 en una secci贸n posterior. Una buena descripci贸n de la experiencia de registro es la siguiente:

1. El receptor recibe un mensaje de invitaci贸n notific谩ndole que tiene un pago pendiente de la organizaci贸n y se le invita a hacer clic en un [deep link](https://en.wikipedia.org/wiki/Mobile_deep_linking) para abrir o instalar y abrir una aplicaci贸n de wallet

2. Cuando el receptor abre la aplicaci贸n de wallet, la wallet inmediatamente integra al receptor, crea una cuenta Stellar y trustline para el activo deseado, inicia una transacci贸n de dep贸sito [SEP-24](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0024.md) con el SDP, y abre la p谩gina web de registro del SDP como una pantalla superpuesta/iframe dentro de la app.

3. El usuario confirma su n煤mero de tel茅fono y fecha de nacimiento directamente con el SDP, sin compartir datos con la wallet, y despu茅s de concluir el registro, se le redirige a la aplicaci贸n de wallet. Aqu铆 est谩n las pantallas que demuestran estos pasos:

  

![Flujo de Registro](/assets/sdp/27.png)

4. El usuario recibe el pago en segundos

## Enlace Profundo de Registro

Una vez que el usuario ha instalado la aplicaci贸n de wallet, esta debe ser capaz de interpretar un [deep link](https://en.wikipedia.org/wiki/Mobile_deep_linking) que siga el formato registrado en el SDP para iniciar el [Procedimiento de Registro de Wallet](#wallet-registration-procedure). El formato del deep link soportado por el SDP sigue este formato:

```url
https://<host-with-optional-path>?asset=<asset>&domain=<domain>&name=<name>&signature=<signature>
```

- `asset`: el activo Stellar.
- `domain`: el dominio que aloja el archivo `stellar.toml` del SDP. La wallet necesitar谩 usarlo tanto para obtener el archivo `stellar.toml`, como para rellenar el campo `home_domain` en la transacci贸n GET challenge [SEP-10](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0010.md).
- `name`: el nombre de la organizaci贸n que env铆a los pagos.
- `signature`: una firma de la clave de firma [SEP-10](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0010.md) del SDP.

:::info

Ten en cuenta que el deep link es espec铆fico para cada SDP, organizaci贸n pagadora y activo. No es espec铆fico para cada receptor individual. No hay riesgo en compartir el enlace con receptores que forman parte del mismo desembolso. El enlace ser谩 el mismo para m煤ltiples receptores, y estos probar谩n su identidad como parte del flujo de dep贸sito [SEP-24](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0024.md).

:::

A continuaci贸n, un ejemplo de enlace de registro (firmado)

```url
https://vibrantapp.com/sdp-dev?asset=USDC-GBBD47IF6LWK7P7MDEVSCWR7DPUWV3NY3DTQEVFL4NAT4AQH3ZLLFLA5&domain=ap-stellar-disbursement-platform-backend-dev.stellar.org&name=Stellar+Test&signature=fea6c5e805a29b903835bea2f6c60069113effdf1c5cb448d4948573c65557b1d667bcd176c24a94ed9d54a1829317c74f39319076511512a3e697b4b746ae0a
```

En este ejemplo, el host es `https://vibrantapp.com/sdp-dev` y la firma es el resultado de firmar la URL (sin firma) abajo usando la clave de firma [SEP-10](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0010.md) `SBUSPEKAZKLZSWHRSJ2HWDZUK6I3IVDUWA7JJZSGBLZ2WZIUJI7FPNB5`, con la clave p煤blica siendo `GBFDUUZ5ZYC6RAPOQLM7IYXLFHYTMCYXBGM7NIC4EE2MWOSGIYCOSN5F`:

```url
https://vibrantapp.com/sdp-dev?asset=USDC-GBBD47IF6LWK7P7MDEVSCWR7DPUWV3NY3DTQEVFL4NAT4AQH3ZLLFLA5&domain=ap-stellar-disbursement-platform-backend-dev.stellar.org&name=Stellar+Test
```

En este ejemplo, la firma es `fea6c5e805a29b903835bea2f6c60069113effdf1c5cb448d4948573c65557b1d667bcd176c24a94ed9d54a1829317c74f39319076511512a3e697b4b746ae0a`.

A continuaci贸n, un fragmento JavaScript demostrando c贸mo verificar la firma:

```js
#!/usr/bin/env node

const { Keypair } = require("stellar-sdk");

// The SDP's stellar.toml SIGNING_KEY
//
// For security, this should ideally be fetched from
// https://<domain>/.well-known/stellar.toml on demand
const keypair = Keypair.fromPublicKey(
  "GBFDUUZ5ZYC6RAPOQLM7IYXLFHYTMCYXBGM7NIC4EE2MWOSGIYCOSN5F",
);
console.log("public key:", keypair.publicKey());

let url =
  "https://vibrantapp.com/sdp-dev?asset=USDC-GBBD47IF6LWK7P7MDEVSCWR7DPUWV3NY3DTQEVFL4NAT4AQH3ZLLFLA5&domain=ap-stellar-disbursement-platform-backend-dev.stellar.org&name=Stellar%20Test";
let signature =
  "fea6c5e805a29b903835bea2f6c60069113effdf1c5cb448d4948573c65557b1d667bcd176c24a94ed9d54a1829317c74f39319076511512a3e697b4b746ae0a";

console.log(
  "verified:",
  keypair.verify(
    Buffer.from(url.toString(), "utf8"),
    Buffer.from(signature, "hex"),
  ),
);
```

### Procedimiento de Registro de Wallet

Al abrir el [deep link](https://en.wikipedia.org/wiki/Mobile_deep_linking) de registro, estos son los pasos que la wallet debe seguir para aplicar las medidas de seguridad y privacidad esperadas en este flujo, y para permitir que el usuario ingrese su informaci贸n directamente con el SDP:

1.  Confirma que el `domain` del deep link est茅 en la lista blanca (allowlist) de la wallet. Esto es crucial para autenticar desde una wallet confiable.
2. Obt茅n el archivo toml del SDP en `{domain}/.well-known/stellar.toml` y confirma que la variable `SIGNING_KEY` est茅 poblada.
3. Verifica que la firma del enlace de registro haya sido realizada usando `SIGNING_KEY`, similar a la funci贸n `keypairPk.verify(...)` en el fragmento arriba, y que la firma sea v谩lida con el contenido del enlace.
4. Revisa el `asset` del enlace y confirma que el usuario receptor tenga una trustline para ese activo. Crea una si no existe.
5. (Opcional) Usa el `name` del enlace para actualizar la interfaz de usuario de la wallet.
6. Inicia el flujo de dep贸sito [SEP-24](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0024.md) con ese activo usando el valor `TRANSFER_SERVER_SEP0024` del archivo toml del SDP.
   - Esto incluye usar [SEP-10](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0010.md) para autenticar al usuario con el servidor SDP. Ten en cuenta que el SDP requiere que los campos `client_domain` y `home_domain` sean proporcionados en la solicitud `GET <WEB_AUTH_ENDPOINT>`, y deber铆an establecerse como sigue:
     - `client_domain`: el dominio del servidor de wallet que expone el archivo `stellar.toml` del servidor de wallet.
   - `home_domain`: el dominio del servidor SDP que estaba presente en el enlace de registro.
   - `account`: la cuenta Stellar de la wallet del receptor.
7. Lanza el flujo de dep贸sito en un navegador _in-app_ dentro de tu aplicaci贸n m贸vil, siguiendo las instrucciones en la especificaci贸n [SEP-24](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0024.md).
   - ATENCIN: la wallet no debe, bajo ninguna circunstancia, extraer o intentar extraer contenido del navegador _in-app_ para obtener informaci贸n del receptor.
   - NOTA: se recomienda altamente usar un navegador _in-app_ en lugar de un webview.
8.  隆Felicidades! El usuario receptor ahora puede completar los formularios en el navegador _in-app_ y registrarse para recibir su pago .

Adem谩s, la wallet deber铆a guardar el enlace y/o los atributos del enlace y asociarlos con el usuario receptor individual por estas razones:

1. As铆 es como la wallet sabr谩 que el usuario est谩 asociado con cierta organizaci贸n o SDP.
2. Guardar la informaci贸n es 煤til para reportes y soluci贸n de problemas, especialmente si la wallet necesita justificar la fuente de fondos por regulaciones o prop贸sitos fiscales.
3. Si la organizaci贸n pagadora quiere cubrir cualquier comisi贸n de pago cobrada por la wallet o el offramp, la wallet necesitar谩 saber qu茅 usuarios y transacciones deben ser facturados upstream.

### Enlaces diferidos (Deferred Deep Links)

Es muy probable que el receptor no tenga la aplicaci贸n wallet necesaria instalada en su dispositivo. Por esta raz贸n, las wallets deber铆an soportar el concepto de [deferred deep linking](https://en.wikipedia.org/wiki/Mobile_deep_linking#Deferred_deep_linking), que permite el siguiente flujo:

1. La acci贸n inicial del receptor al hacer clic en el deep link deber铆a redirigirlo a la tienda de aplicaciones apropiada para descargar la aplicaci贸n wallet.
2. Despu茅s de instalar y abrir la aplicaci贸n, el receptor deber铆a ser redirigido al flujo t铆pico de integraci贸n de wallet.
3. Una vez que el usuario se haya integrado con 茅xito, la wallet deber铆a usar la informaci贸n incluida en el deep link para iniciar el [Procedimiento de Registro de Wallet](#wallet-registration-procedure).

El deferred deep linking es una caracter铆stica com煤n soportada por numerosas soluciones m贸viles de deep linking; existen servicios de terceros que se pueden usar para implementar esta funcionalidad, como Singular, Branch, AppsFlyer, Adjust, entre otros. [Aqu铆](https://medium.com/bumble-tech/universal-links-for-android-and-ios-1ddb1e70cab0) hay una publicaci贸n de blog con m谩s informaci贸n sobre c贸mo implementar [deferred deep linking](https://en.wikipedia.org/wiki/Mobile_deep_linking#Deferred_deep_linking).

El SDP soporta un formato b谩sico de enlace, tal como `https://<host-con-ruta-opcional>`. Si el sistema de deep linking de tu wallet necesita una estructura m谩s compleja, deber谩s gestionarlo con una aplicaci贸n web. Esta aplicaci贸n deber铆a ser propiedad del proveedor de la wallet, y deber铆a ser capaz de recibir el deep link, interpretarlo y dirigir al usuario a la ubicaci贸n correcta.
