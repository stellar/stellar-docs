---
title: Preparación del Entorno
sidebar_position: 50
---

import { Alert } from "@site/src/components/Alert";

## Inicializar la Base de Datos y el Estado Local

Después de configurar tu [base de datos](./configuring.mdx#database) y los ajustes de [cubos](./configuring.mdx#buckets), antes de ejecutar Stellar Core por primera vez, debes inicializar la base de datos:

```bash
stellar-core new-db
```

Este comando inicializará la base de datos, así como el directorio de cubos, y luego saldrá. También puedes usar este comando si tu base de datos se corrompe y deseas reiniciarla desde cero.

### Mantenimiento Automático

Algunas tablas en stellar-core se utilizan para publicar datos de ledger en archivos de historial.

Si no se gestionan correctamente, esas tablas crecerán sin límites. Para evitar esto, un programador integrado eliminará datos de los ledgers antiguos que ya no son utilizados por otras partes del sistema.

Por defecto, stellar-core realizará este mantenimiento automático. Los campos de configuración que controlan el comportamiento del mantenimiento automático son:

- `AUTOMATIC_MAINTENANCE_PERIOD`,
- `AUTOMATIC_MAINTENANCE_COUNT`

Si necesitas regenerar los metadatos, la forma más sencilla es reproducir ledgers para el rango que te interese después de (opcionalmente) limpiar la base de datos con el comando `new-db` [referenciado anteriormente](#initialize-the-database-and-local-state).

En algunos casos, el mantenimiento automático tiene demasiado trabajo que hacer para volver al estado nominal. Esto puede ocurrir tras grandes operaciones de actualización, como al realizar una actualización completa que puede crear un retraso de decenas de millones de ledgers.

Si esto sucede, el rendimiento de la base de datos puede ser restaurado. El nodo requerirá un tiempo de inactividad mientras realizas los siguientes comandos de recuperación:

1. ejecuta el comando http `maintenance` manualmente con un gran número de ledgers, y
2. realiza una operación de mantenimiento de la base de datos como `VACUUM FULL` para recuperar/reconstruir la base de datos según sea necesario.

### Instantáneas y Restauración de Metadatos

Algunas implementaciones de Stellar Core y Horizon querrán retener metadatos para la _historia completa_ de la red. Estos metadatos pueden ser bastante grandes y computacionalmente costosos de regenerar de nuevo al reproducir ledgers en stellar-core desde un estado inicial de base de datos vacío, como se describe en la sección anterior.

Esto puede ser especialmente costoso si debe ejecutarse más de una vez. Por ejemplo, al poner en línea un nuevo nodo. O incluso si se ejecuta un único nodo con Horizon, ya habiendo ingerido los metadatos _una vez_: una versión posterior de Horizon puede tener un cambio en el esquema que implique reingerirlo _de nuevo_.

<Alert>

Debido a los requisitos de tamaño muy grandes, **recomendamos no** retener metadatos para toda la historia de la red.

</Alert>

Por lo tanto, algunos operadores prefieren apagar sus procesos de stellar-core (y/o Horizon) y _tomar instantáneas a nivel de sistema de archivos_ o _volcados a nivel de base de datos_ del contenido de la base de datos y directorio de cubos de Stellar Core, y/o la base de datos de Horizon, después de que la generación de metadatos haya ocurrido por primera vez. Tales instantáneas pueden ser restauradas, poniendo a stellar-core y/o Horizon en un estado que contenga metadatos sin realizar una reproducción completa.

Cualquier estado razonablemente reciente servirá; si tal instantánea es un poco antigua, stellar-core reproducirá ledgers desde cuando se tomó la instantánea hasta el estado actual de la red de todos modos; pero este procedimiento puede acelerar enormemente la restauración de nodos validador, o clonarlos para crear nuevos.

## Archivos de Historia

Stellar Core normalmente interactúa con uno o más archivos de historia, que son instalaciones configurables donde los [Validadores Completos](../README.mdx#full-validator) almacenan archivos planos que contienen puntos de control de historia: archivos de cubo y registros de historia. Los archivos de historia suelen ser servicios de almacenamiento de mercancías fuera del sitio, como Amazon S3, Google Cloud Storage, Azure Blob Storage, o servidores SCP/SFTP/HTTP personalizados.

Utiliza plantillas de comandos en el archivo de configuración para dar los detalles de qué servicios utilizarás y cómo acceder a ellos. El [ejemplo de configuración] demostrará cómo configurar un archivo de historia a través de plantillas de comandos.

### Configurando para Obtener Datos de un Archivo

No importa qué tipo de nodo estés ejecutando, deberías configurarlo para `get` historia de uno o más archivos públicos. Puedes configurar cualquier número de archivos para descargar: Stellar Core redirigirá automáticamente entre ellos.

Cuando [elijas tu Quorum Set](./configuring.mdx#choosing-your-quorum-set), debes incluir nodos de alta calidad — que, por definición, publican archivos — y añadir la ubicación del archivo de cada nodo en el campo `HISTORY` dentro del [array de validadores](./configuring.mdx#validators-array).

:::note

Si notas muchos errores relacionados con la descarga de archivos, deberías asegurarte de que todos los archivos en tu configuración están actualizados. Puedes revisar la [configuración de ejemplo de Mainnet] para ver cómo podrías usar validadores de Tier 1 actualizados para sus archivos de historia.

:::

### Configurando para Publicar Datos en un Archivo

Las secciones de archivos también pueden ser configuradas con comandos `put` y `mkdir` para hacer que la instancia publique en ese archivo (para nodos configurados como [validadores completos](../README.mdx#full-validator)).

La primera vez que quieras usar tu archivo, _antes de arrancar tu nodo_, necesitas inicializarlo con:

```bash
stellar-core new-hist <historyarchive>
```

:::note

En un entorno de producción seguro, Stellar Core debe ejecutarse como un usuario dedicado. Los paquetes de Debian garantizarán que el usuario `stellar` exista en el sistema. Por esta razón, puede que necesites ejecutar comandos como el usuario stellar, por ejemplo:

```bash
sudo -u stellar stellar-core --conf /etc/stellar/stellar-core.cfg new-hist <historyarchive>
```

:::

Una guía más detallada y estrategias para publicar archivos de historia se pueden encontrar en la página de [publicación de archivos de historia](./publishing-history-archives.mdx). Por favor, consulta allá para más información.

:::info IMPORTANTE:

- Asegúrate de configurar tanto `put` como `mkdir` si `put` no crea automáticamente subcarpetas.
- Escribir en el mismo archivo desde diferentes nodos no está soportado y resultará en un comportamiento indefinido, _potencialmente pérdida de datos_.
- No ejecutes `new-hist` en un archivo existente a menos que quieras borrarlo.

:::

## Otra Preparación

Además, debes asegurarte de que tu entorno operativo también esté funcional. Esto significa que deberías haber considerado y preparado lo siguiente.

- [Registro](./logging.mdx) y rotación de registros
- [Monitoreo](./monitoring.mdx) e infraestructura de alertas

[ejemplo de configuración]: https://github.com/stellar/stellar-core/blob/master/docs/stellar-core_example.cfg
[ejemplo de configuración de Mainnet]: https://github.com/stellar/packages/blob/master/docs/examples/pubnet-validator-full/stellar-core.cfg
