---
title: Publicando Archivos de Historial
sidebar_position: 50
---

Si quieres ejecutar un [Validador Completo](../README.mdx#full-validator), necesitas configurar tu nodo para publicar un archivo de historial. Puedes alojar un archivo usando un blob store como Amazon's S3 o los espacios de Digital Ocean, o simplemente puede servir un archivo local directamente a través de un servidor HTTP como Nginx o Apache. Si estás configurando un [Validador Básico](../README.mdx#basic-validator), puedes omitir esta sección. No importa el tipo de nodo que planees ejecutar, asegúrate de configurarlo en el historial `get`, que está cubierto en [Preparación de entorno](./environment-preparation.mdx).

## Caché y Archivos de Historias

El coste de _primary_ de ejecutar un validador muy probablemente será un ancho de banda de mejora. Una parte crucial de su estrategia para gestionar esos costos debería ser el caché. Puede reducir significativamente estos costes de transferencia de datos mediante el uso de técnicas de almacenamiento en caché comunes o un CDN. Tres sencillas reglas se aplican a la caché de los archivos de historia:

1. No guardar en caché el archivo de estado `.well-known/stellar-history.json` (`Cache-Control: no-cache`)
2. No almacenar en caché respuestas HTTP 4xx (`Cache-Control: no-cache`)
3. Caché de todo por el mayor tiempo posible (**> 1 día**)

## Archivo de Historial Local usando nginx

Aquí demostraremos cómo puede configurar su nodo para almacenar sus archivos de historia en el sistema de archivos local, y luego publicar ese historial usando nginx para nuestro software de servidor web.

En primer lugar, debes añadir una stanza de configuración de historial a tu archivo de configuración `/etc/stellar/stellar-core.cfg`.

```toml
[HISTORY.local]
get="cp /mnt/xvdf/stellar-core-archive/node_001/{0} {1}"
put="cp {0} /mnt/xvdf/stellar-core-archive/node_001/{1}"
mkdir="mkdir -p /mnt/xvdf/stellar-core-archive/node_001/{0}"
```

Luego, debes ejecutar el comando \`new-tformat@@1 de Stellar Core para crear el archivo de historia local.

```bash
sudo -u stellar-core --conf. /stellar/stellar-core.cfg new-hist local
```

Este comando crea la estructura del archivo de historia:

```bash
$ tree -a /mnt/xvdf/stellar-core-archive/
/mnt/xvdf/stellar-core-archive
└── node_001
    ├── history
    │   └── 00
    │       └── 00
    │           └── 00
    │               └── history-00000000.json
    └── .well-known
        └── stellar-history.json

6 directories, 2 files
```

Ahora que la estructura del archivo de historial está lista, puede configurar un host virtual en nginx para servir el archivo local.

```nginx
server {
  listen 80;
  root /mnt/xvdf/stellar-core-archive/node_001/;

  historial de server_name. xample.com;

  # no guardar en caché los errores 404
  error_page 404 /404. tml;
  ubicación = /404. tml {
    add_header Cache-Control "no-cache" siempre;
  }

  # no cachear archivo de estado de historial
  ubicación ~ ^/. ell-known/stellar-historial. son$ {
    add_header Cache-Control "no-cache" siempre;
    try_files $uri =404;
  }

  # caché todo el archivo de historia por 1 día
  ubicación / {
    add_header Cache-Control "max-age=86400";
    try_files $uri =404;
  }
}
```

## Archivo de historia de Amazon S3

Ahora, vamos a demostrar una configuración donde el nodo almacena sus archivos de historia usando el servicio S3 de Amazon. Usted puede publicar ese historial usando un sitio estático de Amazon S3, o de nuevo usar nginx para su software de servidor web. Esta vez, usando nginx, también incluiremos alguna configuración de proxy y CDN.

Comienza añadiendo una stanza de configuración de historia a tu archivo de configuración `/etc/stellar/stellar-core.cfg`.

```toml
[HISTORY.s3]
get='curl -sf http://history.example. om/{0} -o {1}' # endpoint HTTP almacenado en caché
put='aws s3 cp --region Firsteast-1 {0} s3://bucket. ame/{1}' # Acceso directo S3
```

Luego, debe ejecutar el comando `new-Chan` de Stellar Core para crear e inicializar el archivo S3.

```bash
sudo -u stellar-core --conf. /stellar/stellar-core.cfg new-hist s3
```

Estos archivos de historia de S3 se pueden servir con algo tan simple como un sitio estático de Amazon S3.

Opcionalmente, puede querer colocar un proxy inverso y un CDN delante del sitio estático de S3 (usaremos nginx para este ejemplo).

```nginx
server {
  listen 80;
  root /srv/nginx/history.example.com;
  index index.html index.htm;

  server_name history.example. om;

  # utiliza los servidores de nombres de Google para búsquedas
  resolver 8.8.8.8 8.8.4. ;

  # bucket.name s3 static site endpoint
  set $s3_bucket "bucket. ame.s3-website-✫ east-1.► s.com";

  # no guardar en caché 404 errores
  error_page 404 /404.html;
  location = /404. tml {
    add_header Cache-Control "no-cache" siempre;
  }

  # no cachear archivo de estado de historia
  ubicación ~ ^/. ell-known/stellar-historial. son$ {
    add_header Cache-Control "no-cache" siempre;
    proxy_intercept_errors en;
    proxy_pass http://$s3_bucket;
    proxy_read_timeout 120s;
    proxy_redirect off;
    proxy_buffering off;
    servidor proxy_set_header            $s3_bucket;
    proxy_set_header X-Real-IP       $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # archivo de historial de caché para 1 día
  ubicación / {
    add_header Cache-Control "max-age=86400";
    proxy_intercept_errors on;
    proxy_pass http://$s3_bucket;
    proxy_read_timeout 120s;
    proxy_redirect off;
    proxy_buffering off;
    host proxy_set_header            $s3_bucket
    proxy_set_header X-Real-IP       $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}
```

## Copia de seguridad de un archivo de historia

Dada la opción, es mejor configurar el archivo de tu historial _antes de_ la sincronización inicial de tu nodo con una red existente. De esa manera el historial de su validador se publica a medida que se une, y posteriormente se sincroniza con la red.

Sin embargo, si no ha publicado un archivo durante la sincronización inicial del nodo, los pasos necesarios para crear un archivo de historial para un validador existente — en otras palabras, para actualizar un Validador Básico a un Validador Completo — es bastante sencillo. Primero, necesitarás detener tu instancia de `stellar-core`:

```bash
systemctl stop stellar-core # modificar esto si no se utiliza systemctl
```

Luego, agrega la configuración del archivo de historia al archivo de configuración de tu node's `/etc/stellar/stellar-core.cfg`.

```toml
[HISTORY.local]
get="cp /mnt/xvdf/stellar-core-archive/node_001/{0} {1}"
put="cp {0} /mnt/xvdf/stellar-core-archive/node_001/{1}"
mkdir="mkdir -p /mnt/xvdf/stellar-core-archive/node_001/{0}"
```

A continuación, debe ejecutar el comando `new-Chan` de Stellar Core para crear e inicializar el archivo local. (Esto se hace como usuario 'stellar'.)

```bash
sudo -u stellar-core --conf. /stellar/stellar-core.cfg new-hist local
```

Ahora puedes iniciar tu instancia de Stellar Core de nuevo:

```bash
systemctl start stellar-core # modificar esto si no se utiliza systemctl
```

A medida que permite que su nodo se conecte a la red de nuevo, puede ver que comienza a publicar algunos puntos de control en el archivo recién creado.

```log
2019-04-25T12:30:43.275 GDUQJ [Historia INFO] Publicando 1 puntos de control en cola [16895-16895]: Esperando los prerrequisitos 0/0 de: publish-000041ff
```

En esta etapa, su validador está publicando con éxito su historial, lo que permite a otros usuarios unirse a la red usando su archivo.

## Completar Archivo de Historial

La herramienta de línea de comandos [stellar-archivist](https://github.com/stellar/go/tree/master/tools/stellar-archivist) puede utilizarse para replicar, escanear y reparar archivos existentes. Usando los [repositorios de paquetes SDF](https://github.com/stellar/packages), puedes instalar `stellar-archivist` ejecutando:

```bash
apt-get install stellar-archivist
```

Si decides publicar un archivo completo — que permite a otros usuarios unirse a la red desde el editor de genesis — puedes usar `stellar-archivist` para agregar todos los datos de historia faltantes a tu archivo parcial, y para verificar el estado y la integridad de su archivo. Por ejemplo:

```bash
archivo de búsqueda de stellar-archivista:///mnt/xvdf/stellar-core-archive/node_001
```

```log
2019/04/25 11:42:51 Archivos de puntos de control en rango: [0x00003f, 0x0000417f]
archivos 2019/04/25 11:42:51 de puntos de control escaneados con 324 errores
019/04/25 11:42:51 Archive: 3 historial, 2 ledger, 2 transacciones, 2 resultados, 2 scp
2019/04/25 11:42:51 Escaneando todos los cubos, y aquellos referenciados por el rango
2019/04/25 11:42:51 Archive: 30 cubos totales 30 archivos referenciados
2019/04/25 11:42:51 Archivos de puntos de control en estado de extinción para huecos
2019/04/25 11:42:51 Buckets en funcionamiento referenciados por puntos de control
2019/04/25 11:42:51 Historia de faltas (260): [0x0000003f-0x000040ff]
2019/04/25 11:42:51 Ledger perdida (260): [0x0000003f-0x000040ff]
2019/04/25 11:42:51 transacciones perdidas (260): [0x0000003f-0x000040ff][0x0000003f-0x000040ff] 
 2019/04/25 11:42:51 resultados perdidos (260): [0x0000003f-0x000040ff]
2019/04/25 11:42:51 No faltan subastas en rango [0x0000 0x0000417f]
2019/04/25 11:42:51 324 errores escaneando puntos de control
```

Como se puede decir de la salida del comando `scan`, faltan en el archivo de historia local algunos historiales, perdedores, transacciones, y resultados.

Puede reparar los datos que faltan usando el comando `repair` del archivista estellar-archivista combinado con un archivo completo conocido — como el archivo de historia pública SDF:

```bash
reparación de stellar-archivist http://history.stellar.org/prd/core-testnet/core_testnet_001/ file:///mnt/xvdf/stellar-core-archive/node_001/
```

```log
2019/04/25 11:50:15 repairing http://history.stellar. rg/prd/core-testnet/core_testnet_001/ -> file:///mnt/xvdf/stellar-core-archive/node_001/
2019/04/25 11:50:15 Escaneo inicial para reparación
019/04/25 11:50:15 Archivos de puntos de control en rango: [0x00003f, 0x000041bf]
archivos de punto de control 2019/04/25 11:50:15 analizados con 244 errores
019/04/25 11:50:15 Archivo: 4 historia, 3 perfiles, 263 transacciones, 61 resultados, 3 scp
2019/04/25 11:50:15 Error: 244 errores escaneando los puntos de control
2019/04/25 11:50:15 Examining checkpoint files for gaps
2019/04/25 11:50:15 Reparing history/00/00/00/history-0000003f. son
2019/04/25 11:50:15 Repairing history/00/00/00/history-0000007f.json
2019/04/25 11:50:15 Repairing history/00/00/history-000000bf.json
...
2019/04/25 11:50:22 Repairing ledger/00/00/00/ledger-000000003f.xdr.gz
2019/04/25 11:50:23 Repairing ledger/00/00/00/ledger-000000007f.xdr. z 
 2019/04/25 11:50:23 Reparando ledger/00/00/00/00/ledger-0000bf.xdr.gz
...
2019/04/25 11:51:18 Reparando results/00/00/0e/results-00000ebf.xdr.gz
2019/04/25 11:51:18 Reparando results/00/00/0e/results-00000eff.xdr.gz
2019/04/25 11:51:19 Reparando results/00/00/0f/results-00000f3f. dr.gz
...
2019/04/25 11:51:39 Reparar scp/00/00/00/scp-0000003f.xdr.gz
2019/04/25 11:51:39 Reparar scp/00/00/00/scp-000000007f.xdr.gz
2019/04/25 11:51:39 Reparar scp/00/00/00/scp-00000000bf.xdr.gz
...
2019/04/25 11:51:50 Escaneo de archivos de checkpoing en ejecución, para reparación de cubos
2019/04/25 11:51:50 Archivos de punto de control de escaneo en rango: [0x00003f, 0x000041bf]
archivos de punto de control 2019/04/25 11:51:50 archivos de punto de control escaneados con 5 errores
2019/04/25 11:51:50 Archivo: 264 historial, 263 perfiles, 263 transacciones, 263 resultados, 241 scp
2019/04/25 11:51:50 Error: 5 errores escaneando puntos de control
2019/04/25 11:51:50 Escaneando todos los cubos, y aquellos referenciados por el rango
2019/04/25 11:51:50 Archivo: 40 cubos totales 2478 referenciado
2019/04/25 11:51:50 Examining buckets referenciados por los puntos de control
2019/04/25 11:51:50 Reparando bucket/57/18/d4/bucket-5718d412bdc19084dafeb7e1852cf06f454392df627e1ec056c8b756263a47f1. dr.gz
2019/04/25 11:51:50 Bucket/8a/a1/62/bucket-8aa1624cc44aa02609366fe6038ffc5309698d4ba8212ef9c0d89dc1f2c73033.xdr.gz 
 2019/04/25 11:51:50 Repairing bucket/30/82/6a/bucket-30826a8569cb6b178526ddba71b995c612128439f090f371b6bf70fe8cf7ec24.xdr.gz
...
```

Un escaneo final del archivo local confirma que ha sido reparado con éxito

```bash
archivo de búsqueda de stellar-archivista:///mnt/xvdf/stellar-core-archive/node_001
```

```log
2019/04/25 12:15:41 Scanning checkpoint files in range: [0x0000003f, 0x000041bf]
2019/04/25 12:15:41 Archive: 264 history, 263 ledger, 263 transactions, 263 results, 241 scp
2019/04/25 12:15:41 Scanning all buckets, and those referenced by range
2019/04/25 12:15:41 Archive: 2478 buckets total, 2478 referenced
2019/04/25 12:15:41 Examining checkpoint files for gaps
2019/04/25 12:15:41 Examining buckets referenced by checkpoints
2019/04/25 12:15:41 No checkpoint files missing in range [0x0000003f, 0x000041bf]
2019/04/25 12:15:41 No missing buckets referenced in range [0x0000003f, 0x000041bf]
```

Por último, puedes volver a iniciar tu instancia de Núcleo estelar.

```bash
systemctl iniciar stellar-core
```

Ahora debería tener un archivo de historia completo siendo escrito por su validador completo. ¡Felicidades!
