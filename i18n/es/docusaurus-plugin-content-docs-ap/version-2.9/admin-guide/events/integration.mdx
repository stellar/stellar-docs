---
title: Integración
sidebar_position: 20
---

Esta guía te guiará a través de la integración con el servicio de eventos para comenzar a recibir eventos. El servicio de eventos actualmente solo admite Apache Kafka como el intermediario de mensajes de backend.

Asume familiaridad con Kafka y no cubrirá cómo configurar un clúster de Kafka.

## Requisitos

Anchor Platform enviará eventos al tema `TRANSACTION` de Kafka. El servicio de eventos consumirá eventos de este tema y los enviará a los endpoints apropiados.

## Configuración

Primero, el productor de Kafka del servicio de eventos debe configurarse utilizando la sección `event.queue` del archivo de configuración o configurando las variables de entorno. El siguiente es el conjunto de variables de entorno requeridas para configurar el productor de Kafka del servicio de eventos:

<CodeExample>

```bash
# dev.env
EVENTS_ENABLED=true
EVENTS_QUEUE_TYPE=kafka
EVENTS_QUEUE_KAFKA_BOOTSTRAP_SERVER=localhost:9092
```

```yaml
# dev.services.yaml
events:
  enabled: true
  queue:
    type: kafka
    kafka:
      bootstrap_server: localhost:9092
```

</CodeExample>

Anchor Platform permite establecer un subconjunto de la configuración del cliente del productor de Kafka. Consulta el [archivo de valores predeterminados][default-values-file] para más información sobre lo que está disponible. Para más información sobre la configuración del cliente del productor de Kafka, consulta la [documentación de Kafka](https://kafka.apache.org/documentation/#producerconfigs).

A continuación, el procesador de eventos debe configurarse en la sección `event_processor` del archivo de configuración de Anchor Platform o configurando las variables de entorno.

<CodeExample>

```bash
# dev.env
EVENT_PROCESSOR_CLIENT_STATUS_CALLBACK_ENABLED=true
EVENT_PROCESSOR_CALLBACK_API_REQUEST_ENABLED=true
```

```yaml
# dev.services.yaml
event_processor:
  client_status_callback:
    enabled: true
  callback_api_request:
    enabled: true
```

</CodeExample>

Esto habilitará el procesador de eventos para comenzar a procesar eventos del tema `TRANSACTION`. En este ejemplo, el procesador de eventos enviará eventos a los endpoints de devolución de llamada de cliente y servidor comercial.

## Recibir Eventos

El servicio de eventos se puede utilizar para enviar eventos a los endpoints de devolución de llamada de cliente y servidor comercial. El servicio de eventos enviará eventos a estos endpoints como solicitudes HTTP POST con los datos del evento en el cuerpo de la solicitud.

### Como Aplicación Cliente

Las aplicaciones cliente pueden recibir actualizaciones sobre las transacciones y la información de los clientes de sus usuarios. El esquema de los datos del evento dependerá del tipo de evento que se esté enviando.

Para recibir eventos como una aplicación cliente, necesitarás exponer URLs de devolución de llamada a las que el servicio de eventos pueda enviar eventos. El servicio de eventos enviará una solicitud POST a este endpoint con los datos del evento en el cuerpo de la solicitud. El esquema de los datos del evento dependerá del tipo de evento que se esté enviando. Anchor Platform permite configurar endpoints únicos por tipo de evento.

Anchor Platform solo enviará eventos a los clientes listados en la configuración del cliente. Consulta la [documentación de configuración de clientes][clients-config] para más información.

#### Firma de Devolución de Llamada

Anchor Platform firma las solicitudes de devolución de llamada que envía a las aplicaciones cliente. La firma se incluye en el encabezado `Signature` de la solicitud. La especificación de firma de la URL de devolución de llamada se puede encontrar en las especificaciones de protocolo SEP correspondientes.

- [SEP-0006](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0006.md#url-callback-signature)
- [SEP-0012](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0012.md#callback-post-request)
- [SEP-0024](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0024.md#url-callback-signature)
- [SEP-0031](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0031.md#url-callback-signature)

### Como Servidor Comercial

Además de las actualizaciones del estado de transacción SEP, los servidores comerciales pueden recibir eventos sobre la creación de cotizaciones SEP-31 o actualizaciones de información de clientes SEP-12. El esquema de los datos del evento dependerá del tipo de evento que se esté enviando. Visita la [documentación de la API de eventos](../../api-reference/callbacks/post-event.api.mdx) para más información sobre el esquema de los datos del evento.

Para recibir eventos como un servidor comercial, necesitarás exponer una URL de devolución de llamada a la que el servicio de eventos pueda enviar eventos. El servicio de eventos enviará una solicitud POST a este endpoint con los datos del evento en el cuerpo de la solicitud.

#### Configuración

La API de devolución de llamada del servicio de eventos se puede configurar utilizando la sección `callback_api` del archivo de configuración de Anchor Platform o configurando las variables de entorno.

:::caution

El `--event-processor` ignorará cualquier segmento de ruta especificado en `callback_api.base_url` y en su lugar enviará eventos a `[scheme]://[host]:[port]/event`. Este es un error, pero para no interrumpir a quienes utilizan el procesador de eventos, postergaremos la corrección de incluir segmentos de ruta en la versión 3 de Anchor Platform.

:::

El siguiente es un ejemplo de cómo configurar la API de devolución de llamada del servicio de eventos con autenticación JWT:

<CodeExample>

```bash
# dev.env

# note `/callback` will not be used for event callbacks
# instead events will be sent to `http://localhost:8081/event`
# all other callbacks (rates, customer, etc.) will use the provided `/callback` root path
CALLBACK_API_BASE_URL=http://localhost:8081/callback
CALLBACK_API_AUTH_TYPE=jwt
CALLBACK_API_AUTH_JWT_EXPIRATION_MILLISECONDS=30000
CALLBACK_API_AUTH_JWT_HTTP_HEADER=Authorization
SECRET_CALLBACK_API_AUTH_SECRET="a secret for signing jwts"
```

```yaml
# dev.services.yaml
callback_api:
  base_url: http://localhost:8081/callback
  auth:
    type: jwt
    jwt:
      expiration_milliseconds: 30000
      http_header: Authorization
```

</CodeExample>

El siguiente es un ejemplo de cómo configurar la API de devolución de llamada del servicio de eventos con autenticación por clave API:

<CodeExample>

```bash
# dev.env
CALLBACK_API_BASE_URL=http://localhost:8081/callback
CALLBACK_API_AUTH_TYPE=api_key
CALLBACK_API_AUTH_API_KEY_HTTP_HEADER=X-Api-Key
SECRET_CALLBACK_API_AUTH_SECRET="your API key"
```

```yaml
# dev.services.yaml
callback_api:
  base_url: http://localhost:8081/callback
  auth:
    type: api_key
    api_key:
      http_header: X-Api-Key
```

</CodeExample>

Esto configura la API de devolución de llamada del servicio de eventos que se utilizará para enviar eventos a los endpoints de devolución de llamada de cliente y servidor comercial. Las siguientes son las opciones de configuración admitidas:

- `base_url`: La URL base del endpoint de devolución de llamada del servidor comercial.
- `secret`: El secreto que se utilizará al enviar eventos al endpoint de devolución de llamada del servidor comercial. Esto se utiliza para firmar el cuerpo de la solicitud cuando se habilita la autenticación JWT y es la clave API cuando se habilita la autenticación por clave API.
- `auth`: El método de autenticación que se utilizará al enviar eventos al endpoint de devolución de llamada del servidor comercial. Los siguientes son los métodos de autenticación admitidos:
  - `JWT`: El servicio de eventos enviará un token web JSON (JWT) en el encabezado `Authorization` de la solicitud. Las siguientes son las opciones de configuración admitidas:
    - `expiration_milliseconds`: El tiempo de caducidad del JWT en milisegundos.
    - `http_header`: El encabezado en el que se enviará el JWT.
  - `API_KEY`: El servicio de eventos enviará una clave API en el encabezado `Authorization` de la solicitud. Las siguientes son las opciones de configuración admitidas:
    - `http_header`: El encabezado en el que se enviará la clave API.

[archivo-de-valores-predeterminados]: https://github.com/stellar/java-stellar-anchor-sdk/blob/develop/platform/src/main/resources/config/anchor-config-default-values.yaml
[configuración-de-clientes]: ../../admin-guide/sep10/README.mdx#config-with-client-attribution
