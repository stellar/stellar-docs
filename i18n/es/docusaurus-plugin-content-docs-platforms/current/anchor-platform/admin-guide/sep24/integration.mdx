---
title: Integración
sidebar_position: 30
---

import { CodeExample } from "@site/src/components/CodeExample";
import { AttributeTable } from "@site/src/components/AttributeTable";
import Security from "../component/security/security.mdx";
import UsingApiKey from "../component/security/api_key.mdx";
import UsingJwt from "../component/security/jwt.mdx";
import Rpc from "../component/rpc/rpc.mdx";
import RpcRequest from "../component/rpc/request.mdx";
import RpcResponse from "../component/rpc/response.mdx";
import RpcError from "../component/rpc/error.mdx";
import Observer from "../component/observer/observer.mdx";

Uno de los puntos principales de interacción con la Plataforma de Ancla es notificar a la Plataforma de Ancla sobre eventos relacionados con la transacción.

En general, querrás proporcionar actualizaciones para los siguientes eventos:

- Su negocio está procesando la información de KYC proporcionada por el usuario
- Tu negocio está listo para recibir fondos del usuario
- Tu negocio ha recibido fondos del usuario
- Tu negocio ha enviado fondos al usuario
- Tu negocio ha procesado un reembolso por la transacción del usuario
- Su negocio experimentó un error inesperado

Esto se hace haciendo peticiones JSON-RPC al punto final de la API de Plataforma. Las solicitudes JSON-RPC le permiten actualizar el estado de la transacción. Para mover la transacción a un estado específico. es necesario hacer una petición JSON-RPC correspondiente y pasar los datos requeridos por este método RPC.

La Plataforma de Anchor JSON-RPC API está diseñada para notificar a la plataforma sobre los cambios en el estado de la transacción. Dado que la API será llamada cada vez que un usuario o el anclaje tome cualquier acción que progrese el estado de la transacción en el flujo.

Puede encontrar más información sobre el flujo de transacciones y los estados en el [documento del protocolo SEP-24][sep-24]

## Asegurando API de Plataforma

<Security />

### Usando API Key

<UsingApiKey />

### Usando JWT

<UsingJwt />

## Realizando solicitudes JSON-RPC

<Rpc />

### Solicitud JSON-RPC

<RpcRequest />

### Respuesta JSON-RPC

<RpcResponse />

### Códigos de error

<RpcError />

## Actualizando transacción de depósito vía JSON-RPC

El diagrama de flujo de depósitos SEP-24 define la secuencia/reglas del estado de la transición de la transacción y un conjunto de métodos JSON-RPC que deben ser llamados para cambiar ese estado. No puede definir el estado que desea establecer para una transacción específica en sus solicitudes. Cada método JSON-RPC define las estructuras de datos que espera en solicitud. Si la solicitud no contiene los atributos requeridos, la Plataforma de Ancla devolverá el error y no cambiará el estado de la transacción.

[![Flujo de depósito sep24](/assets/sep24-deposit-flow-diagram.png)](/assets/sep24-deposit-flow-diagram.png)

:::tip

Los estados en <span style={{color: "green"}}>verde</span> son obligatorios y definen la forma más corta.

Los estados en <span style={{color: "#B0BF1A"}}>amarillo</span> son opcionales y se pueden omitir.

Los estados en <span style={{color: "red"}}>rojo</span> significan que la transacción está en un estado de error o ha caducado.

:::

### Listo para recibir fondos

El primer paso del flujo del depósito después de comenzar el depósito es recoger KYC. Generalmente se hace en la aplicación web, pero también puede ser proporcionada opcionalmente por la aplicación de monedero, usando [SEP-9]. Una vez recogido el KYC necesario, una solicitud `request_offchain_funds` JSON-RPC debe ser hecha.

<CodeExample>

```json
// request-offchain-funds.json
[
  {
    "id": 1,
    "jsonrpc": "2.0",
    "method": "request_offchain_funds",
    "params": {
      "transaction_id": "<transaction_id>",
      "message": "Request offchain funds",
      "amount_in": {
        "amount": 10,
        "asset": "iso4217:USD"
      },
      "amount_out": {
        "amount": 9,
        "asset": "stellar:USDC:GBBD47IF6LWK7P7MDEVSCWR7DPUWV3NY3DTQEVFL4NAT4AQH3ZLLFLA5"
      },
      "amount_fee": {
        "amount": 1,
        "asset": "iso4217:USD"
      },
      "amount_expected": {
        "amount": 10
      }
    }
  }
]
```

</CodeExample>

- `amount_in` es la cantidad que el usuario tiene que enviar al negocio.
- `amount_out` es la cantidad que el usuario recibirá.
- `amount_fee` es la cantidad total de comisiones cobradas por el negocio.
- `asset` es parte del campo `amount_x` y está en un formato SEP-38. En este ejemplo, se establece en USD, asumiendo que el usuario hizo una transferencia bancaria al sistema usando USD.

La información acerca de montos (in/out/fee) es necesaria si quieres mover la transacción desde el `incomplete` al estado `pending_user_transfer_start`. Si el estado de la transacción se cambia de `pending_anchor` a `pending_user_transfer_start`, puedes omitir la definición de las cantidades.

Para ejecutar esto, necesitas ejecutar:

<CodeExample>

```bash
./call-json-rpc.sh request-offchain-funds.json
```

</CodeExample>

:::tip

Cuando el proceso KYC es largo (por ejemplo, verificación de ID), se aconseja establecer primero el estado de la transacción en `pending_anchor` usando `notify_interactive_flow_completado` solicitud JSON-RPC. Esto indicará al usuario que KYC está siendo procesado.

:::

### Procesando información de KYC

:::tip

Este paso es opcional. La mayoría de las empresas no lo utilizan. Puedes saltarlo e ir al [siguiente paso](#funds-received).

El uso de este estado se recomienda cuando la verificación de KYC puede necesitar ser realizada de forma asincrónica.

:::

**debes** especificar los campos `amount_x`.

<CodeExample>

```json
// kyc-in-process.json
[
  {
    "id": 1,
    "jsonrpc": "2.0",
    "method": "notify_interactive_flow_completed",
    "params": {
      "transaction_id": "<transaction_id>",
      "message": "Interactive flow completed.",
      "amount_in": {
        "amount": 10,
        "asset": "iso4217:USD"
      },
      "amount_out": {
        "amount": 9,
        "asset": "stellar:USDC:GBBD47IF6LWK7P7MDEVSCWR7DPUWV3NY3DTQEVFL4NAT4AQH3ZLLFLA5"
      },
      "amount_fee": {
        "amount": 1,
        "asset": "iso4217:USD"
      },
      "amount_expected": {
        "amount": 10
      }
    }
  }
]
```

</CodeExample>

Para ejecutar esto, necesitas ejecutar:

<CodeExample>

```bash
./call-json-rpc.sh kyc-in-process.json
```

</CodeExample>

### Fondos recibidos

Si los fondos de offchain fueron recibidos, querrá proporcionar una información de transacción actualizada.

<CodeExample>

```json
// offchain-funds-received.json
[
  {
    "id": 1,
    "jsonrpc": "2.0",
    "method": "notify_offchain_funds_received",
    "params": {
      "transaction_id": "<transaction_id>",
      "message": "Offchain funds received",
      "funds_received_at": "2023-07-04T12:34:56Z",
      "external_transaction_id": "7...9",
      "amount_in": {
        "amount": 10
      },
      "amount_out": {
        "amount": 9
      },
      "amount_fee": {
        "amount": 1
      },
      "amount_expected": {
        "amount": 10
      }
    }
  }
]
```

</CodeExample>

- `fons_received_at` es la fecha y hora de recibir fondos
- `external_transaction_id` es el ID de la transacción en red externa

Los campos de cantidad son opcionales. Si se omite, se tomarán los valores de las solicitudes JSON-RPC anteriores.

Para ejecutar esto, necesitas ejecutar:

<CodeExample>

```bash
./call-json-rpc.sh offchain-funds-received.json
```

</CodeExample>

### Esperando fondos de usuario

En un mundo real, el proceso de confirmación de la transferencia puede llevar tiempo. En tales casos, las transacciones deben establecerse en un nuevo estado que indique que la confirmación de la transferencia ha sido recibida, pero los fondos no han sido recibidos todavía.

<CodeExample>

```json
// offchain-funds-sent.json
[
  {
    "id": 1,
    "jsonrpc": "2.0",
    "method": "notify_offchain_funds_sent",
    "params": {
      "transaction_id": "<transaction_id>",
      "message": "Offchain funds sent",
      "funds_received_at": "2023-07-04T12:34:56Z",
      "external_transaction_id": "7...9"
    }
  }
]
```

</CodeExample>

Para ejecutar esto, necesitas ejecutar:

<CodeExample>

```bash
./call-json-rpc.sh offchain-funds-sent.json
```

</CodeExample>

### Enviando fondos Onchain

A continuación, envíe una transacción en la red Stellar para satisfacer una solicitud de usuario. Después de completar la transacción, es necesario enviar la solicitud JSON-RPC `notify_onchain_funds_sent` para notificar a un usuario que los fondos fueron enviados correctamente.

<CodeExample>

```json
// onchain-funds-sent.json
[
  {
    "id": 1,
    "jsonrpc": "2. ",
    "method": "notify_onchain_funds_sent",
    "params": {
      "transaction_id": "<transaction_id>",
      "message": "Onchain funds sent",
      "stellar_transaction_id": "7. .9"
    }
  }
]
```

</CodeExample>

- `stellar_transaction_id` es el id de transacción en la red estelar de la transferencia

Para ejecutar esto, necesitas ejecutar:

<CodeExample>

```bash
./llamar-json-rpc.sh onchain-funds-sent.json
```

</CodeExample>

Después de esta solicitud JSON-RPC, la transacción se transferirá al estado `completado`.

### Envío de pago a través del Servicio de Custodia

La Plataforma de Anclaje proporciona la posibilidad de enviar un pago a través de servicios de custodia, tales como Fireblocks. Para realizar un pago a través del servicio de custodia, es necesario hacer la siguiente solicitud JSON-RPC:

<CodeExample>

```json
// do-stellar-payment.json
[
  {
    "id": 1,
    "jsonrpc": "2.0",
    "method": "do_stellar_payment",
    "params": {
      "transaction_id": "<transaction_id>",
      "message": "Custody payment started"
    }
  }
]
```

</CodeExample>

Para ejecutar esto, necesitas ejecutar:

<CodeExample>

```bash
./llamar-json-rpc.sh do-stellar-payment.json
```

</CodeExample>

Después del procesamiento exitoso del pago sobre un servicio de custodia, la Plataforma de Anchor automáticamente hará la solicitud JSON-RPC `notify_onchain_funds_sent` y el estado de la transacción se cambiará a `completado`.

:::caution

Una cuenta de usuario puede no estar lista para recibir fondos. Puedes comprobar que la cuenta ha establecido una [trustline](/docs/learn/glossary#trustline). De lo contrario, puedes establecer el estado de la transacción a `pending_trust` para indicar que el anclaje está esperando que el usuario establezca la línea de confianza.

Si la integración de la custodia está habilitada, la plataforma de anclaje hará esta validación automáticamente.

:::

### Confianza pendiente

Este estado debe establecerse si un pago requiere una línea de confianza de activos que no ha sido configurada por el usuario. Hay dos maneras de mover la transacción al estado `pending_trust`. El primero es el procesamiento de un pago por servicio de custodia en caso de que detecte que la línea de fideicomiso no está configurada. La segunda es cuando el propio negocio detecta que falta la línea de confianza y quiere notificar al usuario que tiene que ser configurada. Para mover la transacción al estado `pending_trust`, es necesario hacer la siguiente solicitud JSON-RPC:

<CodeExample>

```json
// request-trust.json
[
  {
    "id": 1,
    "jsonrpc": "2.0",
    "method": "request_trust",
    "params": {
      "transaction_id": "<transaction_id>",
      "message": "Asset trustine not configured"
    }
  }
]
```

</CodeExample>

Para ejecutar esto, necesitas ejecutar:

<CodeExample>

```bash
./llamar-json-rpc.sh request-trust.json
```

</CodeExample>

:::info

El pago a través del servicio de custodia comprueba periódicamente si la fideicomiso fue configurada. Si lo fuera, automáticamente enviará un pago a un servicio de custodia y cambiará el estado de la transacción a `pending_stellar`.

:::

### Confiar

Este estado debe establecerse si la empresa ha detectado que la línea de confianza fue o no fue configurada por el usuario.

<CodeExample>

```json
// trust-set.json
[
  {
    "id": 1,
    "jsonrpc": "2.0",
    "method": "notify_trust_set",
    "params": {
      "transaction_id": "<transaction_id>",
      "message": "Asset trustine set",
      "success": "true"
    }
  }
]
```

</CodeExample>

- Bandera `success` que define si la línea de confianza fue o no fue configurada por el usuario

Para ejecutar esto, necesitas ejecutar:

<CodeExample>

```bash
./llamar-json-rpc.sh trust-set.json
```

</CodeExample>

:::info

Dependiendo de la bandera `éxito`, el estado de la transacción se cambiará a `pending_stellar` si se estableció la línea de confianza. o a `pending_anchor` si no fue.

:::

### Envío de reembolso por servicio de Custodia

Existe la posibilidad de devolver los fondos al usuario (reembolso). Usted puede reembolsar todo el importe (reembolso completo) o hacer un conjunto de reembolsos parciales. También, si el usuario envió más dinero del esperado, puede devolver una parte de la suma de vuelta al usuario y enviar el resto como fondos onchain.

<CodeExample>

```json
// refund-sent.json
[
  {
    "id": 1,
    "jsonrpc": "2.0",
    "method": "notify_refund_sent",
    "params": {
      "transaction_id": "<transaction_id>",
      "message": "Refund sent",
      "refund": {
        "id": "1c186184-09ee-486c-82a6-aa7a0ab1119c",
        "amount": {
          "amount": 10,
          "asset": "iso4217:USD"
        },
        "amount_fee": {
          "amount": 1,
          "asset": "iso4217:USD"
        }
      }
    }
  }
]
```

</CodeExample>

Para ejecutar esto, necesitas ejecutar:

<CodeExample>

```bash
./llamar-json-rpc.sh reembolso sent.json
```

</CodeExample>

:::info

Si una suma de reembolsos es menor que `amount_in`, el estado de la transacción se establecerá a `pending_anchor`. Sólo si la suma de los reembolsos es igual a `amount_in`, el estado de la transacción se establecerá a `refunded`.

:::

### Reembolso pendiente

Es similar a [Reembolso enviado](#reembolso enviado), pero maneja un caso cuando un reembolso ha sido enviado a la red externa pero aún no está confirmado. El estado de la transacción se establece en `pending_external`. Este es el estado que se establecerá al esperar a que Bitcoin u otra red de criptomonedas externa complete una transacción, o al esperar una transferencia bancaria.

### Error de transacción

Si encuentras un error irrecuperable al procesar la transacción, es necesario establecer el estado de la transacción en `error`. Puede utilizar el campo de mensaje para describir los detalles del error.

<CodeExample>

```json
// transaction-error.json
[
  {
    "id": 1,
    "jsonrpc": "2.0",
    "method": "notify_transaction_error",
    "params": {
      "transaction_id": "<transaction_id>",
      "message": "Error occurred"
    }
  }
]
```

</CodeExample>

Para ejecutar esto, necesitas ejecutar:

<CodeExample>

```bash
./call-json-rpc.sh transaction-error.json
```

</CodeExample>

:::tip

Si un usuario ha hecho una transferencia, usted debe hacer una recuperación de una transacción y entonces usted puede volver a intentar procesar la transacción o iniciar un reembolso.

:::

### Transacción caducada

Su negocio puede querer expirar transacciones que han sido abandonadas por el usuario después de algún tiempo. Es una buena práctica limpiar las transacciones inactivas en el estado `incomplete`. Para ello, simplemente cambie el estado de la transacción a `expired`.

<CodeExample>

```json
// transaction-expired.json
[
  {
    "id": 1,
    "jsonrpc": "2.0",
    "method": "notify_transaction_expired",
    "params": {
      "transaction_id": "<transaction_id>",
      "message": "Transaction expired"
    }
  }
]
```

</CodeExample>

Para ejecutar esto, necesitas ejecutar:

<CodeExample>

```bash
./call-json-rpc.sh transaction-expired.json
```

</CodeExample>

:::tip

Este método JSON-RPC no se puede utilizar después de que el usuario haya realizado una transferencia.

:::

### Transacción en espera

En casos raros, puede que desee pausar la transacción actual y solicitar más información al usuario (después de que la transferencia haya sido recibida).
Esto podría utilizarse para casos de uso de cumplimiento.

<CodeExample>

```json
// transaction-hold.json
[
  {
    "id": 1,
    "jsonrpc": "2.0",
    "method": "notify_transaction_on_hold",
    "params": {
      "transaction_id": "<transaction_id>",
      "message": "Transaction is on hold. Please contact customer support to resolve the hold."
    }
  }
]
```

</CodeExample>

Para ejecutar esto, necesitas ejecutar:

<CodeExample>

```bash
./llamar-json-rpc.sh transaction-hold.json
```

</CodeExample>

### Recuperación de la transacción

El estado de la transacción puede cambiarse de `error/expired` a `pending_anchor`. Después de la recuperación, usted puede reembolsar los activos recibidos o proceder con el procesamiento de la transacción. Para recuperar una transacción, es necesario hacer la siguiente solicitud JSON-RPC:

<CodeExample>

```json
// transaction-recovery.json
[
  {
    "id": 1,
    "jsonrpc": "2.0",
    "method": "notify_transaction_recovery",
    "params": {
      "transaction_id": "<transaction_id>",
      "message": "Transaction recovered"
    }
  }
]
```

</CodeExample>

Para ejecutar esto, necesitas ejecutar:

<CodeExample>

```bash
./llamar-json-rpc.sh transaction-recovery.json
```

</CodeExample>

## Actualizando la transacción de Withdrawal vía JSON-RPC

Este diagrama define una secuencia/reglas del estado de transición de la transacción para el flujo de retiro SEP-24.

\[![Flujo de retiro sep24](/assets/sep24 -flow-diagram.png)](/assets/sep24 withdrawal diagram.png)

:::tip

Los estados en <span style={{color: "green"}}>verde</span> son obligatorios y definen la forma más corta.

Los estados en <span style={{color: "#B0BF1A"}}>amarillo</span> son opcionales y se pueden omitir.

Los estados en <span style={{color: "red"}}>rojo</span> significan que la transacción está en un estado de error o ha caducado.

:::

Una vez finalizado el flujo de depósito, la aplicación de la retirada es sencilla. Algunas partes del flujo son similares y pueden ser reutilizadas.

El punto de partida tanto para el retiro como para el depósito es el mismo.

### Listo para recibir fondos

Similar al depósito, el siguiente paso es notificar al usuario que el anclaje está listo para recibir fondos. Sin embargo, como su servicio recibirá transacciones a través de la red Stellar, la actualización se verá de forma diferente.

<CodeExample>

```json
// request-onchain-funds.json
[
  {
    "id": 1,
    "jsonrpc": "2. ",
    "method": "request_onchain_funds",
    "params": {
      "transaction_id": "<transaction_id>",
      "mensaje": "Solicitar fondos en la cadena",
      "amount_in": {
        "amount": 10,
        "activo": "stellar:USDC:GBBD47IF6LWK7P7MDEVSCWR7DPUWV3NY3DTQEVFL4NAT4AQH3ZLLFLA5"
      },
      "amount_out": {
        "amount": 9,
        "activo": "iso4217:USD"
      },
      "amount_fee": {
        "amount": 1,
        "activo": "stellar:USDC:GBBD47IF6LWK7P7MDEVSCWR7DPUWV3NY3DTQEVFL4NAT4AQH3ZLLFLA5"
      },
      "amount_expected": {
        "amount": 10
      },
      "destination_account": "GD. .G",
      "memo": "12345",
      "memo_type": "id"
    }
  }
]
```

</CodeExample>

- `memo` Valor de memo a adjuntar a la transacción
- `memo_type` Tipo de nota que el ancla debe adjuntar a la transacción
- `Cuenta de destino` Cuenta de destino

Para ejecutar esto, necesitas ejecutar:

<CodeExample>

```bash
./call-json-rpc.sh request-onchain-funds.json
```

</CodeExample>

:::tip

Establecer `memo`, `memo_type`, y `destination_account` es opcional.

Si la integración con un custodiano de terceros está habilitada, la Plataforma de Anchor puede generar `memo`, `memo_type` y `destination_address` si se elige un `deposit_info_generator_type` correspondiente. También, puedes proporcionar `memo` y `memo_type` a la solicitud como se muestra arriba. Tenga en cuenta que la nota debe ser única, esto es lo que ayuda a asociar las transacciones estelares con transacciones SEP.

Si su negocio administra los activos, la Plataforma de Ancestro puede generar memos para usted. Cuando el estado se cambia a `pending_user_transfer_start`, la Plataforma de Anchor establece automáticamente `memo` y `memo_type` (sólo si no se incluye en la solicitud).

:::

:::note

Debe configurarse la cuenta Stellar que se utilizará para recibir fondos.

:::

### Procesando información de KYC

Este paso es opcional y es similar a [Procesando información de KYC](#processing-kyc-information) del flujo de depósito.

### Fondos recibidos

Si los fondos onchain fueron recibidos, usted necesita proporcionar cantidades y cambiar el estado de la transacción a `pending_anchor`.

<CodeExample>

```json
// onchain-funds-received.json
[
  {
    "id": 1,
    "jsonrpc": "2. ",
    "method": "notify_onchain_funds_received",
    "params": {
      "transaction_id": "<transaction_id>",
      "message": "Onchain funds received",
      "stellar_transaction_id": "7. .9",
      "amount_in": {
        "amount": 10
      },
      "amount_out": {
        "amount": 9
      },
      "amount_fee": {
        "amount": 1
      }
    }
  }
]
```

</CodeExample>

Para ejecutar esto, necesitas ejecutar:

<CodeExample>

```bash
./llamar-json-rpc.sh onchain-funds-received.json
```

</CodeExample>

:::tip

Este método será llamado automáticamente por el servidor de custodia si la integración de custodia está habilitada.

:::

### Cantidad actualizada

Si los fondos onchain fueron recibidos, pero por alguna razón el `amount_in` difiere del especificado en el flujo interactivo (`amount_expected`), puedes actualizar `amount_out` y `amount_fee` para que correspondan a la `amount_in`. El estado de la transacción en este caso no se cambiará y será igual a `pending_anchor`.

<CodeExample>

```json
// amounts-updated.json
[
  {
    "id": 1,
    "jsonrpc": "2.0",
    "method": "notify_amounts_updated",
    "params": {
      "transaction_id": "<transaction_id>",
      "message": "Amounts updated",
      "amount_out": {
        "amount": 9
      },
      "amount_fee": {
        "amount": 1
      }
    }
  }
]
```

</CodeExample>

Para ejecutar esto, necesitas ejecutar:

<CodeExample>

```bash
./llamar-json-rpc.sh cantidades-actualizado.json
```

</CodeExample>

:::note

Sólo `amount_out` y `amount_fee` pueden ser actualizados usando esta solicitud JSON-RPC, y no es necesario especificar los activos de las cantidades.

:::

### Fondos de Offchain enviados

Para completar la transacción y cambiar su estado a `completado`, necesitas hacer la solicitud JSON-RPC `notify_offchain_funds_sent`.

<CodeExample>

```json
// offchain-funds-sent.json
[
  {
    "id": 1,
    "jsonrpc": "2.0",
    "method": "notify_offchain_funds_sent",
    "params": {
      "transaction_id": "<transaction_id>",
      "message": "Offchain funds sent",
      "funds_sent_at": "2023-07-04T12:34:56Z",
      "external_transaction_id": "a...c"
    }
  }
]
```

</CodeExample>

Para ejecutar esto, necesitas ejecutar:

<CodeExample>

```bash
./call-json-rpc.sh offchain-funds-sent.json
```

</CodeExample>

### Fondos offchain disponibles

Puedes mover el estado de la transacción a `pending_user_transfer_complete` si se enviaron fondos offchain y si está listo para que el usuario / destinatario los recoja.

<CodeExample>

```json
// offchain-funds-available.json
[
  {
    "id": 1,
    "jsonrpc": "2.0",
    "method": "notify_offchain_funds_available",
    "params": {
      "transaction_id": "<transaction_id>",
      "message": "Offchain funds available",
      "external_transaction_id": "a...c"
    }
  }
]
```

</CodeExample>

Para ejecutar esto, necesitas ejecutar:

<CodeExample>

```bash
./call-json-rpc.sh offchain-funds-available.json
```

</CodeExample>

### Fondos offchain pendientes

Otra opción es mover el estado de la transacción a `pending_external`. Este estado significa que el pago se ha enviado a una red externa, pero aún no se ha confirmado.

<CodeExample>

```json
// offchain-funds-pending.json
[
  {
    "id": 1,
    "jsonrpc": "2.0",
    "method": "notify_offchain_funds_pending",
    "params": {
      "transaction_id": "<transaction_id>",
      "message": "Offchain funds pending",
      "external_transaction_id": "a...c"
    }
  }
]
```

</CodeExample>

Para ejecutar esto, necesitas ejecutar:

<CodeExample>

```bash
./call-json-rpc.sh offchain-funds-pending.json
```

</CodeExample>

### Reembolso enviado

La lógica del reembolso funciona de la misma manera que para el flujo de depósitos. Para obtener más información, consulte [Reembolso enviado](#reembolso enviado) del flujo de depósitos.

### Envío de reembolso por servicio de Custodia

La integración con un servicio de custodia le permite hacer un reembolso a través de un servicio de custodia, como Bloques de Fuego.

<CodeExample>

```json
// do-stellar-refund.json
[
  {
    "id": 1,
    "jsonrpc": "2.0",
    "method": "do_stellar_refund",
    "params": {
      "transaction_id": "<transaction_id>",
      "message": "Do stellar refund",
      "refund": {
        "amount": {
          "amount": 9,
          "asset": "stellar:USDC:GBBD47IF6LWK7P7MDEVSCWR7DPUWV3NY3DTQEVFL4NAT4AQH3ZLLFLA5"
        },
        "amount_fee": {
          "amount": 1,
          "asset": "stellar:USDC:GBBD47IF6LWK7P7MDEVSCWR7DPUWV3NY3DTQEVFL4NAT4AQH3ZLLFLA5"
        }
      }
    }
  }
]
```

</CodeExample>

Para ejecutar esto, necesitas ejecutar:

<CodeExample>

```bash
./call-json-rpc.sh do-stellar-refund.json
```

</CodeExample>

:::note

Del mismo modo al flujo del depósito, usted puede hacer un reembolso completo o un conjunto de reembolsos parciales. La transacción permanecerá en estado `pending_anchor` hasta que la suma de los reembolsos sea menor que `amount_in`. Si la suma de los reembolsos es igual a `amount_in`, la Plataforma de Anchor cambiará automáticamente el estado de la transacción a `refunded`.

:::

### Error de transacción

Funciona de la misma manera que para el flujo de depósito. Para obtener más detalles, consulte [Error de transacción](#transaction-error) del flujo de depósitos.

### Transacción caducada

Funciona de la misma manera que para el flujo de depósito. Para más detalles, consulta [Transacción caducada](#transacción-caducada) del flujo de depósitos.

### Transacción en espera

Funciona de la misma manera que para el flujo de depósito. Para más detalles, consulta [On-Hold Transaction](#on-hold-transaction) del flujo de depósitos.

### Recuperación de la transacción

Funciona de la misma manera que para el flujo de depósito. Para más detalles, consulta [Recuperación de la Transacción](#transaction-recovery) del flujo de depósitos.

## Seguimiento de transacciones estelares

<Observer />

[sep-9]: https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0009.md
[sep-24]: https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0024.md
[métodos json-rpc-jones]: ../../api-reference/rpc/methods/README.mdx
