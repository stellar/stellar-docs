---
title: Integración
sidebar_position: 20
---

Esta guía le guiará a través de la integración con el servicio de eventos para comenzar a recibir eventos. El servicio de eventos actualmente sólo soporta Apache Kafka como el broker de mensajes del back-end.

Asume familiaridad con Kafka y no cubrirá cómo crear un grupo de Kafka.

## Requisitos

La Plataforma de Anchor enviará eventos al tema `TRANSACTION` Kafka. El servicio de eventos consumirá eventos de este tema y los enviará a los puntos finales apropiados.

## Configuración

Primero, el productor de Kafka del servicio de eventos debe configurarse usando la sección `event.queue` del archivo de configuración o configurando las variables de entorno. El siguiente es el conjunto de variables de entorno requeridas para configurar el productor Kafka del servicio de eventos:

<CodeExample>

```bash
# dev.env
EVENTS_ENABLED=true
EVENTS_QUEUE_TYPE=kafka
EVENTS_QUEUE_KAFKA_BOOTSTRAP_SERVER=localhost:9092
```

```yaml
# dev.services.yaml
events:
  enabled: true
  queue:
    type: kafka
    kafka:
      bootstrap_server: localhost:9092
```

</CodeExample>

La Plataforma de Anchor permite establecer un subconjunto de la configuración del cliente del productor Kafka. Vea el [archivo de valores por defecto][default-values-file] para más información sobre lo que está disponible. Para obtener más información sobre la configuración del cliente del productor de Kafka, consulte la [documentación de Kafka](https://kafka.apache.org/documentation/#producerconfigs).

A continuación, el procesador de eventos necesita ser configurado en la sección `event_processor` del archivo de configuración de la plataforma Anchor o configurando las variables de entorno.

<CodeExample>

```bash
# dev.env
EVENT_PROCESSOR_CLIENT_STATUS_CALLBACK_ENABLED=true
EVENT_PROCESSOR_CALLBACK_API_REQUEST_ENABLED=true
```

```yaml
# dev.services.yaml
event_processor:
  client_status_callback:
    habilitado: true
  callback_api_request:
    habilitado: true
```

</CodeExample>

Esto permitirá al procesador de eventos comenzar a procesar eventos desde el tema `TRANSACTION`. En este ejemplo, el procesador de eventos enviará eventos a los puntos finales de callback del cliente y del servidor empresarial.

## Recibiendo eventos

El servicio de eventos se puede utilizar para enviar eventos a los puntos finales de callback del cliente y del servidor de negocios. El servicio de eventos enviará eventos a estos extremos como peticiones POST HTTP con los datos del evento en el cuerpo de la solicitud.

### Como aplicación de cliente

Las aplicaciones de cliente pueden recibir actualizaciones siempre que el `status` de una transacción SEP cambie.

Para recibir eventos como una aplicación cliente, necesitará exponer una URL de callback a la que el servicio de eventos puede enviar eventos. El servicio del evento enviará una solicitud POST a este punto final con los datos del evento en el cuerpo de la solicitud.

La Plataforma de Anchor sólo enviará eventos a los clientes listados en la configuración del cliente. Vea la [documentación de configuración del cliente][clients-config] para más información.

#### Firmar llamada

Anchor Platform firma las solicitudes de devolución de llamada que envía a las aplicaciones del cliente. La firma está incluida en la cabecera `Signature` de la solicitud. La especificación de la firma de la URL de llamada puede encontrarse en las especificaciones de protocolo SEP correspondientes.

- [SEP-0006](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0006.md#url-callback-signature)
- [SEP-0024](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0024.md#url-callback-signature)
- [SEP-0031](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0031.md#url-callback-signature)

### Como servidor de negocios

Además de las actualizaciones de estado de las transacciones SEP, los servidores empresariales pueden recibir eventos sobre la creación de cotizaciones SEP-31 o actualizaciones de información del cliente SEP-12. El esquema de los datos del evento dependerá del tipo de evento que se envíe. Visita la [documentación de la API de eventos](../../api-reference/callbacks/post-event.api.mdx) para más información sobre el esquema de los datos del evento.

Para recibir eventos como un servidor empresarial, necesitará exponer una URL de callback a la que el servicio de eventos puede enviar eventos. El servicio del evento enviará una solicitud POST a este punto final con los datos del evento en el cuerpo de la solicitud.

#### Configuración

La API de callback del servicio de eventos puede configurarse usando la sección `callback_api` del archivo de configuración de la plataforma Anchor o configurando las variables de entorno.

:::caution

El `--event-processor` ignorará cualquier segmento de ruta especificado en `callback_api.base_url` y en su lugar enviará eventos a `[scheme]://[host]:[port]/event`. Esto es un error, pero para no interrumpir a quienes usan el procesador de eventos, diferiremos la corrección de incluir segmentos de rutas en la versión 3 de la plataforma Anchor.

:::

El siguiente es un ejemplo de cómo configurar la API de devolución de llamada del servicio de eventos con autenticación JWT:

<CodeExample>

```bash
# dev. nv

# nota `/callback` no será usada para callbacks de eventos
# en su lugar los eventos serán enviados a `http://localhost:8081/event`
# todos los demás callbacks (tasas, tarifas, etc) cliente, etc. usará la ruta raíz `/callback` proporcionada
CALLBACK_API_BASE_URL=http://localhost:8081/callback
CALLBACK_API_AUTH_TYPE=jwt
CALLBACK_API_AUTH_JWT_EXPIRATION_MILISECONDS=30000
CALLBACK_API_AUTH_JWT_HTTP_HEADER=Authorization
SECRET_CALLBACK_API_AUTH_SECRET="a secret for signing jwts"
```

```yaml
# dev.services.yaml
callback_api:
  base_url: http://localhost:8081/callback
  auth:
    type: jwt
    jwt:
      expiration_milliseconds: 30000
      http_header: Autorización
```

</CodeExample>

El siguiente es un ejemplo de cómo configurar la API de devolución de llamada del servicio de eventos con autenticación de clave API:

<CodeExample>

```bash
# dev.env
CALLBACK_API_BASE_URL=http://localhost:8081/callback
CALLBACK_API_AUTH_TYPE=api_key
CALLBACK_API_AUTH_API_API_KEY_HTTP_HEADER=X-Api-Key
SECRET_CALLBACK_API_AUTH_SECRET="tu clave API"
```

```yaml
# dev.services.yaml
callback_api:
  base_url: http://localhost:8081/callback
  auth:
    type: api_key
    api_key:
      http_header: X-Api-Key
```

</CodeExample>

:::caution

El `http_header` no es configurable a partir de la versión `2.5.2` y anterior. El valor por defecto es `Authorization` para JWT y `X-Api-Key` para API key.

Problema de seguimiento: https://github.com/stellar/java-stellar-anchor-sdk/issues/1272

:::

Esto configura la API de callback del servicio de eventos que se utilizará para enviar eventos a los puntos finales de callback del cliente y del servidor empresarial. Las siguientes son las opciones de configuración soportadas:

- `base_url`: La URL base del punto final de devolución de llamada del servidor de negocios.
- `secret`: El secreto que se utilizará para enviar eventos al punto final del servidor de negocios. Esto se utiliza para firmar el cuerpo de la petición cuando la autenticación JWT está habilitada y es la clave API cuando la autenticación de la clave API está habilitada.
- `auth`: El método de autenticación a utilizar cuando se envían eventos al punto final del servidor de negocios. Los siguientes son los métodos de autenticación soportados:
  - `JWT`: El servicio de eventos enviará un JSON Web Token (JWT) en el encabezado `Authorization` de la solicitud. Las siguientes son las opciones de configuración soportadas:
    - `expiration_milliseconds`: El tiempo de caducidad del JWT en milisegundos.
    - `http_header`: La cabecera en la que se enviará el JWT.
  - `API_KEY`: El servicio de eventos enviará una clave API en el encabezado `Authorization` de la solicitud. Las siguientes son las opciones de configuración soportadas:
    - `http_header`: La cabecera en la que se enviará la clave API.

[archivo predeterminado-valores]: https://github.com/stellar/java-stellar-anchor-sdk/blob/develop/platform/src/main/resources/config/anchor-config-default-values.yaml
[clientes-configuración]: ../../admin-guide/sep10/README.mdx#config-with-client-attribution
