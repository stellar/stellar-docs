---
id: migración individual a múltiples inquilinos
title: Guía de Migración de 1.x a 2.x
description: Guía de migración de inquilinos múltiples.
keywords:
  - migración
  - inquilino individual
  - multiinquilino
  - SDP
  - 1 x
  - 2 x
---

import { CodeExample } from "@site/src/components/CodeExample";

Aquí encontrará los pasos necesarios para migrar una aplicación Stellar Disbursement Platform existente (`1.x`) a una versión multi-inquilina (`2.x+`).

## ¿Por qué la mutación?

Comenzando con la versión `2. `, el SDP proporciona una arquitectura de múltiples arrendatarios, donde múltiples organizaciones pueden administrar los desembolsos bajo una infraestructura unificada y al mismo tiempo mantener una gestión de fondos y conjuntos de datos separados.

Las nuevas características y correcciones sólo se publicarán en la versión multi-inquilina.

La versión multi-inquilina también se adapta a escenarios de un solo inquilino, a través de una configuración simplificada que se describirá más adelante en este documento.

> **DISCLAIMER**: esta guía fue preparada y probada con las bases de código `1.1.6 -> 2.0.0-rc1`. Si está en una versión posterior, es posible que las nuevas migraciones de base de datos causen un error al seguir estos pasos.
>
> Tienes la opción de usar la versión `2.0.0-rc1` para realizar esta migración, y luego actualizar a la última versión después de que la migración se haya completado.

## Preparación para las Migraciones

### Halt la versión de un inquilino 🚧

Antes de continuar con la migración, asegúrese de que la versión de un solo inquilino del SDP no se esté ejecutando. Esto es crucial para prevenir cualquier inconsistencia de datos o conflictos durante el proceso de migración.

### Prevención del doble gasto 🚨

Para evitar el doble gasto, asegúrese de que ningún pago está en el estado `PENDING`, de lo contrario, esto podría dar lugar a que el mismo pago sea presentado de forma independiente tanto por instancias de un inquilino como de varios inquilinos. Puedes hacerlo comprobando la tabla de `pagos` para cualquier pago en el estado `PENDING`:

<CodeExample>

```sql
SELECT * FROM public.payments WHERE status = ANY(array['PENDING']::payment_status[]);
```

</CodeExample>

Del mismo modo, compruebe la tabla `submitter_transactions` para cualquier transacción en el estado `PENDING`:

<CodeExample>

```sql
SELECT * FROM public.submitter_transactions WHERE status = ANY(array['PROCESSING']::transaction_status[]);
```

</CodeExample>

Si hay algún pago en el estado `PENDING` o transacciones en el estado `PROCESSING`, debes esperar a que sean procesados y transicionados a `SUCCESS` o `FAILED` antes de continuar con la migración.

### Eliminar cuentas de canal 🧹

En la versión `2.x`, las cuentas de canal son cifradas usando el `CHANNEL_ACCOUNT_ENCRYPTION_PASSPHRASE`, que es un env diferente del utilizado en la versión de un inquilino (`DISTRIBUTION_SEED`). Para evitar cualquier problema, vamos a eliminar todas las cuentas de canal existentes en el priot de versión de un solo inquilino a la migración:

<CodeExample>

```bash
./stellar-disbursement-platform channel-accounts delete --delete-all-accounts
```

</CodeExample>

### Copia de seguridad y configuración de base de datos 💾

Haga una copia de seguridad de su base de datos de un solo inquilino antes de continuar con la migración. En este punto, la instancia de un solo inquilino debería detenerse, y no debería haber ningún pago `PENDING` ni `PROCESSING` submitter_transactions.

También se recomienda crear una nueva base de datos para la versión multi-tenant para evitar cualquier pérdida de datos. Utilice el volcado de la base de datos de un inquilino para poblar el estado inicial de este inquilino. A partir de este punto, en cualquier momento nos referimos a **la base de datos**, nos referiremos a la nueva base de datos de varios inquilinos que fue creada a partir de un volcado de la base de datos de un inquilino.

Así es como puedes hacer la copia de seguridad y restaurar:

<CodeExample>

```bash
pg_dump --dbname=$singleTenantDB > sdp-singleTenant.sql
creado $multiTenantDB
psql --dbname=$multiTenantDB < sdp-singleTenant.sql
```

</CodeExample>

## Cambios explicados

Entre los cambios introducidos en la versión multi-inquilina, los más significativos son:

1. **Infraestructura**: la versión de múltiples arrendatarios incluye un agente de eventos (Kafka) como componente de infraestructura adicional altamente recomendado para las configuraciones de múltiples arrendatarios, especialmente cuando se requiere un alto rendimiento.
2. **Variables de entorno**: la versión multiinquilina introduce nuevas variables de entorno para configurar el broker de eventos, así como variables adicionales relevantes para la multitenencia.
3. **Segregación de fondos**: la versión multiinquilina introduce el concepto de una cuenta de distribución para cada inquilino, que se utiliza para enviar transacciones en nombre del inquilino. También hay una cuenta de distribución HOST, que se utiliza para financiar las cuentas de distribución del inquilino y las cuentas del canal TSS.
4. **Comandos CLI**: algunos comandos CLI han sido revisados para que sean conscientes del inquilino, mientras que otros han sido incluidos para soportar nuevas características multi-inquilinas.
5. **Estructura de base de datos**: la estructura de base de datos ha sido revisada para acomodar múltiples tenencias y las tablas se distribuyen ahora a través de múltiples esquemas, proporcionando aislamiento entre inquilinos.

### Infraestructura

Para la configuración de la infraestructura, SDP Multi-tenant ofrece modos operativos flexibles. 

#### Evento Broker vs Jobs Programados

Los administradores pueden elegir entre utilizar un agente de eventos para operaciones motivadas por eventos, o trabajos programados para operaciones periódicas. Los corredores de eventos se recomiendan para configuraciones multi-huéspedes, ya que proporcionan una forma escalable y confiable de manejar eventos, mientras que los trabajos programados se recomiendan para configuraciones locales o SDP de un solo inquilino. Además, los corredores de eventos proporcionan una comunicación más rápida entre los servicios.

#### Versión de la plataforma de ancla

Mientras que el inquilino único usó [`stellar/anchor-platform:2.1.3`](https://hub.docker.com/layers/stellar/anchor-platform/2.1.3/images/sha256-e6ef4b17a8d3e5d1455fa3d8f5f7e2a2b9534ad749584ff5446d685eb07837e9?context=explore), la versión multitenant requiere [`stellar/anchor-platform:2.6.0`](https://hub.docker.com/layers/stellar/anchor-platform/2.6.0/images/sha256-913fa2461d36d5150724a172ca46f8c76284a3890b60a9d5709fe

### Variables de entorno

Debajo están las variables de entorno que han sido añadidas o modificadas en la versión multi-inquilina.

Variables generales de entorno:

- `ADMIN_ACCOUNT`: El nombre de usuario de la cuenta de administrador utilizado para autenticar peticiones HTTP en el servidor de administración. Las peticiones dirigidas por el administrador deben añadir la cabecera "Authorization", formateada como Base64 codificada `"ADMIN_ACCOUNT:ADMIN_API_KEY"`.
- `ADMIN_API_KEY`: La clave api de la cuenta de administrador para autenticar peticiones HTTP al servidor de administración. Las peticiones dirigidas por el administrador deben añadir la cabecera "Authorization", formateada como Base64 codificada `"ADMIN_ACCOUNT:ADMIN_API_KEY"`.
- `ADMIN_PORT`: el puerto del servidor Admin utilizado para crear y administrar inquilinos. Por defecto es 8003. 
- `INSTANCE_NAME`: el nombre de la instancia SDP que se mostrará en el archivo `stellar.toml`. Ejemplo: "SDP Testnet".
- `SINGLE_TENANT_MODE`: Cuando se establece en `"true"`, habilita el modo de un solo inquilino, que es útil para el desarrollo local o configuraciones de un solo inquilino. Además de establecerlo a verdadero, necesitarás configurar el inquilino por defecto llamando a la solicitud [`POST /tenants/default-tenant`](../api-reference/resources/default-tenant).
- `TENANT_XLM_BOOTSTRAP_AMOUNT`: La cantidad de XLM que la cuenta de HOST Stellar depositará en la cuenta de distribución del inquilino para el arranque del inquilino.

Variables de entorno de configuración de cuentas estelares:

- `CHANNEL_ACCOUNT_ENCRYPTION_PASSPHRASE`: A Stellar-compatibles con la clave privada ed25519 usada para cifrar/descifrar las claves privadas de las cuentas del canal. Cuando no se establece, se establecerá por defecto al valor de la opción 'distribution-seed', que fue usada en la versión de un solo inquilino. **Atención**, al migrar desde un solo inquilino, configurando esta configuración a algo diferente de la antigua `DISTRIBUTION_SEED` evitará que el código sea capaz de descifrar las cuentas del canal.
- `DISTRIBUTION_SIGNER_TYPE`: El tipo de firmante utilizado para firmar transacciones Stellar para las cuentas de distribución de los inquilinos. Opciones: `DISTRIBUTION_ACCOUNT_DB` (recomendado), `DISTRIBUTION_ACCOUNT_ENV` (igual que la versión de un solo inquilino).
- `DISTRIBUTION_ACCOUNT_ENCRYPTION_PASSPHRASE`: Una clave privada que cumple con Stellar-ed25519 usada para cifrar/descifrar las claves privadas de las cuentas de distribución en memoria. Es obligatorio cuando la distribución-signer-type se establece en `DISTRIBUTION_ACCOUNT_DB`.

Variables de entorno de configuración del broker de eventos:

- `BROKER_URLS`: Una lista separada por comas de las URLs del broker de mensajes.
- `CONSUMER_GROUP_ID`: Especifica un ID de grupo para los consumidores del broker.
- `EVENT_BROKER_TYPE`: Especifica el tipo de broker de eventos a utilizar. Opciones: "KAFKA", "NINGUNO". Por defecto es "Kafka".
- `KAFKA_SECURITY_PROTOCOL`: Define el protocolo de seguridad para Kafka. Opciones: PLAINTEXT, SASL_PLAINTEXT, SASL_SSL, SSL.
- `KAFKA_SASL_USERNAME`: Especifica el nombre de usuario SASL de Kafka, requerido cuando el protocolo de seguridad de kafka está establecido en `SASL_PLAINTEXT` o `SASL_SSL`.
- `KAFKA_SASL_PASSWORD`: Especifica la contraseña SASL de Kafka, requerida cuando el protocolo de seguridad kafka está establecido en `SASL_PLAINTEXT` o `SASL_SSL`.
- `KAFKA_SSL_ACCESS_KEY`: The Kafka Access Key (keystore) en formato PEM, requerido cuando el protocolo de seguridad kafka está establecido en `SSL`.
- `KAFKA_SSL_ACCESS_CERTIFICATE`: El certificado de acceso Kafka SSL en formato PEM que coincide con la clave de acceso Kafka, requerido cuando el protocolo de seguridad de kafka está establecido en `SSL`.

Variables de entorno del programador:

- `ENABLE_SCHEDULER`: Por defecto "false". Esto permite trabajos programados que reemplazan las operaciones de un corredor para sincronizar pagos entre SDP y TSS, así como para enviar invitaciones de receptor. Debe establecerse en "true" cuando el broker de eventos está deshabilitado.
- `SCHEDULER_PAYMENT_JOB_SECONDS`: Intervalo en segundos para el trabajo que sincroniza los pagos entre SDP y TSS. Mínimo es 5s.
- `SCHEDULER_RECEIVER_INVITATION_JOB_SECONDS`: Intervalo en segundos para el trabajo que envía invitaciones del receptor. Mínimo es 5s.

En el lado de la Plataforma de Ancor, debemos establecer los siguientes envas:

- `SEP10_HOME_DOMAINS="localhost:8000, *.stellar.local:8000"`: una lista separada por comas de dominios de inicio usados para [SEP-10]. Esto debería contener los dominios de las instancias de inquilinos del SDP.
- `SEP10_HOME_DOMAIN=""`: esta debe ser una cadena vacía para la versión Multi-tenant.
- `SEP10_WEB_AUTH_DOMAIN=<localhost:8080>`: el dominio principal de la instancia de la plataforma de anclas.

### Segregación de fondos

En la versión de varios inquilinos, apoyamos la segregación de fondos entre inquilinos configurando el `DISTRIBUTION_SIGNER_TYPE`:

- Cuando se establece en `DISTRIBUTION_ACCOUNT_ENV`, la clave privada de la cuenta de distribución se lee de la variable de entorno `DISTRIBUTION_SEED` y los fondos no están segregados.
- Cuando se establece en `DISTRIBUTION_ACCOUNT_DB`, la clave privada de la cuenta de distribución se almacena en la base de datos y los fondos se separan entre inquilinos. El secreto es cifrado usando la variable de entorno `DISTRIBUTION_ACCOUNT_ENCRYPTION_PASSPHRASE`.

Las cuentas de canal por otro lado se comparten entre los inquilinos, y son creados por la cuenta de distribución HOST, establecida en la variable de entorno `DISTRIBUTION_SEED`. Las cuentas de canal se cifran usando la variable de entorno `CHANNEL_ACCOUNT_ENCRYPTION_PASSPHRASE`, o la `DISTRIBUTION_SEED` si la primera no está definida. En la versión de un solo inquilino, las cuentas de canal fueron cifradas por el `DISTRIBUTION_SEED`.

### Comandos de CLI

Los siguientes comandos CLI se actualizaron para ser conocidos por el inquilino:

#### Migraciones de base de datos y población

Los comandos de un solo inquilino para la migración de BD y la prepoblación solían ser:

<CodeExample>

```bash
./stellar-disbursement-platform db migrate up # ⚠️ DECOMISSIONED in 2. !
./stellar-disbursement-platform db auth migrate up # ⚠️ 2. ¡REQUIERE A (NEW) TENANT-AWARE FLAG!
./stellar-disbursement-platform db setup-for-network # ⚠️ 2.x REQUIRES A (NEW) TENANT-AWARE FLAG!
```

</CodeExample>

Los nuevos comandos multi-tenant son:

<CodeExample>

```bash
./stellar-disbursement-platform db admin migra hasta
./stellar-disbursement-platform db tss migrate up
. stellar-disbursement-platform db auth migrate up --all
./stellar-disbursement-platform db sdp migrate up --all
./stellar-disbursement-platform db setup-for-network --all
```

</CodeExample>

Por favor, ten en cuenta que algunos comandos requieren una bandera consciente del inquilino, que puede ser:

- `--all`: para ejecutar estas migraciones en todos los inquilinos.
- `--tenant-id`: para especificar el ID de inquilino para ejecutar las migraciones.

#### Cuentas del canal

El comando asegurar se actualizó desde la bandera `--num-channel-accounts-ensure` hasta el uso de un argumento posicional:

<CodeExample>

```bash
./stellar-disbursement-platform channel-accounts ensure --num-channel-accounts-ensure 1 # OLD WAY
./stellar-disbursement-platform channel-accounts ensure 1 # NEW WAY
```

</CodeExample>

### Estructura de base de datos

En la versión actualizada, la estructura de la base de datos ha sido revisada para adaptarse a la multitenencia. Como resultado, las tablas ahora se distribuyen a través de múltiples esquemas, y se han introducido nuevas tablas para soportar la arquitectura multi-inquilina. Las siguientes esquemas se utilizan en la versión multi-inquilino:

- **admin**: alberga tablas asociadas a la administración de inquilinos. Sirve como punto central para gestionar la información relacionada con el inquilino y para resolver los nombres de los esquemas de los inquilinos basados en identificadores de inquilinos. Ninguna de estas tablas existía en la versión de un solo inquilino.
- **sdp\_\<tenant_name>**: son esquemas por instancia que tienen prefijo `sdp_`. Por ejemplo, para los inquilinos BlueCorp y RedCorp, los esquemas proporcionados se llamarían `sdp_bluecorp` y `sdp_redcorp`, respectivamente. Estos esquemas contienen todas las tablas necesarias para la operación SDP adaptada a cada arrendatario, incluyendo la autenticación por usuario por inquilino.
- **ts**: es un esquema dedicado al Servicio de Envío de Transacciones (TSS). Las tablas TSS no pertenecen a ningún inquilino, aunque cada transacción TSS contiene una columna a la que pertenece el inquilino.

Estos cambios permiten el aislamiento de los datos de los inquilinos por esquema, asegurando que los datos de cada inquilino se mantengan separados de otros inquilinos.

## Guía de Migración paso a paso

> EDIT: el código contiene un script de ayuda llamado [`./dev/migrate_1.1.6_to_2.0.0.sh`](https://github.com/stellar/stellar-disbursement-platform-backend/pull/267) que hace la mayoría de los siguientes pasos automáticamente por ti. Ten en cuenta que necesitarás editar el script con valores como el DSN de tu base de datos y el nombre del inquilino. Si ves algún error, puede que necesites recurrir a los siguientes pasos para ejecutar la migración de forma incremental manualmente.

Usando la nueva base de datos creada a partir del volcado de base de datos de un solo cliente como punto de partida (como se describe en la sección [Copia de seguridad y configuración](#database-backup--setup-)), ahora podemos continuar con los pasos de migración a continuación.

### Desplegar la nueva versión

Para transaccionar a una configuración de múltiples huéspedes, despliegue la última versión de la versión SDP `2+`. Si estás usando cartas de Helm, puedes obtener el gráfico de Helm del [repositorio SDP Helm Chart](https://github.com/stellar/helm-charts/pull/80).

### Ejecutando Migraciones iniciales de base de datos

Siguiendo el despliegue del SDP multi-tenant, el siguiente paso es realizar las **migraciones de bases de datos iniciales**. Todavía no incluye las tablas específicas del inquilino, se crearán más tarde.

Comandos de Migración:

<CodeExample>

```bash
./stellar-disbursement-platform db admin migra hacia arriba
./stellar-disbursement-platform db tgross migrate arriba
```

</CodeExample>

Estos comandos crearán las tablas de administración de inquilinos en el esquema **admin** y las tablas de Servicio de Transacción en el esquema **tss**, respectivamente.

### Nuevo proceso de aprovisionamiento de inquilinos

Después de aplicar con éxito las migraciones de bases de datos, el siguiente paso es proporcionar un nuevo inquilino. Esto se logra haciendo una petición HTTP a la **API de administración**.

Tenga en cuenta que proporcionará a los inquilinos todas las migraciones por inquilino incluidas.

#### Iniciando el servidor SDP API

Para facilitar la provisión de huéspedes, inicie el servidor SDP usando el comando:

<CodeExample>

```bash
./stellar-disbursement-platform serve
```

</CodeExample>

#### Publicando en la API de administración

- **Puerto API**: La API de Admin es accesible en el puerto `8003` por defecto. Esta configuración de puerto se puede ajustar alterando la variable de entorno `ADMIN_PORT`.
- **Autenticación**: Admin API utiliza autenticación básica para asegurar el acceso. Para autenticar, rellene el encabezado de la solicitud "Authorization" con `"Authorization: Basic ${Base64(ADMIN_ACCOUNT:ADMIN_API_KEY)}"`.

Aquí hay un script de shell que puede ser usado para crear un inquilino a través de la API de Administración:

<CodeExample>

```bash
ADMIN_ACCOUNT="SDP-admin"
ADMIN_API_KEY="api_key_1234567890"
basicAuthCredentials=$(echo -n "$ADMIN_ACCOUNT:$ADMIN_API_KEY" | base64)
AuthHeader="Autorización: Basic $basicAuthCredentials"

tenant="bluecorp"
baseURL="http://$tenant. tellar.local:8000"
sdpUIBaseURL="http://$tenant.stellar.local:3000"
ownerEmail="owner@$tenant. rg"

curl -X POST http://localhost:8003/tenants \
     -H "Content-Type: application/json" \
     -H "$AuthHeader" \
     -d '{
            "name": "'"$tenant"'",
            "organization_name": "Blue Corp",
            "base_url": "'"$baseURL"'",
            "sdp_ui_base_url": "'"$sdpUIBaseURL"'",
            "owner_email": "'"$ownerEmail"'",
            "owner_first_name": "john",
            "owner_last_name": "hacer"
}'
```

</CodeExample>

> TODO: compruebe si `base_url` y `sdp_ui_base_url` deben ser eliminados después de que https://stellarorg.atlassian.net/browse/SDP-1148 haya terminado.

En el SDP Multi-tenant, ciertas configuraciones previamente gestionadas a través de variables de entorno en la configuración de un solo cliente ahora se almacenan dentro de la tabla **inquilinos** en el esquema de administración. Este cambio permite a cada inquilino tener su propia configuración personalizada. 

El campo **nombre** es importante porque es el identificador del inquilino. Los otros campos pueden establecerse a los mismos valores utilizados en las variables de entorno utilizadas en la versión no inquilina.

### Importando tus datos

Ahora que hemos provisto a un nuevo inquilino, podemos importar nuestros datos en él. Tenemos que copiar los datos de nuestras tablas antiguas al nuevo esquema de arrendatarios.

Tenga en cuenta que las siguientes tablas no necesitan ser copiadas:

- **_migraciones_gorp_**
- **_auth_migrations_**
- **_países_**
- **_organizaciones_**

Para importar sus datos de la estructura de un solo inquilino, comenzaremos por eliminar entradas preexistentes de varios inquilinos que se añadieron automáticamente al proporcionar al inquilino:

<CodeExample>

```sql
BEGIN TRANSACCIÓN;

DELETE DE Sdp_<tenant name>.auth_users;
DELETE DE Sdp_<tenant name>. allets_assets;
DELETE DE Sdp_<tenant name>.assets;
DELETE DE sdp_<tenant name>.wallets;

COMMIT;
```

</CodeExample>

Ahora podemos importar los datos para las tablas de inquilinos restantes. Tenga en cuenta que algunas tablas no pueden ser importadas directamente debido a un conflicto de tipo personalizado. Por ejemplo, la columna `status` en la tabla `public.payments` depende de `public. ayment_status` tipo enum, mientras que el que está en la tabla `sdp_<tenant name>.payments` depende del tipo de enum `sdp_<tenant name>.payment_status`. Para resolver esto, actualizamos el tipo en la tabla de origen para que coincida con el tipo de tabla de destino:

<CodeExample>

```sql
-- INSERT new data:
BEGIN TRANSACTION;

-- These tables can be copied without changing any types in the source table columns:
INSERT INTO sdp_<tenant name>.wallets SELECT * FROM public.wallets;
INSERT INTO sdp_<tenant name>.assets SELECT * FROM public.assets;
INSERT INTO sdp_<tenant name>.wallets_assets SELECT * FROM public.wallets_assets;
INSERT INTO sdp_<tenant name>.auth_users SELECT * FROM public.auth_users;
INSERT INTO sdp_<tenant name>.receivers SELECT * FROM public.receivers;
INSERT INTO sdp_<tenant name>.auth_user_mfa_codes SELECT * FROM public.auth_user_mfa_codes;
INSERT INTO sdp_<tenant name>.auth_user_password_reset SELECT * FROM public.auth_user_password_reset;

-- These tables need to have the type of some columns changed, we do that with the `ALTER TABLE` directives:
-- NOTE: we're not reverting the types back to the original ones, as the source tables will be dropped after the migration.
ALTER TABLE public.receiver_wallets
	ALTER COLUMN status DROP DEFAULT,
	ALTER COLUMN status TYPE sdp_<tenant name>.receiver_wallet_status
		USING status::text::sdp_<tenant name>.receiver_wallet_status;
INSERT INTO sdp_<tenant name>.receiver_wallets SELECT * FROM public.receiver_wallets;

ALTER TABLE public.receiver_verifications
	ALTER COLUMN verification_field TYPE sdp_<tenant name>.verification_type
		USING verification_field::text::sdp_<tenant name>.verification_type;
INSERT INTO sdp_<tenant name>.receiver_verifications SELECT * FROM public.receiver_verifications;

ALTER TABLE public.disbursements
	ALTER COLUMN status DROP DEFAULT,
	ALTER COLUMN status TYPE sdp_<tenant name>.disbursement_status
		USING status::text::sdp_<tenant name>.disbursement_status;
ALTER TABLE public.disbursements
	ALTER COLUMN verification_field DROP DEFAULT,
	ALTER COLUMN verification_field TYPE sdp_<tenant name>.verification_type
		USING verification_field::text::sdp_<tenant name>.verification_type;
INSERT INTO sdp_<tenant name>.disbursements SELECT * FROM public.disbursements;

ALTER TABLE public.payments
	ALTER COLUMN status DROP DEFAULT,
	ALTER COLUMN status TYPE sdp_<tenant name>.payment_status
		USING status::text::sdp_<tenant name>.payment_status;
INSERT INTO sdp_<tenant name>.payments SELECT * FROM public.payments;

ALTER TABLE public.messages
	ALTER COLUMN status DROP DEFAULT,
	ALTER COLUMN status TYPE sdp_<tenant name>.message_status
		USING status::text::sdp_<tenant name>.message_status;
ALTER TABLE public.messages
	ALTER COLUMN type TYPE sdp_<tenant name>.message_type
		USING type::text::sdp_<tenant name>.message_type;
INSERT INTO sdp_<tenant name>.messages SELECT * FROM public.messages;

COMMIT;
```

</CodeExample>

Esto concluye la importación de **datos de huéspedes** de SDP, así que el siguiente paso será importar los datos del Servicio de Transacción (TSS). Como pre-solicitud para eso, asegúrese de que tiene exactamente un resultado de esta consulta y que no hay campos vacíos:

<CodeExample>

```sql
ID SELECT, name, distribution_account_address FROM admin.tenants;
```

</CodeExample>

Ahora podemos utilizar estos campos para importar los datos de TSS:

<CodeExample>

```sql
BEGIN TRANSACCIÓN;

---- 1. añadir nuevas columnas a la tabla transaction_submitter y rellenarlas
ALTER TABLE público. ubmitter_transactions
    ADD COLUMN intenant_id VARCHAR(36),
    ADD COLUMN distribution_account_address VARCHAR(56);
CON SelectedTenant AS (
    SELECT id AS tenant_id, distribution_account_address
    FROM admin. entrantes
    LIMIT 1
)
público ACTUAL. ubmitter_transactions SET tenant_id = (SELECT tenant_id FROM SelectedTenant), distribution_account_address = (SELECT distribution_account_address FROM SelectedTenant);

---- 2. copiar valores a la nueva tabla
INSERT INTO tss. ubmitter_transactions 
SELECT
    id, external_id,
    estado::text::tss. ransaction_status AS estado,
    status_history, status_message, asset_code, asset_issuer, amount, destination, created_at, updated_at, locked_at, started_at, sent_at, completed_at, synced_at, locked_until_ledger_number, stellar_transaction_hash, attempts_count, xdr_sent, xdr_received, tenant_id, distribution_account_address
FROM public . ubmitter_transactions;

COMIT;
```

</CodeExample>

Esto concluye la migración de los datos del SDP a la versión multi-inquilina. El siguiente paso es eliminar las tablas antiguas que ya no son necesarias.

### Soltar tablas viejas

Ahora, el único paso que falta es eliminar las tablas de un solo inquilino que no deberían estar en la base de datos multi-inquilino:

<CodeExample>

```sql
BEGIN TRANSACCIÓN;

DROP TABLE public.messages CASCADE;
DROP TABLE public.payments CASCADE;
DROP TABLE público. isbursements CASCADE;
DROP TABLE public.receiver_verifications CASCADE;
DROP TABLE public. eceiver_wallets CASCADE;
DROP TABLE public.auth_user_password_reset CASCADE;
DROP TABLE public.auth_user_mfa_codes CASCADE;
DROP TABLE public.receivers CASCADE;
DROP TABLE public. uth_users CASCADE;
DROP TABLE public.wallets_assets CASCADE;
DROP TABLE público. ssets CASCADE;
DROP TABLE public.wallets CASCADE;
DROP TABLE public.organizations CASCADE;
DROP TABLE public. orp_migrations CASCADE;
DROP TABLE public.auth_migrations CASCADE;
DROP TABLE public.countries CASCADE;
DROP TABLE public.submitter_transactions CASCADE;
DROP TABLE public.channel_accounts CASCADE;

COMIT;
```

</CodeExample>

### Conclusión 🎉

Esto debería concluir la migración de datos de la versión de un inquilino a la versión de varios inquilinos del SDP. Por favor, asegúrese de ejecutar una prueba e2e para asegurar que todo está funcionando como se esperaba.

[SEP-10]: https://stellar.org/protocol/sep-10
