---
title: Diseño y arquitectura
sidebar_position: 20
---

La plataforma de desembolso estelar consiste en cuatro servicios desplegados juntos:

- **Tablero**: los administradores de la interfaz de usuario utilizan para iniciar y rastrear el progreso de los desembolsos
- **SDP Core Service**: el servicio principal que realiza varias funciones:
  - **Dashboard API**: la API usada por la interfaz de usuario front-end para todas las solicitudes de desembolso. La API está documentada [here](../api-reference/resources/README.mdx)
  - **API de administrador**: la API utilizada por la organización anfitriona para administrar la provisión de inquilinos y la configuración. La API está documentada [here](../api-reference/resources/admin/README.mdx)
  - **Servicio de mensajería**: un proceso recurrente que envía mensajes de texto a los usuarios que les piden descargar el monedero seleccionado para un desembolso particular y verificar su teléfono con un OTP
  - **IU de registro de cartera**: una aplicación web que recoge y verifica el código OTP del destinatario y la información de verificación a través del protocolo de Stellar [SEP-24: Alojamiento de Depósitos y Retirados](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0024.md)
- **Servicio de Plataforma de Anchor**: el servidor API que utiliza la cartera para autenticar e iniciar el proceso de registro del destinatario a través del flujo de depósitos SEP-24
- **Servicio de Envío de Transacciones**: el servicio que envía todas las transacciones de pago a la red Stellar. Este servicio está diseñado para maximizar el pago a través de la cola, manejar la cola y gestionar graciosamente la remisión/error

## Dependencias {#dependencies}

- **Orquesta de contenedores**: el SDP está empaquetado como contenedores Docker y puede ser desplegado en Kubernetes o AWS Fargate. SDF proporciona un gráfico de casco para Kubernetes
- **Postgres**: el SDP utiliza un servidor de base de datos de Postgres para todos sus servicios
- **Apache Kafka**: el SDP usa opcionalmente Kafka para transmitir eventos entre servicios. Esto se utiliza principalmente entre SDP Core Service y Transaction Submission Service
- **Twilio o AWS SNS y SES**: el servicio de mensajería de SDP utiliza mensajes SMS a través de Twilio o AWS SNS y correos electrónicos administrativos para la configuración y recuperación de cuentas de la organización a través de AWS SES
- **Cuentas Estelar**:
  - Cuenta de Distribución: el SDP requiere acceso a al menos una cuenta Stellar financiada para hacer pagos al destinatario
  - Cuenta Auth SEP-10: el SDP requiere una cuenta Stellar para el protocolo de autenticación mutua [SEP-10: Stellar Web Authentication](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0010.md) usado para conectar a aplicaciones de cartera

## Diagrama de arquero

![Diagrama de Archivo](/assets/SDP/SDP2.png)

## Base de datos y esquemas {#database}

El SDP utiliza una base de datos de Postgres para todos sus servicios. El esquema de base de datos es administrado por el SDP Core Service y está versionado en el código base.
El esquema de base de datos está diseñado para ser consciente del inquilino, lo que significa que cada arrendatario tiene su propio conjunto de tablas y datos. Esto permite que el SDP sea multi-inquilino y apoye a múltiples organizaciones utilizando la misma instancia.

Hay 3 tipos de esquemas en la base de datos:

- **Esquema de administración**: contiene tablas para administrar inquilinos. Este esquema es utilizado por la API de administración para administrar la configuración y la provisión del inquilino.
- **TSS Schema**: contiene tablas para gestionar transacciones. Este esquema es utilizado por el Servicio de Envío de Transacciones para gestionar el estado de las transacciones de pago.
- **Esquemas de inquilino**: cada inquilino tiene su propio esquema que contiene tablas para administrar desembolsos, destinatarios y otros datos específicos del inquilino. Estos esquemas tienen prefijo `sdp_`.

## Multi-tenencia {#multi-tenancy}

El SDP puede ser desplegado en una configuración de múltiples huéspedes, donde múltiples organizaciones comparten la misma instancia del SDP. Cada organización es referida como un inquilino y tiene su propio conjunto de datos y configuración. Una organización anfitriona puede administrar múltiples inquilinos y administrar su configuración a través de la API de administración.

### Resolución de la instancia {#tenant-resolution}

El SDP utiliza una estrategia de resolución de inquilinos para determinar a qué inquilino pertenece una solicitud. La resolución del inquilino sólo es necesaria para las solicitudes no autenticadas, ya que las solicitudes autenticadas incluyen la información del inquilino ya en el token JWT.

- **Encabezado**: la cabecera `SDP-Tenant-Name` se utiliza para especificar el nombre del inquilino en la solicitud. Cuando está presente, esta cabecera se utiliza para intentar resolver el inquilino.
- **Subdominio**: el SDP puede usar el subdominio de la URL de la solicitud para resolver el inquilino. Por ejemplo, `tenant1.sdp.backend.test` resolvería el `tenant1`.

La prioridad de la resolución es la siguiente: JWT token (peticiones autenticadas) > Header > Subdominio.

#### Modo individual de inquilino {#single-tenant-mode}

Cuando se habilita el modo de una sola instancia usando la variable de entorno `SINGLE_TENANT_MODE`, todos los inquilinos se resolverán automáticamente al arrendatario predeterminado. Una instancia por defecto se establece llamando a la API [`POST /tenants/default-tenant`](../api-reference/resources/default-tenant).

El inquilino por defecto es útil para fines de desarrollo o cuando el SDP es utilizado por una sola organización. Esto permite a la organización omitir especificar el inquilino en cada petición y simplifica operativamente la configuración SDP eliminando la necesidad de proporcionar certificados TLS comodines para configuraciones multi-inquilinos.

#### Resolución de subdominio {#subdomain-resolution}

Cuando se ejecuta el SDP en modo multi-tenant, el SDP utiliza el subdominio de la URL de la petición para resolver el inquilino. Por ejemplo, `tenant1.sdp.backend.test` resolvería el `tenant1`. Esto permite al SDP diferenciar entre los inquilinos sin requerir que el nombre del inquilino se especifique en la solicitud.

La resolución del subdominio es particularmente importante para el proceso de registro de billetera, ya que el SDP depende de subdominios para diferenciar entre los inquilinos durante el flujo de depósitos SEP-24. Dominios de casa, que contienen el nombre del inquilino como un subdominio, son utilizados durante el proceso de registro por el SDP para identificar al inquilino y encaminar la solicitud de registro de cartera al contexto de inquilino correcto.
