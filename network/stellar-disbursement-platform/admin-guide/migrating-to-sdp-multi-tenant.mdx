---
id: single-tenant-to-multi-tenant-migration
title: 1.x to 2.x Migration Guide
description: Single-tenant to multi-tenant migration guide.
keywords: [migration, single-tenant, multi-tenant, SDP, 1.x, 2.x]
---

import { CodeExample } from "@site/src/components/CodeExample";

Here you will find the required steps to migrate an existing single-tenant (`1.x`) Stellar Disbursement Platform application (SDP) to a multi-tenant (`2.x+`) version.

## Why Migrate?

Starting with version `2.x`, the SDP provides a multi-tenant architecture, where multiple organizations can manage disbursements under a unified infrastructure while maintaining separate datasets and funds management.

New features and fixes will only be published to the multi-tenant version.

The multi-tenant version also suits single-tenant scenarios, through a simplified configuration that will be described later in this document.

## Preparing for the Migrations

### Halt the Single-Tenant Version üöß

Before proceeding with the migration, ensure that the single-tenant version of the SDP is not running. This is crucial to prevent any data inconsistencies or conflicts during the migration process.

### Double-Spending Prevention üö®

To avoid double-spending, ensure that no payment is in the `PENDING` state, otherwise this could result in having the same payment submitted independently by both single-tenant and multi-tenant instances. You can do that by checking the `payments` table for any payment in the `PENDING` state:
```sql
SELECT * FROM public.payments WHERE status = ANY(array['PENDING']::payment_status[]);
```

Similarly, check the `submitter_transactions` table for any transaction in the `PENDING` state:
```sql
SELECT * FROM public.submitter_transactions WHERE status = ANY(array['PROCESSING']::transaction_status[]);
```

If there are any payments in the `PENDING` state or transactions in the `PROCESSING` state, you should wait for them to be processed and transitioned to either `SUCCESS` or `FAILED` before proceeding with the migration.

### Database Backup & Setup üíæ

Backup your single-tenant database before proceeding with the migration. At this point, the single-tenant instance should be halted, and there shouldn't be any `PENDING` payments nor `PROCESSING` submitter_transactions.

It's also recommended that you create a new database for the multi-tenant version to avoid any data loss. Use the dump from the single-tenant database to populate the initial state of this multi-tenant one. From this point onwards, anytime we refer to **the database**, we'll be referring to the new multi-tenant database that was created from a dump of the single-tenant database.

## Changes Explained

Among the changes introduced in the multi-tenant version, the most significant ones are:

1. **Infrastructure**: the multi-tenant version includes an event-broker (Kafka) as an additional infrastructure component that is highly-recommended for multi-tenant setups, especially when high throughput is required.
1. **Environment Variables**: the multi-tenant version introduces new environment variables to configure the event broker, as well as additional variables relevant for multi-tenancy.
1. **Seggregation of Funds**: the multi-tenant version introduces the concept of a distribution account for each tenant, which is used to submit transactions on behalf of the tenant. There's also the HOST distribution account, that's used to fund the tenant distribution accounts and the TSS channel accounts.
1. **CLI Commands**: some CLI commands have been revised to be tenant-aware, while others have been included to support new multi-tenant features.
1. **Database Structure**: the database structure has been revised to accommodate multi-tenancy and the tables are now distributed across multiple schemas, providing isolation between tenants.

### Infrastructure

For the infrastructure setup, SDP Multi-tenant offers flexible operational modes. Administrators can optionally configure the SDP to utilize an event broker for event-driven operations. This setup currently only supports Kafka but can be extended to support other brokers like SQS or Solace. Alternatively, the SDP can operate on a scheduled job basis for payment processing and sending receiver invitations. The choice between these two modes depends on the needs of the host. Event brokers are recommended when the host needs to support multiple tenants, while scheduled jobs are recommended for local setups or single-tenant SDPs.

### Environment Variables

Below are the environment variables that have been added or modified in the multi-tenant version.

General environment variables:

- `ADMIN_ACCOUNT`: The username of the admin account used to authenticate HTTP requests to the Admin server. The Admin-targeted requests should add the "Authorization" header, formatted as Base64-encoded `"ADMIN_ACCOUNT:ADMIN_API_KEY"`.
- `ADMIN_API_KEY`: The api key of the admin accountused to authenticate HTTP requests to the Admin server. The Admin-targeted requests should add the "Authorization" header, formatted as Base64-encoded `"ADMIN_ACCOUNT:ADMIN_API_KEY"`.
- `ADMIN_PORT`: the port of the Admin server used to create and manage tenants. Default is 8003. 
- `INSTANCE_NAME`: the name of the SDP instance to be displayed in the `stellar.toml` file. Example: "SDP Testnet".
- `SINGLE_TENANT_MODE`: When set to `"true"`, it enables the single-tenant mode, which is useful for local development or single-tenant setups. In addition to set it to true, you'll need to configure the default tenant by calling the [`POST
- `TENANT_XLM_BOOTSTRAP_AMOUNT`: The amount of XLM that the HOST Stellar account will deposit deposited to the tenant distribution account for tenant bootstrap.
/tenants/default-tenant`](../resources/default-tenant) request.

Stellar accounts configuration environment variables:

- `CHANNEL_ACCOUNT_ENCRYPTION_PASSPHRASE`: A Stellar-compliant ed25519 private key used to encrypt/decrypt the channel accounts' private keys. When not set, it will default to the value of the 'distribution-seed' option, which was used in the single-tenant version. **Attention**, when migrating from the single-tenant, setting this config to something different from the old `DISTRIBUTION_SEED` will prevent the code from being able to decrypt the channel accounts.
- `DISTRIBUTION_SIGNER_TYPE`: The type of signer used to sign Stellar transactions for the tenants' distribution accounts. Options: `DISTRIBUTION_ACCOUNT_DB` (recommended), `DISTRIBUTION_ACCOUNT_ENV` (same as the single-tenant version).
- `DISTRIBUTION_ACCOUNT_ENCRYPTION_PASSPHRASE`: A Stellar-compliant ed25519 private key used to encrypt/decrypt the in-memory distribution accounts' private keys. It's mandatory when the distribution-signer-type is set to `DISTRIBUTION_ACCOUNT_DB`.

Event broker configuration environment variables:

- `BROKER_URLS`: A comma-separated list of the message broker URLs.
- `CONSUMER_GROUP_ID`: Specifies a group ID for the broker consumers.
- `EVENT_BROKER_TYPE`: Specifies the type of event broker to be used. Options: "KAFKA", "NONE". Defaults to "Kafka".
- `KAFKA_SECURITY_PROTOCOL`: Defines the security protocol for Kafka. Options: PLAINTEXT, SASL_PLAINTEXT, SASL_SSL, SSL.
- `KAFKA_SASL_USERNAME`: Specifies the Kafka SASL Username, required when the kafka security protocol is set to either `SASL_PLAINTEXT` or `SASL_SSL`.
- `KAFKA_SASL_PASSWORD`: Specifies the Kafka SASL Password, required when the kafka security protocol is set to either `SASL_PLAINTEXT` or `SASL_SSL`.
- `KAFKA_SSL_ACCESS_KEY`: The Kafka Access Key (keystore) in PEM format, required when the kafka security protocol is set to `SSL`.
- `KAFKA_SSL_ACCESS_CERTIFICATE`: The Kafka SSL Access Certificate in PEM format that matches with the Kafka Access Key, required when the kafka security protocol is set to `SSL`.

Scheduler environment variables:

- `ENABLE_SCHEDULER`: Default "false". This enables scheduled jobs that replace the operations of a broker for synchronizing payments between SDP and TSS as well as submitting receiver invitations.
- `SCHEDULER_PAYMENT_JOB_SECONDS`: Interval in seconds for the job that synchronizes payments between SDP and TSS. Minimum is 5s.
- `SCHEDULER_RECEIVER_INVITATION_JOB_SECONDS`: Interval in seconds for the job that submits receiver invitations. Minimum is 5s.

On the Anchor Platform side, we must set the following envs:

- `SEP10_HOME_DOMAINS=`"localhost:8000, *.stellar.local:8000"`: a comma-separated list of home domains used for [SEP-10].
- `SEP10_HOME_DOMAIN=""`: this should be an empty string for the Multi-tenant version.

### Seggregation of Funds

In the multi-tenant version, we support the segregation of funds between tenants by configuring the DISTRIBUTION_SIGNER_TYPE:
- When set to DISTRIBUTION_ACCOUNT_ENV, the distribution account private key is read from the environment variable `DISTRIBUTION_SEED` and the funds are not seggregated.
- When set to DISTRIBUTION_ACCOUNT_DB, the distribution account private key is stored in the database and the funds are seggregated between tenants. The secret is encrypted using the `DISTRIBUTION_ACCOUNT_ENCRYPTION_PASSPHRASE` environment variable.

The channel accounts on the other hand are shared between tenants, and they are created by the HOST distribution account, set in the `DISTRIBUTION_SEED` environment variable. The channel accounts are encrypted using the `CHANNEL_ACCOUNT_ENCRYPTION_PASSPHRASE` environment variable, or the `DISTRIBUTION_SEED` if the former is not set. In the single-tenant version, the channel accounts were encrypted by the `DISTRIBUTION_SEED`.

### CLI Commands

The following CLI commands were updated to become tenant-aware:

#### Database Migrations & Population

The single-tenant commands for DB migration and pre-population used to be:

```sh
./stellar-disbursement-platform db migrate up           # ‚ö†Ô∏è DECOMISSIONED!
./stellar-disbursement-platform db auth migrate up      # ‚ö†Ô∏è NEEDS A TENANT-AWARE FLAG!
./stellar-disbursement-platform db setup-for-network    # ‚ö†Ô∏è NEEDS A TENANT-AWARE FLAG!
```

The new multi-tenant commands are:

```sh
./stellar-disbursement-platform db admin migrate up
./stellar-disbursement-platform db tss migrate up
./stellar-disbursement-platform db auth migrate up --all
./stellar-disbursement-platform db sdp migrate up --all
./stellar-disbursement-platform db setup-for-network --all
```

Please notice that some commands require a tenant-aware flag, that can be either:
- `--all`: to execute these migrations in all tenants.
- `--tenant-id`: to specify the tenant ID to execute the migrations.

#### Channel Accounts

The ensure command was updated from using the `--num-channel-accounts-ensure` flag to using a positional argument:

```sh
./stellar-disbursement-platform channel-accounts ensure --num-channel-accounts-ensure 1 # OLD WAY
./stellar-disbursement-platform channel-accounts ensure 1                               # NEW WAY
```

## Database Schemas

In the updated version, database schemas have been revised to accommodate multi-tenancy. The organization of schemas as follows:

- **public**: The public schema houses tables associated with tenant administration, referred to as the admin tables. It serves as the central point for managing tenant-related information.
- **tss**: Dedicated to the Transaction Submitter Service (TSS), this schema is distinct from the SDP's primary schemas, a change from the single-tenant version where TSS tables were integrated with SDP tables. The TSS schema includes tables such as submitter_transactions, channel_accounts, and vault, specifically for handling transaction submissions.
- **sdp\_&lt;tenant name&gt;**: Tenant-specific schemas are prefixed with "sdp_". For example, for tenants BlueCorp and RedCorp, the provisioned schemas would be named **sdp_bluecorp** and **sdp_redcorp**, respectively. These schemas contain all necessary tables for the SDP‚Äôs operation tailored to each tenant.

## Migration Process

### Deploying a new version

To transaction to a multi-tenant setup, deploy the latest version of the SDP 2.x.x. This deployment can be achieved through various methods depending on your infrastructure, such as updating to a new Docker image, utilizing the latest Helm chart for Kubernetes deployments, etc.

### Executing Database Migrations

Following the deployment of the new SDP, the next step is to perform **database migrations** to align the database structure with the multi-tenant requirements.

Migration Commands:

<CodeExample>

```bash
./stellar-disbursement-platform db admin migrate up
./stellar-disbursement-platform db tss migrate up
```

</CodeExample>

These commands will create the tenant admin tables on the **public** schema and the Transaction Submitter Service tables on the **tss** schema, respectively.

### New Tenant Provisioning Process

After successfully applying the database migrations, the next step is to provision a new tenant. This is achieved by making an HTTP request to the **Admin API**.

#### Starting the SDP API server 

To facilitate tenant provisioning, initiate the SDP Server using the command:

<CodeExample>

```bash
./stellar-disbursement-platform serve
```

</CodeExample>

#### Accessing the Admin API 

- **Port Configuration**: The Admin API is accessible on port `8003` by default. This port setting can be adjusted by altering the `ADMIN_PORT` environment variable.
- **Authentication**: Admin API employs Basic Authentication for securing access. To authenticate, concatenate the administrator‚Äôs account name (set in the `ADMIN_ACCOUNT` environment variable) and the Admin API KEy (specified in the `ADMIN_API_KEY` environment variable). This concatenated string must then be base64 encoded to create the Authorization Header.

Shell script example of creating a tenant through the Admin API:

<CodeExample>

```shell
adminAccount="SDP-admin"
adminApiKey="api_key_1234567890"
encodedCredentials=$(echo -n "$adminAccount:$adminApiKey" | base64)
AuthHeader="Authorization: Basic $encodedCredentials"

curl -X POST https://bluecorp.backend.com:8003/tenants \
        -H "Content-Type: application/json" \
        -H "$AuthHeader" \
        -d '{
                "name": "bluecorp",
                "organization_name": "Blue Corp",
                "email_sender_type": "DRY_RUN",
                "sms_sender_type": "DRY_RUN",
                "base_url": "https://bluecorp.backend.com",
                "sdp_ui_base_url": "https://bluecorp.com",
                "owner_email": "owner@bluecorp.com",
                "owner_first_name": "john",
                "owner_last_name": "doe"
        }'
```

</CodeExample>

In the SDP Multi-tenant, certain configurations previously managed through environment variables in the single-tenant setup are now stored within the **tenants** table in the admin schema. This change allows each tenant to have its own custom configuration. 

The field **name** is important because it's the tenant identifier. The other fields can be set to the same values used on the environment variables used on the non-tenant version.

### Importing your data

Now that we've provisioned a new tenant, we can import our data into it. We need to copy our old tables' data to the new tenant schema.

An important note on this is that there are some tables that we don't need to copy. These tables are:

- **_gorp_migrations_**
- **_auth_migrations_**
- **_countries_**
- **_organizations_**

To import your data it's important to start with the following tables but we need to delete the pre-existing entries from the provisioned tenant, before importing it. These tables are:

- **_auth_users_**
- **_wallets_assets_**
- **_assets_**
- **_wallets_**

The following SQL script deletes the entries on those tables:

<CodeExample>

```sql
DELETE FROM sdp_<tenant name>.auth_users;
DELETE FROM sdp_<tenant name>.wallets_assets;
DELETE FROM sdp_<tenant name>.assets;
DELETE FROM sdp_<tenant name>.wallets;
```

</CodeExample>

After this step, you can import the data for those tables. Remember importing them in the opposite order they were deleted.

Next, we can import the tables left. We recommend following the table order described here because foreign keys references:

- **_receivers_**
- **_receiver_wallets_**
- **_receiver_verifications_**
- **_disbursements_**
- **_payments_**
- **_messages_**
- **_auth_user_mfa_codes_**
- **_Auth_user_password_reset_**

_**Note**: some columns like **status** and **types** have their enum type, so you probably will need to cast values to the type (i.e. **status::sdp_bluecorp.payment_status**)_

With this, we complete importing the SDP data but still need to import the Transaction Submitter Service data. To that, we will import our data to the tss schema tables. But before importing the submitter_transactions table we need to get the tenant ID generated for our provisioned tenant:

<CodeExample>

```sql
SELECT id, name FROM public.tenants;
```

</CodeExample>

This query retrieves the ID for the tenant.

- **_channel_accounts_** will be imported to **_tss.channel_accounts_**
- **_submitter_transactions_** will be imported to **_tss.submitter_transactions_**. Note that 2 new columns were added for this table on this version **_tenant_id_** and **_distribution_account_**, for the **_tenant_id_** column we will add the ID we got before, and for the **_distribution_account_** we set the public key of the distribution account.
- **_tss.vault_**  this table is used for storing encrypted distribution account private keys when `DISTRIBUTION_SIGNER_TYPE=DISTRIBUTION_ACCOUNT_DB`

Now, the migration from the non-tenant version to the tenant version is complete. You can log in to your SDP

### [Optional] Drop old tables

In case you applied these changes to the same database you were using before, you may now drop the SDP tables from the public schema since your tenant now has its own schema. Please, be careful running these commands since it can result in permanent data loss.

<CodeExample>

```sql
BEGIN TRANSACTION;
DROP TABLE public.wallets CASCADE;
DROP TABLE public.assets CASCADE;
DROP TABLE public.receiver_verifications CASCADE;
DROP TABLE public.receiver_wallets CASCADE;
DROP TABLE public.receivers CASCADE;
DROP TABLE public.messages CASCADE;
DROP TABLE public.auth_migrations CASCADE;
DROP TABLE public.auth_user_mfa_codes CASCADE;
DROP TABLE public.auth_user_password_reset CASCADE;
DROP TABLE public.auth_users CASCADE;
DROP TABLE public.countries CASCADE;
DROP TABLE public.gorp_migrations CASCADE;
DROP TABLE public.organizations CASCADE;
DROP TABLE public.submitter_transactions CASCADE;
DROP TABLE public.channel_accounts CASCADE;
DROP TABLE public.wallets_assets CASCADE;
DROP TABLE public.payments CASCADE;
DROP TABLE public.disbursements CASCADE;
COMMIT;
```

</CodeExample>

[SEP-10]: https://stellar.org/protocol/sep-10