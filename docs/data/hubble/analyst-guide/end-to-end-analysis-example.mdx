---
title: "End to End Analysis Example"
sidebar_position: 40
---

import create_data_source from "/img/hubble/create-data-source.png";
import bq_connector from "/img/hubble/bq-connector.png";
import add_contract_data from "/img/hubble/add-contract-data.png";
import create_report from "/img/hubble/create-report.png";
import select_data_sources from "/img/hubble/select-data-sources.png";
import add_pie_chart from "/img/hubble/add-pie-chart.png";
import pie_contract_data from "/img/hubble/pie-contract-data.png";
import pie_config from "/img/hubble/pie-config.png";
import pie_chart_durability from "/img/hubble/pie-chart-durability.png";
import click_add_data from "/img/hubble/click-add-data.png";
import add_custom_query from "/img/hubble/add-custom-query.png";
import add_column_chart from "/img/hubble/add-column-chart.png";
import column_chart_config from "/img/hubble/column-chart-config.png";
import resource_column_chart from "/img/hubble/resource-column-chart.png";

This page will guide you through an end-to-end analysis use case with Hubble and [Google Looker Studio](https://cloud.google.com/looker-studio?hl=en)

## Prerequisites

1. Make sure you have connected to Hubble by following the instructions in the [Connecting](./connecting.mdx) page
2. You have access to [Google Looker Studio](https://cloud.google.com/looker-studio?hl=en)
3. You have read and understand the general [Best Practices](https://developers.stellar.org/docs/data/hubble/analyst-guide/optimizing-queries#best-practices) for querying BigQuery data

## Create a Dashboard Analyzing Soroban Metrics

### Attach Data Sources to Looker Studio

1. Select `Create --> Data source`

<img src={create_data_source} width="200" />

2. Find and select the `BigQuery Google Connector`

<img src={bq_connector} width="300" />

3. Find the desired tables that you want to connect. For this example you will want to add a data source for:
   1. `crypto-stellar.crypto_stellar.contract_data`

<img src={add_contract_data} width="600" />

### Create a New Report (Dashboard)

1. Select `Create --> Report`

<img src={create_report} width="200" />

2. Add your data sources from above

<img src={select_data_sources} width="300" />

3. Insert a `Pie chart`

<img src={add_pie_chart} width="200" />

4. Choose `contract_data` as the `Data source`

<img src={pie_contract_data} width="300" />

5. Choose `closed_at` as the `Date Range Dimension` and `contract_durability` as the `Dimension`

<img src={pie_config} width="300" />

6. You should now have a pie chart showing the percentage of Temporary VS Persistent Contract Data Durability

<img src={pie_chart_durability} width="500" />

### Use Custom SQL to Create a Chart

1. In your report, click `Add Data` which will be near the bottom right of your window

<img src={click_add_data} width="500" />

2. Select `BigQuery` and choose `CUSTOM QUERY` and select your desired `Billing Project` where the query will be charged

<img src={add_custom_query} width="500" />

3. Add the following query and click `Add`

```
-- Selects each ContractData ledger entry from the last 7 days from the contract_data table.
with
  contract_data as (
    select
      contract_id
      , (contract_id || contract_key_type || contract_durability) as contract_entrykey
      , date(closed_at) as ledger_date
    from `crypto-stellar.crypto_stellar.contract_data`
    where(
      deleted is false
      and (date(closed_at) between datetime_sub(current_datetime(), interval 7 day)
      and current_datetime())
    )
  )

-- Selects successful 'invoke_contract' Soroban transactions and its resource consumption from the enriched_history_operations table.
  , enriched_operations as (
    select
      transaction_id
      , contract_id
      , soroban_resources_instructions
      , soroban_resources_read_bytes
      , soroban_resources_write_bytes
      , closed_at
      , date(closed_at) as ledger_date
    from `crypto-stellar.crypto_stellar_dbt.enriched_history_operations_soroban`
    where(
      op_type = 24
      and successful is true
      and soroban_operation_type = 'invoke_contract'
      and (date(closed_at) between datetime_sub(current_datetime(), interval 7 day)
      and current_datetime())
    )
  )

  , join_tables as (
    select
      eo.ledger_date
      , cd.contract_entrykey
      , eo.soroban_resources_instructions
      , eo.soroban_resources_read_bytes
      , eo.soroban_resources_write_bytes
      , row_number() over(
          partition by cd.contract_entrykey, eo.transaction_id
          order by eo.closed_at desc
      ) as rn
    from enriched_operations as eo
    inner join contract_data as cd
      on eo.contract_id = cd.contract_id
      and eo.ledger_date = cd.ledger_date
  )

-- Deduplicates transactions and calculates the average resource consumption over the last 7 days.
  , last_7_days_avg_resources as (
    select
      avg(soroban_resources_instructions) as avg_resources_instructions
      , avg(soroban_resources_read_bytes) as avg_resources_read_bytes
      , avg(soroban_resources_write_bytes) as avg_resources_write_bytes
    from join_tables
    where rn = 1
  )

-- Get the max resources that can currently be requested on the network
  , config_settings as (
    select
      max(tx_max_instructions) as tx_max_instructions
      , max(tx_max_read_bytes) as tx_max_read_bytes
      , max(tx_max_write_bytes) as tx_max_write_bytes
    from `crypto-stellar.crypto_stellar_dbt.config_settings_current`
    where config_setting_id in (1,2)
  )

-- Calculates the average percentage of the last 7 days' usage for each resource relative to the configured limit.
  , actual_vs_config as (
    select
      (res.avg_resources_instructions / cs.tx_max_instructions) as resources_instructions_perc
      , (res.avg_resources_read_bytes / cs.tx_max_read_bytes) as resources_read_bytes_perc
      , (res.avg_resources_write_bytes / cs.tx_max_write_bytes) as resources_write_bytes_perc
    from last_7_days_avg_resources as res
    join config_settings as cs
      on 1=1
  )

-- Lists each resource and its percentages.
  , percentage_list as (
      select
        'Ledger CPU Instructions' as resource
        , resources_instructions_perc as percentage_usage
      from actual_vs_config
      union all
      select
        'Ledger Read Bytes' as resource
        , resources_read_bytes_perc as percentage_usage
      from actual_vs_config
      union all
      select
        'Ledger Write Bytes' as resource
        , resources_write_bytes_perc as percentage_usage
      from actual_vs_config
  )

  select *
  from percentage_list
  order by percentage_usage desc
```

4. Insert `Column chart`

<img src={add_column_chart} width="200" />

5. Select `BigQuery Custom SQL` as your `Data source`, `resource` as the `Dimension`, and `percentage_usage` as the `Metric`

<img src={column_chart_config} width="300" />

6. You should now have a column chart (bar chart) showing the Soroban Average Resource Utilization

<img src={resource_column_chart} width="500" />
