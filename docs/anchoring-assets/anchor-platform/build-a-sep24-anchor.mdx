---
title: Build a SEP-24 Anchor
sidebar_position: 10
---

import { CodeExample } from "@site/src/components/CodeExample";

This guide will walk you through installing, configuring, and integrating with the Anchor Platform for the purpose of building a on & off ramp service compatible with [SEP-24][sep-24], the ecosystem's standardized protocol for hosted deposits and withdrawals.

By leveraging the Anchor Platform's support for SEP-24, businesses make their on & off ramp service available as an in-app experience through Stellar-based applications such as wallets and exchanges, extending their reach and connecting with users through the applications they already use.

:::note

As we improve the documentation, parts of this guide that are relevant to other use cases may be moved into their own sections.

:::

## Installation

The easiest way to install the Anchor Platform is to pull the [docker image][anchor-platform-image]. SEP-24 support is not yet officially released, but is available using the `edge` tag.

<CodeExample>

```bash
docker pull stellar/anchor-platform:edge
```

</CodeExample>

## Configuration

In this guide we'll use [docker compose][docker-compose] for simplicity, but you can run the Anchor Platform using other tools that support docker as well, such as [minikube] or a full-blown [kubernetes] cluster.

Lets create a minimal compose file to get started.

<CodeExample>

```yaml
# docker-compose.yml
version: "3.8"
services:
platform-server:
  image: stellar/anchor-platform:edge
  command: --sep-server
  ports:
    - "8080:8080"
  env_file:
    - ./config/dev.env
  volumes:
    - ./config:/home
```

</CodeExample>

The `--sep-server` option tells the Anchor Platform to make the API endpoints defined by the SEPs you've enabled via configuration on port 8080. This option also makes the Platform API available, which is the backend API your service(s) will use to communicate with the Anchor Platform.

:::note

A future release of the Anchor Platform will add an additional command line option for the Platform API, and update the `--sep-server` option to only make the SEP APIs available.

:::

### Create a Configuration File

The Anchor Platform supports two approaches for configuration: using environment variables or a YAML configuration file. While its possible to only use one of the two approaches, most deployments will use both due to the a variables value structure or security requirements.

We'll use environment variables for most of our configuration and only use our YAML file when simple key-value pairs aren't a good way to represent our values.

See the full set of configuration options in the Anchor Platform's [default values file][ap-default-values].

Lets create a file for our environment variables and a directory containing our YAML configuration.

<CodeExample>

```bash
touch dev.env 
mkdir config 
touch config/dev.config.yaml
```

</CodeExample>

Add an environment variable that specifies the path to our YAML configuration file.

<CodeExample>

```bash
# dev.env
ANCHOR_CONFIG_FILE=/home/dev.config.yaml
```

</CodeExample>

Specify the following in your `dev.config.yaml` file, and change the values depending on your preferences.

<CodeExample>

```yaml
# dev.config.yaml
version: 1

assets:
  type: json
  value: |
    {
        "assets": [
          {
            "schema": "stellar",
            "code": "USDC",
            "issuer": "GBBD47IF6LWK7P7MDEVSCWR7DPUWV3NY3DTQEVFL4NAT4AQH3ZLLFLA5",
            "distribution_account": "GBLSAHONJRODSFTLOV225NZR4LHICH63RIFQTQN37L5CRTR2IMQ5UEK7",
            "significant_decimals": 2,
            "deposit": {
              "enabled": true,
              "min_amount": 1,
              "max_amount": 1000000
            },
            "withdraw": {
              "enabled": true,
              "min_amount": 1,
              "max_amount": 1000000
            },
            "sep24_enabled": true
          }
        ]
    }
```

</CodeExample>

The information provided for the `assets` value closely maps to the information that will be expsosed to wallet application using the [`GET /info`][sep24-get-info] SEP-24 endpoint. The Anchor Platform also uses this information to validate requests made to your service.

:::note

A future release of the Anchor Platform will support providing this JSON in a `.json` file or specifying this information in YAML format.

:::

### Publish a Stellar Info File

Next, lets enable applications to learn more about your service by hosting a `stellar.toml` file at a standardized URL path. This file allows applications to find information about your business, the assets your services utilize, as well as the root URL paths for these services. We can specify this file using the Anchor Platform.

Lets create a file called `dev.stellar.toml` file using the contents below as a starting point. For the full set of attributes, see the [SEP-1 specification][sep-1].

<CodeExample>

```toml
# dev.stellar.toml
ACCOUNTS = ["add your public keys for your distribution accounts here"]
SIGNING_KEY = "add your signing key here"
NETWORK_PASSPHRASE = "Test SDF Network ; September 2015"

TRANSFER_SERVER_SEP0024 = "http://localhost:8080/sep24"
WEB_AUTH_ENDPOINT = "http://localhost:8080/auth"

[[CURRENCIES]]
code = "USDC"
issuer = "GBBD47IF6LWK7P7MDEVSCWR7DPUWV3NY3DTQEVFL4NAT4AQH3ZLLFLA5"
status = "test"
is_asset_anchored = false
desc = "USD Coin issued by Circle"

[DOCUMENTATION]
ORG_NAME = "Your organization"
ORG_URL = "Your website"
ORG_DESCRIPTION = "A description of your organization"
```

</CodeExample>

Note that you'll need to create another file for your production deployment that uses the public network's passphrase, your production service URLs, your mainnet distribution accounts and signing key, as well as the mainnet issuing accounts of the assets your service utilizes.

In your `dev.env` file, specify the following.

<CodeExample>

```bash
SEP1_ENABLED=true
SEP1_TYPE=file
SEP1_VALUE=/home/dev.stellar.toml
```

</CodeExample>

This will tell the Anchor Platform that it should host the file specified by `SEP1_VALUE` at `./well-known/stellar.toml`.

Alternatively, your `stellar.toml` file could be hosted using a proper static file server like [nginx]. As long as your info file includes the appropriate URLs pointing to the Anchor Platform, this will work just fine.

### Enable Stellar Authentication

Stellar-based wallet applications create authenticated sessions with Stellar anchors by proving they, or their users, have sufficient control over a Stellar account. Once authenticated, the wallet application uses a session token provided by the anchor in subsequent requests to the anchor's standardized services.

The Anchor Platform supports this form of authentication with minimal configuration from the business.

<CodeExample>

```bash
SEP10_ENABLED=true
SECRET_SEP10_SIGNING_SEED="a Stellar private key"
SECRET_SEP10_JWT_SECRET="a secret encryption key"
```

</CodeExample>

`SECRET_SEP10_SIGNING_SEED` is the private key to the public key you've specified as the `SIGNING_KEY` in your `stellar.toml` file. It will be used to sign authentication challenges presented to wallet applications, providing that you are in possession of the `SIGNING_KEY`. Wallets will check for this signature before signing and sending back the authentication challenge.

`SECRET_SEP10_JWT_SECRET` is the enyption key that will be used to sign and verify the authentication tokens you issue to wallet applications after they or thier users have proven control of their Stellar account.

By default, the Anchor Platform allows anyone with a Stellar account to authenticate with your services. If you'd like to only allow users of a particular wallet application to authenticate, or want to disallow specific users from authenticating, use the following environment variables. This is an optional feature and should only be added if it is a business requirement.

<CodeExample>

```bash
SEP10_CLIENT_ATTRIBUTION_REQUIRED=true
SEP10_CLIENT_ATTTRIBUTION_ALLOWLIST=lobstr.co,api.vibrantapp.com,decaf.so,api.beansapp.com

SEP10_REQUIRE_KNOWN_OMNIBUS_ACCOUNT=true
SEP10_OMNIBUS_ACCOUNT_LIST=GBIBMZNXMD3P7HXVQCYIWWT5NG43NEIIY7VYBQ5SADV6UULUKCAJTGPG
```

</CodeExample>

`SEP10_CLIENT_ATTRIBUTION_REQUIRED` informs the Anchor Platform whether or not it should allow users of non-custodial wallets to authenticate without the wallet also identifying itself, and `SEP10_CLIENT_ATTTRIBUTION_ALLOWLIST` is the list of non-custodial wallets that can create authenticated sessions with your services.

`SEP10_REQUIRE_KNOWN_OMNIBUS_ACCOUNT` informs the Anchor Platform whether or not it should allow users of custodial wallets to authenticate without the custdodial wallet's public key being included in the `SEP10_OMNIBUS_ACCOUNT_LIST`.

### Enable Hosted Deposits & Withdrawals

Now you're ready to enable hosted deposits and withdrawals via the SEP-24 API. Add the following variables to your environment file.

<CodeExample>

```bash
# dev.env
SEP24_ENABLED=true
SEP24_INTERACTIVE_URL_BASE_URL=http://localhost:8081
SECRET_SEP24_INTERACTIVE_URL_JWT_SECRET="your encryption key shared with your business server"
SECRET_SEP24_MORE_INFO_URL_JWT_SECRET="your encryption key shared with your business server"
```

</CodeExample>

`SEP24_INTERACTIVE_URL_BASE_URL` is the URL that the Anchor Platform will provide to wallet applications when they initiate transactions. Wallet applications will open this URL in a webview inside their app, handing over control of the user experience from the wallet to your business. We'll dive further into this experience in subsequent sections.

`SECRET_SEP24_INTERACTIVE_URL_JWT_SECRET` and `SECRET_SEP24_MORE_INFO_URL_JWT_SECRET` are encryption keys that the Anchor Platform will use to generate short-lived tokens it will add to the URLs provided to the wallet. Your business server must also have these keys in its environment so it can verify the token's signature.

### Test With the Demo Wallet

Wallets should now be able to discover, authenticate, and initiate transactions with your service! Your project and source files should now look something like this.

<CodeExample>

```
├── dev.env
├── docker-compose.yaml
├── config
│   ├── dev.config.yaml
│   ├── dev.stellar.toml
```

</CodeExample>

Your environment should now look like the following.

<CodeExample>

```bash
# dev.env
ANCHOR_CONFIG_FILE=/home/dev.config.yaml

SEP1_ENABLED=true
SEP1_TYPE=file
SEP1_VALUE=/home/dev.stellar.toml

SEP10_ENABLED=true
SECRET_SEP10_SIGNING_SEED="a Stellar private key"
SECRET_SEP10_JWT_SECRET="a secret encryption key"

SEP24_ENABLED=true
SEP24_INTERACTIVE_URL_BASE_URL=http://localhost:8081
SECRET_SEP24_INTERACTIVE_URL_JWT_SECRET="your encryption key shared with your business server"
SECRET_SEP24_MORE_INFO_URL_JWT_SECRET="your encryption key shared with your business server"
```

</CodeExample>

To test this out, go to the [Stellar Demo Wallet][stellar-demo-wallet].

![demo wallet connected to the anchor platform](/assets/anchor-platform-sep24-demo-wallet.png)

Initiate a transaction by doing the following:

* Create a new keypair
* Click the "Add Asset" button and enter 
  * the code of the Stellar asset on your `stellar.toml` file
  * your home domain, `localhost:8080`
* Select the dropdown and click "SEP-24 Deposit", then click "Start"

The demo wallet should be able to find your `stellar.toml` file, authenticate using the Stellar keypair you just created, and initiate a transaction. However, when the demo wallet attempts to open the URL provided by the Anchor Platform, you'll get a not found page.

![demo wallet after initiating a transaction](/assets/anchor-platform-sep24-demo-wallet-widget.png)

### Add Data Persistance

Before we move forward, lets add a database to our development environment so the transactions we initiate persist after stopping the service.

<CodeExample>

```yaml
# docker-compose.yml
version: '3.8'
services:
  platform-server:
    image: stellar/anchor-platform:edge
    command: --sep-server
    env_file:
      - ./dev.env
    volumes:
      - ./config:/home
    ports:
      - "8080:8080"
    depends_on:
      - db
  db:
    image: postgres:latest
    ports:
      - "5432:5432"
    env_file:
      - ./dev.env
```

</CodeExample>

Now lets update our environment so the platform server can connect to the database server.

<CodeExample>

```bash
# dev.env
DATA_TYPE=postgres
DATA_URL=jdbc:postgresql://db/platform
DATA_FLYWAY_ENABLED=false
SECRET_DATA_USERNAME=postgres
SECRET_DATA_PASSWORD=password

POSTGRES_USER=postgres
POSTGRES_PASSWORD=password
```

</CodeExample>

We have to create the `platform` database before we the platform server can connect to it, so lets run the database container and create our database.

<CodeExample>

```bash
docker compose up db
```

</CodeExample>

Copy the name of the container from the command's output. If you're in a directory called `sep24-anchor`, then your container will be `sep24-anchor-db-1`. Now lets create the database inside the container.

<CodeExample>

```bash
docker exec -it sep24-anchor-db-1 psql -U postgres
```

</CodeExample>

Now that you're in the PostgreSQL console, create the database.

<CodeExample>

```bash
CREATE DATABASE platform;
```

</CodeExample>

Exit the container, and try to run the platform server in addition to the database.

<CodeExample>

```bash
docker compose up
```

</CodeExample>

You should see the logs reporting a successful connection to the postgres database.

## Integration



[sep-1]: https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0001.md
[sep-24]: https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0024.md
[sep24-get-info]: https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0024.md#info
[anchor-platform-image]: https://hub.docker.com/r/stellar/anchor-platform
[docker-compose]: https://docs.docker.com/compose/
[minikube]: https://minikube.sigs.k8s.io/docs/
[kubernetes]: https://kubernetes.io/
[nginx]: https://www.nginx.com/
[ap-default-values]: https://github.com/stellar/java-stellar-anchor-sdk/blob/develop/platform/src/main/resources/config/anchor-config-default-values.yaml
[stellar-demo-wallet]: https://demo-wallet.stellar.org