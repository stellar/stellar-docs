---
title: Recovery
sidebar_position: 60
---

import Header from "./component/header.mdx";

<Header WIPLangs={["dart"]} />

The [Sep-30] standard defines the standard way for an individual (e.g., a user or wallet) to regain access to their Stellar account after losing its private key without providing any third party control of the account. During this flow the wallet communicates with one or more recovery signer servers to register the wallet for a later recovery if it's needed.

## Create recoverable account

First, let's create an account key, a device key, and a recovery key that will be attached to the account.

<CodeExample>

```typescript
const accountKp = wallet.stellar().account().createKeypair();
const deviceKp = wallet.stellar().account().createKeypair();
const recoveryKp = wallet.stellar().account().createKeypair();
```

</CodeExample>

The `accountKp` is the wallet's main account. The `deviceKp` we will be adding to the wallet as a signer so a device (eg. a mobile device a wallet is hosted on) can take control of the account. And the recovery key will be used to identify the key with the recovery servers.

Next, let's identify the recovery servers and create our recovery object:

<CodeExample>

```typescript
const server1Key = "server1";
const server1 = {
  endpoint: "recovery-example.com",
  authEndpoint: "auth-example.com",
  homeDomain: "test-domain",
};

const server2Key = "server2";
const server2 = {
  endpoint: "recovery-example2.com",
  authEndpoint: "auth-example2.com",
  homeDomain: "test-domain2",
};

const recovery = wallet.recovery({
  servers: { [server1Key]: server1, [server2Key]: server2 },
});
```

</CodeExample>

Next, we need to define SEP-30 identities. In this example we are going to use the same list of identities on both recovery servers.

<CodeExample>

```typescript
const identity = {
  role: RecoveryRole.OWNER,
  authMethods: [
    {
      type: RecoveryType.STELLAR_ADDRESS,
      value: recoveryKp.publicKey,
    },
  ],
};
```

</CodeExample>

Here, stellar key will be used as a recovery method. Other recovery servers may support email or phone as a recovery methods.

You can read more about SEP-30 identities [here](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0030.md#common-request-fields)

Next, let's create a recoverable account:

<CodeExample>

```typescript
const config = {
  accountAddress: accountKp,
  deviceAddress: deviceKp,
  accountThreshold: { low: 10, medium: 10, high: 10 },
  accountIdentity: { [server1Key]: [identity], [server2Key]: [identity] },
  signerWeight: { device: 10, recoveryServer: 5 },
};
const recoverableWallet = await recovery.createRecoverableWallet(config);
```

</CodeExample>

With the given parameters, this function will create a transaction that will:

1. Set `deviceKp` as the primary account key. Please note that the master key belonging to `accountKp` will be locked. `deviceKp` should be used as a primary signer instead.
2. Set all operation thresholds to 10. You can read more about threshold in the [documentation](https://developers.stellar.org/docs/encyclopedia/signatures-multisig#thresholds)
3. Use identities that were defined earlier on both servers. (That means, both server will accept SEP-10 authentication via `recoveryKp` as an auth method)
4. Set device key weight to 10, and recovery server weight to 5. Given these account thresholds, both servers must be used to recover the account, as transaction signed by one will only have weight of 5, which is not sufficient to change account key.

Finally, sign and submit transaction to the network:

<CodeExample>

```typescript
recoverableWallet.transaction.sign(accountKp.keypair);

await stellar.submitTransaction(recoverableWallet.transaction);
```

</CodeExample>

## Get Account Info

You can fetch account info from one or more servers. To do so, first we need to authenticate with a recovery server using the SEP-10 authentication method:

<CodeExample>

```typescript
const authToken = await recovery
  .sep10Auth(server1Key)
  .authenticate({ accountKp: recoveryKp });
```

</CodeExample>

Next, get account info using auth tokens:

<CodeExample>

```typescript
const accountResp = await recovery.getAccountInfo(accountKp, {
  [server1Key]: authToken,
});
```

</CodeExample>

## Recover Wallet

First, we need to authenticate with both recovery servers:

<CodeExample>

```typescript
const authToken1 = await recovery
  .sep10Auth(server1Key)
  .authenticate({ accountKp: recoveryKp });

const authToken2 = await recovery
  .sep10Auth(server1Key)
  .authenticate({ accountKp: recoveryKp });
```

</CodeExample>

We need to know the recovery signer addresses that will be used to sign the transaction. You can get them from either the recoverable wallet object we created earlier (`recoverableWallet.signers`), or via fetching account info from recovery servers.

<CodeExample>

```typescript
const recoverySignerAddress1 = recoverableWallet.signers[0];
const recoverySignerAddress2 = recoverableWallet.signers[1];
```

</CodeExample>

Next, create a new device key and retrieve a signed key replacement transaction from the recovery servers:

<CodeExample>

```typescript
const newDeviceKp = accountService.createKeypair();

const serverAuth = {
  [server1Key]: {
    signerAddress: recoverySignerAddress1,
    authToken1,
  },
  [server2Key]: {
    signerAddress: recoverySignerAddress2,
    authToken2,
  },
};

const recoverTxn = await recovery.replaceDeviceKey(
  accountKp,
  newKp,
  serverAuth,
);
```

</CodeExample>

Calling this function will create a transaction that locks the previous device key and replaces it with your new key (having the same weight as the old one). Lost device key is deduced automatically. Signer will be considered a device key, if one of these conditions matches:

1. It's the only signer that's not in `serverAuth`
2. All signers in `serverAuth` has the same weight, and potential signer is the only one with a different weight.

Note that the account created above will match the first criteria. If 2-3 schema were used, then second criteria would match. (In 2-3 schema, 3 serves are used and 2 of them is enough to recover key. This is a recommended approach.)

Note: you can also use more low-level `signWithRecoveryServers` functions to sign arbitrary transaction.

Finally, it's time to submit transaction:

<CodeExample>

```typescript
await stellar.submitTransaction(recoverTxn);
```

</CodeExample>

[sep-30]: https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0030.md
