---
sidebar_position: 10
title: 8. State Expiration
description: State Expiration Semantics
---

# Terms and Semantics

## Expiration Ledger

Each `ContractData` and `ContractCode` entry has an `expirationLedger` field stored in its `LedgerEntry`.
The entry is considered expired when `current_ledger > expirationLedger`.

## Lifetime

An entry's lifetime is defined as how many ledgers remain until the entry expires.
For example, if the current ledger is 5 and an entry's expiration ledger is 15, then
the entry's lifetime is 10 ledgers.

## Minimum Lifetime

For each entry type, there is a minimum lifetime that the entry must have when being created
or updated. This lifetime minimum is enforced automatically at the protocol level. This minimum
is a network parameter and defaults to 16 ledgers for `Temporary` entries and 4,096 ledgers for
`Persistent` and `Instance` entries.

## Maximum Lifetime

On any given ledger, an entry's lifetime can be extended up to the maximum lifetime. This is a
network parameter and defaults to 1 year worth of ledgers. This maximum lifetime is not enforced
based on when an entry was created, but based on the current ledger. For example, if an entry is
created on January 1st, 2024, its lifetime could initially be bumped up to January 1st, 2025.
After this initial lifetime bump, if the entry received another lifetime bump later on January 10th, 2024,
the lifetime could be extended up to January 10th, 2025.

# Operations

## BumpFootprintExpirationOp

### Semantics

XDR:
```
/*
    Threshold: med
    Result: BumpFootprintExpirationResult
*/
struct BumpFootprintExpirationOp
{
    ExtensionPoint ext;
    uint32 ledgersToExpire;
};
```

`BumpFootprintExpirationOp` is a Soroban operation that will bump the expiration
ledger of the entries specified in the *read-only set of the footprint*. The
read-write set must be empty. The bump will make sure that the entries will not
expire before ledgersToExpire ledgers from now.

Let's look at this example below.
```
Ex. Last closed ledger (LCL) = 5, Current Ledger = 6, ledgersToExpire = 8

entry1.expirationLedger = 10 
entry2.expirationLedger = 14
entry3.expirationLedger = 10000

entry1.expirationLedger will be updated to 14 so it will live for 8 more ledgers
after the current one closes and the entry can be accessed in ledgers [6, 14]. Note: This is going to be updated to count
Current Ledger, so it'll become [6, 13].

entry2 and entry3 will not be updated because they already have an
expirationLedger that is large enough.
```

### Transaction resources

`BumpFootprintExpirationOp` is a Soroban operation, and therefore must be the
only operation in a transaction. The transaction also needs to populate
`SorobanTransactionData` transaction extension explained
[here](../fundamentals-and-concepts/invoking-contracts-with-transactions.mdx#transaction-resources). To fill
out `SorobanResources`, use preflight mentioned in the provided link, or make
sure `readBytes` includes the key and entry size of every entry in the
`readOnly` set and make sure `extendedMetaDataSizeBytes` is at least double of
`readBytes`.


## RestoreFootprintOp

XDR:
```
/*
    Threshold: med
    Result: RestoreFootprintOp
*/
struct RestoreFootprintOp
{
    ExtensionPoint ext;
};
```

`RestoreFootprintOp` is a Soroban operation that will restore expired entries
specified in the *read-write set of the footprint* and make them accessible
again. The read-only set of the footprint must be empty. An expired entry is one
where its expirationLedger is less than the current ledger number.

The restored entry will have its expiration ledger bumped to the [minimums] the
network allows for newly created entries, which is 4096 + current ledger for
persistent entries, and 16 + current ledger for temporary entries (Note that
both will be updated soon to use 4096 + current ledger - 1 and 16 + current
ledger - 1). The minimums linked are what the settings will be on release, but
they can be updated in the future through a validator vote.

[minimums]: https://github.com/stellar/stellar-core/blob/2109a168a895349f87b502ae3d182380b378fa47/src/ledger/NetworkConfig.h#L77-L78
### Transaction resources

`RestoreFootprintOp` is a Soroban operation, and therefore must be the only
operation in a transaction. The transaction also needs to populate
`SorobanTransactionData` transaction extension explained
[here](../fundamentals-and-concepts/invoking-contracts-with-transactions.mdx#transaction-resources). To fill
out `SorobanResources`, use preflight mentioned in the provided link, or make
sure `writeBytes` includes the key and entry size of every entry in the
`readWrite` set and make sure `extendedMetaDataSizeBytes` is at least double of
`writeBytes`.
