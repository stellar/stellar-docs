#!/bin/bash

export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

if ! nvm use 22 >/dev/null 2>&1; then
  echo "⚠️  Node v22 not installed. Skipping formatting check."
  exit 0
fi

G='\033[0;32m'
P='\033[0;35m'
CLEAN='\033[0;0m'

if command -v yarn >/dev/null 2>&1; then
  CHECK_OUTPUT=$(yarn run check:mdx 2>&1)
  STATUS=$?

  if echo "$CHECK_OUTPUT" | grep -q 'The engine "node" is incompatible with this module'; then
    echo -e "${G}Warning:${CLEAN} Node version mismatch. Skipping formatting check."
    exit 0
  fi

  if [ "$STATUS" -ne 0 ]; then
    echo "$CHECK_OUTPUT"
    echo -e "${G}Hint:${CLEAN} Run ${P}yarn run format:mdx${CLEAN} to fix formatting."
    exit 1
  fi

else
  echo -e "${G}Hint:${CLEAN} Yarn not installed. Skipping formatting check."
  exit 0
fi